<?php

/**
 * SupplyOfMaterialTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class SupplyOfMaterialTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object SupplyOfMaterialTable
	 */
	public static function getInstance()
	{
		return Doctrine_Core::getTable('SupplyOfMaterial');
	}

	public static function getTotalAmount($projectId)
	{
		$con = self::getInstance()->getConnection();

		//Get BillIds
		$billIds = $con->fetchColumn("SELECT bill.id FROM " . ProjectStructureTable::getInstance()->getTableName() . " AS bill
		WHERE bill.root_id = " . $projectId . " AND bill.deleted_at IS NULL AND bill.type = '" . ProjectStructure::TYPE_SUPPLY_OF_MATERIAL_BILL . "'");

		if ( count($billIds) > 0 )
		{
			// We'll fetch and SUM the latest grand_total from Bill Item
			$amounts = $con->fetchAssoc("SELECT COALESCE(SUM(item.amount),0) AS amount
			FROM " . SupplyOfMaterialItemTable::getInstance()->getTableName() . " AS item
			LEFT JOIN " . SupplyOfMaterialElementTable::getInstance()->getTableName() . " AS element ON item.element_id = element.id
			WHERE element.project_structure_id IN (" . implode(',', $billIds) . ")
			AND item.deleted_at IS NULL AND element.deleted_at IS NULL");

			return $amounts[0]['amount'];
		}

		return 0;
	}

}