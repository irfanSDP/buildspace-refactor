<?php

/**
 * BillBuildUpFloorAreaItem
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class BillBuildUpFloorAreaItem extends BaseBillBuildUpFloorAreaItem
{
    const FORMULATED_COLUMN_FACTOR = 'factor';
    const FORMULATED_COLUMN_LENGTH = 'length';
    const FORMULATED_COLUMN_WIDTH = 'width';

    const SIGN_POSITIVE = 1;
    const SIGN_NEGATIVE = 2;
    const SIGN_POSITIVE_TEXT = '+';
    const SIGN_NEGATIVE_TEXT = '-';

    public function getSignText()
    {
        switch($this->sign)
        {
            case self::SIGN_POSITIVE:
                $text = self::SIGN_POSITIVE_TEXT;
                break;
            case self::SIGN_NEGATIVE:
                $text = self::SIGN_NEGATIVE_TEXT;
                break;
            default:
                throw new Exception('invalid sign');
        }
        return $text;
    }

    public function calculateTotal()
    {
        $result = DoctrineQuery::create()->select('COUNT(id) as count, MULTIPLY(c.final_value) AS value')
            ->from('BillBuildUpFloorAreaFormulatedColumn c')
            ->where('c.relation_id = ?', $this->id)
            ->andWhereIn('c.column_name', array(self::FORMULATED_COLUMN_WIDTH, self::FORMULATED_COLUMN_LENGTH, self::FORMULATED_COLUMN_FACTOR))
            ->andWhere('c.final_value IS NOT NULL')
            ->andWhere('c.deleted_at IS NULL')
            ->limit(1)
            ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
            ->fetchOne();

        if($result['count'] > 0)
        {
            $total = $this->sign == self::SIGN_POSITIVE ? abs($result['value']) : abs($result['value']) * -1;
        }
        else
        {
            $total = 0;
        }

        if($this->total != $total)
        {
            $this->total = $total;
            $this->save();
        }

        return $this->total;
    }

    public function getFormulatedColumnByName($columnName)
    {
        return BillBuildUpFloorAreaItemTable::getFormulatedColumnByRelationIdAndColumnName($this->id, $columnName);
    }

    public function delete(Doctrine_Connection $conn = null)
    {
        $buildUpFloorAreaItemIds = array();
        $affectedBuildUpFloorAreaItems = array();
        $formulatedColumnIds = array();
        $nodes = null;

        $conn = $conn ? $conn : $this->getTable()->getConnection();

        try
        {
            $conn->beginTransaction();

            foreach($this->FormulatedColumns as $formulatedColumn)
            {
                $nodes = $formulatedColumn->getNodesRelatedByColumnName($formulatedColumn->column_name);

                if(is_array($nodes))
                {
                    foreach($nodes as $node)
                    {
                        $referencedNode = Doctrine_Core::getTable('BillBuildUpFloorAreaFormulatedColumn')->find($node['node_from']);

                        if($referencedNode)
                        {
                            $value = $itemId = str_ireplace('r'.$this->id, '#REF!', $referencedNode->value);
                            $referencedNode->setFormula($value);

                            $referencedNode->save();

                            $buildUpFloorAreaItemIds[$referencedNode->relation_id] = $referencedNode->relation_id;
                        }
                    }
                }

                Doctrine_Manager::getInstance()->getCurrentConnection()
                    ->fetchAssoc("UPDATE ".$formulatedColumn->getTable()->getTableName()." SET
                    deleted_at = NOW()
                    WHERE id = ".$formulatedColumn->id);

                $formulatedColumnIds[] = $formulatedColumn->id;
            }

            if(count($formulatedColumnIds) > 0)
            {
                //now we can remove all edges after we've updated related nodes
                Doctrine_Query::create()
                    ->delete('BillBuildUpFloorAreaEdge e')
                    ->whereIn('e.node_from', $formulatedColumnIds)
                    ->execute();

                Doctrine_Query::create()
                    ->delete('BillBuildUpFloorAreaEdge e')
                    ->whereIn('e.node_to', $formulatedColumnIds)
                    ->execute();
            }

            parent::delete($conn);

            $conn->commit();
        }
        catch(Exception $e)
        {
            $conn->rollback();
            throw $e;
        }

        foreach($buildUpFloorAreaItemIds as $buildUpFloorAreaItemId)
        {
            $affectedBuildUpFloorAreaItem = array();
            $buildUpFloorAreaItem = $this->getTable()->find($buildUpFloorAreaItemId);

            $affectedBuildUpFloorAreaItem['id'] = $buildUpFloorAreaItem->id;
            $affectedBuildUpFloorAreaItem['total'] = $buildUpFloorAreaItem->calculateTotal();

            foreach($buildUpFloorAreaItem->FormulatedColumns as $formulatedColumn)
            {
                $columnName = $formulatedColumn->column_name;
                $affectedBuildUpFloorAreaItem[$columnName."-final_value"] = $formulatedColumn->final_value;
                $affectedBuildUpFloorAreaItem[$columnName."-value"] = $formulatedColumn->value;
                $affectedBuildUpFloorAreaItem[$columnName.'-has_cell_reference'] = $formulatedColumn->hasCellReference();
                $affectedBuildUpFloorAreaItem[$columnName.'-has_formula'] = $formulatedColumn->hasFormula();
            }

            array_push($affectedBuildUpFloorAreaItems, $affectedBuildUpFloorAreaItem);
        }

        return $affectedBuildUpFloorAreaItems;
    }

    public function moveTo($priority, $lastPosition=false)
    {
        $priority = $lastPosition ? $priority+1 : $priority;

        $con = $this->getTable()->getConnection();

        try
        {
            $con->beginTransaction();

            $this->priority = $priority;
            $this->save();

            if(!$lastPosition)
            {
                $this->updatePriority($priority, $this->id);
            }

            $con->commit();

            return true;
        }
        catch(Exception $e)
        {
            $con->rollback();
            throw $e;
        }

    }

    public function copyTo($targetItem, $lastPosition=false)
    {
        $con = $this->getTable()->getConnection();

        try
        {
            $con->beginTransaction();

            $priorityToUpdate = $lastPosition ? $targetItem->priority + 1 : $targetItem->priority;

            $cloneItem = $this->copy();
            $cloneItem->priority = $priorityToUpdate;
            $cloneItem->save($con);

            if(!$lastPosition)
            {
                $this->updatePriority($priorityToUpdate, $cloneItem->id);
            }

            $cloneItem->copyFormulatedColumnsFromItem($this);

            $con->commit();

            $cloneItem->refresh(true);

            return $cloneItem;
        }
        catch(Exception $e)
        {
            $con->rollback();
            throw $e;
        }
    }

    public function copyFormulatedColumnsFromItem(BillBuildUpFloorAreaItem $item)
    {
        $formulatedColumnNames = Utilities::getAllFormulatedColumnConstants('BillBuildUpFloorAreaItem');
        $edgeTable = Doctrine_Core::getTable('BillBuildUpFloorAreaEdge');

        foreach($formulatedColumnNames as $columnName)
        {
            $formulatedColumn = $item->getFormulatedColumnByName($columnName);
            if($formulatedColumn)
            {
                $cloneFormulatedColumn = $formulatedColumn->copy();
                $cloneFormulatedColumn->relation_id = $this->id;
                $cloneFormulatedColumn->save();

                $edgeTable->getConnection()->fetchAssoc("INSERT INTO ".$edgeTable->getTableName()." (node_from, node_to, column_name, created_at, updated_at)
                    SELECT ".$cloneFormulatedColumn->id.", old.node_to, old.column_name, NOW(), NOW() FROM ".$edgeTable->getTableName()." AS old
                    WHERE old.node_from = ".$formulatedColumn->id." AND old.deleted_at IS NULL");
            }
        }
    }

    private function updatePriority($priority, $excludeId)
    {
        $records = DoctrineQuery::create()->select('i.id')
            ->from('BillBuildUpFloorAreaItem i')
            ->andWhere('i.bill_column_setting_id = ?', $this->bill_column_setting_id)
            ->andWhere('i.priority >= ?',$priority)
            ->addOrderBy('i.priority ASC')
            ->execute();

        $priorityToUpdate = $priority + 1;

        foreach($records as $record)
        {
            if($record->id != $excludeId)
            {
                $record->priority = $priorityToUpdate;
                $record->save();
            }

            $priorityToUpdate++;
        }
    }
}
