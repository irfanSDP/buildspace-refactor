<?php

/**
 * BillBuildUpRateResource
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class BillBuildUpRateResource extends BaseBillBuildUpRateResource
{
    public function delete(Doctrine_Connection $conn = null)
    {
        $buildUpRateItems = $this->Items->toArray();

        $buildUpRateItemIds = Utilities::arrayValueRecursive('id', $buildUpRateItems);

        parent::delete($conn);

        if(count($buildUpRateItemIds) > 0 && $buildUpRateItemIds[0])
        {
            $implodedIds = implode(',', $buildUpRateItemIds);

            Doctrine_Manager::getInstance()->getCurrentConnection()
                ->fetchAssoc("UPDATE ".BillBuildUpRateItemTable::getInstance()->getTableName()." SET deleted_at = NOW() WHERE id IN (".$implodedIds.") AND deleted_at IS NULL");

            Doctrine_Query::create()
                ->delete('BillBuildUpRateEdge e')
                ->where('node_from IN (SELECT c.id FROM BillBuildUpRateFormulatedColumn c WHERE c.relation_id IN ('.$implodedIds.') AND c.deleted_at IS NULL)')
                ->execute();

            Doctrine_Query::create()
                ->delete('BillBuildUpRateEdge e')
                ->where('node_to IN (SELECT c.id FROM BillBuildUpRateFormulatedColumn c WHERE c.relation_id IN ('.$implodedIds.') AND c.deleted_at IS NULL)')
                ->execute();

            Doctrine_Manager::getInstance()->getCurrentConnection()
                ->fetchAssoc("UPDATE ".BillBuildUpRateFormulatedColumnTable::getInstance()->getTableName()." SET deleted_at = NOW() WHERE relation_id IN (".$implodedIds.") AND deleted_at IS NULL");

            Doctrine_Query::create()
                ->delete('BillBuildUpRateResourceTrade t')
                ->where('t.build_up_rate_resource_id = ?', $this->id)
                ->execute();
        }
    }
}
