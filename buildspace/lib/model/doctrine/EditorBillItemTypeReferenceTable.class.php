<?php

/**
 * EditorBillItemTypeReferenceTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EditorBillItemTypeReferenceTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return EditorBillItemTypeReferenceTable The table instance
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('EditorBillItemTypeReference');
    }

    public static function getByItemIdAndColumnId($itemInfoId, $columnSettingId, $hydrate = null)
    {
        $query = DoctrineQuery::create()->select('r.*')
            ->from('EditorBillItemTypeReference r')
            ->where('r.bill_item_info_id = ?', $itemInfoId)
            ->andWhere('r.bill_column_setting_id = ?', $columnSettingId)
            ->limit(1);

        if ( !is_null($hydrate) )
        {
            $query->setHydrationMode($hydrate);
        }

        return $query->fetchOne();
    }

    public static function updateTypeTotalByBillColumnSettingAndItemId($billItemInfoId, $billColumnSetting)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $sql = "SELECT COALESCE((ROUND(COALESCE(ifc.final_value,0), 2)),0) * COALESCE(type.quantity_per_unit, 0)
            FROM " . EditorBillItemInfoTable::getInstance()->getTableName() . " as item
            JOIN " . EditorBillItemFormulatedColumnTable::getInstance()->getTableName() . " as ifc ON ifc.relation_id = item.id
            JOIN " . EditorBillItemTypeReferenceTable::getInstance()->getTableName() . " as type ON type.bill_item_info_id = item.id AND type.bill_column_setting_id = " . $billColumnSetting['id'] . "
            WHERE ifc.column_name = '" . BillItem::FORMULATED_COLUMN_RATE . "' AND item.id = " . $billItemInfoId . "
            AND ifc.deleted_at IS NULL";

        //Update Grand Total
        $stmt = $pdo->prepare("UPDATE " . EditorBillItemTypeReferenceTable::getInstance()->getTableName() . " SET
            grand_total = (ROUND((" . $sql . "),2) * " . $billColumnSetting['quantity'] . ")
            WHERE bill_column_setting_id = " . $billColumnSetting['id'] . " AND bill_item_info_id = ".$billItemInfoId);

        $stmt->execute();
    }
}
