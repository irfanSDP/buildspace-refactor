<?php

/**
 * ScheduleOfRateTrade
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class ScheduleOfRateTrade extends BaseScheduleOfRateTrade
{
    public function delete(Doctrine_Connection $conn = null)
    {
        // get item associated with current deleting trade ID
        $items = Doctrine_Query::create()
            ->select('sori.id, fc.id')
            ->from('ScheduleOfRateItem sori')
            ->leftJoin('sori.FormulatedColumns fc')
            ->where('sori.trade_id = ?', $this->id)
            ->execute();

        $affectedFormulatedColumnId = array();
        $affectedItemIds            = array();

        foreach($items as $item)
        {
            foreach ( $item['FormulatedColumns'] as $formulatedColumn )
            {
                array_push($affectedFormulatedColumnId, $formulatedColumn['id']);
            }

            array_push($affectedItemIds, $item->id);
        }

        // unlink bill item that is linked to SoR, if available
        if ( count($affectedFormulatedColumnId) > 0 )
        {
            BillItemFormulatedColumnTable::unlinkFormulatedColumnFromSor($affectedFormulatedColumnId);
        }

        if ( count($affectedItemIds) > 0 )
        {
            ScheduleOfRateItemFormulatedColumnTable::deleteRecordRelatedToItems($affectedItemIds);
        }

        parent::delete($conn);
    }

    public function moveTo($priority, $lastPosition=false)
    {
        $priority = $lastPosition ? $priority+1 : $priority;

        $con = $this->getTable()->getConnection();

        try
        {
            $con->beginTransaction();

            $this->priority = $priority;
            $this->save();

            if(!$lastPosition)
            {
                $this->updatePriority($priority, $this->id);
            }

            $con->commit();

            return true;
        }
        catch(Exception $e)
        {
            $con->rollback();
            throw $e;
        }

    }

    public function copyTo($targetItem, $lastPosition=false)
    {
        $con = $this->getTable()->getConnection();

        try
        {
            $con->beginTransaction();

            $priorityToUpdate = $lastPosition ? $targetItem->priority + 1 : $targetItem->priority;

            $cloneTrade = $this->copy();
            $cloneTrade->priority = $priorityToUpdate;
            $cloneTrade->save($con);

            if(!$lastPosition)
            {
                $this->updatePriority($priorityToUpdate, $cloneTrade->id);
            }

            $query = Doctrine_Core::getTable('ScheduleOfRateItem')
                ->createQuery('i')
                ->select('i.*')
                ->where('i.root_id = i.id')
                ->addWhere('i.trade_id = ?', $this->id)
                ->orderBy('i.priority ASC');

            $roots = $query->execute();
            $scopeContainer = new ScheduleOfRateItem();

            foreach($roots as $root)
            {
                $newRoot = $root->copy();

                $newRoot->trade_id = $cloneTrade->id;
                $newRoot->save($con);

                $query = Doctrine_Core::getTable('ScheduleOfRateItem')
                    ->createQuery('i')
                    ->select('i.*')
                    ->where('i.root_id = ?', $root->id)
                    ->addWhere('i.lft > ? AND i.rgt < ?', array($root->lft, $root->rgt))
                    ->orderBy('i.lft ASC');
                $children = $query->execute();

                foreach($children as $child)
                {
                    $newChild = $child->copy();
                    $newChild->root_id = $newRoot->id;
                    $newChild->trade_id = $cloneTrade->id;
                    $newChild->save($con);
                    $newChild->refresh();

                    array_push($scopeContainer->itemContainerAfterCopy, array(
                        'id' => $newChild->id,
                        'origin' => $child->id
                    ));

                    $newChild->copyFormulatedColumnsFromItem($child, $scopeContainer);
                    $newChild->copyBuildUpRatesFromItem($child);

                    unset($newChild, $child);
                }

                $newRoot->root_id = $newRoot->id;
                $newRoot->save($con);
                $newRoot->refresh();

                array_push($scopeContainer->itemContainerAfterCopy, array(
                    'id' => $newRoot->id,
                    'origin' => $root->id
                ));

                $newRoot->copyFormulatedColumnsFromItem($root, $scopeContainer);
                $newRoot->copyBuildUpRatesFromItem($root);

                $newRoot->free();
                unset($newRoot, $root);
            }

            $scopeContainer->updateItemRowLinkingAfterCopy();

            $con->commit();

            unset($scopeContainer);

            return $cloneTrade;
        }
        catch(Exception $e)
        {
            $con->rollback();
            throw $e;
        }
    }

    private function updatePriority($priority, $excludeId)
    {
        $query = DoctrineQuery::create()->select('t.id')
            ->from('ScheduleOfRateTrade t')
            ->where('t.schedule_of_rate_id = ?', $this->schedule_of_rate_id)
            ->andWhere('t.priority >= ?',$priority)
            ->addOrderBy('t.priority ASC');

        $records = $query->execute();

        $priorityToUpdate = $priority + 1;

        foreach($records as $record)
        {
            if($record->id != $excludeId){
                $record->priority = $priorityToUpdate;
                $record->save();
            }
            $priorityToUpdate++;
        }
    }

    public function getCostAnalysis(ProjectStructure $project)
    {
        ScheduleOfRateTradeTable::getCostAnalysisByProject($project, array($this->id));
    }
}
