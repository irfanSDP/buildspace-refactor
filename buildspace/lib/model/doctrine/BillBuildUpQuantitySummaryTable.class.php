<?php

/**
 * BillBuildUpQuantitySummaryTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BillBuildUpQuantitySummaryTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object BillBuildUpQuantitySummaryTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('BillBuildUpQuantitySummary');
    }

    public static function createByBillItemIdAndBillColumnSettingId($billItemId, $billColumnSettingId, $type)
    {
        $billBuildUpQuantitySummary = DoctrineQuery::create()->select('s.id')
            ->from('BillBuildUpQuantitySummary s')
            ->where('s.bill_item_id = ?', $billItemId)
            ->andWhere('s.bill_column_setting_id = ?', $billColumnSettingId)
            ->andWhere('s.type = ?', $type)
            ->limit(1)
            ->fetchOne();

        if(!$billBuildUpQuantitySummary)
        {
            //get current Bill rounding Type
            $billSetting = Doctrine_Core::getTable('BillSetting')
                ->createQuery('b')
                ->leftJoin('b.ProjectStructure p')
                ->leftJoin('p.BillColumnSettings c')
                ->addWhere('c.id = ?', $billColumnSettingId)
                ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
                ->fetchOne();

            $billBuildUpQuantitySummary = new BillBuildUpQuantitySummary();
            $billBuildUpQuantitySummary->bill_item_id = $billItemId;
            $billBuildUpQuantitySummary->bill_column_setting_id = $billColumnSettingId;
            $billBuildUpQuantitySummary->type = $type;
            $billBuildUpQuantitySummary->rounding_type = ($billSetting['build_up_quantity_rounding_type']) ? $billSetting['build_up_quantity_rounding_type'] : BillSetting::ROUNDING_TYPE_DISABLED;
            $billBuildUpQuantitySummary->conversion_factor_operator = Constants::ARITHMETIC_OPERATOR_ADDITION;

            $billBuildUpQuantitySummary->save(self::getInstance()->getConnection());
        }

        return $billBuildUpQuantitySummary;
    }

    public static function getByBillItemIdAndBillColumnSettingId($billItemId, $billColumnSettingId, $type)
    {
        return DoctrineQuery::create()->select('s.id')
            ->from('BillBuildUpQuantitySummary s')
            ->where('s.bill_item_id = ?', $billItemId)
            ->andWhere('s.bill_column_setting_id = ?', $billColumnSettingId)
            ->andWhere('s.type = ?', $type)
            ->limit(1)
            ->fetchOne();
    }
}