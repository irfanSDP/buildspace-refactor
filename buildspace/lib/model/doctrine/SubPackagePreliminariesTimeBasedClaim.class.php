<?php

/**
 * SubPackagePreliminariesTimeBasedClaim
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class SubPackagePreliminariesTimeBasedClaim extends BaseSubPackagePreliminariesTimeBasedClaim
{
    public function save(Doctrine_Connection $conn = NULL)
    {
        // delete available record for PreliminariesWorkBasedClaim
        Doctrine_Query::create()
        ->delete('SubPackagePreliminariesWorkBasedClaim a')
        ->where('a.sub_package_post_contract_bill_item_rate_id = ?', $this->sub_package_post_contract_bill_item_rate_id)
        ->andWhere('a.revision_id = ?', $this->revision_id)
        ->execute();

        parent::save($conn);

        // attach a record to let system know that current edited item has been claim, if total is over than 0
        if ( $this->total > 0 )
        {
            $record = Doctrine_Core::getTable('SubPackagePreliminariesClaim')->findOneBy('sub_package_post_contract_bill_item_rate_id', $this->sub_package_post_contract_bill_item_rate_id);

            if ( ! $record )
            {
                $record                                  = new SubPackagePreliminariesClaim();
                $record->sub_package_post_contract_bill_item_rate_id = $this->sub_package_post_contract_bill_item_rate_id;
                $record->claim_at_revision_id            = $this->revision_id;
                $record->save();
            }
        }
    }
}
