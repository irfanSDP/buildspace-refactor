<?php

/**
 * CostDataProvisionalSumItemTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class CostDataProvisionalSumItemTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return CostDataProvisionalSumItemTable The table instance
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('CostDataProvisionalSumItem');
    }

    public static function getTotalSum(CostData $costData)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "SELECT COALESCE(SUM(i.approved_cost), 0) as approved_sum, COALESCE(SUM(i.awarded_cost), 0) as awarded_sum, COALESCE(SUM(i.variation_order_cost), 0) as variation_order_sum, COALESCE(SUM(i.awarded_cost + i.variation_order_cost), 0) as adjusted_sum
        FROM ".self::getInstance()->getTableName()." i
        WHERE i.cost_data_id = :costDataId
        AND i.deleted_at IS NULL;";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'costDataId' => $costData->id ));

        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    public static function getLatestUpdateDetails(CostData $costData)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "SELECT i.id, i.updated_at, i.updated_by, cp.name as updater_name
        FROM ".self::getInstance()->getTableName()." i
        LEFT JOIN ".sfGuardUserTable::getInstance()->getTableName()." u on u.id = i.updated_by
        LEFT JOIN ".sfGuardUserProfileTable::getInstance()->getTableName()." cp ON cp.user_id = u.id
        WHERE i.cost_data_id = :costDataId
        AND i.deleted_at IS NULL
        ORDER BY i.updated_by DESC;";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'costDataId' => $costData->id ));

        return $stmt->fetch(PDO::FETCH_ASSOC);
    }
}