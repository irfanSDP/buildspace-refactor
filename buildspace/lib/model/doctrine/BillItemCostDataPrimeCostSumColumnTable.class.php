<?php

/**
 * BillItemCostDataPrimeCostSumColumnTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BillItemCostDataPrimeCostSumColumnTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return BillItemCostDataPrimeCostSumColumnTable The table instance
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('BillItemCostDataPrimeCostSumColumn');
    }

    public static function sync(MasterCostDataPrimeCostSumItem $masterItem, $columnId, $selectedBillItemIds, $deselectedBillItemIds)
    {
        self::unlink($masterItem, $columnId, $deselectedBillItemIds);

        self::link($masterItem, $columnId, $selectedBillItemIds);

        $item = CostDataPrimeCostSumColumnTable::getItem($masterItem, $columnId);

        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "UPDATE " . CostDataPrimeCostSumColumnTable::getInstance()->getTableName() . " i
                SET amount = :amount
                WHERE i.id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array(
            'amount' => self::getSumOfLinkedBillItems($masterItem, $columnId) * $item->conversion_factor,
            'itemId'      => $item['id']
        ));
    }

    protected static function unlink(MasterCostDataPrimeCostSumItem $masterItem, $columnId, $deselectedBillItemIds)
    {
        if( count($deselectedBillItemIds) <= 0 ) return;

        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostSumColumnTable::getItem($masterItem, $columnId);

        $implodedDeselectedItemIds = implode(',', $deselectedBillItemIds);

        if( $item->exists() )
        {
            $statement = "DELETE FROM " . self::getInstance()->getTableName() . " pivot
                WHERE pivot.cost_data_prime_cost_sum_column_id = :itemId
                AND pivot.bill_item_id in ({$implodedDeselectedItemIds})";

            $stmt = $pdo->prepare($statement);

            $stmt->execute(array( 'itemId' => $item['id'] ));
        }
    }

    protected static function link(MasterCostDataPrimeCostSumItem $masterItem, $columnId, array $selectedBillItemIds)
    {
        $item = CostDataPrimeCostSumColumnTable::getItem($masterItem, $columnId);

        if($item->isNew()) $item->save();

        $linkedBillItemIds = array_column(self::getLinkedBillItems($masterItem, $columnId), 'bill_item_id');

        $newlySelectedBillItemIds = array_diff($selectedBillItemIds, $linkedBillItemIds);

        foreach($newlySelectedBillItemIds as $billItemId)
        {
            $pivotRecord = new BillItemCostDataPrimeCostSumColumn();
            $pivotRecord->bill_item_id = $billItemId;
            $pivotRecord->cost_data_prime_cost_sum_column_id = $item->id;
            $pivotRecord->save();
        }
    }

    public static function getLinkedBillItems(MasterCostDataPrimeCostSumItem $masterItem, $columnId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostSumColumnTable::getItem($masterItem, $columnId);

        if($item->isNew()) return array();

        $statement = "SELECT i.id as bill_item_id, e.id as element_id, b.id as bill_id, p.id as project_id 
            FROM ".self::getInstance()->getTableName()." pivot
            JOIN " . BillItemTable::getInstance()->getTableName() . " i on i.id = pivot.bill_item_id
            JOIN " . BillElementTable::getInstance()->getTableName() . " e on e.id = i.element_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " b on b.id = e.project_structure_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " p on p.id = b.root_id
            WHERE pivot.cost_data_prime_cost_sum_column_id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'itemId' => $item['id'] ));

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public static function getSumOfLinkedBillItems(MasterCostDataPrimeCostSumItem $masterItem, $columnId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostSumColumnTable::getItem($masterItem, $columnId);

        $linkedBillItems = self::getLinkedBillItems($masterItem, $columnId);

        if($item->isNew() || empty($linkedBillItems)) return 0;

        $linkedBillItemIds = Utilities::arrayValueRecursive('bill_item_id', $linkedBillItems);

        $statement = "SELECT SUM(COALESCE(r.grand_total,0))
        FROM ".self::getInstance()->getTableName()." pivot
        JOIN ".BillItemTable::getInstance()->getTableName()." bi on bi.id = pivot.bill_item_id
        LEFT JOIN " . PostContractBillItemRateTable::getInstance()->getTableName() . " r ON bi.id = r.bill_item_id
        WHERE pivot.cost_data_prime_cost_sum_column_id = :itemId
        AND bi.deleted_at IS NULL;";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'itemId' => $item['id'] ));

        return $stmt->fetch(PDO::FETCH_COLUMN,0);
    }

    public static function flushItemLinks($billItemIds)
    {
        Doctrine_Query::create()
            ->delete('BillItemCostDataPrimeCostSumColumn')
            ->whereIn('bill_item_id', $billItemIds)
            ->execute();
    }

    public static function itemValueUpdate(MasterCostDataPrimeCostSumItem $masterItem, $columnId)
    {
        $item = CostDataPrimeCostSumColumnTable::getItem($masterItem, $columnId);

        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "UPDATE " . CostDataPrimeCostSumColumnTable::getInstance()->getTableName() . " i
            SET amount = :amount
            WHERE i.id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array(
            'amount' => self::getSumOfLinkedBillItems($masterItem, $columnId) * $item->conversion_factor,
            'itemId' => $item['id']
        ));
    }
}