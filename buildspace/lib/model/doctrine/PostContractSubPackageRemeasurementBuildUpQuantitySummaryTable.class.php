<?php

/**
 * PostContractSubPackageRemeasurementBuildUpQuantitySummaryTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PostContractSubPackageRemeasurementBuildUpQuantitySummaryTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object PostContractSubPackageRemeasurementBuildUpQuantitySummaryTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('PostContractSubPackageRemeasurementBuildUpQuantitySummary');
    }

    public static function createByBillItemIdAndBillColumnSettingId($postContractSubPackageBillItemRateId, $billColumnSettingId, $type)
    {
        $billBuildUpQuantitySummary = DoctrineQuery::create()
        ->select('s.id')
        ->from('PostContractSubPackageRemeasurementBuildUpQuantitySummary s')
        ->where('s.sub_package_post_contract_bill_item_rate_id = ?', $postContractSubPackageBillItemRateId)
        ->andWhere('s.bill_column_setting_id = ?', $billColumnSettingId)
        ->andWhere('s.type = ?', $type)
        ->limit(1)
        ->fetchOne();

        if (!$billBuildUpQuantitySummary)
        {
            //get current Bill rounding Type
            $billSetting = Doctrine_Core::getTable('BillSetting')
            ->createQuery('b')
            ->leftJoin('b.ProjectStructure p')
            ->leftJoin('p.BillColumnSettings c')
            ->addWhere('c.id = ?', $billColumnSettingId)
            ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
            ->fetchOne();

            $billBuildUpQuantitySummary                                              = new PostContractSubPackageRemeasurementBuildUpQuantitySummary();
            $billBuildUpQuantitySummary->sub_package_post_contract_bill_item_rate_id = $postContractSubPackageBillItemRateId;
            $billBuildUpQuantitySummary->bill_column_setting_id                      = $billColumnSettingId;
            $billBuildUpQuantitySummary->type                                        = $type;
            $billBuildUpQuantitySummary->rounding_type                               = ($billSetting['build_up_quantity_rounding_type']) ? $billSetting['build_up_quantity_rounding_type'] : BillSetting::ROUNDING_TYPE_DISABLED;
            $billBuildUpQuantitySummary->conversion_factor_operator                  = Constants::ARITHMETIC_OPERATOR_ADDITION;

            $billBuildUpQuantitySummary->save(self::getInstance()->getConnection());
        }

        return $billBuildUpQuantitySummary;
    }

    public static function getByBillItemIdAndBillColumnSettingId($postContractSubPackageBillItemRateId, $billColumnSettingId, $type)
    {
        $query = DoctrineQuery::create()
        ->select('s.id')
        ->from('PostContractSubPackageRemeasurementBuildUpQuantitySummary s')
        ->where('s.sub_package_post_contract_bill_item_rate_id = ?', $postContractSubPackageBillItemRateId)
        ->andWhere('s.bill_column_setting_id = ?', $billColumnSettingId)
        ->andWhere('s.type = ?', $type)
        ->limit(1);

        return $query->fetchOne();
    }
}