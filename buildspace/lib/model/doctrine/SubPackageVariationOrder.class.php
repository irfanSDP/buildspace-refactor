<?php

/**
 * SubPackageVariationOrder
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class SubPackageVariationOrder extends BaseSubPackageVariationOrder
{
    public function canAddNewClaim()
    {
        $record = DoctrineQuery::create()->select('c.id')
            ->from('SubPackageVariationOrderClaim c')
            ->where('c.sub_package_variation_order_id = ?',$this->id)
            ->andWhere('c.status = ?', SubPackageVariationOrderClaim::STATUS_PROGRESSING)
            ->limit(1)
            ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
            ->fetchOne();

        return $record ? false : true;
    }

    public function getViewingClaim()
    {
        $record = DoctrineQuery::create()->select('c.*')
            ->from('SubPackageVariationOrderClaim c')
            ->where('c.sub_package_variation_order_id = ?',$this->id)
            ->andWhere('c.is_viewing IS TRUE')
            ->limit(1)
            ->fetchOne();

        return $record;
    }

    public function canEditClaimAmount()
    {
        $record = DoctrineQuery::create()->select('c.id')
            ->from('SubPackageVariationOrderClaim c')
            ->where('c.sub_package_variation_order_id = ?',$this->id)
            ->andWhere('c.status = ?', SubPackageVariationOrderClaim::STATUS_PROGRESSING)
            ->andWhere('c.is_viewing IS TRUE')
            ->limit(1)
            ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
            ->fetchOne();

        return $record ? true : false;
    }

    public function delete(Doctrine_Connection $conn = null)
    {
        $pdo = $this->getTable()->getConnection()->getDbh();

        $stmt = $pdo->prepare("DELETE FROM ".SubPackageVariationOrderBuildUpQuantityItemTable::getInstance()->getTableName()."
        WHERE sub_package_variation_order_item_id IN (SELECT id FROM ".SubPackageVariationOrderItemTable::getInstance()->getTableName()."
        WHERE sub_package_variation_order_id = ".$this->id.")");

        $stmt->execute();

        $stmt = $pdo->prepare("DELETE FROM ".SubPackageVariationOrderBuildUpQuantitySummaryTable::getInstance()->getTableName()."
        WHERE sub_package_variation_order_item_id IN (SELECT id FROM ".SubPackageVariationOrderItemTable::getInstance()->getTableName()."
        WHERE sub_package_variation_order_id = ".$this->id.")");

        $stmt->execute();

        $stmt = $pdo->prepare("DELETE FROM ".SubPackageVariationOrderItemUnitTable::getInstance()->getTableName()."
        WHERE sub_package_variation_order_item_id IN (SELECT id FROM ".SubPackageVariationOrderItemTable::getInstance()->getTableName()."
        WHERE sub_package_variation_order_id = ".$this->id.")");

        $stmt->execute();

        Doctrine_Query::create()
            ->delete('SubPackageVariationOrderItem i')
            ->where('i.sub_package_variation_order_id = ?', $this->id)
            ->execute();

        Doctrine_Query::create()
            ->delete('SubPackageVariationOrderClaim c')
            ->where('c.sub_package_variation_order_id = ?', $this->id)
            ->execute();

        parent::delete($conn);
    }
}
