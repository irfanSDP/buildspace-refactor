<?php

/**
 * StockInInvoiceItem
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class StockInInvoiceItem extends BaseStockInInvoiceItem {

    const QUANTITY = 'quantity';
    const RATES = 'rates';
    const DISCOUNT_PERCENTAGE = 'discount_percentage';
    const TAX_PERCENTAGE = 'tax_percentage';

    public function save(Doctrine_Connection $conn = null)
    {
        $this->total = $this->calculateTotalAmount();

        $discountAmount = $this->calculateDiscountAmount();

        $this->total             = $this->total - $discountAmount;
        $this->total_without_tax = $this->total;

        $this->total = $this->calculateTaxAmount();

        parent::save($conn);
    }

    private function calculateTotalAmount()
    {
        $quantity = number_format((float) $this->quantity, 2, '.', '');
        $rates    = number_format((float) $this->rates, 2, '.', '');

        return StockInInvoiceItemTable::calculateTotalAmount($quantity, $rates);
    }

    private function calculateDiscountAmount()
    {
        if ( empty( $this->discount_percentage ) )
        {
            return 0;
        }

        $percentage = $this->discount_percentage / 100;

        return $this->total * $percentage;
    }

    private function calculateTaxAmount()
    {
        if ( empty( $this->tax_percentage ) )
        {
            return 0;
        }

        $percentage = $this->tax_percentage / 100;

        return $this->total + ( $this->total * $percentage );
    }

    public static function remarksFormatter($description, $remarks, $color = 'blue')
    {
        return "{$description}<br /><span style='color: {$color};'>{$remarks}</span>";
    }

}