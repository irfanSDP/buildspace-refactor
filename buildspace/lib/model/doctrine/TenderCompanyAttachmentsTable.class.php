<?php

/**
 * TenderCompanyAttachmentsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TenderCompanyAttachmentsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TenderCompanyAttachmentsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TenderCompanyAttachments');
    }

    public static function saveAttachment($projectId, $companyId, $filePath, $filename, $extension)
    {
        $record = new TenderCompanyAttachments();
        $record->project_structure_id = $projectId;
        $record->company_id = $companyId;
        $record->filepath = $filePath;
        $record->filename = $filename;
        $record->extension = $extension;

        return $record->save();
    }

    public static function deleteAttachment($recordId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("DELETE FROM " . self::getInstance()->getTableName() . " WHERE id = " . $recordId );

        $stmt->execute();
    }

    public static function getAttachments($projectId, $companyId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT tca.id, tca.filename, tca.filepath, tca.extension, tca.updated_by, tca.updated_at, p.name FROM " . self::getInstance()->getTableName() . " tca
            JOIN " . sfGuardUserTable::getInstance()->getTableName() . " u on u.id = tca.updated_by 
            JOIN " . sfGuardUserProfileTable::getInstance()->getTableName() . " p on p.user_id = u.id 
            WHERE tca.project_structure_id = " . $projectId . "
            AND tca.company_id = " . $companyId . "
            ORDER BY tca.created_at DESC");

        $stmt->execute();

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}