<?php

/**
 * MasterCostDataProjectInformation
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 *  
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MasterCostDataProjectInformation extends BaseMasterCostDataProjectInformation
{
    public function delete(Doctrine_Connection $conn = null)
    {
        parent::delete($conn);
        $this->deleteDescendantsAndSelf();
        $this->recalculateSiblingPriorities();
    }

    protected function recalculateSiblingPriorities()
    {
        $parentClause = "parent_id = {$this->parent_id}";

        if( ! $this->parent_id )
        {
            $parentClause = "parent_id IS NULL";
        }

        Doctrine_Manager::getInstance()->getCurrentConnection()
            ->fetchAssoc("UPDATE {$this->getTable()->getTableName()} SET priority = priority-1 WHERE master_cost_data_id = {$this->master_cost_data_id} AND {$parentClause} AND priority > {$this->priority} AND deleted_at IS NULL");
    }

    protected function deleteDescendantsAndSelf()
    {
        $allIds = MasterCostDataProjectInformationTable::getDescendantIds([$this->id]);

        $allIds[] = $this->id;

        $implodedDescendantId = implode(',', $allIds);

        Doctrine_Manager::getInstance()->getCurrentConnection()
            ->fetchAssoc("UPDATE ".$this->getTable()->getTableName()." SET deleted_at = NOW() WHERE id in ({$implodedDescendantId}) AND deleted_at IS NULL");
    }

    public function inUse()
    {
        return $this->descendantsHaveValues();
    }

    protected function descendantsHaveValues(){

        $allIds = MasterCostDataProjectInformationTable::getDescendantIds([ $this->id ]);

        $allIds[] = $this->id;

        $pdo = MasterCostDataProjectInformationTable::getInstance()->getConnection()->getDbh();

        $implodedMasterItemIds = implode(',', $allIds);

        $statement = "SELECT COUNT(i.id)
        FROM " . CostDataProjectInformationTable::getInstance()->getTableName() . " i
        JOIN " . MasterCostDataProjectInformationTable::getInstance()->getTableName() . " m on m.id = i.master_cost_data_project_information_id
        WHERE m.id in ({$implodedMasterItemIds})
        AND (i.description != '' AND i.description IS NOT NULL)
        AND m.deleted_at IS NULL";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $numberOfUsedItems = $stmt->fetch(PDO::FETCH_COLUMN, 0);

        return $numberOfUsedItems > 0;
    }
}
