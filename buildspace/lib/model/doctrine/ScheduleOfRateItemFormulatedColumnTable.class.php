<?php

/**
 * ScheduleOfRateItemFormulatedColumnTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ScheduleOfRateItemFormulatedColumnTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object ScheduleOfRateItemFormulatedColumnTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('ScheduleOfRateItemFormulatedColumn');
    }

    public static function getFormulatedColumnByItemIdAndColumnName($itemId, $columnName)
    {
        $table = Doctrine_Core::getTable('ScheduleOfRateItem');
        return $table::getFormulatedColumnByRelationIdAndColumnName($itemId, $columnName);
    }

    public static function deleteRecordRelatedToItems($affectedItemIds)
    {
        $affectedFormulatedColumnIds = array();
        $affectedBuildUpRateItemIds  = array();

        $affectedFormulatedColumns = Doctrine_Query::create()
        ->select('id')
        ->from('ScheduleOfRateItemFormulatedColumn')
        ->whereIn('relation_id', $affectedItemIds)
        ->andWhere('deleted_at IS NULL')
        ->execute();

        foreach ( $affectedFormulatedColumns as $affectedFormulatedColumn )
        {
            array_push($affectedFormulatedColumnIds, $affectedFormulatedColumn->id);
        }

        $affectedBuildUpRateItems = Doctrine_Query::create()
        ->select('sorburfc.id, buri.id')
        ->from('ScheduleOfRateBuildUpRateFormulatedColumn sorburfc')
        ->leftJoin('sorburfc.BuildUpRateItem buri')
        ->whereIn('buri.schedule_of_rate_item_id', $affectedItemIds)
        ->andWhere('buri.deleted_at IS NULL')
        ->andWhere('sorburfc.deleted_at IS NULL')
        ->execute();

        foreach ( $affectedBuildUpRateItems as $affectedBuildUpRateItem )
        {
            array_push($affectedBuildUpRateItemIds, $affectedBuildUpRateItem->id);
        }

        if ( count($affectedFormulatedColumnIds) > 0 )
        {
            $q = Doctrine_Query::create()
            ->delete('ScheduleOfRateItemFormulatedColumn')
            ->whereIn('relation_id', $affectedItemIds)
            ->andWhere('deleted_at IS NULL')
            ->execute();

            $q = Doctrine_Query::create()
            ->delete('ScheduleOfRateItemEdge')
            ->whereIn('node_from', $affectedFormulatedColumnIds)
            ->andWhere('deleted_at IS NULL')
            ->execute();

            $q = Doctrine_Query::create()
            ->delete('ScheduleOfRateItemEdge')
            ->whereIn('node_to', $affectedFormulatedColumnIds)
            ->andWhere('deleted_at IS NULL')
            ->execute();
        }

        if ( count($affectedBuildUpRateItemIds) > 0 )
        {
            $q = Doctrine_Query::create()
            ->delete('ScheduleOfRateBuildUpRateFormulatedColumn')
            ->whereIn('id', $affectedBuildUpRateItemIds)
            ->andWhere('deleted_at IS NULL')
            ->execute();

            $q = Doctrine_Query::create()
            ->delete('ScheduleOfRateBuildUpRateEdge')
            ->whereIn('node_from', $affectedBuildUpRateItemIds)
            ->andWhere('deleted_at IS NULL')
            ->execute();

            $q = Doctrine_Query::create()
            ->delete('ScheduleOfRateBuildUpRateEdge')
            ->whereIn('node_to', $affectedBuildUpRateItemIds)
            ->andWhere('deleted_at IS NULL')
            ->execute();
        }

        $q = Doctrine_Query::create()
        ->delete('ScheduleOfRateBuildUpRateSummary')
        ->whereIn('schedule_of_rate_item_id', $affectedItemIds)
        ->andWhere('deleted_at IS NULL')
        ->execute();

        $q = Doctrine_Query::create()
        ->delete('ScheduleOfRateBuildUpRateResource')
        ->whereIn('schedule_of_rate_item_id', $affectedItemIds)
        ->andWhere('deleted_at IS NULL')
        ->execute();

        $q = Doctrine_Query::create()
        ->delete('ScheduleOfRateBuildUpRateItem')
        ->whereIn('schedule_of_rate_item_id', $affectedItemIds)
        ->andWhere('deleted_at IS NULL')
        ->execute();

        $q = Doctrine_Query::create()
        ->delete('ScheduleOfRateItem')
        ->whereIn('id', $affectedItemIds)
        ->andWhere('deleted_at IS NULL')
        ->execute();
    }
}