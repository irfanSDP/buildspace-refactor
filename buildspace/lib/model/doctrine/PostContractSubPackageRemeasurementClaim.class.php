<?php

/**
 * PostContractSubPackageRemeasurementClaim
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class PostContractSubPackageRemeasurementClaim extends BasePostContractSubPackageRemeasurementClaim
{

	public function parentSave(Doctrine_Connection $conn = null)
	{
		parent::save($conn);
	}

	public function save(Doctrine_Connection $conn = null)
	{
		parent::save($conn);

		if ($this->deleted_at == NULL)
		{
			$this->refresh();

			$this->clearBuildUpQuantities();
		}
	}

	public function clearBuildUpQuantities()
	{
		if ( ! $this->has_build_up)
		{
			$type = BillBuildUpQuantityItem::QUANTITY_PER_UNIT_ORIGINAL;

			$query = Doctrine_Query::create()
			->delete('PostContractSubPackageRemeasurementBuildUpQuantitySummary s')
			->where('s.sub_package_post_contract_bill_item_rate_id = ?', $this->sub_package_post_contract_bill_item_rate_id)
			->andWhere('s.bill_column_setting_id = ?', $this->bill_column_setting_id)
			->andWhere('s.type = ?', $type)
			->execute();

			$query = DoctrineQuery::create()
			->delete('PostContractSubPackageRemeasurementBuildUpQuantityItem i')
			->where('i.sub_package_post_contract_bill_item_rate_id = ?', $this->sub_package_post_contract_bill_item_rate_id)
			->andWhere('i.bill_column_setting_id = ?', $this->bill_column_setting_id)
			->andWhere('i.type = ?', $type)
			->execute();
		}
	}

}
