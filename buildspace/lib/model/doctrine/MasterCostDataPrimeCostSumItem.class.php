<?php

/**
 * MasterCostDataPrimeCostSumItem
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 *  
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MasterCostDataPrimeCostSumItem extends BaseMasterCostDataPrimeCostSumItem
{
    public function inUse()
    {
        return $this->hasCostDataValues() || $this->hasCostDataColumnValues() || $this->costDataLinkedToBillItem() || $this->costDataColumnsLinkedToBillItem();
    }

    protected function hasCostDataValues()
    {
        $pdo = MasterCostDataPrimeCostSumItemTable::getInstance()->getConnection()->getDbh();

        $statement = "SELECT COUNT(i.id)
        FROM " . CostDataPrimeCostSumItemTable::getInstance()->getTableName() . " i
        JOIN " . MasterCostDataPrimeCostSumItemTable::getInstance()->getTableName() . " m on m.id = i.master_cost_data_prime_cost_sum_item_id
        WHERE m.id = {$this->id}
        AND (i.approved_cost != 0 OR i.awarded_cost != 0)";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $numberOfUsedItems = $stmt->fetch(PDO::FETCH_COLUMN, 0);

        return $numberOfUsedItems > 0;
    }

    protected function hasCostDataColumnValues()
    {
        $pdo = MasterCostDataPrimeCostSumItemTable::getInstance()->getConnection()->getDbh();

        $statement = "SELECT COUNT(c.id)
            FROM " . CostDataPrimeCostSumColumnTable::getInstance()->getTableName() . " c
            JOIN " . MasterCostDataPrimeCostSumItemTable::getInstance()->getTableName() . " m on m.id = c.master_cost_data_prime_cost_sum_item_id
            WHERE m.id = {$this->id}
            AND c.amount != 0";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $numberOfUsedItems = $stmt->fetch(PDO::FETCH_COLUMN, 0);

        return $numberOfUsedItems > 0;
    }

    protected function costDataLinkedToBillItem()
    {
        $pdo = MasterCostDataPrimeCostSumItemTable::getInstance()->getConnection()->getDbh();

        $statement = "SELECT COUNT(pivot.id)
        FROM " . BillItemCostDataPrimeCostSumItemTable::getInstance()->getTableName() . " pivot
        JOIN " . CostDataPrimeCostSumItemTable::getInstance()->getTableName() . " i on i.id = pivot.cost_data_prime_cost_sum_item_id
        JOIN " . MasterCostDataPrimeCostSumItemTable::getInstance()->getTableName() . " m on m.id = i.master_cost_data_prime_cost_sum_item_id
        WHERE m.id = {$this->id}
        AND m.deleted_at IS NULL";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $numberOfLinks = $stmt->fetch(PDO::FETCH_COLUMN, 0);

        return $numberOfLinks > 0;
    }

    protected function costDataColumnsLinkedToBillItem()
    {
        $pdo = MasterCostDataPrimeCostSumItemTable::getInstance()->getConnection()->getDbh();

        $statement = "SELECT COUNT(pivot.id)
            FROM " . BillItemCostDataPrimeCostSumColumnTable::getInstance()->getTableName() . " pivot
            JOIN " . CostDataPrimeCostSumColumnTable::getInstance()->getTableName() . " c on c.id = pivot.cost_data_prime_cost_sum_column_id
            JOIN " . MasterCostDataPrimeCostSumItemTable::getInstance()->getTableName() . " m on m.id = c.master_cost_data_prime_cost_sum_item_id
            WHERE m.id = {$this->id}";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $numberOfLinks = $stmt->fetch(PDO::FETCH_COLUMN, 0);

        return $numberOfLinks > 0;
    }
}
