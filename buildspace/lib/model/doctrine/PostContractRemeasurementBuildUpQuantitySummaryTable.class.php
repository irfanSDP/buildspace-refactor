<?php

/**
 * PostContractRemeasurementBuildUpQuantitySummaryTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PostContractRemeasurementBuildUpQuantitySummaryTable extends Doctrine_Table
{
	/**
	 * Returns an instance of this class.
	 *
	 * @return object PostContractRemeasurementBuildUpQuantitySummaryTable
	 */
	public static function getInstance()
	{
		return Doctrine_Core::getTable('PostContractRemeasurementBuildUpQuantitySummary');
	}

	public static function createByBillItemIdAndBillColumnSettingId($postContractBillItemRateId, $billColumnSettingId, $type)
	{
		$query = DoctrineQuery::create()->select('s.id')
			->from('PostContractRemeasurementBuildUpQuantitySummary s')
			->where('s.post_contract_bill_item_rate_id = ?', $postContractBillItemRateId)
			->andWhere('s.bill_column_setting_id = ?', $billColumnSettingId)
			->andWhere('s.type = ?', $type)
			->limit(1);

		$billBuildUpQuantitySummary = $query->fetchOne();

		if (!$billBuildUpQuantitySummary)
		{
			//get current Bill rounding Type
			$query = Doctrine_Core::getTable('BillSetting')
				->createQuery('b')
				->leftJoin('b.ProjectStructure p')
				->leftJoin('p.BillColumnSettings c')
				->addWhere('c.id = ?', $billColumnSettingId)
				->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY);

			$billSetting = $query->fetchOne();

			$billBuildUpQuantitySummary                                  = new PostContractRemeasurementBuildUpQuantitySummary();
			$billBuildUpQuantitySummary->post_contract_bill_item_rate_id = $postContractBillItemRateId;
			$billBuildUpQuantitySummary->bill_column_setting_id          = $billColumnSettingId;
			$billBuildUpQuantitySummary->type                            = $type;
			$billBuildUpQuantitySummary->rounding_type                   = ($billSetting['build_up_quantity_rounding_type']) ? $billSetting['build_up_quantity_rounding_type'] : BillSetting::ROUNDING_TYPE_DISABLED;
			$billBuildUpQuantitySummary->conversion_factor_operator      = Constants::ARITHMETIC_OPERATOR_ADDITION;

			$billBuildUpQuantitySummary->save(self::getInstance()->getConnection());
		}

		return $billBuildUpQuantitySummary;
	}

	public static function getByBillItemIdAndBillColumnSettingId($postContractBillItemRateId, $billColumnSettingId, $type)
	{
		$query = DoctrineQuery::create()->select('s.id')
			->from('PostContractRemeasurementBuildUpQuantitySummary s')
			->where('s.post_contract_bill_item_rate_id = ?', $postContractBillItemRateId)
			->andWhere('s.bill_column_setting_id = ?', $billColumnSettingId)
			->andWhere('s.type = ?', $type)
			->limit(1);

		return $query->fetchOne();
	}
}