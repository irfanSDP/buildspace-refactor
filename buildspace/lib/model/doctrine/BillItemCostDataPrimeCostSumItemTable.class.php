<?php

/**
 * BillItemCostDataPrimeCostSumItemTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BillItemCostDataPrimeCostSumItemTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return BillItemCostDataPrimeCostSumItemTable The table instance
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('BillItemCostDataPrimeCostSumItem');
    }

    public static function sync(CostData $costData, MasterCostDataPrimeCostSumItem $masterItem, $selectedBillItemIds, $deselectedBillItemIds)
    {
        self::unlink($costData, $masterItem, $deselectedBillItemIds);

        self::link($costData, $masterItem, $selectedBillItemIds);

        $item = CostDataPrimeCostSumItemTable::getItem($costData, $masterItem);

        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "UPDATE " . CostDataPrimeCostSumItemTable::getInstance()->getTableName() . " i
                SET awarded_cost = :awardedCost
                WHERE i.id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array(
            'awardedCost' => self::getSumOfLinkedBillItems($costData, $masterItem) * $item->conversion_factor,
            'itemId'      => $item['id']
        ));
    }

    protected static function unlink(CostData $costData, MasterCostDataPrimeCostSumItem $masterItem, $deselectedBillItemIds)
    {
        if( count($deselectedBillItemIds) <= 0 ) return;

        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostSumItemTable::getItem($costData, $masterItem);

        $implodedDeselectedItemIds = implode(',', $deselectedBillItemIds);

        if( $item->exists() )
        {
            $statement = "DELETE FROM " . self::getInstance()->getTableName() . " pivot
                WHERE pivot.cost_data_prime_cost_sum_item_id = :itemId
                AND pivot.bill_item_id in ({$implodedDeselectedItemIds})";

            $stmt = $pdo->prepare($statement);

            $stmt->execute(array( 'itemId' => $item['id'] ));
        }
    }

    protected static function link(CostData $costData, MasterCostDataPrimeCostSumItem $masterItem, array $selectedBillItemIds)
    {
        $item = CostDataPrimeCostSumItemTable::getItem($costData, $masterItem);

        if($item->isNew()) $item->save();

        $linkedBillItemIds = array_column(self::getLinkedBillItems($costData, $masterItem), 'bill_item_id');

        $newlySelectedBillItemIds = array_diff($selectedBillItemIds, $linkedBillItemIds);

        foreach($newlySelectedBillItemIds as $billItemId)
        {
            $pivotRecord = new BillItemCostDataPrimeCostSumItem();
            $pivotRecord->bill_item_id = $billItemId;
            $pivotRecord->cost_data_prime_cost_sum_item_id = $item->id;
            $pivotRecord->save();
        }
    }

    public static function getLinkedBillItems(CostData $costData, MasterCostDataPrimeCostSumItem $masterItem)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostSumItemTable::getItem($costData, $masterItem);

        if($item->isNew()) return array();

        $statement = "SELECT i.id as bill_item_id, e.id as element_id, b.id as bill_id, p.id as project_id 
            FROM ".self::getInstance()->getTableName()." pivot
            JOIN " . BillItemTable::getInstance()->getTableName() . " i on i.id = pivot.bill_item_id
            JOIN " . BillElementTable::getInstance()->getTableName() . " e on e.id = i.element_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " b on b.id = e.project_structure_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " p on p.id = b.root_id
            WHERE pivot.cost_data_prime_cost_sum_item_id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'itemId' => $item['id'] ));

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public static function getSumOfLinkedBillItems(CostData $costData, MasterCostDataPrimeCostSumItem $masterItem)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostSumItemTable::getItem($costData, $masterItem);

        $linkedBillItems = self::getLinkedBillItems($costData, $masterItem);

        if($item->isNew() || empty($linkedBillItems)) return 0;

        $linkedBillItemIds = Utilities::arrayValueRecursive('bill_item_id', $linkedBillItems);

        $statement = "SELECT SUM(COALESCE(r.grand_total,0))
        FROM ".self::getInstance()->getTableName()." pivot
        JOIN ".BillItemTable::getInstance()->getTableName()." bi on bi.id = pivot.bill_item_id
        LEFT JOIN " . PostContractBillItemRateTable::getInstance()->getTableName() . " r ON bi.id = r.bill_item_id
        WHERE pivot.cost_data_prime_cost_sum_item_id = :itemId
        AND bi.deleted_at IS NULL;";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'itemId' => $item['id'] ));

        return $stmt->fetch(PDO::FETCH_COLUMN,0);
    }

    public static function flushItemLinks($billItemIds)
    {
        Doctrine_Query::create()
            ->delete('BillItemCostDataPrimeCostSumItem')
            ->whereIn('bill_item_id', $billItemIds)
            ->execute();
    }

    public static function itemValueUpdate(CostData $costData, MasterCostDataPrimeCostSumItem $masterItem)
    {
        $item = CostDataPrimeCostSumItemTable::getItem($costData, $masterItem);

        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "UPDATE " . CostDataPrimeCostSumItemTable::getInstance()->getTableName() . " i
            SET awarded_cost = :awardedCost
            WHERE i.id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array(
            'awardedCost' => self::getSumOfLinkedBillItems($costData, $masterItem) * $item->conversion_factor,
            'itemId'      => $item['id']
        ));
    }
}