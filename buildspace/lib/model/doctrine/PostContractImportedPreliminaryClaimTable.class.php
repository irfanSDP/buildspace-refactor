<?php

/**
 * PostContractImportedPreliminaryClaimTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PostContractImportedPreliminaryClaimTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return PostContractImportedPreliminaryClaimTable The table instance
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('PostContractImportedPreliminaryClaim');
    }

    public static function getImportedBillClaimAmounts($claimRevisionId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT e.project_structure_id as bill_id, ROUND(COALESCE(SUM(ic.up_to_date_amount),0),2) AS imported_up_to_date_amount
            FROM " . self::getInstance()->getTableName() . " ic
            JOIN " . BillItemTable::getInstance()->getTableName() . " i on i.id = ic.bill_item_id
            JOIN " . BillElementTable::getInstance()->getTableName() . " e on e.id = i.element_id
            WHERE ic.revision_id = {$claimRevisionId}
            GROUP BY e.project_structure_id");

        $stmt->execute();

        return $stmt->fetchAll(PDO::FETCH_KEY_PAIR);
    }

    public static function getImportedItemsClaimAmounts($claimRevisionId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT ic.bill_item_id, ROUND(COALESCE(ic.up_to_date_amount,0),2) AS imported_up_to_date_amount
            FROM " . self::getInstance()->getTableName() . " ic
            WHERE ic.revision_id = {$claimRevisionId}");

        $stmt->execute();

        return $stmt->fetchAll(PDO::FETCH_KEY_PAIR);
    }
}