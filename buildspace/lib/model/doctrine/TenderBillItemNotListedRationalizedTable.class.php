<?php

/**
 * TenderBillItemNotListedRationalizedTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TenderBillItemNotListedRationalizedTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TenderBillItemNotListedRationalizedTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TenderBillItemNotListedRationalized');
    }

    public static function flushExistingByProjectId($projectId)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $sql = "SELECT i.id FROM ".BillItemTable::getInstance()->getTableName()." i 
            LEFT JOIN ".BillElementTable::getInstance()->getTableName()." e ON e.id = i.element_id
            LEFT JOIN ".ProjectStructureTable::getInstance()->getTableName()." p ON p.id = e.project_structure_id
            WHERE i.deleted_at IS NULL AND e.deleted_at IS NULL AND i.type = ".BillItem::TYPE_ITEM_NOT_LISTED." 
            AND p.root_id = ".$projectId;

        $stmt = $pdo->prepare($sql);
        $stmt->execute();
        $itemIds = $stmt->fetchAll(PDO::FETCH_COLUMN);

        if(count($itemIds))
        {
            $sql = "DELETE FROM ".TenderBillItemNotListedRationalizedTable::getInstance()->getTableName()." p 
                WHERE p.bill_item_id IN (".implode(',', $itemIds).")";

            $stmt = $pdo->prepare($sql);

            $stmt->execute();
        }
    }
}