<?php

/**
 * EditorBillItemInfo
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class EditorBillItemInfo extends BaseEditorBillItemInfo
{
    public function updateTypeTotalAmount()
    {
        $billColumnSettings = $this->BillItem->Element->ProjectStructure->BillColumnSettings->toArray();

        foreach ( $billColumnSettings as $columnSetting )
        {
            EditorBillItemTypeReferenceTable::updateTypeTotalByBillColumnSettingAndItemId($this->id, $columnSetting);
        }
    }

    public function updateBillItemTotalColumns()
    {
        $pdo = EditorBillItemInfoTable::getInstance()->getConnection()->getDbh();

        $grandTotalQuantityStatement = "SELECT COALESCE(SUM(r.total_quantity), 0)
        FROM " . EditorBillItemTypeReferenceTable::getInstance()->getTableName() . " AS r
        LEFT JOIN " . BillColumnSettingTable::getInstance()->getTableName() . " AS c ON r.bill_column_setting_id = c.id
        WHERE r.bill_item_info_id = " . $this->id . " AND c.deleted_at IS NULL";

        $grandTotalStatement = "SELECT COALESCE(SUM(r.grand_total), 0)
        FROM " . EditorBillItemTypeReferenceTable::getInstance()->getTableName() . " AS r
        LEFT JOIN " . BillColumnSettingTable::getInstance()->getTableName() . " AS c ON r.bill_column_setting_id = c.id
        WHERE r.bill_item_info_id = " . $this->id . " AND c.deleted_at IS NULL";

        //update grand total
        $stmt = $pdo->prepare("UPDATE " . EditorBillItemInfoTable::getInstance()->getTableName() . " SET
            grand_total_quantity = (" . $grandTotalQuantityStatement . "), grand_total = (" . $grandTotalStatement . ")
            WHERE id = " . $this->id);

        $stmt->execute();
    }
}
