<?php

/**
 * BillItemCostDataPrimeCostRateTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BillItemCostDataPrimeCostRateTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return BillItemCostDataPrimeCostRateTable The table instance
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('BillItemCostDataPrimeCostRate');
    }

    public static function sync(CostData $costData, MasterCostDataPrimeCostRate $masterItem, $selectedBillItemIds, $deselectedBillItemIds)
    {
        self::unlink($costData, $masterItem, $deselectedBillItemIds);

        self::link($costData, $masterItem, $selectedBillItemIds);

        self::itemValueUpdate($costData, $masterItem);
    }

    public static function itemValueUpdate(CostData $costData, MasterCostDataPrimeCostRate $masterItem)
    {
        $item = CostDataPrimeCostRateTable::getItem($costData, $masterItem);

        $pdo = self::getInstance()->getConnection()->getDbh();

        $statement = "UPDATE " . CostDataPrimeCostRateTable::getInstance()->getTableName() . " i
            SET awarded_value = :awardedValue
            WHERE i.id = :itemId";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array(
            'awardedValue' => self::getSumOfLinkedBillItems($costData, $masterItem),
            'itemId'      => $item['id']
        ));

        $item->updateRelativesCost(array( CostDataPrimeCostRate::COLUMN_AWARDED_VALUE ));
    }

    protected static function unlink(CostData $costData, MasterCostDataPrimeCostRate $masterItem, $deselectedBillItemIds)
    {
        if( count($deselectedBillItemIds) <= 0 ) return;

        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostRateTable::getItem($costData, $masterItem);

        $questionMarks = '(' . implode(',', array_fill(0, count($deselectedBillItemIds), '?')) . ')';

        if( $item->exists() )
        {
            $statement = "DELETE FROM " . self::getInstance()->getTableName() . " pivot
                WHERE pivot.cost_data_prime_cost_rate_id = {$item->id}
                AND pivot.bill_item_id in {$questionMarks}";

            $stmt = $pdo->prepare($statement);

            $stmt->execute($deselectedBillItemIds);
        }
    }

    protected static function link(CostData $costData, MasterCostDataPrimeCostRate $masterItem, array $selectedBillItemIds)
    {
        $item = CostDataPrimeCostRateTable::getItem($costData, $masterItem);

        if($item->isNew()) $item->save();

        $linkedBillItemIds = array_column(self::getLinkedBillItems($costData, [$masterItem->id])[$masterItem->id], 'bill_item_id');

        $newlySelectedBillItemIds = array_diff($selectedBillItemIds, $linkedBillItemIds);

        foreach($newlySelectedBillItemIds as $billItemId)
        {
            $pivotRecord = new BillItemCostDataPrimeCostRate();
            $pivotRecord->bill_item_id = $billItemId;
            $pivotRecord->cost_data_prime_cost_rate_id = $item->id;
            $pivotRecord->save();
        }
    }

    public static function getDescendantsAndSelfLinkedBillItems(CostData $costData, array $masterItemIds)
    {
        if(empty($masterItemIds)) return array();

        $pdo = self::getInstance()->getConnection()->getDbh();

        $descendantIdsByMasterItemId = array();

        $descendantIds = array();

        foreach($masterItemIds as $masterItemId)
        {
            $descendantIdsByMasterItemId[$masterItemId] = MasterCostDataPrimeCostRateTable::getDescendantIds([$masterItemId]);

            $descendantIdsByMasterItemId[$masterItemId][] = $masterItemId;

            $descendantIds = array_merge($descendantIds, $descendantIdsByMasterItemId[$masterItemId]);
        }

        $statement = "SELECT mi.id as master_cost_data_prime_cost_rate_id, pivot.cost_data_prime_cost_rate_id, i.id as bill_item_id, e.id as element_id, b.id as bill_id, p.id as project_id
            FROM ".self::getInstance()->getTableName()." pivot
            JOIN " . CostDataPrimeCostRateTable::getInstance()->getTableName() . " ci ON ci.id = pivot.cost_data_prime_cost_rate_id
            JOIN " . MasterCostDataPrimeCostRateTable::getInstance()->getTableName() . " mi ON mi.id = ci.master_cost_data_prime_cost_rate_id
            JOIN " . BillItemTable::getInstance()->getTableName() . " i ON i.id = pivot.bill_item_id
            JOIN " . BillElementTable::getInstance()->getTableName() . " e ON e.id = i.element_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " b ON b.id = e.project_structure_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " p ON p.id = b.root_id
            WHERE ci.cost_data_id = {$costData->id}
            AND mi.id IN (" . implode(',', $descendantIds) . ")";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $records = $stmt->fetchAll(PDO::FETCH_ASSOC);

        $data = array();

        foreach($descendantIdsByMasterItemId as $itemId => $descendantIds)
        {
            if(!array_key_exists($itemId, $data)) $data[$itemId] = array();

            foreach($records as $key => $record)
            {
                if(!in_array($record['master_cost_data_prime_cost_rate_id'], $descendantIds)) continue;

                unset($record['master_cost_data_prime_cost_rate_id'], $record['cost_data_prime_cost_rate_id']);

                $data[$itemId][] = $record;

                unset($records[$key]);
            }
        }

        return $data;
    }

    public static function getLinkedBillItems(CostData $costData, array $masterItemIds)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $questionMarks = '(' . implode(',', array_fill(0, count($masterItemIds), '?')) . ')';

        $statement = "SELECT pcr.master_cost_data_prime_cost_rate_id as master_id, i.id as bill_item_id, e.id as element_id, b.id as bill_id, p.id as project_id 
            FROM ".self::getInstance()->getTableName()." pivot
            JOIN " . BillItemTable::getInstance()->getTableName() . " i on i.id = pivot.bill_item_id
            JOIN " . BillElementTable::getInstance()->getTableName() . " e on e.id = i.element_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " b on b.id = e.project_structure_id
            JOIN " . ProjectStructureTable::getInstance()->getTableName() . " p on p.id = b.root_id
            JOIN " . CostDataPrimeCostRateTable::getInstance()->getTableName() . " pcr on pcr.id = pivot.cost_data_prime_cost_rate_id
            WHERE pcr.master_cost_data_prime_cost_rate_id IN {$questionMarks}";

        $stmt = $pdo->prepare($statement);

        $stmt->execute($masterItemIds);

        $results = $stmt->fetchAll(PDO::FETCH_GROUP|PDO::FETCH_ASSOC);

        $data = [];

        foreach($masterItemIds as $masterItemId)
        {
            $data[$masterItemId] = $results[$masterItemId] ?? [];
        }

        return $data;
    }

    public static function getSumOfLinkedBillItems(CostData $costData, MasterCostDataPrimeCostRate $masterItem)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $item = CostDataPrimeCostRateTable::getItem($costData, $masterItem);

        $linkedBillItems = self::getLinkedBillItems($costData, [$masterItem->id])[$masterItem->id];

        if($item->isNew() || empty($linkedBillItems)) return 0;

        $linkedBillItemIds = Utilities::arrayValueRecursive('bill_item_id', $linkedBillItems);

        $statement = "SELECT SUM(COALESCE(r.rate,0))
        FROM ".self::getInstance()->getTableName()." pivot
        JOIN ".BillItemTable::getInstance()->getTableName()." bi on bi.id = pivot.bill_item_id
        LEFT JOIN " . PostContractBillItemRateTable::getInstance()->getTableName() . " r ON bi.id = r.bill_item_id
        LEFT JOIN (
            SELECT i.id, ROUND(SUM(bit.total_quantity), 2) AS total_quantity
            FROM bs_bill_items i
            JOIN " . PostContractBillItemTypeTable::getInstance()->getTableName() . " bit ON bit.bill_item_id = i.id
            WHERE i.id in (" . implode(',', $linkedBillItemIds) . ")
            GROUP BY i.id
            ) qty ON qty.id = bi.id
        WHERE pivot.cost_data_prime_cost_rate_id = :itemId
        AND bi.deleted_at IS NULL;";

        $stmt = $pdo->prepare($statement);

        $stmt->execute(array( 'itemId' => $item['id'] ));

        return $stmt->fetch(PDO::FETCH_COLUMN,0);
    }

    public static function flushItemLinks($billItemIds)
    {
        Doctrine_Query::create()
            ->delete('BillItemCostDataPrimeCostRate')
            ->whereIn('bill_item_id', $billItemIds)
            ->execute();
    }
}