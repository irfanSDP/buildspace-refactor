<?php

/**
 * SubPackageVariationOrderBuildUpQuantityItemTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class SubPackageVariationOrderBuildUpQuantityItemTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object SubPackageVariationOrderBuildUpQuantityItemTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('SubPackageVariationOrderBuildUpQuantityItem');
    }

    public static function getSignTextBySign($sign)
    {
        switch($sign)
        {
            case SubPackageVariationOrderBuildUpQuantityItem::SIGN_POSITIVE:
                return SubPackageVariationOrderBuildUpQuantityItem::SIGN_POSITIVE_TEXT;
            case SubPackageVariationOrderBuildUpQuantityItem::SIGN_NEGATIVE:
                return SubPackageVariationOrderBuildUpQuantityItem::SIGN_NEGATIVE_TEXT;
            default:
                throw new Exception('invalid sign');
        }
    }

    public static function getFormulatedColumnNames(UnitOfMeasurement $unitOfMeasurement)
    {
        $columnNames = array();

        foreach($unitOfMeasurement->Dimensions as $dimension)
        {
            $columnNames[] = $dimension->id.'-dimension_column';
        }

        array_push($columnNames, SubPackageVariationOrderBuildUpQuantityItem::FORMULATED_COLUMN_FACTOR);

        return $columnNames;
    }

    public static function getFormulatedColumnByRelationIdAndColumnName($id, $columnName, $hydrate=null)
    {
        $query = DoctrineQuery::create()->select('*')
            ->from('SubPackageVariationOrderBuildUpQuantityFormulatedColumn c')
            ->where('c.relation_id = ?', $id)
            ->andWhere('c.column_name = ?', $columnName)
            ->limit(1);

        if(!is_null($hydrate))
        {
            $query->setHydrationMode($hydrate);
        }

        return $query->fetchOne();
    }

    public static function getBuildUpItemsByVOItemIds(array $voItemIds)
    {
        $data = array();

        $buildUpItems = DoctrineQuery::create()
        ->select('i.id, i.sub_package_variation_order_item_id, i.type, i.description, i.sign, i.total, ifc.column_name, ifc.value, ifc.final_value')
        ->from('SubPackageVariationOrderBuildUpQuantityItem i')
        ->leftJoin('i.FormulatedColumns ifc')
        ->whereIn('i.sub_package_variation_order_item_id', $voItemIds)
        ->addOrderBy('i.priority ASC')
        ->fetchArray();

        foreach ( $buildUpItems as $buildUpItem )
        {
            $data[$buildUpItem['type']][$buildUpItem['sub_package_variation_order_item_id']][] = $buildUpItem;

            unset($buildUpItem);
        }

        unset($buildUpItems);

        return $data;
    }
}