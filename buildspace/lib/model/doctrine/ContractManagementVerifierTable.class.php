<?php

/**
 * ContractManagementVerifierTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ContractManagementVerifierTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object ContractManagementVerifierTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('ContractManagementVerifier');
    }

    public static function getVerifierList(ProjectStructure $project, $moduleIdentifier)
    {
        return EProjectProjectContractManagementModuleTable::getContractManagementVerifiers($project->MainInformation, $moduleIdentifier);
    }

    public static function initialiseVerifierList(ProjectStructure $project, $moduleIdentifier)
    {
        $userIds = EProjectProjectContractManagementModuleTable::getContractManagementVerifiers($project->MainInformation, $moduleIdentifier);

        if( count($userIds) < 1 ) return false;

        static::flushExistingVerifiers($project, $moduleIdentifier);
        static::assignVerifiers($project, $userIds, $moduleIdentifier);

        return true;
    }

    private static function flushExistingVerifiers(ProjectStructure $project, $moduleIdentifier)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("UPDATE " . self::getInstance()->getTableName() . " set deleted_at = NOW() WHERE project_structure_id = " . $project->id . " AND module_identifier = " . $moduleIdentifier);

        $stmt->execute();
    }

    private static function assignVerifiers(ProjectStructure $project, $userIds, $moduleIdentifier)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $sequence_number = 0;
        foreach($userIds as $userId => $verifierInfo)
        {
            $daysToVerify = $verifierInfo['days_to_verify'];

            if(empty($daysToVerify)) $daysToVerify = 'null';

            $stmt = $pdo->prepare('INSERT INTO '.self::getInstance()->getTableName().' (project_structure_id, module_identifier, user_id, sequence_number, approved, verified_at, days_to_verify) VALUES ('.$project->id.', '.$moduleIdentifier.', '. $userId.', '.(++$sequence_number).', null, null, '.$daysToVerify.') RETURNING id');
            $stmt->execute();
        }

        // Set start_at for next verifier.
        if($nextVerifierRecord = self::getCurrentVerifierRecord($project, $moduleIdentifier))
        {
            $stmt = $pdo->prepare("UPDATE " . self::getInstance()->getTableName() . " set start_at = NOW() where id = {$nextVerifierRecord['id']}");
            $stmt->execute();
        }
    }

    public static function isApproved(ProjectStructure $project, $moduleIdentifier)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT * FROM " . self::getInstance()->getTableName() . " 
            WHERE project_structure_id = " . $project->id . "
            AND module_identifier = " . $moduleIdentifier . "
            AND deleted_at IS NULL 
            AND (approved = false OR approved IS NULL)");
        $stmt->execute();

        $data = $stmt->fetchAll(PDO::FETCH_ASSOC);

        return (count($data) == 0);
    }

    public static function isRejected(ProjectStructure $project, $moduleIdentifier)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT * FROM " . self::getInstance()->getTableName() . " 
            WHERE project_structure_id = " . $project->id . "
            AND module_identifier = " . $moduleIdentifier . "
            AND approved = false
            AND deleted_at IS NULL");
        $stmt->execute();

        $data = $stmt->fetchAll(PDO::FETCH_ASSOC);

        return (count($data) > 0);
    }

    public static function isPending(ProjectStructure $project, $moduleIdentifier)
    {
        if( self::isRejected($project, $moduleIdentifier) ) return false;

        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT * FROM " . self::getInstance()->getTableName() . " 
            WHERE project_structure_id = " . $project->id . "
            AND module_identifier = " . $moduleIdentifier . "
            AND approved IS NULL
            AND deleted_at IS NULL");
        $stmt->execute();

        $data = $stmt->fetchAll(PDO::FETCH_ASSOC);

        return (count($data) > 0);
    }

    public static function getCurrentVerifierRecord(ProjectStructure $project, int $moduleIdentifier)
    {
        if( ! self::isPending($project, $moduleIdentifier) ) return false;

        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("SELECT * FROM " . self::getInstance()->getTableName() . " 
            WHERE project_structure_id = " . $project->id . "
            AND module_identifier = " . $moduleIdentifier . "
            AND approved is NULL
            AND deleted_at IS NULL
            ORDER BY sequence_number ASC
            LIMIT 1");

        $stmt->execute();

        $data = $stmt->fetchAll(PDO::FETCH_ASSOC);

        return $data[0] ?? null;
    }

    public static function isCurrentVerifier($user, ProjectStructure $project, int $moduleIdentifier)
    {
        if( ! $currentVerifierRecord = self::getCurrentVerifierRecord($project, $moduleIdentifier) ) return false;

        return $user->id == $currentVerifierRecord['user_id'];
    }

    public static function approve(ProjectStructure $project, $user, $moduleIdentifier, bool $approve, $remarks)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        $record = DoctrineQuery::create()->select('*')
            ->from('ContractManagementVerifier v')
            ->where('v.project_structure_id = ?', $project->id)
            ->andWhere('v.module_identifier = ?', $moduleIdentifier)
            ->andWhere('v.user_id = ?', $user->id)
            ->andWhere('v.approved is NULL')
            ->andWhere('v.deleted_at is NULL')
            ->limit(1)
            ->fetchOne();

        if( ! ( $record && self::isCurrentVerifier($user, $project, $moduleIdentifier) ) ) return false;

        $record->remarks  = $remarks;
        $record->approved = $approve;
        $record->save();

        $stmt = $pdo->prepare("UPDATE " . self::getInstance()->getTableName() . " set verified_at = NOW() where id = {$record->id}");
        $stmt->execute();

        // Set start_at for next verifier.
        if($approve && $nextVerifierRecord = self::getCurrentVerifierRecord($project, $moduleIdentifier))
        {
            $stmt = $pdo->prepare("UPDATE " . self::getInstance()->getTableName() . " set start_at = NOW() where id = {$nextVerifierRecord['id']}");
            $stmt->execute();
        }

        return true;
    }

    public static function sendNotifications(ProjectStructure $project, $moduleIdentifier)
    {
        $client = new GuzzleHttp\Client(array(
            'verify'   => sfConfig::get('app_guzzle_ssl_verification'),
            'base_uri' => sfConfig::get('app_e_project_url')
        ));

        $eProjectProject = $project->MainInformation->getEProjectProject();

        try
        {
            $res = $client->post("buildspace/notifications/{$eProjectProject->id}/contract-management/{$moduleIdentifier}/review/send");

            $success = json_decode($res->getBody())->success;
        }
        catch(Exception $e)
        {
            throw $e;
        }

        return $success;
    }
}