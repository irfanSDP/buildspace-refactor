<?php

/**
 * MaterialOnSite
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MaterialOnSite extends BaseMaterialOnSite {

	const STATUS_TYPE_THIS_CLAIM = 1;
	const STATUS_TYPE_CLAIMED = 2;

	const STATUS_TYPE_THIS_CLAIM_TEXT = 'This Claim';
	const STATUS_TYPE_CLAIMED_TEXT = 'Claimed';

	public function save(Doctrine_Connection $conn = null)
	{
		$this->calculateTotalAmount();

		parent::save($conn);
	}

	public function delete(Doctrine_Connection $conn = null)
	{
		$affectedItemIds = array();

		foreach ( $this->Items as $item )
		{
			$affectedItemIds[] = $item->id;
		}

		if ( !empty( $affectedItemIds ) )
		{
			Doctrine::getTable('MaterialOnSiteItem')
				->createQuery()
				->delete()
				->where('material_on_site_id = ?', $this->id)
				->andWhereIn('id', $affectedItemIds)
				->execute();
		}

		parent::delete($conn);
	}

	public function updateAmount()
	{
		$this->calculateTotalAmount();

		$this->save();
	}

	public function calculateTotalAmount()
	{
		$this->total                 = MaterialOnSiteTable::calculateTotalFromItem($this);
		$this->total_after_reduction = $this->total;

		if ( !empty( $this->reduction_percentage ) )
		{
			$percentage = $this->reduction_percentage / 100;

			$this->total_after_reduction = $this->total - ( $this->total * $percentage );
		}
	}

}