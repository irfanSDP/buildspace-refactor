<?php

/**
 * ScheduleOfRateBuildUpRateFormulatedColumn
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class ScheduleOfRateBuildUpRateFormulatedColumn extends BaseScheduleOfRateBuildUpRateFormulatedColumn
{
    public function postSave($event)
    {
        if($this->BuildUpRateItem->resource_item_library_id > 0 and $this->deleted_at == NULL)
        {
            $resourceItem = $this->BuildUpRateItem->ResourceItemLibrary;

            if($this->column_name == ScheduleOfRateBuildUpRateItem::FORMULATED_COLUMN_RATE and (!$resourceItem->getFormulatedColumnByName(ResourceItem::FORMULATED_COLUMN_RATE) or $this->value != $resourceItem->getFormulatedColumnByName(ResourceItem::FORMULATED_COLUMN_RATE)->final_value))
            {
                Doctrine_Manager::getInstance()->getCurrentConnection()
                    ->fetchAssoc("UPDATE ".$this->BuildUpRateItem->getTable()->getTableName()." SET
                resource_item_library_id = NULL, resource_trade_library_id = NULL
                WHERE id = ".$this->BuildUpRateItem->id);

                Doctrine_Manager::getInstance()->getCurrentConnection()
                    ->fetchAssoc("UPDATE ".$this->getTable()->getTableName()." SET
                linked = FALSE
                WHERE relation_id = ".$this->BuildUpRateItem->id);
            }
            elseif($this->column_name == ScheduleOfRateBuildUpRateItem::FORMULATED_COLUMN_WASTAGE and (!$resourceItem->getFormulatedColumnByName(ResourceItem::FORMULATED_COLUMN_WASTAGE) or $this->value != $resourceItem->getFormulatedColumnByName(ResourceItem::FORMULATED_COLUMN_WASTAGE)->final_value))
            {
                Doctrine_Manager::getInstance()->getCurrentConnection()
                    ->fetchAssoc("UPDATE ".$this->getTable()->getTableName()." SET
                linked = FALSE
                WHERE id = ".$this->id);
            }
            elseif($this->column_name == ScheduleOfRateBuildUpRateItem::FORMULATED_COLUMN_CONSTANT and (!$resourceItem->getFormulatedColumnByName(ResourceItem::FORMULATED_COLUMN_CONSTANT) or $this->value != $resourceItem->getFormulatedColumnByName(ResourceItem::FORMULATED_COLUMN_CONSTANT)->final_value))
            {
                Doctrine_Manager::getInstance()->getCurrentConnection()
                    ->fetchAssoc("UPDATE ".$this->getTable()->getTableName()." SET
                linked = FALSE
                WHERE id = ".$this->id);
            }
            else
            {
                Doctrine_Manager::getInstance()->getCurrentConnection()
                    ->fetchAssoc("UPDATE ".$this->getTable()->getTableName()." SET
                linked = TRUE
                WHERE id = ".$this->id);
            }
        }

        return parent::postSave($event);
    }
}
