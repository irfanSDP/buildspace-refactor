<?php

/**
 * MasterCostDataParticular
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 *  
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MasterCostDataParticular extends BaseMasterCostDataParticular
{
    public function inUse()
    {
        $pdo = $this->table->getConnection()->getDbh();

        $statement = "SELECT id FROM ".MasterCostDataItemColumnParticularTable::getInstance()->getTableName()." pivot
        WHERE pivot.master_cost_data_particular_id = {$this->id}";

        $stmt = $pdo->prepare($statement);

        $stmt->execute();

        $records =  $stmt->fetchAll(PDO::FETCH_COLUMN,0);

        return count($records) >= 1;
    }

    public function itemUpdate($attribute, $value)
    {
        if( $attribute == 'uom_id' && $value == -1 ) $value = null;

        $this->{$attribute} = $value;
        $this->save();
    }

    public function delete(Doctrine_Connection $conn = null)
    {
        parent::delete($conn);

        $this->recalculateSiblingPriorities();
    }

    protected function recalculateSiblingPriorities()
    {
        Doctrine_Manager::getInstance()->getCurrentConnection()
            ->fetchAssoc("UPDATE {$this->getTable()->getTableName()} SET priority = priority-1 WHERE master_cost_data_id = {$this->master_cost_data_id} AND priority > {$this->priority} AND deleted_at IS NULL");
    }
}
