<?php

/**
 * PurchaseOrderProjectTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PurchaseOrderProjectTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object PurchaseOrderProjectTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('PurchaseOrderProject');
    }

    public static function getLatestPurchaseOrderNoCountByProjectId(ProjectStructure $project)
    {
        $pdo = self::getInstance()->getConnection()->getDbh();

        // will select soft delete row as well in order to generate accurate running number for PO
        $stmt = $pdo->prepare('SELECT COUNT(s.id) FROM '.PurchaseOrderProjectTable::getInstance()->getTableName().' s
        WHERE s.project_structure_id = '.$project->id);

        $stmt->execute();

        $count = $stmt->fetch(PDO::FETCH_COLUMN, 0);

        return $count + 1;
    }

    public static function getAssignedSuppliersByProject(ProjectStructure $project)
    {
        $data = array();
        $pdo  = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare('SELECT DISTINCT c.id, c.name FROM '.self::getInstance()->getTableName().' s
        JOIN '.PurchaseOrderTable::getInstance()->getTableName().' po ON (po.id = s.purchase_order_id AND po.deleted_at IS NULL)
        JOIN '.PurchaseOrderSupplierTable::getInstance()->getTableName().' pos ON (pos.purchase_order_id = po.id AND pos.deleted_at IS NULL)
        JOIN '.CompanyTable::getInstance()->getTableName().' c ON (c.id = pos.company_id AND c.deleted_at IS NULL)
        WHERE s.project_structure_id = '.$project->id.' AND s.deleted_at IS NULL');

        $stmt->execute();

        $companies = $stmt->fetchAll(PDO::FETCH_ASSOC);

        foreach ( $companies as $company )
        {
            $data[] = array(
                'id'   => $company['id'],
                'name' => $company['name'],
            );
        }

        return $data;
    }
}