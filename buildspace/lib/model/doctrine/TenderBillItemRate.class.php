<?php

/**
 * TenderBillItemRate
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class TenderBillItemRate extends BaseTenderBillItemRate
{
    public function save(Doctrine_Connection $conn = null)
    {
        parent::save($conn);

        $bill = $this->BillItem->Element->ProjectStructure;

        $grandTotal = 0;

        foreach($bill->BillColumnSettings as $billColumnSetting)
        {
            $quantityFieldName = $billColumnSetting->use_original_quantity ? BillItemTypeReference::FORMULATED_COLUMN_QTY_PER_UNIT : BillItemTypeReference::FORMULATED_COLUMN_QTY_PER_UNIT_REMEASUREMENT;

            if($type = BillItemTypeReferenceTable::getByItemIdAndColumnId($this->bill_item_id, $billColumnSetting->id, Doctrine_Core::HYDRATE_ARRAY))
            {
                $qtyRecord = BillItemTypeReferenceFormulatedColumnTable::getInstance()->getByRelationIdAndColumnName($type['id'], $quantityFieldName);

                $qty = $qtyRecord->isNew() ? 0 : $qtyRecord->final_value;

                $pricePerType = ($qty * number_format($this->rate, 2, '.', '')) * $billColumnSetting->quantity;

                $grandTotal += $pricePerType;
            }
        }

        $this->grand_total = $grandTotal;

        parent::save($conn);

        TenderBillItemRateLogTable::insertIntoLog($this);

        if(!$tenderElementGrandTotal = TenderBillElementGrandTotalTable::getByTenderCompanyIdAndBillElementId($this->tender_company_id, $this->BillItem->element_id))
        {
            $tenderElementGrandTotal = new TenderBillElementGrandTotal();
            $tenderElementGrandTotal->tender_company_id = $this->tender_company_id;
            $tenderElementGrandTotal->bill_element_id = $this->BillItem->element_id;

            $tenderElementGrandTotal->save($conn);
        }

        $tenderElementGrandTotal->updateGrandTotal();
    }
}
