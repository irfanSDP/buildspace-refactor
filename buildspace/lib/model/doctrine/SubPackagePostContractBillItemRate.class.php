<?php

/**
 * SubPackagePostContractBillItemRate
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class SubPackagePostContractBillItemRate extends BaseSubPackagePostContractBillItemRate
{
    const PRELIM_RATE_COLUMN_NAME                   = 'rate';

    const PRELIM_INITIAL_CLAIM_COLUMN_NAME          = 'initial';
    const PRELIM_RECURRING_CLAIM_COLUMN_NAME        = 'recurring';
    const PRELIM_TIMEBASED_CLAIM_COLUMN_NAME        = 'timeBased';
    const PRELIM_WORKBASED_CLAIM_COLUMN_NAME        = 'workbased';
    const PRELIM_FINAL_CLAIM_COLUMN_NAME            = 'final';

    const PRELIM_CLAIM_PERCENTAGE_FIELD_EXT_NAME    = 'percentage';
    const PRELIM_CLAIM_AMOUNT_FIELD_EXT_NAME        = 'amount';

    public function save(Doctrine_Connection $conn = null)
    {
        parent::save();

        // get item's recurring total
        $recurringTotal = $this->BillItem->single_unit_grand_total;

        // run it when updating item's rate
        $claimColumns = array('SubPackagePreliminariesInitialClaim', 'SubPackagePreliminariesFinalClaim');

        foreach ( $claimColumns as $claimColumn )
        {
            if ( $claimRecord = Doctrine_Core::getTable($claimColumn)->findOneBy('sub_package_post_contract_bill_item_rate_id', $this->id) )
            {
                $claimAmount = ($recurringTotal == 0) ? 0 : ($claimRecord->percentage / 100) * $recurringTotal;

                $claimRecord->amount = $claimAmount;
                $claimRecord->save();
            }
        }
    }
}
