<?php

/**
 * EditorBillItemTypeReference
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 *
 * @package    buildspace
 * @subpackage model
 * @author     1337 developers
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class EditorBillItemTypeReference extends BaseEditorBillItemTypeReference
{
    public function save(Doctrine_Connection $conn = null)
    {
        $this->total_quantity = $this->quantity_per_unit * $this->BillColumnSetting->quantity;

        parent::save($conn);

        $this->refresh();

        $billItemTypeRef = DoctrineQuery::create()
            ->select('t.id')
            ->from('BillItemTypeReference t')
            ->where('t.bill_column_setting_id = ? AND t.bill_item_id = ?', [$this->bill_column_setting_id, $this->EditorBillItemInfo->bill_item_id])
            ->fetchOne();

        if(empty($billItemTypeRef))
        {
            $billItemTypeRef = new BillItemTypeReference();
            $billItemTypeRef->bill_item_id = $this->EditorBillItemInfo->bill_item_id;
            $billItemTypeRef->bill_column_setting_id = $this->bill_column_setting_id;
            $billItemTypeRef->save($conn);
        }

        EditorBillItemTypeReferenceTable::updateTypeTotalByBillColumnSettingAndItemId($this->bill_item_info_id, $this->BillColumnSetting->toArray());
    }
}
