<?php

/**
 * SupplyOfMaterialElementTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class SupplyOfMaterialElementTable extends Doctrine_Table
{

    /**
     * Returns an instance of this class.
     *
     * @return object SupplyOfMaterialElementTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('SupplyOfMaterialElement');
    }

    public static function getTotalRateByElementId($elementId)
    {
        $result = DoctrineQuery::create()->select('SUM(COALESCE(i.estimated_qty) * COALESCE(i.difference)) AS total')
            ->from('SupplyOfMaterialItem i')
            ->where('i.element_id = ?', $elementId)
            ->andWhere('i.type = ?', SupplyOfMaterialItem::TYPE_WORK_ITEM)
            ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
            ->fetchOne();

        return $result['total'];
    }

    public static function getMaxPriorityByBillId($billId)
    {
        $queryResult = DoctrineQuery::create()->select('max(e.priority)')
            ->from('SupplyOfMaterialElement e')
            ->where('e.project_structure_id = ?', $billId)
            ->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY)
            ->fetchOne();

        return $queryResult['max'];
    }

    /**
     * Returns the affected bills and items.
     * (Selected by user using elementId).
     *
     * @param ProjectStructure $bill
     * @param                  $elementIds
     *
     * @return array
     */
    public static function getAffectedBillsAndItemsByElementId(ProjectStructure $bill, $elementIds)
    {
        $data = array();
        $pdo = self::getInstance()->getConnection()->getDbh();
        $elementIds = json_decode($elementIds, true);

        if( count($elementIds) == 0 )
        {
            return $data;
        }

        $stmt = $pdo->prepare("
            SELECT i.id, i.element_id
            FROM " . SupplyOfMaterialItemTable::getInstance()->getTableName() . " i
            WHERE i.element_id IN (" . implode(',', $elementIds) . ")
            AND i.deleted_at IS NULL
            ");

        $stmt->execute();

        $items = $stmt->fetchAll(PDO::FETCH_ASSOC);

        if( count($items) == 0 )
        {
            return $data;
        }

        foreach($items as $item)
        {
            $data[ $bill->id ][ $item['element_id'] ][] = $item['id'];
        }

        return $data;
    }

    /**
     * Returns the affected bills and elements.
     * (Selected by user using itemIds).
     *
     * @param $itemIds
     *
     * @return array
     */
    public static function getAffectedBillsAndElementsByItemIds($itemIds)
    {
        $itemIds = json_decode($itemIds, true);
        $elementIds = array();
        $data = array();

        if( count($itemIds) == 0 )
        {
            return $data;
        }

        $pdo = self::getInstance()->getConnection()->getDbh();

        $stmt = $pdo->prepare("
            SELECT DISTINCT i.element_id
            FROM " . SupplyOfMaterialItemTable::getInstance()->getTableName() . " i
            WHERE i.id IN (" . implode(',', $itemIds) . ")
            AND i.deleted_at IS NULL
            ");

        $stmt->execute();

        $elements = $stmt->fetchAll(PDO::FETCH_ASSOC);

        if( count($elements) == 0 )
        {
            return $data;
        }

        foreach($elements as $element)
        {
            $elementIds[] = $element['element_id'];

            unset( $element );
        }

        unset( $elements );

        $stmt = $pdo->prepare("
            SELECT DISTINCT e.project_structure_id, e.id as element_id
            FROM " . SupplyOfMaterialElementTable::getInstance()->getTableName() . " e
            WHERE e.id IN (" . implode(',', $elementIds) . ")
            AND e.deleted_at IS NULL
            ");

        $stmt->execute();

        $bills = $stmt->fetchAll(PDO::FETCH_ASSOC);

        foreach($bills as $bill)
        {
            $data[ $bill['project_structure_id'] ][ $bill['element_id'] ] = null;
        }

        return $data;
    }
}