<?php

/**
 * TenderBillElementRationalizedGrandTotalTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TenderBillElementRationalizedGrandTotalTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TenderBillElementRationalizedGrandTotalTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TenderBillElementRationalizedGrandTotal');
    }

    public static function flushExistingRatesByProjectId( $projectId )
    {
        $pdo = ProjectStructureTable::getInstance()->getConnection()->getDbh();

        $sql = "SELECT e.id FROM ".BillElementTable::getInstance()->getTableName()." e
        LEFT JOIN ".ProjectStructureTable::getInstance()->getTableName()." p ON e.project_structure_id = p.id AND p.deleted_at IS NULL
        WHERE p.root_id = :project_id AND e.deleted_at IS NULL";

        $stmt = $pdo->prepare($sql);

        $stmt->execute(array(
            'project_id' => $projectId
        ));

        $billElementIds = $stmt->fetchAll(PDO::FETCH_COLUMN);

        if(count($billElementIds))
        {
            $sql = "DELETE FROM ".TenderBillElementRationalizedGrandTotalTable::getInstance()->getTableName()." i WHERE i.bill_element_id IN (".implode(',', $billElementIds).")";

            $stmt = $pdo->prepare($sql);

            $stmt->execute();
        }
    }
}