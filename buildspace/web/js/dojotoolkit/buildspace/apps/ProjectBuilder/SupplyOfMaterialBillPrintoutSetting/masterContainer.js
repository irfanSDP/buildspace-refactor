// Generated by CoffeeScript 1.9.0
(function() {
  define(['dojo/_base/declare', 'dijit/layout/BorderContainer', 'dijit/layout/TabContainer', 'dijit/Toolbar', 'dijit/form/Button', 'dojo/request', 'dojo/dom', 'dojo/dom-attr', 'dojo/_base/lang', 'dojo/i18n!buildspace/nls/PrintLayoutSetting'], function(declare, BorderContainer, TabContainer, Toolbar, Button, request, dom, domAttr, lang, nls) {
    return declare('buildspace.apps.ProjectBuilder.SupplyOfMaterialBillPrintoutSetting', BorderContainer, {
      somBillLayoutSettingId: 1,
      region: 'center',
      saveURL: 'supplyOfMaterial/saveBillPrintOutSettings',
      style: 'padding:0px;margin:0px;outline:none!important;height:100%;width:100%;',
      gutters: false,
      postCreate: function() {
        var layoutSettings;
        layoutSettings = this.layoutSettings = this.getSettings();
        return this.addChild(this.renderTabs(layoutSettings));
      },
      renderTabs: function(layoutSettings) {
        var borderContainer, counter, form, selected, self, setting, settings, tc, toolBar, type;
        counter = 0;
        self = this;
        form = [];
        borderContainer = [];
        settings = {
          headStyling: {
            title: nls.headStyling,
            nameSpace: 'HeadStylingFormatForm',
            dataName: 'headSettings',
            id: "headSettings-" + this.somBillLayoutSettingId
          },
          fontNumber: {
            title: nls.fontNumFormat,
            nameSpace: 'FontNumberFormatForm',
            dataName: 'layoutSetting',
            id: "fontNumber-" + this.somBillLayoutSettingId
          },
          pageFormat: {
            title: nls.pageFormat,
            nameSpace: 'PageFormatForm',
            dataName: 'layoutSetting',
            id: "pageFormat-" + this.somBillLayoutSettingId
          },
          standardPhrase: {
            title: nls.standardPhrases,
            nameSpace: 'StandardPhrasesForm',
            dataName: 'phrase',
            id: "standardPhrases-" + this.somBillLayoutSettingId
          },
          headerFooter: {
            title: nls.headerFooter,
            nameSpace: 'HeaderFooterForm',
            dataName: 'phrase',
            id: "headerFooter-" + this.somBillLayoutSettingId
          }
        };
        tc = new TabContainer({
          style: "padding:0px;margin:0px;outline:none!important;width:100%;height:100%;left:0px!important;",
          region: "center",
          nested: true
        });
        for (type in settings) {
          setting = settings[type];
          selected = counter === 0 ? true : false;
          borderContainer[counter] = new BorderContainer({
            id: setting.id,
            title: setting.title,
            style: 'padding:0px;margin:0px;outline:none!important;height:100%;width:100%;',
            gutters: false,
            selected: selected
          });
          form[counter] = new buildspace.apps.ProjectBuilder.SupplyOfMaterialBillPrintoutSetting[setting.nameSpace]({
            somBillLayoutSettingId: self.somBillLayoutSettingId,
            data: layoutSettings[setting.dataName],
            region: "center",
            style: "overflow:auto;"
          });
          toolBar = new Toolbar({
            region: 'top',
            style: "outline:none!important;margin:0px;padding:2px;overflow:hidden;"
          });
          toolBar.addChild(new Button({
            label: nls.save,
            iconClass: "icon-16-container icon-16-save",
            formCounter: counter,
            nameSpace: setting.nameSpace,
            onClick: function() {
              var postContent;
              postContent = form[this.formCounter].validateForm();
              if (postContent) {
                return self.postForm(postContent);
              } else {
                return new buildspace.dialog.dijitDialog({
                  title: nls.errorDialogTitle,
                  content: nls.validationMsg,
                  style: "width: 340px;"
                });
              }
            }
          }));
          borderContainer[counter].addChild(toolBar);
          borderContainer[counter].addChild(form[counter]);
          tc.addChild(borderContainer[counter]);
          counter++;
        }
        return tc;
      },
      getSettings: function() {
        var layoutSettings;
        layoutSettings = void 0;
        request.get("supplyOfMaterial/getBillPrintOutSettings/id/" + this.somBillLayoutSettingId, {
          sync: true,
          handleAs: 'json',
          preventCache: true
        }).then(function(response) {
          return layoutSettings = response;
        }, function(error) {
          return console.log(error);
        });
        return layoutSettings;
      },
      postForm: function(postContent) {
        var heads, pb, self;
        self = this;
        heads = [];
        pb = new buildspace.dialog.indeterminateProgressBar({
          title: 'Processing...'
        });
        lang.mixin(postContent, {
          '_csrf_token': self.layoutSettings._csrf_token
        });
        pb.show();
        return request.post(this.saveURL, {
          data: postContent,
          handleAs: 'json'
        }).then(function(response) {
          pb.hide();
          if (response.success) {
            return heads = response.heads;
          } else {
            return new buildspace.dialog.dijitDialog({
              title: nls.errorDialogTitle,
              content: response.error,
              style: "width: 340px;"
            });
          }
        }, function(error) {
          pb.hide();
          return new buildspace.dialog.dijitDialog({
            title: nls.errorDialogTitle,
            content: nls.serverErrorMsg,
            style: "width: 340px;"
          });
        });
      },
      updateFormNewIdValue: function(heads, type) {
        var id, idName, key, target, _results;
        idName = type === 'ReserveWordForm' ? 'word[id]' : 'content[id]';
        if (heads != null) {
          _results = [];
          for (key in heads) {
            id = heads[key];
            target = dom.byId(idName + "[" + key + "]");
            _results.push(domAttr.set(target, 'value', id));
          }
          return _results;
        }
      }
    });
  });

}).call(this);
