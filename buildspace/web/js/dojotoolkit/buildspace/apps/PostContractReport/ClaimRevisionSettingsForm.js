// Generated by CoffeeScript 1.6.3
(function() {
  var __hasProp = {}.hasOwnProperty;

  define("buildspace/apps/PostContractReport/ClaimRevisionSettingsForm", ["dojo/_base/declare", "dojo/html", "dojo/dom", "dojo/dom-construct", "dojo/keys", "dojo/request", "dojo/dom-style", "dojo/dom-attr", "dojo/dom-geometry", "dojo/_base/lang", "dijit/form/Form", "dijit/form/RadioButton", "dijit/form/Select", "dijit/form/ValidationTextBox", "dijit/form/NumberTextBox", "dijit/form/CurrencyTextBox", "dojo/number", "dijit/_WidgetBase", "dijit/_OnDijitClickMixin", "dijit/_TemplatedMixin", "dijit/_WidgetsInTemplateMixin", "dojo/on", "dojo/text!./templates/claimRevisionSettingsForm.html", "dojo/text!./templates/claimRevisionSettingsRow.html", "dojo/i18n!buildspace/nls/PostContract"], function(declare, html, dom, domConstruct, keys, request, domStyle, domAttr, domGeo, lang, Form, RadioButton, Select, ValidateTextBox, NumberTextBox, CurrencyTextBox, number, _WidgetBase, _OnDijitClickMixin, _TemplatedMixin, _WidgetsInTemplateMixin, bindOn, claimRevisionSettingsTemplate, claimRevisionSettingRowTemplate, nls) {
    var ClaimRevisionSettingRowForm, ClaimRevisionSettingsForm, maxRevision;
    maxRevision = buildspace.constants.MAX_CLAIM_REVISIONS;
    ClaimRevisionSettingRowForm = declare("buildspace.apps.PostContractReport.ClaimRevisionSettingRowForm", [_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {
      isNew: false,
      projectId: -1,
      revisionId: -1,
      postContractId: -1,
      region: "center",
      nls: nls,
      rootProject: null,
      revisionData: null,
      ClaimRevisionSettingsForm: null,
      _csrf_token: 0,
      constructor: function(args) {
        return args.templateString = claimRevisionSettingRowTemplate;
      },
      postCreate: function() {
        var self;
        this.inherited(arguments);
        self = this;

        this.setSelectedCurrentSelectedRevision();
        this.exitEditMode();
        this.updateRevisionStatusDescription(this.revisionData.locked_status);
        this.lockedStatusValue.set('value', this.revisionData.locked_status);

        return bindOn(this.showRevisionSelectedLink, 'click', function(e) {
          return self.assignNewSelectedRevision();
        });
      },
      assignNewSelectedRevision: function() {
        var pb, postContent, self;
        self = this;
        pb = new buildspace.dialog.indeterminateProgressBar({
          title: 'Processing...'
        });
        pb.show();
        postContent = {
          'post_contract_id': this.revisionData.post_contract_id,
          'revisionId': this.revisionId,
          'post_contract_claim_revision[post_contract_id]': this.revisionData.post_contract_id,
          'post_contract_claim_revision[current_selected_revision]': true,
          'post_contract_claim_revision[_csrf_token]': this._csrf_token
        };
        return request.post('postContract/assignNewSelectedRevision', {
          data: postContent,
          handleAs: 'json',
          preventCache: true
        }).then(function(response) {
          self.ClaimRevisionSettingsForm.revisionDatas = response;
          pb.hide();
          return self.ClaimRevisionSettingsForm.clearOldRevisionAndAddNewRevision();
        }, function(error) {
          console.log(error);
          return pb.hide();
        });
      },
      setSelectedCurrentSelectedRevision: function() {
        if (this.revisionData.selected) {
          domStyle.set(this.showRevisionSelectedMarker, "display", "block");

          var container = dijit.byId(this.rootProject.id[0]+'-ProjectRevision');
          container.set('title', nls.claimRevision + '::' +nls.version + ' ' + this.revisionData.version);

          return domStyle.set(this.showRevisionSelectedLink, "display", "none");
        } else {
          domStyle.set(this.showRevisionSelectedMarker, "display", "none");
          return domStyle.set(this.showRevisionSelectedLink, "display", "block");
        }
      },
      setupEditMode: function() {
        domStyle.set(this.addendumStatusInput, "display", "");
        domStyle.set(this.addendumStatusView, "display", "none");
      },
      exitEditMode: function() {
        domStyle.set(this.addendumStatusInput, "display", "none");
        domStyle.set(this.addendumStatusView, "display", "");
      },
      updateRevisionStatusDescription: function(revisionStatus) {
        var statusLabel;
        statusLabel = revisionStatus ? nls.addendumLocked : nls.addendumProgressing;
        html.set(this.addendumStatusView, statusLabel);
      }
    });
    ClaimRevisionSettingsForm = declare("buildspace.apps.PostContractReport.ClaimRevisionSettingsForm", [_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {
      projectId: -1,
      baseClass: "buildspace-form",
      style: "padding:5px;overflow:auto;border:0px;",
      region: "center",
      rootProject: null,
      nls: nls,
      workarea: null,
      revisionDatas: null,
      postContractId: null,
      _csrf_token: 0,
      tableCount: 1,
      rowArray: [],
      constructor: function(args) {
        return args.templateString = claimRevisionSettingsTemplate;
      },
      postMixInProperties: function() {
        this.inherited(arguments);
        return this.rowArray[this.projectId] = [];
      },
      postCreate: function() {
        this.inherited(arguments);
        return this.masterGenerateClaimRevisionTableRow();
      },
      masterGenerateClaimRevisionTableRow: function() {
        var pb, xhrArgs,
          _this = this;
        pb = buildspace.dialog.indeterminateProgressBar({
          title: nls.pleaseWait + "..."
        });
        pb.show();
        xhrArgs = {
          url: "postContract/getClaimRevisionLists",
          handleAs: "json",
          content: {
            id: this.projectId
          },
          load: function(data) {
            _this.revisionDatas = data;
            _this.populateClaimRevisionTableRow();
            _this.postContractId = data.postContractId;
            return pb.hide();
          },
          error: function(error) {
            return pb.hide();
          }
        };
        return dojo.xhrGet(xhrArgs);
      },
      clearOldRevisionAndAddNewRevision: function() {
        var self;
        self = this;
        self.rowArray[self.projectId] = [];
        self.tableCount = 1;
        dojo.empty(self.tableContainer);
        self.populateClaimRevisionTableRow();
        return lang.hitch(self, 'closeElementItemGrid')();
      },
      populateClaimRevisionTableRow: function() {
        var form, key, largeString, lastRowStatusValue, self, value, _ref;
        self = this;
        lastRowStatusValue = null;
        largeString = "";
        this._csrf_token = this.revisionDatas.form.csrf_token;
        _ref = this.revisionDatas.claimRevisions;
        for (key in _ref) {
          if (!__hasProp.call(_ref, key)) continue;
          value = _ref[key];
          form = this.rowArray[this.projectId][key] = new ClaimRevisionSettingRowForm({
            count: this.tableCount,
            rootProject: this.rootProject,
            projectId: this.projectId,
            revisionId: value.id,
            postContractId: value.post_contract_id,
            revisionData: value,
            ClaimRevisionSettingsForm: this,
            _csrf_token: this.revisionDatas.form.csrf_token
          });
          lastRowStatusValue = value.locked_status;
          this.addTableRow(form);
        }
      },
      addTableRow: function(form) {
        domConstruct.place(form.domNode, this.tableContainer);
        return this.tableCount++;
      },
      closeElementItemGrid: function() {
        return lang.hitch(this.workarea, 'removeBillTab')();
      }
    });
    return ClaimRevisionSettingsForm;
  });

}).call(this);
