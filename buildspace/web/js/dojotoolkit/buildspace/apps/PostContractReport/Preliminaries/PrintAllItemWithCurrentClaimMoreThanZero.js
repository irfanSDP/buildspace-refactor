// Generated by CoffeeScript 1.9.0
(function() {
  define("buildspace/apps/PostContractReport/Preliminaries/PrintAllItemWithCurrentClaimMoreThanZero", ["dojo/_base/declare", "dojo/aspect", "dojo/_base/lang", "dojo/_base/connect", "dojo/when", "dojo/html", "dojo/dom", "dojo/keys", "dojo/dom-style", "dojo/request", "dojo/json", "dojo/number", "dojo/currency", "./PrintPreviewFormDialog", "buildspace/widget/grid/cells/Formatter", 'dojo/i18n!buildspace/nls/PostContract'], function(declare, aspect, lang, connect, when_, html, dom, keys, domStyle, request, JSON, number, currency, PrintPreviewFormDialog, Formatter, nls) {
    var Dialog, reportingFormatter, selectedItemGrid, selectedItemGridContainer;
    reportingFormatter = declare("buildspace.apps.PostContractReport.Preliminaries.PreviewItemGridFormatter", null, {
      formulaPrelimCurrencyCellFormatter: function(cellValue, rowIdx, cell) {
        var fieldName, item, val, value;
        item = this.grid.getItem(rowIdx);
        value = number.parse(cellValue);
        val = "&nbsp;";
        fieldName = cell.field.split("-");
        if (isNaN(value) || value === 0 || (value == null)) {
          val = "&nbsp;";
        } else {
          val = currency.format(value);
        }
        if (item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER || item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N || item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID) {
          cell.customClasses.push("disable-cell");
          val = "&nbsp;";
        } else {
          if (fieldName && (fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_RECURRING || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_TIMEBASED || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_WORKBASED)) {
            cell.customClasses.push("recurring-cell");
          }
        }
        return val;
      },
      prelimPercentFormatter: function(cellValue, rowIdx, cell) {
        var fieldName, formattedValue, item, val;
        item = this.grid.getItem(rowIdx);
        fieldName = cell.fieldName;
        if (item && item.grand_total && item.grand_total[0] === 0) {
          cellValue = "&nbsp;";
        } else if (isNaN(cellValue) || parseFloat(cellValue) === 0) {
          cellValue = "&nbsp;";
        } else {
          formattedValue = number.format(cellValue, {
            places: 2
          }) + "%";
          if (cell.fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_TIMEBASED || cell.fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_WORKBASED) {
            cellValue = (cellValue > 0 ? "<span style=\"color:blue;\">" + formattedValue + "</span>" : "<span style=\"color:#FF0000\">" + formattedValue + "</span>");
          } else {
            cellValue = (cellValue > 0 ? "<span>" + formattedValue + "</span>" : "<span style=\"color:#FF0000\">" + formattedValue + "</span>");
          }
        }
        if (item.type[0] < 1) {
          cell.customClasses.push('invalidTypeItemCell');
        } else if (item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER || item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N || item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID) {
          cell.customClasses.push("disable-cell");
          val = "&nbsp;";
        } else if (fieldName && (fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_RECURRING || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_TIMEBASED || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_WORKBASED)) {
          cell.customClasses.push("recurring-cell");
        } else {
          if (fieldName && (fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_PREVIOUSCLAIM || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_CURRENTCLAIM || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_UPTODATECLAIM)) {
            cell.customClasses.push("disable-cell");
          }
        }
        if (item.type[0] < 1) {
          cell.customClasses.push('invalidTypeItemCell');
        }
        return cellValue;
      },
      prelimAmountFormatter: function(cellValue, rowIdx, cell) {
        var fieldName, formatterValue, item, val, value;
        item = this.grid.getItem(rowIdx);
        value = number.parse(cellValue);
        val = "&nbsp;";
        fieldName = cell.fieldName;
        formatterValue = void 0;
        if (isNaN(value) || value === 0 || (value == null)) {
          formatterValue = "&nbsp;";
        } else {
          formatterValue = currency.format(value);
          if (cell.fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_TIMEBASED || cell.fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_WORKBASED) {
            formatterValue = (value > 0 ? "<span style=\"color:blue;\">" + formatterValue + "</span>" : "<span style=\"color:#FF0000\">" + formatterValue + "</span>");
          } else {
            formatterValue = (value > 0 ? "<span>" + formatterValue + "</span>" : "<span style=\"color:#FF0000\">" + formatterValue + "</span>");
          }
        }
        if (item.type[0] < 1) {
          cell.customClasses.push('invalidTypeItemCell');
        } else if (item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER || item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N || item.type === buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID) {
          cell.customClasses.push("disable-cell");
          val = "&nbsp;";
        } else if (fieldName && (fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_RECURRING || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_TIMEBASED || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_WORKBASED)) {
          cell.customClasses.push("recurring-cell");
        } else {
          if (fieldName && (fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_PREVIOUSCLAIM || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_CURRENTCLAIM || fieldName === buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_UPTODATECLAIM)) {
            cell.customClasses.push("disable-cell");
          }
        }
        return formatterValue;
      }
    });
    selectedItemGrid = declare("buildspace.apps.PostContractReport.Preliminaries.SelectedItemGrid", dojox.grid.EnhancedGrid, {
      style: "border-top:none;",
      region: "center",
      escapeHTMLInData: false,
      canSort: function() {
        return false;
      },
      onStyleRow: function(e) {
        var childElement, elemToHide;
        this.inherited(arguments);
        if (e.node.children[0]) {
          if (e.node.children[0].children[0].rows.length >= 2) {
            elemToHide = e.node.children[0].children[0].rows[1];
            childElement = e.node.children[0].children[0].rows[0].children;
            elemToHide.parentNode.removeChild(elemToHide);
            return dojo.forEach(childElement, function(child, i) {
              var rowSpan;
              rowSpan = dojo.attr(child, "rowSpan");
              if (!rowSpan || rowSpan < 2) {
                return dojo.attr(child, "rowSpan", 2);
              }
            });
          }
        }
      }
    });
    selectedItemGridContainer = declare("buildspace.apps.PostContractReport.Preliminaries.SelectedItemGridContainer", dijit.layout.BorderContainer, {
      style: "padding:0px;width:100%;height:100%;",
      region: "center",
      gutters: false,
      dialog: null,
      store: null,
      structure: null,
      billId: -1,
      postCreate: function() {
        var grid, self, toolbar;
        self = this;
        self.inherited(arguments);
        grid = this.grid = new selectedItemGrid({
          store: self.store,
          structure: self.structure
        });
        toolbar = new dijit.Toolbar({
          region: "top",
          style: "padding:2px;border-bottom:none;width:100%;"
        });
        toolbar.addChild(new dijit.form.Button({
          label: nls.print,
          iconClass: "icon-16-container icon-16-print",
          onClick: function() {
            return self.openPrintingDialog();
          }
        }));
        toolbar.addChild(new dijit.ToolbarSeparator());
        toolbar.addChild(new dijit.form.Button({
          label: nls.close,
          iconClass: "icon-16-container icon-16-close",
          onClick: function() {
            return self.dialog.hide();
          }
        }));
        self.addChild(toolbar);
        return self.addChild(new dijit.layout.ContentPane({
          style: 'width:100%',
          content: grid,
          region: 'center'
        }));
      },
      openPrintingDialog: function(self) {
        var pb;
        if (self == null) {
          self = this;
        }
        pb = buildspace.dialog.indeterminateProgressBar({
          title: nls.pleaseWait + "..."
        });
        pb.show();
        return request.get("viewTendererReporting/getPrintingInformation", {
          handleAs: 'json'
        }).then(function(response) {
          var dialog;
          dialog = new PrintPreviewFormDialog({
            title: self.dialog.title,
            printURL: 'printReport/printPostContractPrelimAllItemWithClaimMoreThanZero',
            exportURL: 'exportExcelReport/exportPostContractPrelimAllItemWithClaimMoreThanZero',
            billId: self.billId,
            _csrf_token: response._csrf_token
          });
          pb.hide();
          return dialog.show();
        }, function(error) {
          return pb.hide();
        });
      }
    });
    return Dialog = declare("buildspace.apps.PostContractReport.Preliminaries.GroupProjectAssignmentDialog", dijit.Dialog, {
      style: "padding:0px;margin:0px;",
      project: null,
      companyId: -1,
      billId: -1,
      companyName: null,
      data: null,
      buildRendering: function() {
        var content;
        content = this.createContent();
        content.startup();
        this.content = content;
        return this.inherited(arguments);
      },
      postCreate: function() {
        domStyle.set(this.containerNode, {
          padding: "0px",
          margin: "0px"
        });
        this.closeButtonNode.style.display = "none";
        return this.inherited(arguments);
      },
      _onKey: function(e) {
        var key;
        key = e.keyCode;
        if (key === keys.ESCAPE) {
          return dojo.stopEvent(e);
        }
      },
      onHide: function() {
        return this.destroyRecursive();
      },
      createContent: function(self) {
        var borderContainer, content;
        if (self == null) {
          self = this;
        }
        borderContainer = new dijit.layout.BorderContainer({
          style: "padding:0px;width:1280px;height:600px;",
          gutters: false
        });
        content = new selectedItemGridContainer({
          store: dojo.data.ItemFileWriteStore({
            data: self.data
          }),
          dialog: self,
          structure: self.constructGridStructure(),
          billId: self.billId
        });
        borderContainer.addChild(content);
        return borderContainer;
      },
      constructGridStructure: function(self) {
        var additionalStructures, basicStructure, colCount, formatter, parentCells, prelimFormatter, typeColumns;
        if (self == null) {
          self = this;
        }
        formatter = new Formatter();
        prelimFormatter = new reportingFormatter();
        typeColumns = this.recurringItemGridStructure();
        colCount = 0;
        parentCells = [];
        basicStructure = {
          noscroll: false,
          width: "50",
          cells: [
            [
              {
                name: "No",
                field: "id",
                width: '30px',
                styles: 'text-align: center;',
                formatter: formatter.rowCountCellFormatter,
                rowSpan: 2
              }, {
                name: nls.billReference,
                field: 'bill_ref',
                styles: "text-align:center; color: red;",
                width: '80px',
                noresize: true,
                formatter: formatter.billRefCellFormatter,
                rowSpan: 2
              }, {
                name: nls.description,
                field: 'description',
                width: 'auto',
                formatter: formatter.postContractPrintPreviewTreeCellFormatter,
                noresize: true,
                rowSpan: 2
              }, {
                name: "" + nls.contractAmount,
                field: 'grand_total',
                styles: "text-align:right;color:blue;",
                width: '110px',
                formatter: formatter.unEditableNumberCellFormatter,
                noresize: true,
                rowSpan: 2
              }, {
                name: "" + nls.initialPayment,
                field: 'initial-amount',
                styles: "text-align:right;color:blue;",
                width: '110px',
                formatter: formatter.unEditableNumberCellFormatter,
                noresize: true,
                rowSpan: 2
              }, {
                name: "" + nls.recurringPayment,
                field: 'recurring-amount',
                styles: "text-align:right;color:blue;",
                width: '110px',
                formatter: formatter.unEditableNumberCellFormatter,
                noresize: true,
                rowSpan: 2
              }, {
                name: "" + nls.finalPayment,
                field: 'final-amount',
                styles: "text-align:right;color:blue;",
                width: '110px',
                formatter: formatter.unEditableNumberCellFormatter,
                noresize: true,
                rowSpan: 2
              }
            ]
          ]
        };
        additionalStructures = [
          {
            name: nls.percent,
            field_name: 'percentage',
            width: '60px',
            styles: "text-align:right;",
            formatter: prelimFormatter.prelimPercentFormatter
          }, {
            name: nls.amount,
            field_name: 'amount',
            width: '100px',
            styles: "text-align:right;",
            formatter: prelimFormatter.prelimAmountFormatter
          }
        ];
        dojo.forEach(typeColumns, function(typeColumn) {
          var cellStructure, colspan, field, fieldName, i, _results;
          colspan = additionalStructures.length;
          colCount++;
          parentCells.push({
            name: typeColumn.name,
            styles: "text-align:center;",
            headerClasses: "staticHeader typeHeader" + colCount,
            colSpan: colspan
          });
          field = null;
          i = 0;
          _results = [];
          while (i < additionalStructures.length) {
            fieldName = typeColumn.field_name;
            field = fieldName + "-" + additionalStructures[i].field_name;
            cellStructure = {
              field: field,
              columnType: "prelimClaimColumn",
              fieldName: typeColumn.field_name
            };
            lang.mixin(cellStructure, additionalStructures[i]);
            basicStructure.cells[0].push(cellStructure);
            _results.push(i++);
          }
          return _results;
        });
        basicStructure.cells.push(parentCells);
        return basicStructure;
      },
      recurringItemGridStructure: function() {
        var i, len, obj, recurringFields, typeColumns;
        typeColumns = [];
        recurringFields = [
          {
            name: nls.totalPayment,
            field_name: buildspace.apps.PostContractReport.ProjectStructureConstants.PRELIM_COLUMN_CURRENTCLAIM
          }
        ];
        len = recurringFields.length;
        i = 0;
        while (i < len) {
          obj = {
            name: recurringFields[i].name,
            field_name: recurringFields[i].field_name
          };
          typeColumns.push(obj);
          i++;
        }
        return typeColumns;
      }
    });
  });

}).call(this);
