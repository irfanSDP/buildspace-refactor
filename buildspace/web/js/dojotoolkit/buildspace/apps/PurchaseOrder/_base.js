// Generated by CoffeeScript 1.9.0
(function() {
    define(["dojo/_base/declare", 'dojo/data/ItemFileWriteStore', 'dojo/request', 'dijit/layout/TabContainer', 'dijit/layout/ContentPane', 'dijit/layout/BorderContainer', 'dijit/layout/StackController', 'dijit/layout/StackContainer', 'dijit/Toolbar', 'dijit/form/Button', './grid', './WorkArea', './PurchaseOrderDialog', 'buildspace/widget/grid/cells/Formatter', 'dojo/i18n!../../nls/PurchaseOrder', 'buildspace/widget/grid/Filter'], function(declare, ItemFileWriteStore, request, TabContainer, ContentPane, BorderContainer, StackController, StackContainer, Toolbar, Button, PurchaseOrderGrid, WorkArea, PurchaseOrderDialog, Formatter, nls, FilterToolbar) {
        return declare("buildspace.apps.PurchaseOrder", buildspace.apps._App, {
            init: function(args) {
                var grid, mainContainer, self, store, toolbar;
                self = this;
                self.win = new buildspace.widget.Window({
                    title: nls.appName,
                    height: "300px",
                    width: "450px",
                    showMaximize: false,
                    iconClass: this.iconClass,
                    onClose: dojo.hitch(this, "kill")
                });
                store = new dojo.data.ItemFileWriteStore({
                    url: 'purchaseOrder/getPurchaseOrderListings',
                    clearOnClose: true,
                    urlPreventCache: true
                });
                grid = this.purchaseOrderGrid = new PurchaseOrderGrid({
                    requestForQuotationGridContainer: self,
                    structure: self.getGridLayout(),
                    store: store,
                    onRowDblClick: function(e) {
                        var builder, purchaseOrder;
                        purchaseOrder = this.getItem(e.rowIndex);
                        if (!(purchaseOrder.id[0] > 0)) {
                            return false;
                        }
                        self.kill();
                        self.win = new buildspace.widget.Window({
                            title: buildspace.truncateString("Purchase Order (PO No : " + purchaseOrder.po_no[0] + ")", 150),
                            onClose: dojo.hitch(self, "kill")
                        });
                        builder = new WorkArea({
                            purchaseOrder: purchaseOrder
                        });
                        self.win.addChild(builder);
                        self.win.show();
                        return self.win.startup();
                    }
                });
                toolbar = new Toolbar({
                    region: 'top',
                    style: "outline:none!important;padding:2px;border:none;width:100%;"
                });
                toolbar.addChild(new Button({
                    label: nls.createNewPO,
                    iconClass: "icon-16-container icon-16-add",
                    onClick: function() {
                        return dojo.hitch(self, 'purchaseOrderDialogForm', -1)();
                    }
                }));
                toolbar.addChild(new dijit.ToolbarSeparator);
                toolbar.addChild(new Button({
                    id: 'deleteCompanyFromPurchaseOrder',
                    label: nls["delete"],
                    iconClass: "icon-16-container icon-16-delete",
                    disabled: true,
                    onClick: function() {
                        return grid.deleteRow(grid.selection.selectedIndex);
                    }
                }));
                mainContainer = this.mainContainer = new BorderContainer({
                    style: "padding:0px;width:100%;height:100%;",
                    gutters: false
                });
                mainContainer.addChild(new FilterToolbar({
                    region: 'top',
                    grid: grid,
                    editableGrid: false,
                    filterFields: new Array('po_no', 'project', 'status')
                }));
                mainContainer.addChild(toolbar);
                mainContainer.addChild(grid);
                self.win.addChild(mainContainer);
                self.win.show();
                return self.win.startup();
            },
            purchaseOrderDialogForm: function(poId) {
                var pb, self;
                self = this;
                pb = new buildspace.dialog.indeterminateProgressBar({
                    title: nls.processing + "..."
                });
                pb.show();
                return request.get('purchaseOrder/getPurchaseOrderFormInformation', {
                    query: {
                        poId: poId
                    },
                    handleAs: 'json'
                }).then(function(response) {
                    var dialog;
                    pb.hide();
                    dialog = new PurchaseOrderDialog({
                        title: nls.addNewPurchaseOrder,
                        poId: poId,
                        data: response,
                        purchaseOrderGrid: self.purchaseOrderGrid
                    });
                    return dialog.show();
                }, function(error) {
                    return pb.hide();
                });
            },
            getGridLayout: function() {
                var formatter = new Formatter;
                return [{
                    name: "No",
                    field: "id",
                    width: '30px',
                    styles: 'text-align: center;',
                    formatter: formatter.rowCountCellFormatter
                },{
                    name: nls.poNo,
                    field: "po_no",
                    width: '120px',
                    styles: 'text-align: center;'
                },{
                    name: nls.project,
                    field: "project",
                    width: 'auto'
                },{
                    name: nls.status,
                    field: "status",
                    width: '120px',
                    styles: 'text-align: center;'
                }, {
                    name: nls.issued_by,
                    field: "issued_by",
                    width: '140px',
                    styles: 'text-align: center;'
                },{
                    name: nls.date_issued,
                    field: "date_issued",
                    width: '140px',
                    styles: 'text-align: center;'
                }];
            },
            kill: function() {
                if (this.win && typeof(this.win) != "undefined"){
                    this.win.close();
                }
            }
        });
    });

}).call(this);
