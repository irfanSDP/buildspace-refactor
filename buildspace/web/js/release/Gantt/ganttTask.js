function TaskFactory(){this.build=function(a,b,c,f,d,e,h,k){return new Task(a,b,c,f,d,e,h,k)}}
function Task(a,b,c,f,d,e,h,k){this.id=a;this.name=b?b:"Task";this.actualProgress=this.progress=0;this.description="";this.code=c;this.level=f;this.status="STATUS_UNDEFINED";this.depends="";this.canWrite=!0;this.start=d;this.duration=h;this.end=e;this.endIsMilestone=this.startIsMilestone=!1;this.collapsed=k;this._csrf_token=this.idFromDB=null;this.totalCost=0;this.completedDate=null;this.hoursPerDay=8;this.rowElement;this.ganttElement;this.master}
Task.prototype.clone=function(){var a={},b;for(b in this)"function"!=typeof this[b]&&(a[b]=this[b]);return a};
Task.prototype.setPeriod=function(a,b){a instanceof Date&&(a=a.getTime());b instanceof Date&&(b=b.getTime());var c=this.end,f=this.duration,d=a;a>b&&(a=b);a=this.master.computeStart(a);if(0<this.duration){var e=new Date;e.setHours(23,59,59,999);e=recomputeDuration(this.start,e);this.actualProgress=e>=this.duration?100:e/this.duration*100}this.actualProgress=0==this.actualProgress?"0.00":this.actualProgress.toFixed(2);var h=this.getSuperiors();if(h&&0<h.length){for(var k=0,e=0;e<h.length;e++)var l=
h[e],k=Math.max(k,incrementDateByWorkingDays(l.from.end,l.lag));if(this.master.computeStart(k)!=a)return this.moveTo(k+1,!1)}e=!1;if(this.start!=a||this.start!=d)this.start=a,e=!0;d=b;b=this.master.computeEnd(b);if(this.end!=b||this.end!=d)this.end=b,e=!0;this.duration=recomputeDuration(this.start,this.end);if(!e)return!0;if(!this.canWrite)return this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+this.name,this),!1;if(this.hasExternalDep)return this.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS+
"\n"+this.name,this),!1;d=!0;c=(e=0<f-this.duration)&&c>this.end;if(e){f=this.getChildren();l=Infinity;for(e=h=0;e<f.length;e++)ch=f[e],c?h=Math.max(h,ch.end):l=Math.min(l,ch.start);c?this.end=Math.max(h,this.end):this.start=Math.min(l,this.start);this.duration=recomputeDuration(this.start,this.end)}else{if(this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate)this.master.setErrorOnTransaction(GanttMaster.messages.CHANGE_OUT_OF_SCOPE,this),d=!1;d&&!updateTree(this)&&(d=!1)}if(d&&
(c=this.getInferiors())&&0<c.length)for(e=0;e<c.length;e++){l=c[e];if(!l.to.canWrite){this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+l.to.name,l.to);break}d=l.to.moveTo(b,!1);if(!d)break}return d};
Task.prototype.moveTo=function(a,b){a instanceof Date&&(a=a.getTime());var c=this.start,f=a;a=this.master.computeStart(a);if(!b&&this.startIsMilestone&&a!=this.start)return this.master.setErrorOnTransaction(GanttMaster.messages.START_IS_MILESTONE,this),!1;if(this.hasExternalDep)return this.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS,this),!1;var d=this.getSuperiors();if(d&&0<d.length){for(var e=0,h=0;h<d.length;h++)var k=d[h],e=Math.max(e,incrementDateByWorkingDays(k.from.end,
k.lag));a=e+1}a=this.master.computeStart(a);d=this.master.computeEndByDuration(a,this.duration);if(this.start!=a||this.start!=f){!b&&this.endIsMilestone&&(d=this.end,this.duration=recomputeDuration(a,d));this.start=a;this.end=d;if(this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate)return this.master.setErrorOnTransaction(GanttMaster.messages.CHANGE_OUT_OF_SCOPE,this),!1;k=c-this.start;c=this.getChildren();for(h=0;h<c.length;h++)if(ch=c[h],!ch.moveTo(ch.start-k,!1))return!1;
if(!updateTree(this))return!1;if((c=this.getInferiors())&&0<c.length)for(h=0;h<c.length;h++)if(k=c[h],!k.to.canWrite)this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+k.to.name,k.to);else if(!k.to.moveTo(d,!1))return!1}return!0};
function updateTree(a){var b=a.getParent();if(!b)return!0;var c=b.start,f=b.end;if(b.start>a.start){if(b.startIsMilestone)return a.master.setErrorOnTransaction(GanttMaster.messages.START_IS_MILESTONE+"\n"+b.name,a),!1;if(b.depends)return a.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_CONSTRAINTS+"\n"+b.name,a),!1;c=a.start}if(b.end<a.end){if(b.endIsMilestone)return a.master.setErrorOnTransaction(GanttMaster.messages.END_IS_MILESTONE+"\n"+b.name,a),!1;f=a.end}return c!=b.start||f!=b.end?
b.canWrite?b.hasExternalDep?(a.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS+"\n"+b.name,a),!1):b.setPeriod(c,f):(a.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+b.name,a),!1):!0}
Task.prototype.changeStatus=function(a){function b(a,d,e,m,n){var h=a.status;if(d==h)return!0;var k=!0;a.status=d;if(a.master.cannotCloseTaskIfIssueOpen&&"STATUS_DONE"==d&&0<a.openIssues)return a.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_CLOSE_TASK_IF_OPEN_ISSUE+" "+a.name),!1;if("STATUS_DONE"==d)if(e||"STATUS_FAILED"!=h){d=a.getSuperiors();for(var g=0;g<d.length;g++)if(0>f.indexOf(d[g].from)&&"STATUS_DONE"!=d[g].from.status){(e||m)&&a.master.setErrorOnTransaction(GanttMaster.messages.GANTT_ERROR_DEPENDS_ON_OPEN_TASK+
"\n"+d[g].from.name+" -> "+a.name);k=!1;break}if(k){e=a.getChildren();for(g=0;g<e.length;g++)b(e[g],"STATUS_DONE",!1,!0,!1);c(f,a.getInferiors(),"STATUS_ACTIVE")}}else k=!1;else if("STATUS_ACTIVE"==d)if(e||"STATUS_FAILED"!=h){(g=a.getParent())&&"STATUS_ACTIVE"!=g.status&&(k=b(g,"STATUS_ACTIVE",!1,!1,!0));if(k)for(d=a.getSuperiors(),g=0;g<d.length;g++)if("STATUS_DONE"!=d[g].from.status){(e||n)&&a.master.setErrorOnTransaction(GanttMaster.messages.GANTT_ERROR_DEPENDS_ON_OPEN_TASK+"\n"+d[g].from.name+
" -> "+a.name);k=!1;break}if(k){e=a.getChildren();if("STATUS_UNDEFINED"==h||"STATUS_SUSPENDED"==h)for(g=0;g<e.length;g++)"STATUS_DONE"!=e[g].status&&b(e[g],"STATUS_ACTIVE",!1,!0,!1);d=a.getInferiors();for(g=0;g<d.length;g++)b(d[g].to,"STATUS_SUSPENDED",!1,!1,!1)}}else k=!1;else if("STATUS_SUSPENDED"==d||"STATUS_UNDEFINED"==d)if(e||"STATUS_FAILED"!=h){(g=a.getParent())&&"STATUS_ACTIVE"!=g.status&&(k=b(g,d,!1,!1,!0));e=a.getChildren();for(g=0;g<e.length;g++)"STATUS_DONE"!=e[g].status&&b(e[g],d,!1,!0,
!1);c(f,a.getInferiors(),d)}else k=!1;else if("STATUS_FAILED"==d){e=a.getChildren();for(g=0;g<e.length;g++)b(e[g],"STATUS_FAILED",!1,!0,!1);c(f,a.getInferiors(),"STATUS_FAILED")}k||(a.status=h);return k}function c(a,c,d){for(var e=0;e<c.length;e++)0>a.indexOf(c[e].to)&&b(c[e].to,d,!1,!1,!1)}var f=this.getDescendant(),d=!0,e=this.status,d=b(this,a,!0,!1,!1);d||(this.status=e);return d};Task.prototype.synchronizeStatus=function(){var a=this.status;this.status="";return this.changeStatus(a)};
Task.prototype.isLocallyBlockedByDependencies=function(){for(var a=this.getSuperiors(),b=!1,c=0;c<a.length;c++)if("STATUS_DONE"!=a[c].from.status){b=!0;break}return b};Task.prototype.getRow=function(){var a=-1;this.master&&(a=this.master.tasks.indexOf(this));return a};Task.prototype.getParents=function(){var a;if(this.master){var b=this.level,c=this.getRow();for(a=[];0<=c;c--){var f=this.master.tasks[c];b>f.level&&(b=f.level,a.push(f))}}return a};
Task.prototype.getParent=function(){var a;if(this.master)for(var b=this.getRow();0<=b;b--){var c=this.master.tasks[b];if(this.level>c.level){a=c;break}}return a};Task.prototype.isParent=function(){var a=!1;if(this.master){var b=this.getRow();b<this.master.tasks.length-1&&(a=this.master.tasks[b+1].level>this.level)}return a};
Task.prototype.getChildren=function(){var a=[];if(this.master)for(var b=this.getRow()+1;b<this.master.tasks.length;b++){var c=this.master.tasks[b];if(c.level==this.level+1)a.push(c);else if(c.level<=this.level)break}return a};Task.prototype.getDescendant=function(){var a=[];if(this.master)for(var b=this.getRow()+1;b<this.master.tasks.length;b++){var c=this.master.tasks[b];if(c.level>this.level)a.push(c);else break}return a};
Task.prototype.getSuperiors=function(){var a=[],b=this;this.master&&(a=this.master.links.filter(function(a){return a.to==b}));return a};Task.prototype.getSuperiorTasks=function(){for(var a=[],b=this.getSuperiors(),c=0;c<b.length;c++)a.push(b[c].from);return a};Task.prototype.getInferiors=function(){var a=[],b=this;this.master&&(a=this.master.links.filter(function(a){return a.from==b}));return a};
Task.prototype.getInferiorTasks=function(){for(var a=[],b=this.getInferiors(),c=0;c<b.length;c++)a.push(b[c].to);return a};
Task.prototype.deleteTask=function(){this.rowElement&&this.rowElement.remove();this.ganttElement&&this.ganttElement.remove();for(var a=this.getChildren(),b=0;b<a.length;b++)a[b].isNew()||this.master.deletedTaskIds.push(a[b].id),a[b].deleteTask();this.isNew()||this.master.deletedTaskIds.push(this.id);this.master.tasks.splice(this.getRow(),1);var c=this;this.master.links=this.master.links.filter(function(a){return a.from!=c&&a.to!=c})};Task.prototype.isNew=function(){return 0==(this.id+"").indexOf("tmp_")};
Task.prototype.isDependent=function(a){for(var b=this,c=this.master.links.filter(function(a){return a.from==b}),f=0;f<c.length;f++)if(c[f].to==a)return!0;for(f=0;f<c.length;f++)if(c[f].to.isDependent(a))return!0;return!1};Task.prototype.setLatest=function(a){this.latestStart=a-this.criticalCost;this.latestFinish=this.latestStart+this.duration};
Task.prototype.indent=function(){var a=this.getRow();if(0>=a)return!1;var b=!1;if(this.level+1<=this.master.tasks[a-1].level+1){b=!0;this.level++;var c=this.getParents();this.level--;for(var f=this.level;a<this.master.tasks.length;a++){var d=this.master.tasks[a];if(d.level>f||d==this)d.level++,this.master.links=this.master.links.filter(function(a){var b=!1;a.to==d?b=0<=c.indexOf(a.from):a.from==d&&(b=0<=c.indexOf(a.to));return!b});else break}(f=this.getParent())&&!this.depends&&(a=this.master.computeEndByDuration(f.start,
this.duration),this.master.changeTaskDates(this,f.start,a));this.master.updateDependsStrings();this.setPeriod(this.start+1,this.end+1);this.synchronizeStatus()}return b};
Task.prototype.outdent=function(){if(1>=this.level)return!1;for(var a=!1,b=this.level,a=!0,c=this.getRow();c<this.master.tasks.length;c++){var f=this.master.tasks[c];if(f.level>b||f==this)f.level--;else break}var d=this,e=this.getChildren();this.master.links=this.master.links.filter(function(a){return!(a.to==d&&0<=e.indexOf(a.from)||a.from==d&&0<=e.indexOf(a.to))});for(c=0;c<e.length;c++)e[c].setPeriod(e[c].start+1,e[c].end+1);this.master.updateDependsStrings();this.setPeriod(this.start+1,this.end+
1);this.synchronizeStatus();return a};
Task.prototype.moveUp=function(){var a,b=this.getRow();if(0>=b)return!1;var c;for(c=b-1;0<=c&&!(this.master.tasks[c].level<=this.level);c--);if(this.master.tasks[c].level==this.level){a=!0;for(var f=0,d=b+1;d<this.master.tasks.length;d++)if(this.master.tasks[d].level>this.level)f++;else break;var d=this.master.tasks.splice(b,f+1),e=this.master.tasks.splice(0,c);this.master.tasks=[].concat(e,d,this.master.tasks);d=this.master.editor.element.find("tr[taskid]");b=d.slice(b,b+f+1);d.eq(c).before(b);this.master.updateDependsStrings()}else this.master.setErrorOnTransaction(GanttMaster.messages.TASK_MOVE_INCONSISTENT_LEVEL,
this),a=!1;return a};
Task.prototype.moveDown=function(){var a=this.getRow();if(a>=this.master.tasks.length-1||0==a)return!1;var b=!1,c;for(c=a+1;c<this.master.tasks.length&&!(this.master.tasks[c].level<=this.level);c++);if(this.master.tasks[c]&&this.master.tasks[c].level==this.level){b=!0;for(c+=1;c<this.master.tasks.length&&!(this.master.tasks[c].level<=this.level);c++);for(var f=0,d=a+1;d<this.master.tasks.length;d++)if(this.master.tasks[d].level>this.level)f++;else break;var d=this.master.tasks.splice(a,f+1),e=this.master.tasks.splice(0,
c-f-1);this.master.tasks=[].concat(e,d,this.master.tasks);d=this.master.editor.element.find("tr[taskid]");c=d.eq(c-1);a=d.slice(a,a+f+1);c.after(a);this.master.updateDependsStrings()}return b};function Link(a,b,c){this.from=a;this.to=b;this.lag=c};
