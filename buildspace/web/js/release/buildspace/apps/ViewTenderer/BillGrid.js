define("buildspace/apps/ViewTenderer/BillGrid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-attr dijit/Menu dojo/number dijit/CheckedMenuItem dojox/grid/enhanced/plugins/Menu dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn dojo/_base/event dojo/keys dijit/focus dojo/_base/html dojo/request/xhr dijit/PopupMenuItem dijit/MenuSeparator ./HistoricalRateSearchDialog ./TendererDetails buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/Tendering dojo/on dojox/grid/_Grid dojox/widget/PlaceholderMenuItem buildspace/widget/grid/cells/TextBox".split(" "),
function(h,k,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,l,n,J,K,p,f,L){var r=h("buildspace.apps.ViewTenderer.BillGrid",dojox.grid.EnhancedGrid,{type:null,billId:-1,elementId:0,itemId:-1,disableEditing:!1,style:"border-top:none;",selectedItem:null,borderContainerWidget:null,keepSelection:!0,rowSelector:"0px",headerMenu:null,typeColumns:null,markupSettings:null,parentGrid:null,elementGridStore:null,updateUrl:null,project:null,typeColumsToQtyUsed:[],constructor:function(a){this.type=a.type;this.hierarchyTypes=
a.hierarchyTypes;this.hierarchyTypesForHead=a.hierarchyTypesForHead;this.unitOfMeasurements=a.unitOfMeasurements;this.columnGroup=a.columnGroup;this.typeColumns=a.typeColumns;this.tender_setting=a.tender_setting;this.tender_companies=a.tender_companies;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;var c=this.formatter=new p;this.companyColumnChildren=[{name:f.rate,field_name:"rate-value",width:"85px",cellType:"buildspace.widget.grid.cells.TextBox",
styles:"text-align:right;",editable:!0,formatter:c.companyRateCurrencyCellFormatter},{name:f.grandTotal,field_name:"grand_total_after_markup",width:"100px",styles:"text-align:right;",editable:!1,formatter:c.unEditableCurrencyCellFormatter}];this.setColumnStructure();this.inherited(arguments)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},editableCellDblClick:function(a){var c;c=1<this._click.length&&has("ie")?
this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(c.cell,c.rowIndex);this.onRowClick(c);this.onRowDblClick(a)},setColumnStructure:function(){var a=this.formatter,c="auto",b;if("tree"==this.type){0<this.tender_companies.length&&(c="500px");var d=this.unitOfMeasurements,e=this.hierarchyTypes,a=this.fixedColumns={noscroll:!1,width:57.8,cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,
noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:f.billReference,field:"bill_ref",styles:"text-align:center; color: red;",width:"80px",noresize:!0,showInCtxMenu:!0,formatter:a.billRefCellFormatter,rowSpan:2,hidden:!1},{name:f.description,field:"description",width:c,editable:!1,cellType:"buildspace.widget.grid.cells.Textarea",formatter:a.treeCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:f.type,field:"type",width:"70px",styles:"text-align:center;",editable:!1,type:"dojox.grid.cells.Select",
options:e.options,values:e.values,formatter:a.typeCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:f.unit,field:"uom_id",width:"50px",editable:!1,styles:"text-align:center;",type:"dojox.grid.cells.Select",options:d.options,values:d.values,formatter:a.unitIdCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:f.grandTotalQty,field:"grand_total_quantity",styles:"text-align:right;color:blue;",width:"90px",formatter:a.unEditableNumberCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},
{name:f.rate,field:"rate_after_markup",styles:"text-align:right;",width:"75px",editable:!1,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:a.rateAfterMarkupCellFormatter,noresize:!0,rowSpan:2},{name:f.grandTotal,field:"grand_total_after_markup",styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:f.qty,field:"quantity_per_unit_remeasurement",styles:"text-align:right;color:blue;",width:"100px",
formatter:a.unEditableCurrencyCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:1},{name:f.amount,field:"remeasurement_amount",styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:1},{name:f.historicalRate,field:"historical_rate",styles:"text-align:right;color:blue;",width:"100px",editable:!0,formatter:a.currencyCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2}],[{name:f.remeasurement,field:"remeasurement_fields",
styles:"text-align:center;",headerClasses:"staticHeader typeHeader2",colSpan:2,hidden:!1}]]},c=[];b=this.generateContractorRateColumn(a)}else 5<this.tender_companies.length&&(c="480px"),a=this.fixedColumns={noscroll:!1,width:"50",cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0},{name:f.description,field:"description",width:c,cellType:"buildspace.widget.grid.cells.Textarea",formatter:a.treeCellFormatter,noresize:!0},{name:f.grandTotal,
field:"overall_total_after_markup",styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0,showInCtxMenu:!0}]]},c=this.generateContractorGrandTotalColumn(),b=a;dojo.forEach(c,function(a){b.cells[0].push(a)});this.structure=b},generateContractorRateColumn:function(a){var c=this.companyColumnChildren,b=[],d=0;dojo.forEach(this.tender_companies,function(e){var f=c.length;d++;var g;g=e.awarded?'<span style="color:blue;">'+buildspace.truncateString(e.name,
28)+"</span>":buildspace.truncateString(e.name,28);b.push({name:g,field:e.id+"-company_fields",styles:"text-align:center;",headerClasses:"staticHeader typeHeader"+d,colSpan:f,headerId:e.id,hidden:!1});for(i=0;i<c.length;i++)f=e.id+"-"+c[i].field_name,f={field:f,columnType:"contractorColumn",companyId:e.id,headerClasses:"typeHeader"+d},k.mixin(f,c[i]),a.cells[0].push(f)});b=a.cells[1].concat(b);a.cells[1]=b;return a},generateContractorGrandTotalColumn:function(){var a=[],c=this.formatter,b=0;dojo.forEach(this.tender_companies,
function(d){b++;var e;e=d.awarded?'<span style="color:blue;">'+buildspace.truncateString(d.name,28)+"</span>":buildspace.truncateString(d.name,28);a.push({name:e,field:d.id+"-overall_total_after_markup",styles:"text-align:right;",width:"120px",formatter:c.unEditableCurrencyCellFormatter,headerClasses:"typeHeader"+b,noresize:!0})});return a},addTendererDetailsContainer:function(a){var c="project-"+this.project.id+"-viewTendererDetails",b=dijit.byId(c);b&&(this.borderContainerWidget.removeChild(b),
b.destroy());b=new n({id:c,region:"bottom",project:this.project,company_id:a,tender_companies:this.tender_companies,style:"padding:0px;margin:0px;width:100%;height:40%;",gutters:!0});this.borderContainerWidget.addChild(b);return b},onHeaderCellDblClick:function(a){var c;c="tree"==this.type?"-company_fields":"-overall_total_after_markup";a.cell.field.endsWith(c)&&(a=a.cell.field.replace(c,""),this.addTendererDetailsContainer(a))},canSort:function(a){return!1},postCreate:function(){this.inherited(arguments)},
doApplyCellEdit:function(a,c,b){var d=this,e=d.getItem(c),q=d.store,g=b.replace("-value","");if(void 0!=e[b][0]||a!==e[b][0]){var m=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),h={id:e.id,project_id:d.project.id,unsorted:d.unsorted,attr_name:g,val:a,_csrf_token:e._csrf_token?e._csrf_token:null},k=this.updateUrl,l=function(a,c){for(var b in a)e.hasOwnProperty(b)&&b!=c._getIdentifierAttribute()&&c.setValue(e,b,a[b]),dojo.forEach(a.affected_nodes,function(a){c.fetchItemByIdentity({identity:a.id,
onItem:function(b){for(var d in a)e.hasOwnProperty(d)&&d!=c._getIdentifierAttribute()&&c.setValue(b,d,a[d])}})});c.save()};m.show().then(function(){dojo.xhrPost({url:k,content:h,handleAs:"json",load:function(a){if(a.success){0<e.id&&l(a.data,q);var f=d.getCellByField(b);window.setTimeout(function(){d.focus.setFocusIndex(c,f.index)},10);m.hide()}},error:function(a){m.hide();console.log(a)}})})}d.inherited(arguments)},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var c=
a.node.children[0].children[0].rows[1],b=a.node.children[0].children[0].rows[0].children;c.parentNode.removeChild(c);dojo.forEach(b,function(a,c){var b=dojo.attr(a,"rowSpan");(!b||2>b)&&dojo.attr(a,"rowSpan",2)})}},canEdit:function(a,c){var b=this;if("tree"==this.type&&void 0!=a){var d=this.getItem(c),e=a.field,f=e.split("-");if(b.disableEditing)return window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1;var g=null;3==f.length&&(g=f[1]);if(0<d.id[0]&&!d.project_revision_deleted_at[0])if(d.type!=
buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&d.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||"description"==e||"type"==e||!a.editable){if(d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&"description"!=e&&"type"!=e&&a.editable||(d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_HTML_EDITOR||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)&&"description"==e||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&"type"!=e&&
"uom_id"!=e||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&"description"!=e&&"rate"!=g||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE&&("rate-value"==e||"rate"==g)||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&"description"!=e&&"type"!=e&&"markup_percentage-value"!=e&&"markup_amount-value"!=e&&"uom_id"!=e&&a.editable||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED)return window.setTimeout(function(){b.edit.cancel();
b.focus.setFocusIndex(c,a.index)},10),!1;if(d.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&d.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&d.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&"historical_rate"==e&&a.editable)return(new l({targetBillItem:d})).show(),window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1}else return window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1;else return!1}return this._canEdit}});
return h("buildspace.apps.ViewTenderer.BillGridBuilder",dijit.layout.BorderContainer,{pageId:"page-00",style:"padding:0px;border:none;width:100%;height:100%;",gutters:!1,stackContainerTitle:"",rootProject:null,billId:-1,elementId:0,disableEditing:!1,itemId:-1,rowSelector:null,gridOpts:{},type:null,postCreate:function(){this.inherited(arguments);k.mixin(this.gridOpts,{billId:this.billId,project:this.rootProject,elementId:this.elementId,type:this.type,region:"center",disableEditing:this.disableEditing,
borderContainerWidget:this});var a=this.grid=new r(this.gridOpts);this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:a,region:"center"}));var c=dijit.byId("viewTenderBreakdown"+this.rootProject.id+"-stackContainer");if(c){var b=document.createElement("div");c.addChild(new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),id:this.pageId,content:this,grid:a},b));c.selectChild(this.pageId)}}})});
