define("buildspace/apps/ViewTenderer/AssignContractorDialog","dojo/_base/declare dijit/form/Form dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/form/FilteringSelect dojo/aspect dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dojo/text!./templates/assignContractorForm.html ./importRatesDialog ./PrintBillDialog ./TendererLogDialog dojo/currency buildspace/widget/grid/cells/Formatter buildspace/widget/grid/cells/CheckBox dojox/grid/enhanced/plugins/IndirectSelection dojo/i18n!buildspace/nls/ViewTenderer".split(" "),
function(n,r,t,N,u,v,A,O,B,P,Q,C,R,w,x,y,z,p,D,E,F,G,l,H,S,T,e){var I=n("buildspace.apps.ViewTenderer.ExportRatesForm",[r,t,u,v,dojox.form.manager._Mixin,dojox.form.manager._NodeMixin,dojox.form.manager._ValueMixin,dojox.form.manager._DisplayMixin],{templateString:'<form data-dojo-attach-point="containerNode"><table class="table-form"><tr><td class="label" style="width:80px;"><label style="display: inline;"></span>'+e.downloadAs+' :</label></td><td><input type="text" name="filename" style="padding:2px;width:220px;" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="trim:true, propercase:true, required: true"><input type="hidden" name="pid" value=""><input type="hidden" name="cid" value=""><input type="hidden" name="wnli" value=""><input type="hidden" name="_csrf_token" value=""></td></tr></table></form>',
project:null,company:null,withNotListedItem:!1,region:"center",dialogWidget:null,exportUrl:null,style:"outline:none;padding:0;margin:0;border:none;",baseClass:"buildspace-form",startup:function(){this.inherited(arguments);var a=String(this.project.title),b=String(this.company.name);60<a.length&&(a=a.substring(0,60));60<b.length&&(b=b.substring(0,60));this.setFormValues({filename:b+"-"+a,pid:this.project.id,cid:this.company.id,wnli:this.withNotListedItem,_csrf_token:this.project._csrf_token})},submit:function(){if(this.validate()&&
this.exportUrl){var a=dojo.formToObject(this.id),b=a.filename.replace(/ /g,"_");buildspace.windowOpen("POST",this.exportUrl,{filename:b,pid:a.pid,cid:a.cid,wnli:a.wnli,_csrf_token:a._csrf_token});this.dialogWidget&&this.dialogWidget.hide()}}}),J=n("buildspace.apps.ViewTenderer.ExportRatesDialog",dijit.Dialog,{style:"padding:0px;margin:0;",title:e.exportContractorRates,project:null,company:null,withNotListedItem:!1,exportUrl:null,buildRendering:function(){var a=this.createContent();a.startup();this.content=
a;this.inherited(arguments)},postCreate:function(){x.set(this.containerNode,{padding:"0",margin:"0"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==w.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createContent:function(){var a=new dijit.layout.BorderContainer({style:"padding:0;width:400px;height:80px;",gutters:!1}),b=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"}),c=I({project:this.project,
company:this.company,withNotListedItem:this.withNotListedItem,exportUrl:this.exportUrl,dialogWidget:this});b.addChild(new dijit.form.Button({label:e.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));b.addChild(new dijit.ToolbarSeparator);b.addChild(new dijit.form.Button({label:e.download,iconClass:"icon-16-container icon-16-import",style:"outline:none!important;",onClick:dojo.hitch(c,"submit")}));a.addChild(b);a.addChild(c);return a}}),
K=n("buildspace.apps.ViewTenderer.ContractorGrid",dojox.grid.EnhancedGrid,{project:null,tenderAlternative:null,disableEditing:!1,style:"border-top:none;",region:"center",canSort:function(a){return!1},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);dojo.forEach(c,function(d,f){f=dojo.attr(d,"rowSpan");(!f||
2>f)&&dojo.attr(d,"rowSpan",2)})}},postCreate:function(){var a=this;a.inherited(arguments);this.on("RowClick",function(b){(b=a.getItem(b.rowIndex))&&0<parseInt(String(b.id))?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0)});this.on("CellClick",function(b){var c=b.cell.field;b=a.getItem(b.rowIndex);"awarded"==c&&b&&0<parseInt(String(b.id))&&!a.disableEditing&&a.awardCompany(b)});this.companyIds=[];this.store.fetch({onComplete:function(b){dojo.forEach(b,function(c,d){c.awarded[0]&&(d=parseFloat(String(c.adjusted_total))-
parseFloat(String(c.total)),d=0<d?'<span style="color:blue">'+l.format(d)+"</span>":0>d?'<span style="color:red">'+l.format(d)+"</span>":l.format(d),a.structure.cells[1][0].name=e.diff+": "+d,a.set("structure",a.structure));c&&0<parseInt(String(c.id))&&c.show[0]&&a.companyIds.push(parseInt(String(c.id)))})}})},doStartEdit:function(a,b){var c=this.getItem(b),d=this.store;5==this.companyIds.length&&c.show[0]?(d.setValue(c,"show",!1),d.save()):(this.inherited(arguments),c&&(this.pushItemIdIntoGridArray(c,
c.show[0]),this.updateCompanySelection()))},dodblclick:function(a){this.onRowDblClick(a)},deleteCompany:function(a){var b=this,c=e.removeContractorFromTender+" "+buildspace.truncateString(this.project.title,25),d=e.areYouSureToRemove+" "+buildspace.truncateString(a.name,30)+"?",f=buildspace.dialog.indeterminateProgressBar({title:e.deleting+". "+e.pleaseWait+"..."}),g=this.tenderAlternative?parseInt(String(this.tenderAlternative.id)):-1,h={url:"viewTenderer/tenderCompanyDelete",content:{pid:parseInt(String(b.project.id)),
cid:parseInt(String(a.id)),tid:g,_csrf_token:a._csrf_token},handleAs:"json",load:function(k){if(k.success){k=b.store;var m=a.show[0]?!0:!1;b.pushItemIdIntoGridArray(a,!1);a.awarded[0]&&(b.structure.cells[1][0].name=e.diff+": "+l.format(0),b.set("structure",b.structure));k.deleteItem(a);k.save();k.close();b.sort();b.disableToolbarButtons(!0);dijit.byId("assignContractorSelect").store.close();m&&dijit.byId("main-project_breakdown").content.reconstructBillContainer()}f.hide()},error:function(k){f.hide()}};
new buildspace.dialog.confirm(c,d,80,400,function(){f.show().then(function(){dojo.xhrPost(h)})},function(){})},awardCompany:function(a){var b=this,c=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."}),d=this.tenderAlternative?parseInt(String(this.tenderAlternative.id)):-1;c.show().then(function(){dojo.xhrPost({url:"viewTenderer/awardCompany",content:{pid:parseInt(String(b.project.id)),cid:parseInt(String(a.id)),tid:d,_csrf_token:String(a._csrf_token)},handleAs:"json",load:function(f){f.success&&
(f=b.store,f.save(),f.close(),b.sort(),dijit.byId("main-project_breakdown").content.reconstructBillContainer(),b.setDiff());c.hide()},error:function(f){c.hide()}})})},setDiff:function(a){var b=this;this.store.fetch({onComplete:function(c){dojo.forEach(c,function(d,f){d.awarded[0]&&(d=parseFloat(String(d.adjusted_total))-parseFloat(String(d.total)),d=0<d?'<span style="color:blue">'+l.format(d)+"</span>":0>d?'<span style="color:red">'+l.format(d)+"</span>":l.format(d),b.structure.cells[1][0].name=e.diff+
": "+d,b.set("structure",b.structure))})}})},disableToolbarButtons:function(a,b){var c=dijit.byId("TendererSetting-"+this.project.id+"-DeleteRow-button"),d=dijit.byId("TendererSetting-"+this.project.id+"-ImportRateRow-button"),f=dijit.byId("TendererSetting-"+this.project.id+"-ExportRateRow-button"),g=dijit.byId("TendererSetting-"+this.project.id+"-RefreshRateRow-button"),h=dijit.byId("TendererSetting-"+this.project.id+"-PrintRateRow-button"),k=dijit.byId("TendererSetting-"+this.project.id+"-LogRateRow-button");
this.disableEditing?(c&&c._setDisabledAttr(!0),d&&d._setDisabledAttr(!0),g&&h._setDisabledAttr(!0)):(c&&c._setDisabledAttr(a),d&&d._setDisabledAttr(a),h&&h._setDisabledAttr(a));f&&f._setDisabledAttr(a);h&&h._setDisabledAttr(a);k&&k._setDisabledAttr(a);g&&g._setDisabledAttr(a);if(a&&b instanceof Array){var m=this;dojo.forEach(b,function(q){(q=dijit.byId("TendererSetting-"+m.project.id+"-"+q+"Row-button"))&&q._setDisabledAttr(!1)})}},selectTree:function(a){var b=a.rowIndex;a=this.selection.selected[b];
(b=this.getItem(b))&&this.pushItemIdIntoGridArray(b,a)},pushItemIdIntoGridArray:function(a,b){var c=dojo.indexOf(this.companyIds,parseInt(String(a.id)));b?-1==c&&this.companyIds.push(parseInt(String(a.id))):-1!=c&&this.companyIds.splice(c,1)},toggleAllSelection:function(a){var b=this,c=b.selection;a?(c.selectRange(0,b.rowCount-1),b.companyIds=[],b.store.fetch({onComplete:function(d){dojo.forEach(d,function(f,g){f&&0<parseInt(String(f.id))&&b.companyIds.push(parseInt(String(f.id)))})}})):(c.deselectAll(),
b.companyIds=[]);this.updateCompanySelection()},updateCompanySelection:function(){var a=this;dojo.xhrPost({url:"viewTenderer/updateCompanySelection",content:{projectId:a.project.id,companyIds:[a.companyIds]},handleAs:"json",load:function(b){b.success&&(a.store.save(),a.store.close(),a._refresh(),dijit.byId("main-project_breakdown").content.reconstructBillContainer())},error:function(b){}})},sortBy:function(a){var b=this,c=buildspace.dialog.indeterminateProgressBar({title:e.sorting+". "+e.pleaseWait+
"..."});switch(a){case "nameDesc":var d=2;break;case "highestToLowest":d=4;break;case "lowestToHighest":d=8;break;default:d=1}c.show().then(function(){dojo.xhrPost({url:"viewTenderer/sortUpdate",content:{pid:b.project.id,opt:d,_csrf_token:b.project._csrf_token},handleAs:"json",load:function(f){f.success&&(f=b.store,f.save(),f.close(),b.sort(),dijit.byId("main-project_breakdown").content.reconstructBillContainer());c.hide()},error:function(f){c.hide()}})})}}),L=n("buildspace.apps.ViewTenderer.ContractorGridContainer",
dijit.layout.BorderContainer,{style:"padding:0px;border:0px;width:100%;height:100%;",gutters:!1,region:"center",project:null,tenderAlternative:null,disableEditing:!1,grid:null,gridOpts:{},postCreate:function(){var a=this;a.inherited(arguments);B.mixin(a.gridOpts,{project:a.project,tenderAlternative:a.tenderAlternative,region:"center",disableEditing:a.disableEditing});var b=this.grid=new K(a.gridOpts),c=new dijit.Toolbar({region:"top",style:"padding:2px;border:0px;width:100%;"});c.addChild(new dijit.form.Button({id:"TendererSetting-"+
a.project.id+"-DeleteRow-button",label:e.remove,iconClass:"icon-16-container icon-16-delete",disabled:-1<b.selection.selectedIndex&&!a.disableEditing?!1:!0,onClick:function(g){-1<b.selection.selectedIndex&&(g=b.getItem(b.selection.selectedIndex))&&0<parseInt(String(g.id))&&b.deleteCompany(g,a.tenderAlternative)}}));c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({id:"TendererSetting-"+a.project.id+"-ImportRateRow-button",label:e.importContractorRates,iconClass:"icon-16-container icon-16-import",
disabled:-1<b.selection.selectedIndex?!1:!0,onClick:function(g){-1<b.selection.selectedIndex&&(g=b.getItem(b.selection.selectedIndex))&&0<parseInt(String(g.id))&&(new E({title:e.importContractorRates,project:a.project,company:g})).show()}}));var d=new z({style:"display: none;"});d.addChild(new p({label:e.withNotListedItem,onClick:function(g){a.exportRates(!0)}}));d.addChild(new p({label:e.withoutNotListedItem,onClick:function(g){a.exportRates(!1)}}));d=new y({id:"TendererSetting-"+a.project.id+"-ExportRateRow-button",
label:e.exportContractorRates,iconClass:"icon-16-container icon-16-import",dropDown:d,disabled:-1<b.selection.selectedIndex?!1:!0});c.addChild(new dijit.ToolbarSeparator);c.addChild(d);c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({id:"TendererSetting-"+a.project.id+"-LogRateRow-button",label:"Log",iconClass:"icon-16-container icon-16-diary",disabled:-1<b.selection.selectedIndex?!1:!0,onClick:function(g){if(-1<b.selection.selectedIndex){var h=b.getItem(b.selection.selectedIndex);
if(h&&0<parseInt(String(h.id))){var k=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});k.show().then(function(){dojo.xhrGet({url:"viewTenderer/getTendererLogCount",handleAs:"json",content:{pid:a.project.id,cid:h.id}}).then(function(m){(new G({project:a.project,company:h,logData:m})).show();k.hide()})})}}}}));c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({id:"TendererSetting-"+a.project.id+"-RefreshRateRow-button",label:e.refresh,iconClass:"icon-16-container icon-16-reload",
disabled:-1<b.selection.selectedIndex?!1:!0,onClick:function(g){if(-1<b.selection.selectedIndex){var h=b.getItem(b.selection.selectedIndex),k=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});k.show().then(function(){dojo.xhrPost({url:"viewTenderer/refreshContractorRates",content:{pid:a.project.id,cid:h.id},handleAs:"json",load:function(m){k.hide();m.success&&(b.store.save(),b.store.close(),b._refresh(),1==h.show[0]&&dijit.byId("main-project_breakdown").content.reconstructBillContainer())},
error:function(m){k.hide()}})})}}}));c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({id:"TendererSetting-"+a.project.id+"-PrintRateRow-button",label:e.printContractorRates,iconClass:"icon-16-container icon-16-print",disabled:-1<b.selection.selectedIndex?!1:!0,onClick:dojo.hitch(this,"printRates")}));var f=new z({style:"display: none;"});dojo.forEach(["nameAsc","nameDesc","highestToLowest","lowestToHighest"],function(g){var h=new p({label:e[g],onClick:function(){b.sortBy(g)}});
f.addChild(h)});c.addChild(new dijit.ToolbarSeparator);c.addChild(new y({label:e.sort,name:"sortBy",dropDown:f}));a.addChild(c);a.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}))},exportRates:function(a){var b=this.grid;-1<b.selection.selectedIndex&&(b=b.getItem(b.selection.selectedIndex),J({title:e.exportContractorRates+" ("+(a?e.withNotListedItem:e.withoutNotListedItem)+")",project:this.project,company:b,withNotListedItem:a,exportUrl:"viewTenderer/exportContractorRates"}).show())},
printRates:function(){var a=this.grid;-1<a.selection.selectedIndex&&(a=a.getItem(a.selection.selectedIndex),(new F({projectId:parseInt(String(this.project.id)),tenderAlternative:this.tenderAlternative,title:e.printBQ+" :: "+a.name,contractor:a,_csrf_token:String(a._csrf_token)})).show())}}),M=n("buildspace.apps.ViewTenderer.AssignContractorForm",[r,t,u,v,dojox.form.manager._Mixin,dojox.form.manager._NodeMixin,dojox.form.manager._ValueMixin,dojox.form.manager._DisplayMixin],{templateString:D,disableEditing:!1,
project:null,region:"top",style:"outline:none;",baseClass:"buildspace-form",nls:e,contractorGrid:null,formValues:[],startup:function(){this.inherited(arguments);this.setFormValues(this.formValues)},postCreate:function(){this.inherited(arguments);this.selectStore=new dojo.data.ItemFileReadStore({url:"viewTenderer/getContractorList/id/"+this.project.id,clearOnClose:!0});this.selectContractor=(new A({id:"assignContractorSelect",name:"tender_company[company_id]",store:this.selectStore,style:"width:520px;padding:2px;",
required:!0,disabled:this.disableEditing,searchAttr:"name"})).placeAt(this.contractorSelectDivNode);this.disableEditing&&this.saveBtn.set("disabled",!0)},submit:function(){var a=this,b=dojo.formToObject(this.id),c=buildspace.dialog.indeterminateProgressBar({title:e.savingData+". "+e.pleaseWait+"..."}),d={url:"viewTenderer/tenderCompanyAdd",content:b,handleAs:"json",load:function(f){dojo.query('[id^="error-"]').forEach(function(h){h.innerHTML=""});if(1==f.success)a.setFormValues(a.formValues),a.selectContractor.store.close(),
a.selectContractor.set("store",a.selectStore),a.selectContractor.set("value",""),a.contractorGrid.store.close(),a.contractorGrid._refresh();else{f=f.errors;for(var g in f)a["error-"+g]&&C.set(a["error-"+g],f[g])}c.hide()},error:function(f){c.hide()}};this.validate()&&c.show().then(function(){dojo.xhrPost(d)})}});return n("buildspace.apps.ViewTenderer.AssignContractorDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:e.assignContractors,disableEditing:!1,project:null,tenderAlternative:null,
formValues:[],buildRendering:function(){var a=this.createContent();a.startup();this.content=a;this.title=e.assignContractors+" :: "+buildspace.truncateString(this.project.title,45);this.inherited(arguments)},postCreate:function(){x.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==w.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createContent:function(){var a=new dijit.layout.BorderContainer({style:"padding:0px;width:850px;height:350px;",
gutters:!1}),b=new H,c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;border-right:0px;border-left:0px;border-top:0px;"}),d=this.tenderAlternative?parseInt(String(this.tenderAlternative.id)):-1,f=new dijit.layout.BorderContainer({style:"padding-bottom:5px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"});d=new dojo.data.ItemFileWriteStore({url:"viewTenderer/getContractors/id/"+parseInt(String(this.project.id))+"/tid/"+d,clearOnClose:!0});b=
new L({project:this.project,tenderAlternative:this.tenderAlternative,disableEditing:this.disableEditing,gridOpts:{id:"viewTenderer-contractorGrid_"+this.project.id,store:d,structure:{cells:[[{name:e.show,field:"show",width:"50px",styles:"text-align:center;",type:dojox.grid.cells.Bool,editable:!0,alwaysEditing:!0,rowSpan:2},{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter,rowSpan:2},{name:e.name,field:"name",width:"auto",rowSpan:2},{name:e.originalTotal,
field:"total",width:"120px",headerClasses:"typeHeader1",styles:"text-align:right;",formatter:b.unEditableCurrencyCellFormatter},{name:e.adjustedTotal,field:"adjusted_total",headerClasses:"typeHeader1",width:"120px",styles:"text-align:right;",formatter:b.unEditableCurrencyCellFormatter},{name:e.action,field:"awarded",width:"80px",styles:"text-align:center;",formatter:b.selectedCellFormatter,rowSpan:2}],[{colSpan:2,headerClasses:"staticHeader typeHeader1",headerId:1,hidden:!1,name:e.diff+": "+l.format(0),
styles:"text-align:center;"}]]}}});d=new M({project:this.project,formValues:this.formValues,contractorGrid:b.grid,disableEditing:this.disableEditing});c.addChild(new dijit.form.Button({label:e.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));f.addChild(d);f.addChild(b);a.addChild(c);a.addChild(f);return a}})});
