define("dojo/_base/declare dojo/aspect dojo/_base/event dojo/when dijit/Menu dojo/keys dojo/on buildspace/widget/grid/cells/Formatter dijit/Tooltip ./rfqRateSelectionGrid dojo/i18n!buildspace/nls/ResourceLibrary".split(" "),function(n,p,k,q,u,r,h,l,v,t,a){return n("buildspace.apps.ResourceLibrary",buildspace.apps._App,{win:null,toolbarActions:["edit","delete"],init:function(b){var c=this;this.win=new buildspace.widget.Window({title:a.appName,onClose:dojo.hitch(this,"kill")});var d=new dijit.Toolbar({region:"top",
style:"padding:2px;width:100%;"});d.addChild(new dijit.form.Button({label:a.newResource,iconClass:"icon-16-container icon-16-add",style:"outline:none!important;",onClick:dojo.hitch(c,"addResource")}));dojo.forEach(this.toolbarActions,function(b){d.addChild(new dijit.ToolbarSeparator);d.addChild(new dijit.form.Button({id:"resourceLibrary-toolbar_"+b,label:a[b],iconClass:"icon-16-container icon-16-"+b,style:"outline:none!important;",disabled:!0,onClick:dojo.hitch(c,b+"Resource")}))});d.addChild(new dijit.ToolbarSeparator);
d.addChild(new dijit.form.Button({label:a.toggleSidebar,iconClass:"icon-16-container icon-16-arrow_bidirectional",style:"outline:none!important;",onClick:dojo.hitch(c,"toggleSidebar")}));b=this.tabArea=new dijit.layout.TabContainer({region:"center",style:"width:100%;height:100%;"});var e=this.libraryStore=new dojo.data.ItemFileWriteStore({url:"resourceLibrary/resourceList"}),f=new dijit.tree.ForestStoreModel({store:e,rootId:"root",rootLabel:a.resources}),g=this.left=new dijit.EditableTree({model:f,
splitter:!0,region:"left",openOnClick:!0,ajaxSubmitUrl:"resourceLibrary/resourceUpdate",onSuccess:function(b){c.updateTabTitle(b)},labelAttr:"name",style:"background-color:#ecede9;width:170px;height:100%;",getIconClass:dojo.hitch(e,function(c,b){return c.root?b?"icon-16-container icon-16-file":"icon-16-container icon-16-folder":"icon-16-container icon-16-list"}),onMouseDown:function(b){var a=dijit.getEnclosingWidget(b.target);a&&a.item&&a.item.root&&c.disableToolbarButtons(!0);if(dojo.mouseButtons.isRight(b))try{this.set("selectedNode",
a)}catch(m){k.stop(b)}k.stop(b)},onClick:function(b,a){a.item&&"root"!=a.item.id&&c.disableToolbarButtons(!1)}});h(g.domNode,h.selector(".dijitTree","contextmenu"),function(b){k.stop(b)});h(g.domNode,h.selector(".dijitTreeNode","contextmenu"),function(b){var a=new dijit.Menu,d={target:b.target,coords:b.keyCode!==r.F10&&"pageX"in b?{x:b.pageX,y:b.pageY}:null};a&&g.selectedItem&&(c.disableToolbarButtons(g.selectedItem.root?!0:!1),c.treeContextMenuItems(a),a._openMyself(d));k.stop(b)});e=this.borderContainer=
new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});dojo.connect(g,"onDblClick",this,"onItem");e.addChild(d);e.addChild(g);e.addChild(b);this.win.addChild(e);this.win.show();this.win.startup()},toggleSidebar:function(){0<=this.borderContainer.getIndexOfChild(this.left)?this.borderContainer.removeChild(this.left):this.borderContainer.addChild(this.left)},disableToolbarButtons:function(b){dojo.forEach(this.toolbarActions,function(a){dijit.byId("resourceLibrary-toolbar_"+
a)._setDisabledAttr(b)})},updateTabTitle:function(b){var a=this.tabArea,d=a.getChildren();this.left.model.store.fetchItemByIdentity({identity:b,onItem:function(b){for(var c in d)if("object"==typeof d[c].lib_info&&d[c].lib_info.id==b.id){d[c].lib_info.name=b.name;d[c].set("title",buildspace.truncateString(b.name,25));a.resize();break}}})},addResource:function(){var b=this,a=this.libraryStore;dojo.xhrPost({url:"resourceLibrary/resourceAdd",handleAs:"json",load:function(c){c.success&&(a.newItem({id:c.item.id,
name:c.item.name,can_be_deleted:c.item.can_be_deleted,_csrf_token:c.item._csrf_token}),a.save(),0>b.borderContainer.getIndexOfChild(b.left)&&b.borderContainer.addChild(b.left))},error:function(b){}})},editResource:function(){this.left._itemNodesMap[this.left.selectedNode.item.id][0].labelWidget.edit()},deleteResource:function(){var b=this,c=this.left.selectedNode.item,d=this.libraryStore,e=buildspace.dialog.indeterminateProgressBar({title:a.deleting+". "+a.pleaseWait+"..."}),f=dijit.byId("TreeInlineEditBox_error-tooltip");
f&&f.destroyRecursive();c.can_be_deleted[0]?buildspace.dialog.confirm(a.confirmation,"<div>"+a.deleteResourceAndAllData+"</div>",60,280,function(){e.show();dojo.xhrPost({url:"resourceLibrary/resourceDelete",content:{id:c.id,_csrf_token:c._csrf_token},handleAs:"json",load:function(a){if(a.success){a=b.tabArea.getChildren();for(var g in a)if("object"==typeof a[g].lib_info&&a[g].lib_info.id==c.id){b.tabArea.removeChild(a[g]);break}d.deleteItem(c);d.save();e.hide()}b.disableToolbarButtons(!0)},error:function(a){e.hide()}})}):
new buildspace.dialog.alert(a.deleteLinkResourceTitle,a.deleteLinkResourceMsg,60,300)},treeContextMenuItems:function(b){var c=this.left;"root"==this.left.selectedItem.id?(b.addChild(new dijit.MenuItem({label:a.newResource,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addResource")})),b.addChild(new dijit.MenuItem({label:a.reload,iconClass:"icon-16-container icon-16-reload",onClick:function(){c.model._requeryTop();c.collapseAll();c.expandAll()}}))):(b.addChild(new dijit.MenuItem({label:a.edit,
iconClass:"icon-16-container icon-16-edit",onClick:dojo.hitch(this,"editResource")})),b.addChild(new dijit.MenuItem({label:a.delete,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteResource")})))},makeTab:function(b,c,d){var e=dijit.byId("resourceLibraryGrid"+b+"-stackContainer");e&&dijit.byId("resourceLibraryGrid"+b+"-stackContainer").destroyRecursive();e=new dijit.layout.StackContainer({style:"width:100%;height:100%;",region:"center",id:"resourceLibraryGrid"+b+"-stackContainer"});
e.addChild(new dijit.layout.ContentPane({title:a.elements,content:d,grid:d.grid}));d=new dijit.layout.StackController({region:"top",containerId:"resourceLibraryGrid"+b+"-stackContainer"});var f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});f.addChild(e);f.addChild(new dijit.layout.ContentPane({style:"padding: 0px; overflow: hidden;",class:"breadCrumbTrail",region:"top",content:d}));e=new dijit.layout.ContentPane({closable:!0,style:"padding: 0px; overflow: hidden;",
title:buildspace.truncateString(c,25),content:f});this.tabArea.addChild(e);this.tabArea.selectChild(e);dojo.subscribe("resourceLibraryGrid"+b+"-stackContainer-selectChild","",function(a){var c=dijit.byId("resourceLibraryGrid"+b+"-stackContainer");if(c){var e=c.getChildren(),d=dojo.indexOf(e,a);d+=1;if(e.length>d){for(;e.length>d;)c.removeChild(e[d]),e[d].destroyRecursive(!0),d+=1;var g=a.grid.selection.selectedIndex;a.grid.store.save();a.grid.store.close();var f=p.after(a.grid,"_onFetchComplete",
function(){f.remove();-1<g&&(this.scrollToRow(g),this.selection.setSelected(g,!0))});a.grid.sort()}}});e.lib_info={name:c,id:b}},onItem:function(b){this.disableToolbarButtons(!0);var c=this.libraryStore;if(c.isItem(b)){var d=c.getValue(b,"id");b=c.getValue(b,"name");if("root"!=d){c=this.tabArea.getChildren();for(var e in c)if("object"==typeof c[e].lib_info&&c[e].lib_info.id==d)return this.tabArea.selectChild(c[e]);c=dojo.data.ItemFileWriteStore({url:"resourceLibrary/getTradeList/id/"+d,clearOnClose:!0,
urlPreventCache:!0});var f=this;e=new l;c=f.grid=buildspace.apps.ResourceLibrary.grid({id:"trade-page-container-"+d,stackContainerTitle:b,pageId:"page-"+d,libraryId:d,gridOpts:{store:c,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:e.rowCountCellFormatter},{name:a.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea"},{name:a.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],addUrl:"resourceLibrary/tradeAdd",
updateUrl:"resourceLibrary/tradeUpdate",checkBeforeDeleteUrl:"resourceLibrary/tradeLinkCheckBeforeDelete",deleteUrl:"resourceLibrary/tradeDelete",pasteUrl:"resourceLibrary/tradePaste",onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&f.createItemGrid(d,a)},deleteLinkNotificationTitle:a.deleteLinkedTradeNoticationTitle,deleteLinkNotificationMsg:a.deleteLinkedTradeNoticationMsg,deleteLinkNormalTitle:a.deleteTradeNormalTitle,deleteLinkNormalMsg:a.deleteTradeNormalMsg}});
f.makeTab(d,b,c)}}},createItemGrid:function(b,c){var d=this,e=l(),f=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],g=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID],k=new dojo.data.ItemFileWriteStore({url:"resourceLibrary/getItemList/id/"+c.id,clearOnClose:!0,
urlPreventCache:!0}),h=dojo.xhrGet({url:"resourceLibrary/getUnits",handleAs:"json"}),m=buildspace.dialog.indeterminateProgressBar({title:a.pleaseWait+"..."});m.show();return q(h,function(h){m.hide();buildspace.apps.ResourceLibrary.grid({id:"item-page-container-"+b,stackContainerTitle:c.description,pageId:"item-page-"+c.id,libraryId:b,tradeId:c.id,type:"tree",gridOpts:{store:k,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:e.rowCountCellFormatter},{name:a.description,
field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:e.treeCellFormatter},{name:a.type,field:"type",width:"70px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:f,values:g,formatter:e.typeCellFormatter},{name:a.constant,field:"constant-value",width:"160px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:e.formulaCurrencyCellFormatter},{name:a.unit,field:"uom_id",
width:"70px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:h.options,values:h.values,formatter:e.unitIdCellFormatter},{name:a.rate,field:"rate-value",width:"100px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:e.formulaCurrencyCellFormatter},{name:a.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:e.formulaCurrencyCellFormatter},
{name:a.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],addUrl:"resourceLibrary/itemAdd",updateUrl:"resourceLibrary/itemUpdate",checkBeforeDeleteUrl:"resourceLibrary/itemLinkCheckBeforeDelete",deleteUrl:"resourceLibrary/itemDelete",pasteUrl:"resourceLibrary/itemPaste",indentUrl:"resourceLibrary/itemIndent",outdentUrl:"resourceLibrary/itemOutdent",deleteLinkNotificationTitle:a.deleteLinkedItemNoticationTitle,deleteLinkNotificationMsg:a.deleteLinkedItemNoticationMsg,deleteLinkNormalTitle:a.deleteItemNormalTitle,
deleteLinkNormalMsg:a.deleteItemNormalMsg,onRowDblClick:function(a){var c=this.getItem(a.rowIndex);colField=a.cell.field;0<c.id&&null!==c.description[0]&&c.type[0]===buildspace.constants.HIERARCHY_TYPE_WORK_ITEM&&"rate-value"===colField&&d.createItemSupplierRateGrid(b,c)}}})},function(a){})},createItemSupplierRateGrid:function(b,c){var d=l(),e=new dojo.data.ItemFileWriteStore({url:"resourceLibrary/getItemSupplierRateList/resourceItemId/"+c.id,clearOnClose:!0}),f=buildspace.dialog.indeterminateProgressBar({title:a.pleaseWait+
"..."});f.show();dojo.xhrGet({url:"resourceLibrary/getSelectedRatesFromRFQ/resourceItemId/"+c.id,handleAs:"json",load:function(g){new t({stackContainerTitle:c.description,pageId:"item-supplier-rate-page-"+c.id,type:"rateSelection",libraryId:b,gridOpts:{formInfo:g.formInformation,itemId:c.id,store:e,structure:[{name:a.supplierName,field:"company_name",width:"250px"},{name:a.projectName,field:"project_title",width:"250px"},{name:a.country,field:"country",width:"100px",styles:"text-align: center;"},
{name:a.state,field:"state",width:"100px",styles:"text-align: center;"},{name:a.rate,field:"rate",width:"120px",styles:"text-align:center;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:d.rfqQuantityCellFormatter},{name:a.remarks,field:"remarks",width:"auto"},{name:a.lastUpdated,field:"rate_last_updated_at",width:"120px",styles:"text-align: center;"}],addUrl:"resourceLibrary/itemAdd",updateUrl:"resourceLibrary/itemUpdate",checkBeforeDeleteUrl:"resourceLibrary/itemLinkCheckBeforeDelete",
deleteUrl:"resourceLibrary/itemDelete",pasteUrl:"resourceLibrary/itemPaste",indentUrl:"resourceLibrary/itemIndent",outdentUrl:"resourceLibrary/itemOutdent",deleteLinkNotificationTitle:a.deleteLinkedItemNoticationTitle,deleteLinkNotificationMsg:a.deleteLinkedItemNoticationMsg,deleteLinkNormalTitle:a.deleteItemNormalTitle,deleteLinkNormalMsg:a.deleteItemNormalMsg}});f.hide()},error:function(a){f.hide()}})},kill:function(){var a=dijit.byId("TreeInlineEditBox_error-tooltip");a&&a.destroyRecursive();this.win&&
"undefined"!=typeof this.win&&this.win.close()}})});
