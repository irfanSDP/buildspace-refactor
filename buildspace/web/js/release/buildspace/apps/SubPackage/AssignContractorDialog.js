define("buildspace/apps/SubPackage/AssignContractorDialog","dojo/_base/declare dijit/form/Form dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/form/FilteringSelect dojo/aspect dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style dojo/text!./templates/assignContractorForm.html ./AssignUnitDialog ./ExportSubPackageByContractorDialog ./BillPrintoutSetting/PrintBillDialog buildspace/widget/grid/cells/Formatter dojox/grid/enhanced/plugins/IndirectSelection ./importRatesDialog dijit/form/DropDownButton dijit/DropDownMenu dijit/Menu dijit/MenuItem dijit/PopupMenuItem dojo/i18n!buildspace/nls/SubPackages".split(" "),
function(h,p,q,P,r,t,z,Q,A,R,B,C,S,u,v,D,E,F,G,H,T,I,w,x,J,g,K,c){var L=h("buildspace.apps.SubPackage.SubContractorGrid",dojox.grid.EnhancedGrid,{rootProject:null,subPackage:null,subPackageGrid:null,disableEditing:!1,style:"border-top:none;",region:"center",canSort:function(a){return!1},postCreate:function(){this.inherited(arguments);this.on("RowClick",function(a){(a=this.getItem(a.rowIndex))&&0<a.id?this.disableToolbarButtons(!1):this.disableToolbarButtons(!0)});this.on("CellClick",function(a){var b=
a.cell.field;a=this.getItem(a.rowIndex);"selected"==b&&a&&0<a.id&&!this.disableEditing&&this.saveAsSelectedContractor(a)})},dodblclick:function(a){this.onRowDblClick(a)},deleteCompany:function(a){var b=this,d=c.removeSubContractorFromSubPackage+" "+buildspace.truncateString(this.subPackage.name,25),e=c.areYouSureToRemove+" "+buildspace.truncateString(a.name,30)+"?",f=buildspace.dialog.indeterminateProgressBar({title:c.deleting+". "+c.pleaseWait+"..."});new buildspace.dialog.confirm(d,e,80,400,function(){f.show().then(function(){dojo.xhrPost({url:"subPackage/subPackageCompanyDelete",
content:{sid:b.subPackage.id,cid:a.id,_csrf_token:a._csrf_token},handleAs:"json",load:function(d){d.success&&(b.selection.deselectAll(),b.store.deleteItem(a),b.store.save(),b.store.close(),b.sort(),b.subPackageGrid.store.save(),b.subPackageGrid.store.close(),b.subPackageGrid.sort(),dijit.byId("assignSubContractorSelect").store.close());f.hide()},error:function(a){f.hide()}})})},function(){})},assignTypesAndUnits:function(){E({rootProject:this.rootProject,subPackage:this.subPackage,assignContractorGrid:this,
subPackageGrid:this.subPackageGrid}).show()},disableToolbarButtons:function(a,b){var d=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"-DeleteRow-button"),c=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"-ImportRateRow-button"),f=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"-ExportExcelRow-button"),k=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"ImportBuildspaceRatesRow-button"),l=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"ExportBuildspaceRatesRow-button"),
y=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"-AssignUnit-button"),g=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"-PrintBQRow-button"),m=dijit.byId("SubPackages_subCons-"+this.subPackage.id+"ExportWithSubConRateRow-button");this.disableEditing?(d&&d._setDisabledAttr(!0),c&&c._setDisabledAttr(!0),f&&f._setDisabledAttr(!0),y&&y._setDisabledAttr(!0),g&&g._setDisabledAttr(!0),m&&m._setDisabledAttr(!0),k&&k._setDisabledAttr(!0),l&&l._setDisabledAttr(!0)):(d&&d._setDisabledAttr(a),c&&
c._setDisabledAttr(a),f&&f._setDisabledAttr(a),g&&g._setDisabledAttr(a),m&&m._setDisabledAttr(a),k&&k._setDisabledAttr(a),l&&l._setDisabledAttr(a));if(a&&b instanceof Array){var h=this;dojo.forEach(b,function(a){(a=dijit.byId("SubPackages_subCons-"+h.subPackage.id+"-"+a+"Row-button"))&&a._setDisabledAttr(!1)})}},sortBy:function(a){var b=this,d,e=buildspace.dialog.indeterminateProgressBar({title:c.sorting+". "+c.pleaseWait+"..."});switch(a){case "nameDesc":d=2;break;case "highestToLowest":d=4;break;
case "lowestToHighest":d=8;break;default:d=1}e.show().then(function(){dojo.xhrPost({url:"subPackage/sortUpdate",content:{sid:b.subPackage.id,opt:d,_csrf_token:b.subPackage._csrf_token},handleAs:"json",load:function(a){a.success&&(a=b.store,a.save(),a.close(),b.sort());e.hide()},error:function(a){e.hide()}})})},saveAsSelectedContractor:function(a){var b=this,d=buildspace.dialog.indeterminateProgressBar({title:c.pleaseWait+"..."});d.show().then(function(){dojo.xhrPost({url:"subPackage/setSelectedCompany",
content:{sid:b.subPackage.id,cid:a.id,_csrf_token:a._csrf_token},handleAs:"json",load:function(c){b.selection.deselectAll();b.store.close();b.sort();b.subPackageGrid.store.save();b.subPackageGrid.store.close();b.subPackageGrid.sort();b.store.fetchItemByIdentity({identity:a.id,onItem:function(a){a&&(a=b.getItemIndex(a),b.selection.setSelected(a,!0))}});(c=dijit.byId("SubPackages-"+b.rootProject.id+"-PushToPostContractRow-button"))&&b.rootProject.status_id[0]==buildspace.constants.STATUS_POSTCONTRACT&&
c._setDisabledAttr(!1);d.hide()},error:function(a){d.hide()}})})}}),M=h("buildspace.apps.ProjectBuilder.ExportBillForm",[p,q,r,t,dojox.form.manager._Mixin,dojox.form.manager._NodeMixin,dojox.form.manager._ValueMixin,dojox.form.manager._DisplayMixin],{templateString:'<form data-dojo-attach-point="containerNode"><table class="table-form"><tr><td class="label" style="width:80px;"><label style="display: inline;"></span>'+c.downloadAs+' :</label></td><td><input type="text" name="filename" style="padding:2px;width:220px;" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="trim:true, propercase:true, required: true"><input type="hidden" name="pid" value=""><input type="hidden" name="sid" value=""><input type="hidden" name="cid" value=""><input type="hidden" name="with_rate" value=""><input type="hidden" name="_csrf_token" value=""></td></tr></table></form>',
project:null,subPackage:null,contractor:null,region:"center",dialogWidget:null,exportUrl:null,withRate:null,style:"outline:none;padding:0;margin:0;border:none;",baseClass:"buildspace-form",startup:function(){this.inherited(arguments);this.setFormValues({filename:this.contractor?this.subPackage.name+"_"+this.contractor.name:this.subPackage.name,pid:this.project.id,sid:this.subPackage.id,cid:this.contractor?this.contractor.id:"",with_rate:this.withRate,_csrf_token:this.subPackage._csrf_token})},submit:function(){if(this.validate()&&
this.exportUrl){var a=dojo.formToObject(this.id),b=a.filename.replace(/ /g,"_");buildspace.windowOpen("POST",this.exportUrl,{filename:b,pid:a.pid,sid:a.sid,cid:a.cid,with_rate:a.with_rate,_csrf_token:a._csrf_token});this.dialogWidget&&this.dialogWidget.hide()}}}),n=h("buildspace.apps.ProjectBuilder.ExportBillDialog",dijit.Dialog,{style:"padding:0px;margin:0;",title:c.downloadZipFile,project:null,subPackage:null,contractor:null,exportUrl:null,withRate:null,buildRendering:function(){var a=this.createContent();
a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){v.set(this.containerNode,{padding:"0",margin:"0"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==u.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createContent:function(){var a=new dijit.layout.BorderContainer({style:"padding:0;width:400px;height:80px;",gutters:!1}),b=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"}),
d=M({project:this.project,subPackage:this.subPackage,contractor:this.contractor,exportUrl:this.exportUrl,withRate:this.withRate,dialogWidget:this});b.addChild(new dijit.form.Button({label:c.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));b.addChild(new dijit.ToolbarSeparator);b.addChild(new dijit.form.Button({label:c.download,iconClass:"icon-16-container icon-16-import",style:"outline:none!important;",onClick:dojo.hitch(d,"submit")}));
a.addChild(b);a.addChild(d);return a}}),N=h("buildspace.apps.SubPackage.SubContractorGridContainer",dijit.layout.BorderContainer,{style:"padding:0px;border:0px;width:100%;height:100%;",gutters:!1,region:"center",subPackage:null,rootProject:null,subPackageGrid:null,disableEditing:!1,grid:null,gridOpts:{},postCreate:function(){var a=this;this.inherited(arguments);A.mixin(this.gridOpts,{rootProject:this.rootProject,subPackage:this.subPackage,disableEditing:this.disableEditing,subPackageGrid:this.subPackageGrid,
region:"center"});var b=this.grid=new L(this.gridOpts),d=new dijit.Toolbar({region:"top",style:"padding:2px;border:0px;width:100%;"});d.addChild(new dijit.form.Button({id:"SubPackages_subCons-"+a.subPackage.id+"-DeleteRow-button",label:c.removeSubContractor,iconClass:"icon-16-container icon-16-delete",disabled:-1<b.selection.selectedIndex&&!a.disableEditing?!1:!0,onClick:function(a){-1<b.selection.selectedIndex&&(a=b.getItem(b.selection.selectedIndex))&&0<a.id&&(b.disableToolbarButtons(!0),b.deleteCompany(a))}}));
d.addChild(new dijit.ToolbarSeparator);var e=new x({style:"display: none;"}),f=new J;f.addChild(new g({id:"SubPackages_subCons-"+a.subPackage.id+"ExportWithSubConRateRow-button",label:c.withSubConRates,disabled:!0,onClick:function(c){(c=b.getItem(b.selection.selectedIndex))&&0<c.id&&n({project:a.rootProject,subPackage:a.subPackage,contractor:c,withRate:!0,exportUrl:"subPackageExportFile/exportSubPackage"}).show()}}));f.addChild(new g({id:"SubPackages_subCons-"+a.subPackage.id+"ExportWithEstimationnRateRow-button",
label:c.withEstimationRates,onClick:function(b){n({project:a.rootProject,subPackage:a.subPackage,withRate:!0,exportUrl:"subPackageExportFile/exportSubPackage"}).show()}}));f.addChild(new g({id:"SubPackages_subCons-"+a.subPackage.id+"ExportWithoutRateRow-button",label:c.withoutRates,onClick:function(b){n({project:a.rootProject,subPackage:a.subPackage,withRate:!1,exportUrl:"subPackageExportFile/exportSubPackage"}).show()}}));e.addChild(new K({id:"SubPackages_subCons-"+a.subPackage.id+"ExportBuildspaceFileRow-button",
label:c.exportBuildspaceFile,popup:f}));e.addChild(new g({id:"SubPackages_subCons-"+a.subPackage.id+"-ExportExcelRow-button",label:c.importExportExcel,onClick:function(d){if(-1<b.selection.selectedIndex){var e=b.getItem(b.selection.selectedIndex);if(e&&0<e.id){var f=dojo.xhrGet({url:"subPackage/getAllowedExportedBills",handleAs:"json",content:{id:a.subPackage.id,company_id:e.id}}),l=buildspace.dialog.indeterminateProgressBar({title:c.pleaseWait+"..."});l.show().then(function(){B(f,function(b){l.hide();
(new F({title:c.importExportSubPackage+" ("+buildspace.truncateString(e.name,60)+")",data:b,subPackage:a.subPackage,company:e,subPackageGrid:a.subPackageGrid,subContractorGridContainer:a})).show()})})}}},disabled:-1<b.selection.selectedIndex&&!a.disableEditing?!1:!0}));e.addChild(new g({id:"SubPackages_subCons-"+a.subPackage.id+"ImportBuildspaceRatesRow-button",label:c.importTenderRates,disabled:-1<b.selection.selectedIndex&&!a.disableEditing?!1:!0,onClick:function(d){-1<b.selection.selectedIndex&&
(d=b.getItem(b.selection.selectedIndex))&&0<d.id&&(new I({title:c.importSubContractorRates,contractorGrid:b,subPackageGrid:a.subPackageGrid,project:a.rootProject,subPackage:a.subPackage,company:d})).show()}}));e.addChild(new g({id:"SubPackages_subCons-"+a.subPackage.id+"ExportBuildspaceRatesRow-button",label:c.exportTenderRates,disabled:-1<b.selection.selectedIndex&&!a.disableEditing?!1:!0,onClick:function(c){(c=b.getItem(b.selection.selectedIndex))&&0<c.id&&n({project:a.rootProject,subPackage:a.subPackage,
contractor:c,exportUrl:"subPackageExportFile/exportContractorRates"}).show()}}));d.addChild(new w({id:"SubPackages_subCons-"+a.subPackage.id+"ImportExportDropDownRow-button",label:c.importExportSubPackage,iconClass:"icon-16-container icon-16-export",dropDown:e}));d.addChild(new dijit.ToolbarSeparator);d.addChild(new dijit.form.Button({id:"SubPackages_subCons-"+a.subPackage.id+"-PrintBQRow-button",label:c.printBQ,iconClass:"icon-16-container icon-16-print",disabled:-1<b.selection.selectedIndex&&!a.disableEditing?
!1:!0,onClick:function(c){c=b.getItem(b.selection.selectedIndex);(new G({subPackage:a.subPackage,subContractorId:c.id})).show()}}));var k=new x({style:"display: none;"});dojo.forEach(["nameAsc","nameDesc","highestToLowest","lowestToHighest"],function(a){var d=new g({label:c[a],onClick:function(){b.sortBy(a)}});k.addChild(d)});d.addChild(new dijit.ToolbarSeparator);d.addChild(new dijit.form.Button({id:"SubPackages_subCons-"+a.subPackage.id+"-AssignUnit-button",label:c.assignTypesAndUnits,iconClass:"icon-16-container icon-16-add",
disabled:a.disableEditing?!0:!1,onClick:function(a){b.assignTypesAndUnits()}}));d.addChild(new dijit.ToolbarSeparator);d.addChild(new w({label:c.sort,name:"sortBy",dropDown:k}));a.addChild(d);a.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}))}}),O=h("buildspace.apps.SubPackage.AssignContractorForm",[p,q,r,t,dojox.form.manager._Mixin,dojox.form.manager._NodeMixin,dojox.form.manager._ValueMixin,dojox.form.manager._DisplayMixin],{templateString:D,subPackage:null,
region:"top",style:"outline:none;",baseClass:"buildspace-form",nls:c,subContractorGrid:null,formValues:[],startup:function(){this.inherited(arguments);this.setFormValues(this.formValues)},postCreate:function(){this.inherited(arguments);this.selectStore=new dojo.data.ItemFileReadStore({url:"subPackage/getSubContractorList/id/"+this.subPackage.id,clearOnClose:!0});this.selectContractor=(new z({id:"assignSubContractorSelect",name:"sub_package_company[company_id]",store:this.selectStore,style:"width:520px;padding:2px;",
required:!0,disabled:this.disableEditing?!0:!1,searchAttr:"name"})).placeAt(this.contractorSelectDivNode);this.disableEditing&&this.saveBtn.set("disabled",!0)},submit:function(){var a=this,b=dojo.formToObject(this.id),d=buildspace.dialog.indeterminateProgressBar({title:c.savingData+". "+c.pleaseWait+"..."});this.validate()&&d.show().then(function(){dojo.xhrPost({url:"subPackage/subPackageCompanyAdd",content:b,handleAs:"json",load:function(b){dojo.query('[id^="error-"]').forEach(function(a){a.innerHTML=
""});if(1==b.success)a.setFormValues(a.formValues),a.selectContractor.store.close(),a.selectContractor.set("store",a.selectStore),a.selectContractor.set("value",""),a.subContractorGrid.store.close(),a.subContractorGrid._refresh();else{b=b.errors;for(var c in b)a["error-"+c]&&C.set(a["error-"+c],b[c])}d.hide()},error:function(a){d.hide()}})})}});return h("buildspace.apps.SubPackage.AssignContractorDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:c.assignSubContractors,subPackage:null,rootProject:null,
subPackageGrid:null,disableEditing:!1,formValues:[],buildRendering:function(){var a=this.createContent();a.startup();this.content=a;this.title=c.assignSubContractors+" :: "+buildspace.truncateString(this.subPackage.name,45);this.inherited(arguments)},postCreate:function(){v.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==u.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createContent:function(){var a=
new dijit.layout.BorderContainer({style:"padding:0px;width:850px;height:350px;",gutters:!1}),b=new H,d=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;border-right:0px;border-left:0px;border-top:0px;"}),e=new dijit.layout.BorderContainer({style:"padding-bottom:5px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"}),f=new dojo.data.ItemFileWriteStore({url:"subPackage/getSubContractors/id/"+this.subPackage.id,clearOnClose:!0}),b=new N({subPackage:this.subPackage,
dialogObj:this,subPackageGrid:this.subPackageGrid,disableEditing:this.disableEditing,rootProject:this.rootProject,gridOpts:{store:f,rootProject:this.rootProject,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},{name:c.name,field:"name",width:"auto"},{name:c.total,field:"total",width:"120px",styles:"text-align:right;",formatter:b.unEditableCurrencyCellFormatter},{name:c.action,field:"selected",width:"80px",styles:"text-align:center;",formatter:b.selectedCellFormatter}]}}),
f=new O({subPackage:this.subPackage,formValues:this.formValues,subContractorGrid:b.grid,disableEditing:this.disableEditing});d.addChild(new dijit.form.Button({label:c.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));e.addChild(f);e.addChild(b);a.addChild(d);a.addChild(e);return a}})});
