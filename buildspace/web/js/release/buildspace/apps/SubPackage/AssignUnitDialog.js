define("buildspace/apps/SubPackage/AssignUnitDialog","dojo/_base/declare dojo/aspect dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/layout/ContentPane dojox/grid/EnhancedGrid buildspace/widget/grid/cells/Formatter dojox/grid/enhanced/plugins/IndirectSelection dojo/i18n!buildspace/nls/SubPackages".split(" "),function(f,k,p,l,v,w,x,q,r,y,z,A,B,C,t,m,D,d){var u=
f("buildspace.apps.SubPackage.AssignUnitGrid",t,{subPackage:null,rootProject:null,subPackageGrid:null,assignContractorGrid:null,bill:null,style:"border:none;",region:"center",pageId:null,dialogObj:null,gridType:null,keepSelection:!0,rowSelector:"0px",initialLoadSelector:!1,constructor:function(a){"bill"!=a.gridType&&(this.counterIds=[],this.connects=[],this.urlGetDescendantIds="subPackage/getTypeUnitDescendants",this.plugins={indirectSelection:{headerSelector:!0,width:"20px",styles:"text-align:center;"}});
this.inherited(arguments)},dodblclick:function(a){this.onRowDblClick(a)},postCreate:function(){var a=this;this.inherited(arguments);"tree"==this.gridType&&(k.after(this,"_onFetchComplete",function(){a.initialLoadSelector||(a.initialLoadSelector=!0,this.store.fetch({query:{selected:!0},queryOptions:{ignoreCase:!0},onComplete:this.markSelectedCheckBoxes,scope:this}))}),this._connects.push(l.connect(this,"onCellClick",function(b){a.selectTree(b)})),this._connects.push(l.connect(this.rowSelectCell,"toggleAllSelection",
function(b){a.toggleAllSelection(b)})))},markSelectedCheckBoxes:function(a,b){for(var c=0;c<a.length;c++){var e=a[c]._0;this.pushItemIdIntoGridArray(a[c],!0);this.rowSelectCell.toggleRow(e,!0)}},selectTree:function(a){a=a.rowIndex;var b=this.selection.selected[a];a=this.getItem(a);var c=this,e=this.store;if(0==a.level){var h=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});h.show();var g=-1;dojo.xhrGet({url:this.urlGetDescendantIds,content:{id:a.id},handleAs:"json",load:function(a){dojo.forEach(a.items,
function(a){e.fetchItemByIdentity({identity:a.id,onItem:function(a){a&&(g=a._0,1==a.level&&c.pushItemIdIntoGridArray(a,b),c.selection[b?"addToSelection":"deselect"](g))}})});h.hide()},error:function(a){h.hide()}})}else 1==a.level&&this.pushItemIdIntoGridArray(a,b)},pushItemIdIntoGridArray:function(a,b){var c=dojo.indexOf(this.counterIds,a.id[0]);b?-1==c&&-1!=a.count[0]&&this.counterIds.push(a.id[0]):-1!=c&&this.counterIds.splice(c,1)},toggleAllSelection:function(a){var b=this,c=b.selection;a?(c.selectRange(0,
b.rowCount-1),b.counterIds=[],b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.count&&b.counterIds.push(a.id[0])})}})):(c.deselectAll(),b.counterIds=[])},canSort:function(a){return!1},reload:function(){this.store.close();this._refresh()},assignUnit:function(){var a=this,b=this.counterIds,c=buildspace.dialog.indeterminateProgressBar({title:d.importing+". "+d.pleaseWait+"..."});c.show();dojo.xhrPost({url:"subPackage/assignUnits",content:{id:this.subPackage.id,bid:this.bill.id,
ids:[b],_csrf_token:this.subPackage._csrf_token},handleAs:"json",load:function(b){a.assignContractorGrid.store.close();a.assignContractorGrid.sort();a.subPackageGrid.store.save();a.subPackageGrid.store.close();a.subPackageGrid.sort();(b=dijit.byId("SubPackages-"+a.rootProject.id+"-PushToPostContractRow-button"))&&a.rootProject.status_id[0]==buildspace.constants.STATUS_POSTCONTRACT&&b._setDisabledAttr(!1);c.hide()},error:function(b){a.counterIds=[];c.hide();a.dialogObj.hide()}})}}),n=f("buildspace.apps.SubPackage.AssignUnitGridContainer",
dijit.layout.BorderContainer,{style:"padding:0px;border:0px;width:100%;height:100%;",gutters:!1,region:"center",url:null,subPackage:null,rootProject:null,subPackageGrid:null,assignContractorGrid:null,bill:null,disableEditing:!1,gridOpts:{},gridType:null,postCreate:function(){this.inherited(arguments);p.mixin(this.gridOpts,{gridType:this.gridType,bill:this.bill,subPackage:this.subPackage,rootProject:this.rootProject,subPackageGrid:this.subPackageGrid,assignContractorGrid:this.assignContractorGrid,
disableEditing:this.disableEditing,region:"center"});var a=this.grid=new u(this.gridOpts);if("tree"==this.gridType){var b=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});b.addChild(new dijit.form.Button({id:"SubPackages-"+this.subPackage.id+"-ApplyRow-button",label:d.assignTypesAndUnits,iconClass:"icon-16-container icon-16-save",onClick:function(){a.assignUnit()}}));this.addChild(b)}this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:a,region:"center"}));
if(b=dijit.byId("SubPackage-assign_unit_"+this.subPackage.id+"-stackContainer")){var c=document.createElement("div"),c=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,45),id:this.pageId,executeScripts:!0},c);b.addChild(c);c.set("content",this);b.selectChild(this.pageId)}}});return f("buildspace.apps.SubPackage.AssignUnitDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:null,disableEditing:!1,rootProject:null,subPackage:null,assignContractorGrid:null,
subPackageGrid:null,url:null,buildRendering:function(){var a=this.createForm();a.startup();this.content=a;this.title=d.assignTypesAndUnits;this.inherited(arguments)},postCreate:function(){this.title="lalalal";r.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==q.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createForm:function(){var a=this,b=new m,c=new dijit.layout.BorderContainer({style:"padding:0px;width:780px;height:350px;",
gutters:!1}),e=dojo.data.ItemFileWriteStore({url:"subPackage/getBillsToAssignUnit/spid/"+a.subPackage.id,clearOnClose:!0}),b=this.makeGridContainer(n({pageId:"SubPackageAssignUnit-page_bill-"+this.subPackage.id,id:"SubPackageAssignUnit-page_bill-"+this.subPackage.id,stackContainerTitle:this.subPackage.name,subPackage:this.subPackage,disableEditing:this.disableEditing,gridType:"bill",gridOpts:{dialogObj:this,structure:[{name:"No.",field:"count",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},
{name:d.title,field:"title",width:"auto"},{name:d.selectedUnits,field:"selected_units",styles:"text-align: right;",width:"120px"}],store:e,onRowDblClick:function(b){b=this.getItem(b.rowIndex);0<b.id&&a.createTypeItemGrid(b)}}}),this.subPackage.name),e=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});e.addChild(new dijit.form.Button({label:d.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));
c.addChild(e);c.addChild(b);return c},makeGridContainer:function(a,b){var c=this,e=this.subPackage.id,d=dijit.byId("SubPackage-push_to_post_contract_"+e+"-stackContainer");d&&dijit.byId("SubPackage-assign_unit_"+e+"-stackContainer").destroyRecursive();d=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"SubPackage-assign_unit_"+e+"-stackContainer"});d.addChild(new dijit.layout.ContentPane({title:buildspace.truncateString(b,45),content:a}));var g=new dijit.layout.StackController({region:"top",
containerId:"SubPackage-assign_unit_"+e+"-stackContainer"}),f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"});f.addChild(d);f.addChild(new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:g}));dojo.subscribe("SubPackage-assign_unit_"+e+"-stackContainer-selectChild","",function(a){var b=dijit.byId("SubPackage-assign_unit_"+e+"-stackContainer");if(b){var d=b.getChildren();
a=dojo.indexOf(d,dijit.byId(a.id));for(var f=0,g=d.length,f=a+=1;d.length>a;)b.removeChild(d[a]),d[a].destroyRecursive(!0),a+=1;if(1==f&&g>f&&(b=dijit.byId("SubPackageAssignUnit-page_bill-"+c.subPackage.id))){b.grid.store.save();b.grid.store.close();var h=k.after(b.grid,"_onFetchComplete",function(){h.remove();this.scrollToRow(this.selection.selectedIndex)});b.grid.sort()}}});return f},createTypeItemGrid:function(a){var b=new m,c=new dojo.data.ItemFileWriteStore({url:"subPackage/getUnitList/bid/"+
a.id+"/sid/"+this.subPackage.id});n({pageId:"SubPackageAssignUnit-page_item-"+a.id,stackContainerTitle:a.title,subPackage:this.subPackage,rootProject:this.rootProject,subPackageGrid:this.subPackageGrid,assignContractorGrid:this.assignContractorGrid,disableEditing:this.disableEditing,bill:a,gridType:"tree",gridOpts:{dialogObj:this,structure:[{name:"No.",field:"count",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",formatter:b.typeListTreeCellFormatter}],
store:c}})}})});
