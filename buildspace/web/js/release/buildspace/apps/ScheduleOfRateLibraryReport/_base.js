define("dojo/_base/declare dojo/dom-style dojo/request dojo/aspect dojo/when dojo/_base/event dijit/Menu dojo/keys dojo/on dojo/store/Memory dojo/dom-geometry dijit/Tooltip ./buildUpGrid ./buildUpSummary buildspace/widget/grid/cells/Formatter dojo/currency dijit/layout/AccordionContainer dijit/layout/AccordionPane dojo/i18n!buildspace/nls/ScheduleOfRateLibrary".split(" "),function(v,z,q,A,r,k,B,C,t,l,D,E,w,x,p,y,F,G,e){return v("buildspace.apps.ScheduleOfRateLibraryReport",buildspace.apps._App,{win:null,
selectedElementStore:[],selectedItemStore:[],elementItemStore:[],init:function(c){this.win=new buildspace.widget.Window({title:e.appName,onClose:dojo.hitch(this,"kill")});c=this.borderContainer=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});var a=new dijit.Toolbar({region:"top",style:"padding:2px;width:100%;"});a.addChild(new dijit.form.Button({label:e.toggleSidebar,iconClass:"icon-16-container icon-16-arrow_bidirectional",style:"outline:none!important;",
onClick:dojo.hitch(this,"toggleSidebar")}));var d=this.tabArea=new dijit.layout.TabContainer({region:"center",style:"width:100%;height:100%;"}),b=this.libraryStore=new dojo.data.ItemFileWriteStore({url:"scheduleOfRate/scheduleOfRateList"}),g=new dijit.tree.ForestStoreModel({store:b,rootId:"root",rootLabel:e.scheduleOfRates,childrenAttrs:["__children"]}),b=this.left=new dijit.EditableTree({model:g,splitter:!0,region:"left",openOnClick:!0,labelAttr:"name",style:"background-color:#ecede9;width:170px;height:100%;",
getIconClass:dojo.hitch(b,function(a,f){return a.root?f?"icon-16-container icon-16-file":"icon-16-container icon-16-folder":"icon-16-container icon-16-list"}),onMouseDown:function(a){var f=dijit.getEnclosingWidget(a.target);if(dojo.mouseButtons.isRight(a))try{this.set("selectedNode",f)}catch(n){k.stop(a)}k.stop(a)}});t(b.domNode,t.selector(".dijitTree","contextmenu"),function(a){k.stop(a)});dojo.connect(b,"onDblClick",this,"onItem");c.addChild(a);c.addChild(b);c.addChild(d);this.win.addChild(c);this.win.show();
this.win.startup()},toggleSidebar:function(){0<=this.borderContainer.getIndexOfChild(this.left)?this.borderContainer.removeChild(this.left):this.borderContainer.addChild(this.left)},makeTab:function(c,a,d){var b=dijit.byId("scheduleOfRate_report_"+c+"-stackContainer");b&&dijit.byId("scheduleOfRate_report_"+c+"-stackContainer").destroyRecursive();b=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"scheduleOfRate_report_"+c+"-stackContainer"});b.addChild(new dijit.layout.ContentPane({title:e.trade,
content:d,grid:d.grid}));d=new dijit.layout.StackController({region:"top",containerId:"scheduleOfRate_report_"+c+"-stackContainer"});var g=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1});g.addChild(b);g.addChild(new dijit.layout.ContentPane({id:"scheduleOfRate_report_"+c+"-controllerPane",style:"padding:0px;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:d}));b=new dijit.layout.ContentPane({closable:!0,style:"padding: 0px; overflow: hidden;border:0px;",
title:buildspace.truncateString(a,25),content:g});this.tabArea.addChild(b);this.tabArea.selectChild(b);dojo.subscribe("scheduleOfRate_report_"+c+"-stackContainer-selectChild","",function(a){var f=dijit.byId("scheduleOfRate_report_"+c+"-stackContainer");if(f){var b=f.getChildren();a=dojo.indexOf(b,a);a+=1;if(b.length>a)for(;b.length>a;)f.removeChild(b[a]),b[a].destroyRecursive(!0),a+=1}});b.lib_info={name:a,id:c}},onItem:function(c){var a=this.libraryStore;if(a.isItem(c)){var d=a.getValue(c,"id");
c=a.getValue(c,"name");if("root"!=d){var a=this.tabArea.getChildren(),b;for(b in a)if("object"==typeof a[b].lib_info&&a[b].lib_info.id==d)return this.tabArea.selectChild(a[b]);var a=dojo.data.ItemFileWriteStore({url:"scheduleOfRate/getTradeList/id/"+d,clearOnClose:!0}),g=this;b=new p;this.selectedElementStore[d]=new l({idProperty:"id"});this.selectedItemStore[d]=new l({idProperty:"id"});this.elementItemStore[d]=[];a=g.grid=buildspace.apps.ScheduleOfRateLibraryReport.grid({id:"trade-reportpage-container-"+
d,stackContainerTitle:c,pageId:"trade-reportpage-"+d,libraryId:d,gridOpts:{gridContainer:g,store:a,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea"},{name:e.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"},{name:e.recalculateResourceStatus,field:"recalculate_resource_status",width:"100px",styles:"text-align:center;",
formatter:b.recalculateSorCellFormatter}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&g.createItemGrid(d,a)},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);this.removedIds=[];if(a)return this.gridContainer.selectedElementStore[this.libraryId].put({id:b.id[0]}),this.getAffectedItemsByTrades(b,"add");this.gridContainer.selectedElementStore[this.libraryId].remove(b.id[0]);this.removedIds.push(b.id[0]);return this.getAffectedItemsByTrades(b,
"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;b.removedIds=[];if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer.selectedElementStore[b.libraryId].put({id:a.id[0]})})}}),b.getAffectedItemsByTrades(null,"add");c.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&(b.gridContainer.selectedElementStore[b.libraryId].remove(a.id[0]),b.removedIds.push(a.id[0]))})}});
return b.getAffectedItemsByTrades(null,"remove")},getAffectedItemsByTrades:function(a,b){var c=this,d=[],f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();if("add"===b)a?d.push(a.id[0]):c.gridContainer.selectedElementStore[c.libraryId].query().forEach(function(a){d.push(a.id)});else for(var g in c.removedIds)d.push(c.removedIds[g]);q.post("scheduleOfRateReporting/getAffectedItemsBySelectedTrades",{handleAs:"json",data:{libraryId:c.libraryId,trade_ids:JSON.stringify(c.gridContainer.arrayUnique(d))}}).then(function(a){for(var h in a)c.gridContainer.elementItemStore[h]||
(c.gridContainer.elementItemStore[h]=new l({idProperty:"id"}));if("add"===b)for(h in a)for(var d in a[h])c.gridContainer.elementItemStore[h].put({id:a[h][d]}),c.gridContainer.selectedItemStore[c.libraryId].put({id:a[h][d]});else for(h in a)for(d in c.gridContainer.selectedElementStore[c.libraryId].remove(h),a[h])c.gridContainer.elementItemStore[h].remove(a[h][d]),c.gridContainer.selectedItemStore[c.libraryId].remove(a[h][d]);f.hide()},function(a){f.hide();console.log(a)})}}});g.makeTab(d,c,a)}}},
createItemGrid:function(c,a){var d=this,b=p(),g=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],k=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID],f=new dojo.data.ItemFileWriteStore({url:"scheduleOfRate/getItemList/id/"+a.id,clearOnClose:!0}),n=dojo.xhrGet({url:"scheduleOfRate/getUnits",
handleAs:"json"}),u=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});u.show();return r(n,function(m){u.hide();buildspace.apps.ScheduleOfRateLibraryReport.grid({id:"item-reportpage-container-"+c,stackContainerTitle:a.description,pageId:"item-reportpage-"+a.id,libraryId:c,tradeId:a.id,type:"tree",gridOpts:{gridContainer:d,tradeGrid:d.grid,store:f,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},{name:e.description,field:"description",
width:"auto",cellType:"buildspace.widget.grid.cells.Textarea",formatter:b.treeCellFormatter},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:g,values:k,formatter:b.typeCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:m.options,values:m.values,formatter:b.unitIdCellFormatter},{name:e.rate,field:"rate-value",field_name:"rate-value",width:"150px",styles:"text-align:right;",
cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:b.formulaCurrencyCellFormatter},{name:e.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"},{name:e.recalculateResourceStatus,field:"recalculate_resource_status",width:"100px",styles:"text-align:center;",formatter:b.recalculateSorCellFormatter}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&a.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM&&d.createBuildUpRateContainer(c,
a,f)},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);this.removedIds=[];if(a)return this.gridContainer.selectedItemStore[this.libraryId].put({id:b.id[0]}),this.getAffectedTradesByItems(b,"add");this.gridContainer.selectedItemStore[this.libraryId].remove(b.id[0]);this.removedIds.push(b.id[0]);return this.getAffectedTradesByItems(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;b.removedIds=[];if(a)return c.selectRange(0,b.rowCount-
1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer.selectedItemStore[b.libraryId].put({id:a.id[0]})})}}),b.getAffectedTradesByItems(null,"add");c.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&(b.gridContainer.selectedItemStore[b.libraryId].remove(a.id[0]),b.removedIds.push(a.id[0]))})}});return b.getAffectedTradesByItems(null,"remove")},getAffectedTradesByItems:function(a,b){var c=this,d=[],f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+
"..."});f.show();if("add"===b)c.gridContainer.selectedItemStore[c.libraryId].query().forEach(function(a){d.push(a.id)});else for(var g in c.removedIds)d.push(c.removedIds[g]);q.post("scheduleOfRateReporting/getAffectedTradesBySelectedItems",{handleAs:"json",data:{libraryId:c.libraryId,item_ids:JSON.stringify(c.gridContainer.arrayUnique(d))}}).then(function(a){for(var d in a)c.gridContainer.elementItemStore[d]||(c.gridContainer.elementItemStore[d]=new l({idProperty:"id"}));var e=dijit.byId("trade-reportpage-container-"+
c.libraryId);if("add"===b)for(d in a){for(var g in a[d])c.gridContainer.elementItemStore[d].put({id:a[d][g]}),c.gridContainer.selectedItemStore[c.libraryId].put({id:a[d][g]});e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return c.gridContainer.selectedElementStore[c.libraryId].put({id:d}),e.grid.rowSelectCell.toggleRow(a._0,!0)}})}else for(d in a){c.gridContainer.selectedElementStore[c.libraryId].remove(d);for(g in a[d])c.gridContainer.elementItemStore[d].remove(a[d][g]),c.gridContainer.selectedItemStore[c.libraryId].remove(a[d][g]);
e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0===c.gridContainer.elementItemStore[d].data.length)return c.gridContainer.selectedElementStore[c.libraryId].remove(d),e.grid.rowSelectCell.toggleRow(a._0,!1)}})}f.hide()},function(a){f.hide();console.log(a)})}}})},function(a){})},createBuildUpRateContainer:function(c,a,d){var b=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;outline:none;",gutters:!1}),g=new dijit.layout.AccordionContainer({id:"accordian_"+
c+"_"+a.id+"-container",region:"center",style:"padding:0px;width:100%;height:100%;border:0px;outline:none;"}),k=dojo.xhrGet({url:"scheduleOfRate/resourceList/item_id/"+a.id,handleAs:"json"}),f=new p;d=dojo.xhrGet({url:"scheduleOfRate/getUnits",handleAs:"json"});var n=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});n.show();d.then(function(d){r(k,function(m){if(0==m.length)g.addChild(new dijit.layout.ContentPane({title:e.emptyResourceCategoryTitle,style:"padding:0px;border:0px;",
doLayout:!1,id:"accPane-empty_resource-"+a.id,content:'<div style="text-align:center;"><p><h1>'+e.emptyResourceCategory+"</h1></p></div> "}));else{var k=x({id:"buildUpRateSummary-"+a.id,itemId:a.id,container:b,_csrf_token:a._csrf_token});dojo.forEach(m,function(b){var c=new dojo.data.ItemFileWriteStore({url:"scheduleOfRate/getBuildUpRateItemList/sor_item_id/"+a.id+"/resource_id/"+b.id,clearOnClose:!0}),c=w({resource:b,scheduleOfRateItemId:a.id,gridOpts:{itemId:a.id,store:c,buildUpSummaryWidget:k,
structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:f.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea",formatter:f.linkedCellFormatter},{name:e.number,field:"number-value",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaCurrencyCellFormatter},{name:e.constant,field:"constant-value",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:f.formulaCurrencyCellFormatter},{name:e.qty,field:"quantity-value",width:"70px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaNumberCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:d.options,values:d.values,formatter:f.linkedUnitIdCellFormatter},{name:e.rate,field:"rate-value",width:"120px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:f.formulaCurrencyCellFormatter},{name:e.total,field:"total",width:"120px",styles:"text-align:right;",formatter:f.linkedCurrencyCellFormatter},{name:e.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaCurrencyCellFormatter},{name:e.lineTotal,field:"line_total",width:"120px",styles:"text-align:right;",formatter:f.linkedCurrencyCellFormatter}]}});g.addChild(new dijit.layout.ContentPane({title:b.name+
'<span style="color:blue;float:right;">'+buildspace.currencyAbbreviation+" "+y.format(b.total_build_up)+"</span>",style:"padding:0px;border:0px;",doLayout:!1,id:"accPane-"+b.id+"-"+a.id,content:c}))});b.addChild(k)}b.addChild(g);if(m=dijit.byId("scheduleOfRate_report_"+c+"-stackContainer")){var l=document.createElement("div"),l=new dojox.layout.ContentPane({title:buildspace.truncateString(a.description,60)+" ("+e.buildUpRate+")",id:"buildUpRatePage-"+a.id,executeScripts:!0},l);m.addChild(l);l.set("content",
b);m.selectChild("buildUpRatePage-"+a.id)}n.hide()})})},kill:function(){var c=dijit.byId("TreeInlineEditBox_error-tooltip");c&&c.destroyRecursive();"undefined"!=typeof this.win&&this.win.close()},markedCheckBoxObject:function(c,a){var d=c.store;a.query().forEach(function(a){a.id!=buildspace.constants.GRID_LAST_ROW&&d.fetchItemByIdentity({identity:a.id,onItem:function(a){if(a)return c.rowSelectCell.toggleRow(a._0,!0)}})})},arrayUnique:function(c){return c.reverse().filter(function(a,c,b){return-1===
b.indexOf(a,c+1)}).reverse()}})});
