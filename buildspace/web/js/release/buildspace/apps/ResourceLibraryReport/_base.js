define("dojo/_base/declare dojo/dom-style dojo/request dojo/_base/event dojo/when dijit/Menu dojo/keys dojo/on dojo/store/Memory buildspace/widget/grid/cells/Formatter dijit/Tooltip ./rfqRateSelectionGrid dojo/i18n!buildspace/nls/ResourceLibrary".split(" "),function(h,v,n,k,q,w,x,y,l,m,z,r,e){return h("buildspace.apps.ResourceLibraryReport",buildspace.apps._App,{win:null,selectedElementStore:[],selectedItemStore:[],elementItemStore:[],init:function(c){this.win=new buildspace.widget.Window({title:e.appName,
onClose:dojo.hitch(this,"kill")});c=new dijit.Toolbar({region:"top",style:"padding:2px;width:100%;"});c.addChild(new dijit.form.Button({label:e.toggleSidebar,iconClass:"icon-16-container icon-16-arrow_bidirectional",style:"outline:none!important;",onClick:dojo.hitch(this,"toggleSidebar")}));var d=this.tabArea=new dijit.layout.TabContainer({region:"center",style:"width:100%;height:100%;"}),b=this.libraryStore=new dojo.data.ItemFileWriteStore({url:"resourceLibrary/resourceList"}),a=new dijit.tree.ForestStoreModel({store:b,
rootId:"root",rootLabel:e.resources}),b=this.left=new dijit.EditableTree({model:a,splitter:!0,region:"left",openOnClick:!0,labelAttr:"name",style:"background-color:#ecede9;width:170px;height:100%;",getIconClass:dojo.hitch(b,function(a,c){return a.root?c?"icon-16-container icon-16-file":"icon-16-container icon-16-folder":"icon-16-container icon-16-list"}),onMouseDown:function(a){var c=dijit.getEnclosingWidget(a.target);if(dojo.mouseButtons.isRight(a))try{this.set("selectedNode",c)}catch(A){k.stop(a)}k.stop(a)}}),
a=this.borderContainer=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});dojo.connect(b,"onDblClick",this,"onItem");a.addChild(c);a.addChild(b);a.addChild(d);this.win.addChild(a);this.win.show();this.win.startup()},toggleSidebar:function(){0<=this.borderContainer.getIndexOfChild(this.left)?this.borderContainer.removeChild(this.left):this.borderContainer.addChild(this.left)},makeTab:function(c,d,b){var a=dijit.byId("resourceLibraryReportGrid"+c+"-stackContainer");
a&&dijit.byId("resourceLibraryReportGrid"+c+"-stackContainer").destroyRecursive();a=new dijit.layout.StackContainer({style:"width:100%;height:100%;",region:"center",id:"resourceLibraryReportGrid"+c+"-stackContainer"});a.addChild(new dijit.layout.ContentPane({title:e.elements,content:b,grid:b.grid}));b=new dijit.layout.StackController({region:"top",containerId:"resourceLibraryReportGrid"+c+"-stackContainer"});var f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});
f.addChild(a);f.addChild(new dijit.layout.ContentPane({style:"padding: 0px; overflow: hidden;","class":"breadCrumbTrail",region:"top",content:b}));a=new dijit.layout.ContentPane({closable:!0,style:"padding: 0px; overflow: hidden;",title:buildspace.truncateString(d,25),content:f});this.tabArea.addChild(a);this.tabArea.selectChild(a);dojo.subscribe("resourceLibraryReportGrid"+c+"-stackContainer-selectChild","",function(a){var d=dijit.byId("resourceLibraryReportGrid"+c+"-stackContainer");if(d){var b=
d.getChildren();a=dojo.indexOf(b,a);a+=1;if(b.length>a)for(;b.length>a;)d.removeChild(b[a]),b[a].destroyRecursive(!0),a+=1}});a.lib_info={name:d,id:c}},onItem:function(c){var d=this.libraryStore;if(d.isItem(c)){var b=d.getValue(c,"id");c=d.getValue(c,"name");if("root"!=b){var d=this.tabArea.getChildren(),a;for(a in d)if("object"==typeof d[a].lib_info&&d[a].lib_info.id==b)return this.tabArea.selectChild(d[a]);var d=dojo.data.ItemFileWriteStore({url:"resourceLibrary/getTradeList/id/"+b,clearOnClose:!0,
urlPreventCache:!0}),f=this;a=new m;this.selectedElementStore[b]=new l({idProperty:"id"});this.selectedItemStore[b]=new l({idProperty:"id"});this.elementItemStore[b]=[];d=f.grid=buildspace.apps.ResourceLibraryReport.grid({id:"trade-reportpage-container-"+b,stackContainerTitle:c,pageId:"page-"+b,libraryId:b,gridOpts:{gridContainer:f,store:d,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:a.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",
cellType:"buildspace.widget.grid.cells.Textarea"},{name:e.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&f.createItemGrid(b,a)},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);this.removedIds=[];if(a)return this.gridContainer.selectedElementStore[this.libraryId].put({id:b.id[0]}),this.getAffectedItemsByTrades(b,"add");this.gridContainer.selectedElementStore[this.libraryId].remove(b.id[0]);
this.removedIds.push(b.id[0]);return this.getAffectedItemsByTrades(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;b.removedIds=[];if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer.selectedElementStore[b.libraryId].put({id:a.id[0]})})}}),b.getAffectedItemsByTrades(null,"add");c.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&(b.gridContainer.selectedElementStore[b.libraryId].remove(a.id[0]),
b.removedIds.push(a.id[0]))})}});return b.getAffectedItemsByTrades(null,"remove")},getAffectedItemsByTrades:function(a,b){var c=this,d=[],f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();if("add"===b)a?d.push(a.id[0]):c.gridContainer.selectedElementStore[c.libraryId].query().forEach(function(a){d.push(a.id)});else for(var u in c.removedIds)d.push(c.removedIds[u]);n.post("resourceLibraryReporting/getAffectedItemsBySelectedTrades",{handleAs:"json",data:{libraryId:c.libraryId,
trade_ids:JSON.stringify(c.gridContainer.arrayUnique(d))}}).then(function(a){for(var g in a)c.gridContainer.elementItemStore[c.libraryId][g]||(c.gridContainer.elementItemStore[c.libraryId][g]=new l({idProperty:"id"}));if("add"===b)for(g in a)for(var d in a[g])c.gridContainer.elementItemStore[c.libraryId][g].put({id:a[g][d]}),c.gridContainer.selectedItemStore[c.libraryId].put({id:a[g][d]});else for(g in a)for(d in c.gridContainer.selectedElementStore[c.libraryId].remove(g),a[g])c.gridContainer.elementItemStore[c.libraryId][g].remove(a[g][d]),
c.gridContainer.selectedItemStore[c.libraryId].remove(a[g][d]);f.hide()},function(a){f.hide();console.log(a)})}}});f.makeTab(b,c,d)}}},createItemGrid:function(c,d){var b=this,a=m(),f=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],t=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID],
k=new dojo.data.ItemFileWriteStore({url:"resourceLibrary/getItemList/id/"+d.id,clearOnClose:!0,urlPreventCache:!0}),h=dojo.xhrGet({url:"resourceLibrary/getUnits",handleAs:"json"}),p=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});p.show();return q(h,function(h){p.hide();buildspace.apps.ResourceLibraryReport.grid({id:"item-page-container-"+c,stackContainerTitle:d.description,pageId:"item-page-"+d.id,libraryId:c,tradeId:d.id,type:"tree",gridOpts:{gridContainer:b,store:k,structure:[{name:"No.",
field:"id",width:"30px",styles:"text-align:center;",formatter:a.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea",formatter:a.treeCellFormatter},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:f,values:t,formatter:a.typeCellFormatter},{name:e.constant,field:"constant-value",width:"160px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:a.formulaCurrencyCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:h.options,values:h.values,formatter:a.unitIdCellFormatter},{name:e.rate,field:"rate-value",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:a.formulaCurrencyCellFormatter},{name:e.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:a.formulaCurrencyCellFormatter},{name:e.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],onRowDblClick:function(a){var d=this.getItem(a.rowIndex);colField=a.cell.field;0<d.id&&null!==d.description[0]&&d.type[0]===buildspace.constants.HIERARCHY_TYPE_WORK_ITEM&&"rate-value"===colField&&b.createItemSupplierRateGrid(c,d)},singleCheckBoxSelection:function(a){var c=a.rowIndex;a=this.selection.selected[c];c=this.getItem(c);this.removedIds=[];if(a)return this.gridContainer.selectedItemStore[this.libraryId].put({id:c.id[0]}),
this.getAffectedTradesByItems(c,"add");this.gridContainer.selectedItemStore[this.libraryId].remove(c.id[0]);this.removedIds.push(c.id[0]);return this.getAffectedTradesByItems(c,"remove")},toggleAllSelection:function(a){var c=this,b=this.selection;c.removedIds=[];if(a)return b.selectRange(0,c.rowCount-1),c.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&c.gridContainer.selectedItemStore[c.libraryId].put({id:a.id[0]})})}}),c.getAffectedTradesByItems(null,"add");b.deselectAll();
c.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&(c.gridContainer.selectedItemStore[c.libraryId].remove(a.id[0]),c.removedIds.push(a.id[0]))})}});return c.getAffectedTradesByItems(null,"remove")},getAffectedTradesByItems:function(a,c){var b=this,d=[],f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();if("add"===c)b.gridContainer.selectedItemStore[b.libraryId].query().forEach(function(a){d.push(a.id)});else for(var h in b.removedIds)d.push(b.removedIds[h]);
n.post("resourceLibraryReporting/getAffectedTradesBySelectedItems",{handleAs:"json",data:{libraryId:b.libraryId,item_ids:JSON.stringify(b.gridContainer.arrayUnique(d))}}).then(function(a){for(var d in a)b.gridContainer.elementItemStore[b.libraryId][d]||(b.gridContainer.elementItemStore[b.libraryId][d]=new l({idProperty:"id"}));var e=dijit.byId("trade-reportpage-container-"+b.libraryId);if("add"===c)for(d in a){for(var g in a[d])b.gridContainer.elementItemStore[b.libraryId][d].put({id:a[d][g]}),b.gridContainer.selectedItemStore[b.libraryId].put({id:a[d][g]});
e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return b.gridContainer.selectedElementStore[b.libraryId].put({id:d}),e.grid.rowSelectCell.toggleRow(a._0,!0)}})}else for(d in a){b.gridContainer.selectedElementStore[b.libraryId].remove(d);for(g in a[d])b.gridContainer.elementItemStore[b.libraryId][d].remove(a[d][g]),b.gridContainer.selectedItemStore[b.libraryId].remove(a[d][g]);e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0===b.gridContainer.elementItemStore[b.libraryId][d].data.length)return b.gridContainer.selectedElementStore[b.libraryId].remove(d),
e.grid.rowSelectCell.toggleRow(a._0,!1)}})}f.hide()},function(a){f.hide();console.log(a)})}}})},function(a){})},createItemSupplierRateGrid:function(c,d){var b=m(),a=new dojo.data.ItemFileWriteStore({url:"resourceLibrary/getItemSupplierRateList/resourceItemId/"+d.id,clearOnClose:!0}),f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();dojo.xhrGet({url:"resourceLibrary/getSelectedRatesFromRFQ/resourceItemId/"+d.id,handleAs:"json",load:function(h){new r({stackContainerTitle:d.description,
pageId:"item-supplier-rate-reportpage-"+d.id,type:"rateSelection",libraryId:c,gridOpts:{formInfo:h.formInformation,itemId:d.id,store:a,structure:[{name:e.supplierName,field:"company_name",width:"250px"},{name:e.projectName,field:"project_title",width:"250px"},{name:e.country,field:"country",width:"100px",styles:"text-align: center;"},{name:e.state,field:"state",width:"100px",styles:"text-align: center;"},{name:e.rate,field:"rate",width:"120px",styles:"text-align:center;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:b.rfqQuantityCellFormatter},{name:e.remarks,field:"remarks",width:"auto"},{name:e.lastUpdated,field:"rate_last_updated_at",width:"120px",styles:"text-align: center;"}]}});f.hide()},error:function(a){f.hide()}})},kill:function(){var c=dijit.byId("TreeInlineEditBox_error-tooltip");c&&c.destroyRecursive();"undefined"!=typeof this.win&&this.win.close()},markedCheckBoxObject:function(c,d){var b=c.store;d.query().forEach(function(a){a.id!=buildspace.constants.GRID_LAST_ROW&&b.fetchItemByIdentity({identity:a.id,
onItem:function(a){if(a)return c.rowSelectCell.toggleRow(a._0,!0)}})})},arrayUnique:function(c){return c.reverse().filter(function(c,b,a){return-1===a.indexOf(c,b+1)}).reverse()}})});
