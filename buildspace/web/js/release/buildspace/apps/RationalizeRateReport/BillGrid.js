define("buildspace/apps/RationalizeRateReport/BillGrid","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/array dojo/dom-attr dojo/json dojo/request dojo/aspect dijit/Menu dojo/number dijit/CheckedMenuItem dojox/grid/enhanced/plugins/Menu dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange dojox/grid/enhanced/plugins/IndirectSelection buildspace/widget/grid/plugins/FormulatedColumn dojo/_base/event dojo/keys dijit/focus dojo/store/Memory dojo/_base/html dojo/request/xhr dijit/PopupMenuItem dijit/MenuSeparator buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox buildspace/widget/grid/cells/Formatter ./PrintPreviewDialog/PrintSelectedElementGridDialog ./PrintPreviewDialog/PrintSelectedItemRateGridDialog ./PrintPreviewDialog/PrintSelectedItemTotalGridDialog dojo/i18n!buildspace/nls/RationalizeRate".split(" "),
function(m,n,p,y,z,h,k,r,A,B,C,D,E,F,G,H,I,J,K,q,L,M,N,O,P,Q,t,u,v,w,d){var x=m("buildspace.apps.RationalizeRateReport.BillGrid",dojox.grid.EnhancedGrid,{type:null,billId:-1,elementId:0,itemId:-1,style:"border-top:none;",selectedItem:null,borderContainerWidget:null,keepSelection:!0,rowSelector:"0px",headerMenu:null,typeColumns:null,markupSettings:null,parentGrid:null,elementGridStore:null,updateUrl:null,project:null,typeColumsToQtyUsed:[],constructor:function(a){this.type=a.type;this.hierarchyTypes=
a.hierarchyTypes;this.hierarchyTypesForHead=a.hierarchyTypesForHead;this.unitOfMeasurements=a.unitOfMeasurements;this.columnGroup=a.columnGroup;this.typeColumns=a.typeColumns;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;var b=this.formatter=new t;this.rationalizedColumnChildren=[{name:d.grandTotalQty,field_name:"rationalized_grand_total_quantity",width:"90px",styles:"text-align:right;",formatter:b.unEditableNumberCellFormatter},
{name:d.rate,field_name:"rationalized_rate-value",width:"85px",styles:"text-align:right;",formatter:b.companyRateCurrencyCellFormatter},{name:d.grandTotal,field_name:"rationalized_grand_total_after_markup",width:"100px",styles:"text-align:right;",formatter:b.unEditableCurrencyCellFormatter}];this.setColumnStructure();this.plugins={indirectSelection:{headerSelector:!0,width:"40px",styles:"text-align: center;"}};this.inherited(arguments)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);
else this.onCellDblClick(a);else this.onRowDblClick(a)},editableCellDblClick:function(a){var b=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(b.cell,b.rowIndex);this.onRowClick(b);this.onRowDblClick(a)},setColumnStructure:function(){var a=this.formatter;if("tree"==this.type){var b=this.unitOfMeasurements,c=this.hierarchyTypes;a=this.fixedColumns={noscroll:!1,width:57.8,cells:[[{name:"No",
field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:d.billReference,field:"bill_ref",styles:"text-align:center; color: red;",width:"80px",noresize:!0,showInCtxMenu:!0,formatter:a.billRefCellFormatter,rowSpan:2,hidden:!1},{name:d.description,field:"description",width:"auto",formatter:a.treeCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:d.type,field:"type",width:"70px",styles:"text-align:center;",type:"dojox.grid.cells.Select",
options:c.options,values:c.values,formatter:a.typeCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:d.unit,field:"uom_id",width:"50px",styles:"text-align:center;",type:"dojox.grid.cells.Select",options:b.options,values:b.values,formatter:a.unitIdCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:d.grandTotalQty,field:"grand_total_quantity",styles:"text-align:right;color:blue;",width:"90px",formatter:a.unEditableNumberCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2},{name:d.rate,
field:"rate_after_markup",styles:"text-align:right;",width:"75px",formatter:a.rateAfterMarkupCellFormatter,noresize:!0,rowSpan:2},{name:d.grandTotal,field:"grand_total_after_markup",styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0,showInCtxMenu:!0,rowSpan:2}]]};b=[];var e=this.generateRationalizedRateColumn(a)}else a=this.fixedColumns={noscroll:!1,width:"50",cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,
noresize:!0},{name:d.description,field:"description",width:"auto",formatter:a.treeCellFormatter,noresize:!0},{name:d.grandTotal,field:"overall_total_after_markup",styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0,showInCtxMenu:!0}]]},b=this.generateRationalizedGrandTotalColumn(),e=a;dojo.forEach(b,function(a){e.cells[0].push(a)});this.structure=e},generateRationalizedRateColumn:function(a){var b=this.rationalizedColumnChildren,c=[];c.push({name:d.rationalizedRate,
styles:"text-align:center;",headerClasses:"staticHeader typeHeader1",colSpan:b.length,hidden:!1});for(i=0;i<b.length;i++){var e=b[i].field_name;e={field:e,columnType:"rationalizedColumn",headerClasses:"typeHeader1"};n.mixin(e,b[i]);a.cells[0].push(e)}a.cells.push(c);return a},generateRationalizedGrandTotalColumn:function(){var a=[];a.push({name:d.rationalizedRate,field:"rationalized_overall_total_after_markup",styles:"text-align:right;",width:"120px",formatter:this.formatter.unEditableCurrencyCellFormatter,
headerClasses:"typeHeader1",noresize:!0});return a},canSort:function(a){return!1},postCreate:function(){var a=this;a.inherited(arguments);var b="tree"===a.type?"viewTendererItemPreviewStore":"viewTendererElementPreviewStore";r.after(a,"_onFetchComplete",function(){a.gridContainer.markedCheckBoxObject(a,a.gridContainer[b][a.billId])})},startup:function(){var a=this;a.inherited(arguments);this._connects.push(p.connect(this,"onCellClick",function(b){""===b.cell.name&&a.singleCheckBoxSelection(b)}));
this._connects.push(p.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)}))},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);return a?"tree"===this.type?this.getAffectedElementAndBillsByItems(b,"add"):this.getAffectedItemsAndBillsByElement(b,"add"):"tree"===this.type?this.getAffectedElementAndBillsByItems(b,"remove"):this.getAffectedItemsAndBillsByElement(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;
var e="tree"===b.type?"viewTendererItemPreviewStore":"viewTendererElementPreviewStore";if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer[e][b.billId].put({id:a.id[0]})})}}),"tree"===b.type?b.getAffectedElementAndBillsByItems(null,"add"):b.getAffectedItemsAndBillsByElement(null,"add");c.deselectAll();return"tree"===b.type?(b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer[e][b.billId].remove(a.id[0])})}}),
b.getAffectedElementAndBillsByItems(null,"remove")):b.getAffectedItemsAndBillsByElement(null,"remove")},getAffectedItemsAndBillsByElement:function(a,b){var c=this,e=c.gridContainer.viewTendererElementPreviewStore[c.billId],f=[],g=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});g.show();a?(c.gridContainer.viewTendererElementPreviewStore[c.billId].put({id:a.id[0]}),f.push(a.id[0])):e.query().forEach(function(a){f.push(a.id)});k.post("rationalizeRateReport/getAffectedBillsAndItems",
{handleAs:"json",data:{bill_id:c.billId,element_ids:h.stringify(c.borderContainerWidget.arrayUnique(f))}}).then(function(a){var e=dijit.byId("rationalizedRate-bill-page-container-"+c.project.id);if("add"===b)for(var d in a){e.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return c.gridContainer.viewTendererBillPreviewStore.put({id:d}),e.rowSelectCell.toggleRow(a._0,!0)}});for(var f in a[d])for(var l in a[d][f])c.gridContainer.viewTendererItemPreviewStore[c.billId].put({id:a[d][f][l]})}else for(d in a){for(f in a[d])for(l in c.gridContainer.viewTendererElementPreviewStore[c.billId].remove(f),
a[d][f])c.gridContainer.viewTendererItemPreviewStore[c.billId].remove(a[d][f][l]);e.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0===c.gridContainer.viewTendererElementPreviewStore[c.billId].data.length)return c.gridContainer.viewTendererBillPreviewStore.remove(d),e.rowSelectCell.toggleRow(a._0,!1)}})}g.hide()},function(a){g.hide();console.log(a)})},getAffectedElementAndBillsByItems:function(a,b){var c=this,e=[],f=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});
f.show();a&&("remove"===b?c.gridContainer.viewTendererItemPreviewStore[c.billId].remove(a.id[0]):c.gridContainer.viewTendererItemPreviewStore[c.billId].put({id:a.id[0]}));c.gridContainer.viewTendererItemPreviewStore[c.billId].query().forEach(function(a){e.push(a.id)});k.post("rationalizeRateReport/getAffectedBillsAndElements",{handleAs:"json",data:{bill_id:c.billId,itemIds:h.stringify(c.borderContainerWidget.arrayUnique(e))}}).then(function(a){c.gridContainer.viewTendererBillPreviewStore=new q({idProperty:"id"});
c.gridContainer.viewTendererElementPreviewStore[c.billId]=new q({idProperty:"id"});c.updateElementAndBillGridSelectBox(a);f.hide()},function(a){f.hide();console.log(a)})},updateElementAndBillGridSelectBox:function(a){var b=this,c=dijit.byId("rationalizedRate-bill-page-container-"+b.project.id),e=dijit.byId("rationalizedRate-element-page-container-"+b.billId);c.store.fetch({onItem:function(a){if(a)return c.rowSelectCell.toggleRow(a._0,!1)}});e.grid.store.fetch({onItem:function(a){if(a)return e.grid.rowSelectCell.toggleRow(a._0,
!1)}});for(var d in a){c.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return b.gridContainer.viewTendererBillPreviewStore.put({id:d}),c.rowSelectCell.toggleRow(a._0,!0)}});for(var g in a[d])e.grid.store.fetchItemByIdentity({identity:g,onItem:function(a){if(a)return b.gridContainer.viewTendererElementPreviewStore[b.billId].put({id:g}),e.grid.rowSelectCell.toggleRow(a._0,!0)}})}},pushIntoStore:function(a,b){a&&a.id&&b.put({id:a.id[0]});return b},removeFromStore:function(a,b){a&&a.id&&
b.remove(a.id[0]);return b},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);dojo.forEach(c,function(a,b){b=dojo.attr(a,"rowSpan");(!b||2>b)&&dojo.attr(a,"rowSpan",2)})}}});return m("buildspace.apps.RationalizeRateReport.BillGridBuilder",dijit.layout.BorderContainer,{pageId:"page-00",style:"padding:0px;width:100%;height:100%;",
gutters:!1,stackContainerTitle:"",rootProject:null,billId:-1,elementId:0,itemId:-1,rowSelector:null,gridOpts:{},type:null,postCreate:function(){var a=this;a.inherited(arguments);n.mixin(a.gridOpts,{billId:a.billId,project:a.rootProject,elementId:a.elementId,type:a.type,region:"center",borderContainerWidget:a});var b=this.grid=new x(a.gridOpts),c=new dijit.Toolbar({region:"top",style:"outline:none!important; border-bottom:none; padding:2px; width:100%;"});"element"===this.type&&(c.addChild(new dijit.form.Button({id:a.rootProject.id+
"-"+this.type+"-ProjectElementSummarySelectedTenderer-button",label:d.projectSummary,iconClass:"icon-16-container icon-16-print",onClick:function(){a.openElementPreviewDialogForSelectedTender()}})),c.addChild(new dijit.ToolbarSeparator));c.addChild(new dijit.form.Button({id:a.rootProject.id+"-"+this.type+"-ProjectItemRateSelectedTenderer-button",label:d.itemRate,iconClass:"icon-16-container icon-16-print",onClick:function(){a.openItemRatePreviewDialogForSelectedTender()}}));c.addChild(new dijit.ToolbarSeparator);
c.addChild(new dijit.form.Button({id:a.rootProject.id+"-"+this.type+"-ProjectItemTotalSelectedTenderer-button",label:d.itemTotal,iconClass:"icon-16-container icon-16-print",onClick:function(){a.openItemTotalPreviewDialogForSelectedTender()}}));a.addChild(c);a.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}));if(b=dijit.byId("rationalizeRateReportBreakdown"+this.rootProject.id+"-stackContainer"))c=document.createElement("div"),c=new dojox.layout.ContentPane({title:buildspace.truncateString(a.stackContainerTitle,
60),id:a.pageId},c),b.addChild(c),c.set("content",a),b.selectChild(a.pageId)},openElementPreviewDialogForSelectedTender:function(){var a=this,b=[];a.gridOpts.gridContainer.viewTendererElementPreviewStore[a.billId].query().forEach(function(a){b.push(a.id)});var c=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});c.show();k.post("rationalizeRateReport/getPrintingSelectedElementByTenderer",{handleAs:"json",data:{bill_id:a.billId,elementIds:h.stringify(a.arrayUnique(b))}}).then(function(e){(new u({title:d.projectSummary,
data:e,billId:a.billId,selectedElements:b})).show();c.hide()},function(a){console.log(a);c.hide()})},openItemRatePreviewDialogForSelectedTender:function(){var a=this,b=[];a.gridOpts.gridContainer.viewTendererItemPreviewStore[a.billId].query().forEach(function(a){b.push(a.id)});var c=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});c.show();k.post("rationalizeRateReport/getPrintingSelectedItemRateByTenderer",{handleAs:"json",data:{bill_id:a.billId,itemIds:h.stringify(a.arrayUnique(b))}}).then(function(e){(new v({project:a.rootProject,
title:d.itemRate,data:e,billId:a.billId,elementId:a.elementId,selectedItems:b})).show();c.hide()},function(a){console.log(a);c.hide()})},openItemTotalPreviewDialogForSelectedTender:function(){var a=this,b=[];a.gridOpts.gridContainer.viewTendererItemPreviewStore[a.billId].query().forEach(function(a){b.push(a.id)});var c=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});c.show();k.post("rationalizeRateReport/getPrintingSelectedItemTotalByTenderer",{handleAs:"json",data:{bill_id:a.billId,
itemIds:h.stringify(a.arrayUnique(b))}}).then(function(e){(new w({project:a.rootProject,title:d.itemTotal,billId:a.billId,elementId:a.elementId,data:e,selectedItems:b})).show();c.hide()},function(a){console.log(a);c.hide()})},arrayUnique:function(a){return a.reverse().filter(function(a,c,d){return-1===d.indexOf(a,c+1)}).reverse()}})});
