define("buildspace/apps/RationalizeRateReport/ProjectBreakdown","dojo/_base/declare dojo/_base/connect dojox/grid/EnhancedGrid dojo/request ./PrintPreviewDialog/PrintSelectedBillGridDialog buildspace/widget/grid/cells/Formatter dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dojo/when dojo/store/Memory ./BillGrid ./lumpSumPercentDialog ./primeCostRateDialog dojo/aspect dojox/grid/enhanced/plugins/IndirectSelection dojo/i18n!buildspace/nls/RationalizeRate".split(" "),function(l,n,r,p,t,
u,z,A,B,v,k,q,C,D,E,F,g){var x=l("buildspace.apps.RationalizeRateReport.ProjectBreakdownGrid",r,{rootProject:null,explorer:null,style:"border:none;",region:"center",keepSelection:!0,tender_setting:null,tender_companies:null,rowSelector:"0px",gridContainer:null,constructor:function(a){this.formatter=new u;this.tender_setting=a.tender_setting;this.tender_companies=a.tender_companies;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;
this.generateColumnStructure();this.plugins={indirectSelection:{headerSelector:!0,width:"40px",styles:"text-align: center;"}};this.inherited(arguments)},canSort:function(a){return!1},postCreate:function(){this.inherited(arguments);var a=this;this._connects.push(n.connect(this,"onCellClick",function(b){""===b.cell.name&&a.singleCheckBoxSelection(b)}));this._connects.push(n.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)}))},singleCheckBoxSelection:function(a){var b=
a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);return a?(this.gridContainer.viewTendererBillPreviewStore.put({id:b.id[0]}),this.getAffectedElementsAndItemsByBillId(b,"add")):this.getAffectedElementsAndItemsByBillId(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer.viewTendererBillPreviewStore.put({id:a.id[0]})})}}),b.getAffectedElementsAndItemsByBillId(null,
"add");c.deselectAll();return b.getAffectedElementsAndItemsByBillId(null,"remove")},generateColumnStructure:function(){var a=this.formatter;this.structure=this.fixedColumns={noscroll:!1,width:"50",cells:[[{name:g.description,field:"title",width:"auto",formatter:w.treeCellFormatter},{name:g.amount,field:"overall_total_after_markup",width:"150px",styles:"color:blue;text-align: right;",formatter:a.unEditableCurrencyCellFormatter},{name:g.rationalizedTotal,field:"rationalized_overall_total_after_markup",
width:"150px",styles:"color:blue;text-align: right;",formatter:a.unEditableCurrencyCellFormatter}]]}},dodblclick:function(a){this.onRowDblClick(a)},getAffectedElementsAndItemsByBillId:function(a,b){var c=this,d=c.gridContainer.viewTendererBillPreviewStore,f=[],h=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."});h.show();a?f.push(a.id[0]):(d.query().forEach(function(a){f.push(a.id)}),f=f.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse());a=JSON.stringify(f);
h.show();p.post("rationalizeRateReport/getAffectedElementsAndItems",{handleAs:"json",data:{bill_ids:a}}).then(function(a){for(var e in a)c.gridContainer.viewTendererElementPreviewStore[e]||(c.gridContainer.viewTendererElementPreviewStore[e]=new k({idProperty:"id"})),c.gridContainer.viewTendererItemPreviewStore[e]||(c.gridContainer.viewTendererItemPreviewStore[e]=new k({idProperty:"id"}));if("add"===b)for(e in a){c.gridContainer.viewTendererBillPreviewStore.put({id:e});for(var d in a[e]){c.gridContainer.viewTendererElementPreviewStore[e].put({id:d});
for(var f in a[e][d])c.gridContainer.viewTendererItemPreviewStore[e].put({id:a[e][d][f]})}}else for(e in a)for(d in c.gridContainer.viewTendererBillPreviewStore.remove(e),a[e])for(f in c.gridContainer.viewTendererElementPreviewStore[e].remove(d),a[e][d])c.gridContainer.viewTendererItemPreviewStore[e].remove(a[e][d][f]);h.hide()},function(a){h.hide();console.log(a)})}}),w={rowCountCellFormatter:function(a,b){return 0<a?a:""},treeCellFormatter:function(a,b){b=this.grid.getItem(b);var c=16*b.level;a=
null==a?"&nbsp":a;b.type<buildspace.apps.RationalizeRateReport.ProjectStructureConstants.TYPE_BILL&&(a="<b>"+a+"</b>");return'<div class="treeNode" style="padding-left:'+c+'px;"><div class="treeContent">'+a+"&nbsp;</div></div>"}};return l("buildspace.apps.RationalizeRateReport.ProjectBreakdown",dijit.layout.BorderContainer,{region:"center",style:"padding:0px;width:100%;height:100%;",gutters:!1,rootProject:null,type:null,explorer:null,grid:null,viewTendererBillPreviewStore:null,viewTendererElementPreviewStore:null,
viewTendererItemPreviewStore:null,constructor:function(a){this.viewTendererBillPreviewStore=[];this.viewTendererElementPreviewStore=[];this.viewTendererItemPreviewStore=[];this.inherited(arguments)},postCreate:function(){this.inherited(arguments);this.createBreakdownGrid()},reconstructBillContainer:function(){var a=dijit.byId("rationalizeRateReportBreakdown"+this.rootProject.id+"-controllerPane"),b=dijit.byId("rationalizeRateReportBreakdown"+this.rootProject.id+"-stackContainer");a.destroyRecursive();
b.destroyRecursive();this.createBreakdownGrid()},createBreakdownGrid:function(){var a=this;buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."});a.viewTendererBillPreviewStore=new k({idProperty:"id"});var b=new dojo.data.ItemFileWriteStore({clearOnClose:!0,url:"rationalizeRate/getProjectBreakdown/id/"+a.rootProject.id}),c=a.grid=x({id:"rationalizedRate-bill-page-container-"+a.rootProject.id,rootProject:a.rootProject,explorer:a.explorer,gridContainer:a,onRowDblClick:function(b){b=
this.getItem(b.rowIndex);b.type[0]==buildspace.constants.TYPE_BILL&&a.createElementGrid(b,c)},store:b});(b=dijit.byId("rationalizeRateReportBreakdown"+a.rootProject.id+"-stackContainer"))&&dijit.byId("rationalizeRateReportBreakdown"+a.rootProject.id+"-stackContainer").destroyRecursive();b=a.stackContainer=new dijit.layout.StackContainer({style:"border:0px;width:100%;height:100%;",region:"center",id:"rationalizeRateReportBreakdown"+a.rootProject.id+"-stackContainer"});var d=new dijit.layout.StackController({region:"top",
containerId:"rationalizeRateReportBreakdown"+a.rootProject.id+"-stackContainer"});d=new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;",baseClass:"breadCrumbTrail",region:"top",id:"rationalizeRateReportBreakdown"+a.rootProject.id+"-controllerPane",content:d});a.addChild(b);a.addChild(d);d=new dijit.layout.BorderContainer({title:buildspace.truncateString(g.bill,60),style:"padding:0px;width:100%;height:100%;",gutters:!1});var f=new dijit.Toolbar({region:"top",style:"outline:none!important; border-bottom:none; padding:2px; width:100%;"});
f.addChild(new dijit.form.Button({id:a.rootProject.id+"-"+this.type+"-ProjectElementSummarySelectedTenderer-button",label:g.projectSummary,iconClass:"icon-16-container icon-16-print",onClick:function(){a.openBillPreviewDialogForSelectedTender()}}));d.addChild(f);d.addChild(new dijit.layout.ContentPane({style:"width:100%",content:c,region:"center"}));b.addChild(d);dojo.subscribe("rationalizeRateReportBreakdown"+a.rootProject.id+"-stackContainer-selectChild","",function(b){var c=dijit.byId("rationalizeRateReportBreakdown"+
a.rootProject.id+"-stackContainer");if(c){var d=c.getChildren();b=dojo.indexOf(d,dijit.byId(b.id));for(b+=1;d.length>b;)c.removeChild(d[b]),d[b].destroyRecursive(),b+=1}})},createElementGrid:function(a,b){this.billId=a.id;var c=this;c.viewTendererElementPreviewStore[this.billId]||(c.viewTendererElementPreviewStore[this.billId]=new k({idProperty:"id"}));c.viewTendererItemPreviewStore[this.billId]||(c.viewTendererItemPreviewStore[this.billId]=new k({idProperty:"id"}));var d=dojo.data.ItemFileWriteStore({url:"rationalizeRate/getElementList/id/"+
a.id,clearOnClose:!0,urlPreventCache:!0});b=dojo.xhrGet({url:"billManager/getBillInfo",handleAs:"json",content:{id:a.id}});var f=this,h=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."});h.show();b.then(function(b){h.hide();try{var e=new q({stackContainerTitle:a.title,billId:a.id,rootProject:f.rootProject,pageId:"element-page-"+a.id,id:"rationalizedRate-element-page-container-"+a.id,type:"element",gridOpts:{gridContainer:c,store:d,typeColumns:b.column_settings,currentGridType:"element",
onRowDblClick:function(c){c=this.getItem(c.rowIndex);0<c.id[0]&&null!==c.description[0]&&""!==c.description[0]&&f.createItemGrid(c,b,e,a)}}})}catch(m){console.debug(m)}})},createItemGrid:function(a,b,c,d){this.billId=d.id;var f=this,h={options:[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_HTML_EDITOR_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PROVISIONAL_TEXT,
buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],values:[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N,
buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_HTML_EDITOR,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PROVISIONAL,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT,
buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID]},k={options:[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT],values:[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER]},e=new dojo.data.ItemFileWriteStore({url:"rationalizeRate/getItemList/id/"+a.id+"/bill_id/"+d.id,clearOnClose:!0}),m=dojo.xhrGet({url:"billManager/getUnits/billId/"+
d.id,handleAs:"json"}),l=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."});l.show();m.then(function(a){return a});return v(m,function(g){l.hide();try{new q({stackContainerTitle:a.description,billId:d.id,rootProject:f.rootProject,id:"item-page-container-"+d.id,elementId:a.id,pageId:"item-page-"+d.id,type:"tree",gridOpts:{gridContainer:f,store:e,escapeHTMLInData:!1,typeColumns:b.column_settings,markupSettings:b.markup_settings,elementGridStore:c,hierarchyTypes:h,hierarchyTypesForHead:k,
updateUrl:"rationalizeRate/billItemRateUpdate",unitOfMeasurements:g,currentGridType:"item"}})}catch(y){console.debug(y)}},function(a){})},markedCheckBoxObject:function(a,b){var c=a.store;b.query().forEach(function(b){b.id!=buildspace.constants.GRID_LAST_ROW&&c.fetchItemByIdentity({identity:b.id,onItem:function(b){if(b)return a.rowSelectCell.toggleRow(b._0,!0)}})})},openBillPreviewDialogForSelectedTender:function(){var a=this,b=[];a.viewTendererBillPreviewStore.query().forEach(function(a){b.push(a.id)});
b=b.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse();var c=JSON.stringify(b),d=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."});d.show();p.post("rationalizeRateReport/getPrintingSelectedBillByTenderer",{handleAs:"json",data:{id:a.rootProject.id,billIds:c}}).then(function(c){(new t({title:g.projectSummary,data:c,projectId:a.rootProject.id,selectedBills:b})).show();d.hide()},function(a){console.log(a);d.hide()})}})});
