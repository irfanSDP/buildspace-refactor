define("buildspace/apps/PostContractReport/MaterialOnSiteReport","dojo/_base/declare dojo/aspect dojo/currency dojo/number dojo/when dojo/request dojo/store/Memory dijit/layout/ContentPane dijit/layout/TabContainer dijit/layout/BorderContainer ./MaterialOnSiteReport/MaterialOnSiteGrid ./MaterialOnSiteReport/PrintSettingForm buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/PostContract".split(" "),function(m,u,k,h,C,l,n,D,v,w,p,x,q,d){var y=function(b,a,c){if(this.grid.getItem(a).id==
buildspace.constants.GRID_LAST_ROW)return c.customClasses.push("disable-cell"),"&nbsp;";if(b==buildspace.apps.PostContractReport.ProjectStructureConstants.MATERIAL_ON_SITE_CLAIMED)return c.customClasses.push("green-cell"),d.claimed.toUpperCase();c.customClasses.push("yellow-cell");return d.thisClaim.toUpperCase()},r=function(b,a,c){if(this.grid.getItem(a).id==buildspace.constants.GRID_LAST_ROW)return c.customClasses.push("disable-cell"),"&nbsp;";c.customClasses.push("disable-cell");b=h.parse(b);return 0>
b?'<span style="color:#FF0000">'+k.format(b)+"</span>":0==b?"&nbsp;":'<span style="color:#42b449;">'+k.format(b)+"</span>"},z=function(b,a,c){var e=h.parse(b);a=this.grid.getItem(a);isNaN(e)||0==e||null==e?b="&nbsp;":(b=k.format(e),b=0<=e?b:'<span style="color:#FF0000">'+b+"</span>");a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY||
c.customClasses.push("disable-cell");return b},t=function(b,a,c){a=this.grid.getItem(a);b=h.parse(b);var e="&nbsp;";isNaN(b)||0==b||null==b||(e=h.format(b,{places:2}));a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY||c.customClasses.push("disable-cell");return 0<=b?e:'<span style="color:#FF0000">'+
e+"</span>"},B=m("buildspace.apps.PostContractReport.MaterialOnSiteReport",w,{style:"padding:0;margin:0;border:none;width:100%;height:100%;",region:"center",gutters:!1,rootProject:null,mosSelectedStore:[],mosItemSelectedStore:[],postCreate:function(){this.inherited(arguments);this.mosSelectedStore=new n({idProperty:"id"});this.mosItemSelectedStore=new n({idProperty:"id"});var b=this,a=new q,c=dojo.data.ItemFileWriteStore({url:"materialOnSite/getMaterialOnSiteList/pid/"+b.rootProject.id,clearOnClose:!0}),
a=new p({id:"material_on_site-"+b.rootProject.id,stackContainerTitle:d.scheduleOfRates,pageId:"material_on_site-"+b.rootProject.id,project:b.rootProject,type:"vo",gridOpts:{gridContainer:b,store:c,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:a.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea"},{name:d.reductionPercentage,cellType:"buildspace.widget.grid.cells.FormulaTextBox",field:"reduction_percentage",
width:"150px",styles:"text-align:right;",formatter:a.editableClaimPercentageCellFormatter},{name:d.totalMos,field:"total",width:"150px",styles:"text-align:right;",formatter:r},{name:d.totalMosAfterReduction,field:"total_after_reduction",width:"150px",styles:"text-align:right;",formatter:r},{name:d.status,field:"status",width:"80px",styles:"text-align:center;",formatter:y},{name:d.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);
0<a.id&&null!==a.description[0]&&0<a.description[0].length&&b.makeItemGrid(a)},singleCheckBoxSelection:function(b){var a=b.rowIndex;b=this.selection.selected[a];a=this.getItem(a);this.removedIds=[];if(b)return this.gridContainer.mosSelectedStore.put({id:a.id[0]}),this.getAffectedItemsByVO(a,"add");this.gridContainer.mosSelectedStore.remove(a.id[0]);this.removedIds.push(a.id[0]);return this.getAffectedItemsByVO(a,"remove")},toggleAllSelection:function(a){var b=this,f=this.selection;b.removedIds=[];
if(a)return f.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a){0<a.id&&b.gridContainer.mosSelectedStore.put({id:a.id[0]})})}}),b.getAffectedItemsByVO(null,"add");f.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,g){0<a.id&&(b.gridContainer.mosSelectedStore.remove(a.id[0]),b.removedIds.push(a.id[0]))})}});return b.getAffectedItemsByVO(null,"remove")},getAffectedItemsByVO:function(a,b){var f=this,c=[],g=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+
"..."});g.show();if("add"===b)f.gridContainer.mosSelectedStore.query().forEach(function(a){c.push(a.id)});else for(var e in f.removedIds)c.push(f.removedIds[e]);l.post("materialOnSiteReporting/getAffectedItems",{handleAs:"json",data:{pid:f.project.id,mos_ids:JSON.stringify(f.gridContainer.arrayUnique(c))}}).then(function(a){if("add"===b)for(var c in a)for(var e in a[c])f.gridContainer.mosItemSelectedStore.put({id:a[c][e]});else for(c in a){for(e in a[c])f.gridContainer.mosItemSelectedStore.remove(a[c][e]);
f.store.fetchItemByIdentity({identity:c,onItem:function(a){if(a)return f.gridContainer.mosSelectedStore.remove(c),f.rowSelectCell.toggleRow(a._0,!1)}})}g.hide()},function(a){g.hide();console.log(a)})}}}),a=this.makeGridContainer(a,d.materialOnSite);this.addChild(a)},makeItemGrid:function(b){var a=new q,c=dojo.data.ItemFileWriteStore({url:"materialOnSite/getMaterialOnSiteItemList/id/"+b.id,clearOnClose:!0}),a=new p({project:this.rootProject,materialOnSite:b,type:"vo-items",gridOpts:{gridContainer:this,
store:c,escapeHTMLInData:!1,structure:[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0},{name:d.description,field:"description",width:"auto",formatter:a.treeCellFormatter,noresize:!0},{name:d.type,field:"type",width:"70px",styles:"text-align:center;",formatter:a.typeCellFormatter,noresize:!0},{name:d.unit,field:"uom_id",width:"70px",styles:"text-align:center;",formatter:a.unitIdCellFormatter,noresize:!0},{name:d.deliveredQty,field:"delivered_qty",
width:"90px",cellType:"buildspace.widget.grid.cells.FormulaTextBox",styles:"text-align:right;",formatter:t,noresize:!0},{name:d.usedQty,field:"used_qty",width:"90px",cellType:"buildspace.widget.grid.cells.FormulaTextBox",styles:"text-align:right;",formatter:t,noresize:!0},{name:d.balanceQty,field:"balance_qty",width:"90px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:a.unEditableCurrencyCellFormatter,noresize:!0},{name:d.rate,field:"rate-value",styles:"text-align:right;",
width:"120px",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:b.status[0]==buildspace.apps.PostContractReport.ProjectStructureConstants.MATERIAL_ON_SITE_THIS_CLAIM?z:a.unEditableCurrencyCellFormatter,noresize:!0},{name:d.amount,field:"amount",styles:"text-align:right;",width:"120px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0}],singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);this.removedIds=[];if(a)return this.gridContainer.mosItemSelectedStore.put({id:b.id[0]}),
this.getAffectedVOByItems(b,"add");this.gridContainer.mosItemSelectedStore.remove(b.id[0]);this.removedIds.push(b.id[0]);return this.getAffectedVOByItems(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;b.removedIds=[];if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a){0<a.id&&b.gridContainer.mosItemSelectedStore.put({id:a.id[0]})})}}),b.getAffectedVOByItems(null,"add");c.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,
function(a){0<a.id&&(b.gridContainer.mosItemSelectedStore.remove(a.id[0]),b.removedIds.push(a.id[0]))})}});return b.getAffectedVOByItems(null,"remove")},getAffectedVOByItems:function(a,b){var c=this,e=[],g=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});g.show();if("add"===b)c.gridContainer.mosItemSelectedStore.query().forEach(function(a){e.push(a.id)});else for(var A in c.removedIds)e.push(c.removedIds[A]);l.post("materialOnSiteReporting/getAffectedMOS",{handleAs:"json",data:{pid:c.project.id,
item_ids:JSON.stringify(c.gridContainer.arrayUnique(e))}}).then(function(a){var e=dijit.byId("material_on_site-"+c.project.id);if("add"===b)for(var d in a){for(var f in a[d])c.gridContainer.mosItemSelectedStore.put({id:a[d][f]});e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0<c.gridContainer.mosItemSelectedStore.data.length)return c.gridContainer.mosSelectedStore.put({id:d}),e.grid.rowSelectCell.toggleRow(a._0,!0)}})}else for(d in a){for(f in a[d])c.gridContainer.mosItemSelectedStore.remove(a[d][f]);
e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0===c.gridContainer.mosItemSelectedStore.data.length)return c.gridContainer.mosSelectedStore.remove(d),e.grid.rowSelectCell.toggleRow(a._0,!1)}})}g.hide()},function(a){g.hide();console.log(a)})}}});this.appendNewStack(a,"material_on_site_items_report-"+b.id+"-"+this.rootProject.id+"-page",b.description)},makeGridContainer:function(b,a){var c=this.rootProject.id,e=dijit.byId("materialOnSiteReport-"+c+"-stackContainer");e&&dijit.byId("materialOnSiteReport-"+
c+"-stackContainer").destroyRecursive();e=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:none;",region:"center",id:"materialOnSiteReport-"+c+"-stackContainer"});e.addChild(new dijit.layout.ContentPane({title:a,content:b,grid:b.grid}));var d=new dijit.layout.StackController({region:"top",containerId:"materialOnSiteReport-"+c+"-stackContainer"}),d=new dijit.layout.ContentPane({style:"padding:0;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:d}),f=new dijit.layout.BorderContainer({style:"padding:0;margin:0;width:100%;height:100%;border:none;",
gutters:!1,region:"center"});f.addChild(e);f.addChild(d);dojo.subscribe("materialOnSiteReport-"+c+"-stackContainer-selectChild","",function(a){var b=dijit.byId("materialOnSiteReport-"+c+"-stackContainer");if(b){var e=b.getChildren(),d=dojo.indexOf(e,a),d=d+1;if(e.length>d){for(;e.length>d;)b.removeChild(e[d]),e[d].destroyDescendants(),e[d].destroyRecursive(),d+=1;var f=a.grid.selection.selectedIndex;a.grid.store.save();a.grid.store.close();var g=u.after(a.grid,"_onFetchComplete",function(){g.remove();
-1<f&&(this.scrollToRow(f,!0),this.selection.setSelected(f,!0))});a.grid.sort()}}});return f},appendNewStack:function(b,a,c){var d=dijit.byId("materialOnSiteReport-"+this.rootProject.id+"-stackContainer");if(d){var g=document.createElement("div");b=new dojox.layout.ContentPane({title:buildspace.truncateString(c,45),id:a,content:b,executeScripts:!0},g);d.addChild(b);d.selectChild(a)}},markedCheckBoxObject:function(b,a){var c=b.store;a.query().forEach(function(a){a.id!=buildspace.constants.GRID_LAST_ROW&&
c.fetchItemByIdentity({identity:a.id,onItem:function(a){if(a)return b.rowSelectCell.toggleRow(a._0,!0)}})})},arrayUnique:function(b){return b.reverse().filter(function(a,b,d){return-1===d.indexOf(a,b+1)}).reverse()}});return m("buildspace.apps.PostContractReport.MaterialOnSiteTabContainer",v,{style:"margin:0;padding:0;border:none;width:100%;height:100%;",gutters:!1,rootProject:null,nested:!0,postCreate:function(){var b=this;this.inherited(arguments);var a=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+
"..."});a.show();l.get("materialOnSite/getPrintSettingForm",{handleAs:"json",query:{pid:b.rootProject.id[0]}}).then(function(c){b.createMaterialOnSiteTab();b.createPrintSettingTab(c);a.hide()},function(b){a.hide();console.log(b)})},createMaterialOnSiteTab:function(){this.addChild(new B({title:buildspace.truncateString(d.materialOnSite,45),rootProject:this.rootProject}))},createPrintSettingTab:function(b){this.addChild(new x({title:buildspace.truncateString(d.printSettingForm,45),rootProject:this.rootProject,
data:b}))}})});
