define("buildspace/apps/PostContractReport/StandardBillManager","dojo/_base/declare dojo/_base/connect dojo/dom-style dijit/TooltipDialog dijit/popup buildspace/widget/grid/plugins/FormulatedColumn dojo/when dojo/number dojo/currency dijit/layout/ContentPane dojox/grid/EnhancedGrid buildspace/widget/grid/cells/Formatter buildspace/apps/ProjectBuilder/BillManager/ScheduleOfQuantityGrid ./BillManager/buildUpQuantitySummary dojo/request dojo/aspect dojo/json dojo/store/Memory dojox/grid/enhanced/plugins/IndirectSelection dijit/DropDownMenu dijit/form/DropDownButton dijit/MenuItem ./BillManager/StandardBillGrid ./BillManager/PrintPreviewElementByTypesDialog ./BillManager/PrintPreviewElementByTypesByUnitsWithClaimDialog dojo/i18n!buildspace/nls/PostContract".split(" "),
function(w,p,P,C,u,D,Q,R,S,T,E,y,F,G,q,U,z,k,V,H,I,x,A,J,B,e){var M=w("buildspace.apps.PostContractReport.TypeGrid",E,{rootProject:null,style:"border:none;",region:"center",pageId:null,billId:null,keepSelection:!0,rowSelector:"0px",gridContainer:null,constructor:function(a){var b=new y;this.structure={noscroll:!1,cells:[[{name:"No.",field:"count",width:"30px",styles:"text-align:center;",formatter:K.rowCountCellFormatter,rowSpan:2},{name:e.description,field:"description",width:"auto",formatter:b.typeListTreeCellFormatter,
rowSpan:2},{name:e.amount,field:"total_per_unit",width:"120px",styles:"text-align: right;color:blue;",formatter:b.unEditableCurrencyCellFormatter,rowSpan:2},{name:e.percent,field:"up_to_date_percentage",width:"120px",headerClasses:"typeHeader1",formatter:b.unEditablePercentageCellFormatter,styles:"text-align: right;"},{name:e.amount,field:"up_to_date_amount",width:"120px",headerClasses:"typeHeader1",formatter:b.unEditableCurrencyCellFormatter,styles:"text-align: right;"}],[{name:e.upToDateClaim,styles:"text-align:center;",
headerClasses:"staticHeader typeHeader1",colSpan:2}]]};this.plugins={indirectSelection:{headerSelector:!0,width:"40px",styles:"text-align: center;"}};this.inherited(arguments)},postCreate:function(){this.inherited(arguments);var a=this;this._connects.push(p.connect(this,"onCellClick",function(b){""===b.cell.name&&a.singleCheckBoxSelection(b)}));this._connects.push(p.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)}))},canSort:function(a){return!1},dodblclick:function(a){this.onRowDblClick(a)},
onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);dojo.forEach(c,function(b,a){a=dojo.attr(b,"rowSpan");(!a||2>a)&&dojo.attr(b,"rowSpan",2)})}},reload:function(){this.store.close();this._refresh()},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);this.removedIds=
[];if(a)return this.gridContainer.typesPreviewStore.put({id:b.id[0]}),this.getAffectedElementsAndItemsByBillId(b,"add");this.gridContainer.typesPreviewStore.remove(b.id[0]);this.removedIds.push(b.id[0]);return this.getAffectedElementsAndItemsByBillId(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;b.removedIds=[];if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){a.id&&b.gridContainer.typesPreviewStore.put({id:a.id[0]})})}}),
b.getAffectedElementsAndItemsByBillId(null,"add");c.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){a.id&&(b.gridContainer.typesPreviewStore.remove(a.id[0]),b.removedIds.push(a.id[0]))})}});return b.getAffectedElementsAndItemsByBillId(null,"remove")},getAffectedElementsAndItemsByBillId:function(a,b){var c=this;a=c.gridContainer.typesPreviewStore;var d=[],g=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});g.show();if("add"===b)a.query().forEach(function(a){d.push(a.id)});
else for(var f in c.removedIds)d.push(c.removedIds[f]);d=d.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse();g.show();q.post("postContractStandardBillClaimReporting/getAffectedElementsAndItems",{handleAs:"json",data:{id:c.billId,type_ids:z.stringify(d)}}).then(function(a){if("add"===b)for(var d in a){c.gridContainer.elementPreviewStore[d]||(c.gridContainer.elementPreviewStore[d]=new k({idProperty:"id"}));c.gridContainer.itemPreviewStore[d]||(c.gridContainer.itemPreviewStore[d]=
new k({idProperty:"id"}));for(var e in a[d]){c.gridContainer.elementPreviewStore[d].put({id:e});for(var f in a[d][e])c.gridContainer.itemPreviewStore[d].put({id:a[d][e][f]})}}else for(var h in c.removedIds)c.gridContainer.elementPreviewStore[c.removedIds[h]]=new k({idProperty:"id"}),c.gridContainer.itemPreviewStore[c.removedIds[h]]=new k({idProperty:"id"});g.hide()},function(a){g.hide();console.log(a)})}}),K={rowCountCellFormatter:function(a,b,c){b=this.grid.getItem(b);void 0!==b.type&&1>b.type&&
c.customClasses.push("invalidTypeItemCell");return 0<a?a:""}};return w("buildspace.apps.PostContractReport.StandardBillManager",dijit.layout.BorderContainer,{style:"padding:0px;border:0px;width:100%;height:100%;",gutters:!1,billId:null,rootProject:null,typesPreviewStore:null,elementPreviewStore:[],itemPreviewStore:[],billInfo:null,constructor:function(a){this.typesPreviewStore=[];this.elementPreviewStore=[];this.itemPreviewStore=[];this.inherited(arguments)},postCreate:function(){this.inherited(arguments);
var a=this;a.createTypeGrid();dojo.subscribe("postContractReportStandardBill"+a.billId+"-stackContainer-selectChild","",function(b){var c=dijit.byId("postContractReportStandardBill"+a.billId+"-stackContainer");if(c){var d=c.getChildren();b=dojo.indexOf(d,dijit.byId(b));b+=1;if(d.length>b)for(;d.length>b;)c.removeChild(d[b]),d[b].destroyDescendants(),d[b].destroyRecursive(),b+=1}})},createTypeGrid:function(){var a=this,b=dijit.byId("postContractReportStandardBill"+this.billId+"-stackContainer");b&&
dijit.byId("postContractReportStandardBill"+this.billId+"-stackContainer").destroyRecursive();b=this.stackContainer=new dijit.layout.StackContainer({style:"border:0px;width:100%;height:100%;",region:"center",id:"postContractReportStandardBill"+this.billId+"-stackContainer"});var c=this;dojo.xhrGet({url:"postContract/getBillInfo",handleAs:"json",content:{id:this.billId}}).then(function(d){a.typesPreviewStore=new k({idProperty:"id"});a.billInfo=d;try{var g=dojo.data.ItemFileWriteStore({url:"postContractStandardBillClaim/getTypeList/id/"+
a.billId,clearOnClose:!0}),f=new M({billId:c.billId,rootProject:c.rootProject,pageId:"type-page-"+c.billId,id:"postContractReport-type-page-container-"+c.billId,store:g,gridContainer:a,onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.level[0]&&c.createElementGrid(a,d,f)}}),l=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",stackContainerTitle:"",gutters:!1}),m=new dijit.Toolbar({region:"top",style:"outline:none!important; border-bottom:none; padding:2px; width:100%;"}),
n=new H({style:"display: none;"}),L=new x({label:e.types,onClick:function(){a.openPrintPreviewDialogByTypes()}});n.addChild(L);var h=new x({label:e.unitsWithClaimOnly,onClick:function(){a.openPrintPreviewDialogByUnitsWithClaim()}});n.addChild(h);var p=new x({label:e.allUnits,onClick:function(){a.openPrintPreviewDialogByAllUnits()}});n.addChild(p);m.addChild(new I({label:e.type+" / "+e.unit,iconClass:"icon-16-container icon-16-print",dropDown:n}));l.addChild(m);l.addChild(new dijit.layout.ContentPane({style:"width:100%",
content:f,region:"center"}));var r=new dijit.layout.ContentPane({title:e.type+" / "+e.unit,content:l,grid:f}),v=new dijit.layout.StackController({region:"top",containerId:"postContractReportStandardBill"+c.billId+"-stackContainer"});b.addChild(r);var O=new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;",baseClass:"breadCrumbTrail",region:"top",id:"postContractReportBillGrid"+c.billId+"-controllerPane",content:v});c.addChild(b);c.addChild(O)}catch(N){console.debug(N)}})},createElementGrid:function(a,
b,c){var d=this,e=a.id[0];d.elementPreviewStore[e]||(d.elementPreviewStore[e]=new k({idProperty:"id"}));d.itemPreviewStore[e]||(d.itemPreviewStore[e]=new k({idProperty:"id"}));dojo.xhrGet({url:"postContractStandardBillClaim/getTypeItem",handleAs:"json",content:{type_id:a.relation_id,project_id:d.rootProject.id,counter:a.count}}).then(function(a){var c=dojo.data.ItemFileWriteStore({url:"postContractStandardBillClaim/getBillElementList/id/"+d.billId+"/project_id/"+d.rootProject.id+"/type_ref_id/"+a.id,
clearOnClose:!0,urlPreventCache:!0}),f=new A({stackContainerTitle:0<a.new_name.length?a.relation_name+" :: "+a.new_name:a.relation_name+" :: "+a.description,billId:d.billId,rootProject:d.rootProject,pageId:"element-page-"+d.billId,id:"postContractReport-element-page-container-"+d.billId,typeItem:a,type:"element",gridOpts:{typeItemId:e,store:c,typeColumns:b.column_settings,bqCSRFToken:b.bqCSRFToken,claimRevision:b.claim_project_revision_status,selectedClaimRevision:b.current_selected_claim_project_revision_status,
currentGridType:"element",gridContainer:d,onRowDblClick:function(c){c=this.getItem(c.rowIndex);0<c.id[0]&&null!==c.description[0]&&""!==c.description[0]&&d.createItemGrid(c,e,a,b,f)}}})})},createItemGrid:function(a,b,c,d,g){var f=this.billId,l=this,m=new dojo.data.ItemFileWriteStore({url:"postContractStandardBillClaim/getItemList/id/"+a.id+"/bill_id/"+f+"/type_ref_id/"+a.claim_type_ref_id+"/project_id/"+l.rootProject.id,clearOnClose:!0});try{new A({stackContainerTitle:a.description,billId:f,disableEditing:!1,
rootProject:l.rootProject,id:"item-page-container-"+f,elementId:a.id,pageId:"item-page-"+f,type:"tree",typeItem:c,gridOpts:{typeItemId:b,store:m,escapeHTMLInData:!1,elementGridStore:g,claimRevision:d.claim_project_revision_status,selectedClaimRevision:d.current_selected_claim_project_revision_status,currentGridType:"item",gridContainer:l,onRowDblClick:function(a){var b=a.cell.field,d=this.getItem(a.rowIndex),f=this.store;if("qty_per_unit"==b&&d[b+"-has_build_up"][0]){var n=c.relation_id;a=dojo.xhrPost({url:"billBuildUpQuantity/getDimensionColumnStructure",
content:{uom_id:d.uom_id[0]},handleAs:"json"});var m=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});m.show();a.then(function(a){l.createBuildUpQuantityContainer(d,a,n,f,g);m.hide()})}}}})}catch(n){console.debug(n)}},createBuildUpQuantityContainer:function(a,b,c,d,g){var f=this,l,m=new dijit.layout.BorderContainer({style:"padding:0;margin:0;width:100%;height:100%;border:none;outline:none;",gutters:!1}),n=new dijit.layout.TabContainer({nested:!0,style:"padding:0;border:none;margin:0;width:100%;height:100%;",
region:"center"}),k=buildspace.constants.QUANTITY_PER_UNIT_ORIGINAL,h=new y;d=dojo.xhrGet({url:"billBuildUpQuantity/getLinkInfo/id/"+a.id+"/bcid/"+c+"/t/"+k,handleAs:"json"});var q=new dojo.data.ItemFileWriteStore({url:"billBuildUpQuantity/getBuildUpQuantityItemList/bill_item_id/"+a.id+"/bill_column_setting_id/"+c+"/type/"+k,clearOnClose:!0}),r=!1,v=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});v.show();d.then(function(d){var g=[{name:"No.",field:"id",styles:"text-align:center;",
width:"30px",formatter:h.rowCountCellFormatter},{name:e.description,field:"description",width:"auto"},{name:e.factor,field:"factor-value",width:"100px",styles:"text-align:right;",formatter:h.formulaNumberCellFormatter}];dojo.forEach(b,function(a){g.push({name:a.title,field:a.field_name,width:"100px",styles:"text-align:right;",formatter:h.formulaNumberCellFormatter})});g.push({name:e.total,field:"total",width:"100px",styles:"text-align:right;",formatter:h.numberCellFormatter});g.push({name:e.sign,
field:"sign",width:"70px",styles:"text-align:center;",formatter:h.signCellFormatter});var t=new G({itemId:a.id,billColumnSettingId:c,type:k,hasLinkedQty:d.has_linked_qty,container:m,_csrf_token:a._csrf_token,disableEditingMode:!0});d.has_linked_qty&&(r=!0,l=F({title:e.scheduleOfQuantities,BillItem:a,billColumnSettingId:c,disableEditingMode:!0,stackContainerId:"postContractReportStandardBill"+f.billId+"-stackContainer",gridOpts:{qtyType:k,buildUpSummaryWidget:t,store:new dojo.data.ItemFileWriteStore({url:"billBuildUpQuantity/getScheduleOfQuantities/id/"+
a.id+"/bcid/"+c+"/type/"+k,clearOnClose:!0}),structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:h.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",formatter:h.treeCellFormatter},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",formatter:h.typeCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",formatter:h.unitIdCellFormatter},{name:e.qty,field:"quantity-value",width:"100px",styles:"text-align:right;",
formatter:h.formulaNumberCellFormatter}]}}));d=w("buildspace.apps.PostContractReport.BillManager.BuildUpQtyGrid",dojox.grid.EnhancedGrid,{title:e.manualQtyItems,region:"center",store:q,structure:g,postCreate:function(){var a=null;this.formulatedColumn=D(this,{});this.inherited(arguments);this._connects.push(p.connect(this,"onCellMouseOver",function(b){var c=b.cell.field,d=b.rowIndex,e=this.getItem(d);c=c.replace("-value","");"undefined"!==typeof e[c+"-has_formula"]&&e[c+"-has_formula"][0]&&(e=e[c+
"-value"][0],e=this.formulatedColumn.convertItemIdToRowIndex(e,d),null===a&&(a=new C({content:e,onMouseLeave:function(){u.close(a)}}),u.open({popup:a,around:b.cellNode})))}));this._connects.push(p.connect(this,"onCellMouseOut",function(){null!==a&&(u.close(a),a=null)}));this._connects.push(p.connect(this,"onStartEdit",function(){null!==a&&(u.close(a),a=null)}))},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,p.disconnect);delete this._connects}});n.addChild(new d);r&&n.addChild(l);
m.addChild(n);m.addChild(t);if(t=dijit.byId("postContractReportStandardBill"+f.billId+"-stackContainer"))d=document.createElement("div"),d=new dojox.layout.ContentPane({title:buildspace.truncateString(a.description,45)+" ("+e.buildUpQuantity+" - "+a.uom_symbol+")",id:"buildUpQuantityPage-"+a.id,style:"padding:0px;border:0px;",content:m,grid:r?l.grid:null,executeScripts:!0},d),t.addChild(d),t.selectChild("buildUpQuantityPage-"+a.id);v.hide()})},markedCheckBoxObject:function(a,b){var c=a.store;b.query().forEach(function(b){b.id!=
buildspace.constants.GRID_LAST_ROW&&c.fetchItemByIdentity({identity:b.id,onItem:function(b){if(b)return a.rowSelectCell.toggleRow(b._0,!0)}})})},openPrintPreviewDialogByTypes:function(){var a=this,b=a.billInfo.column_settings,c=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});c.show();q.post("postContractReport/getPrintingPreviewDataByTypes",{handleAs:"json",data:{bill_id:a.billId}}).then(function(d){(new J({project:a.rootProject,title:e.types,data:d,billId:a.billId,columnSettings:b})).show();
c.hide()},function(a){console.log(a);c.hide()})},openPrintPreviewDialogByUnitsWithClaim:function(){var a=this,b=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});b.show();q.post("postContractReport/getPrintingPreviewDataByUnitsWithClaim",{handleAs:"json",data:{bill_id:a.billId}}).then(function(c){(new B({project:a.rootProject,title:e.unitsWithClaimOnly,data:c.items,billId:a.billId,columnSettings:c.billColumns,dynamicUnitStructure:c.gridStructure,printURL:"printReport/printPostContractElementWithClaimByTypes",
exportURL:"exportExcelReport/exportPostContractElementWithClaimByTypes"})).show();b.hide()},function(a){console.log(a);b.hide()})},openPrintPreviewDialogByAllUnits:function(){var a=this,b=[];a.typesPreviewStore.query().forEach(function(a){b.push(a.id)});var c=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});c.show();q.post("postContractReport/getPrintingPreviewDataBySelectedUnits",{handleAs:"json",data:{bill_id:a.billId,itemIds:z.stringify(a.arrayUnique(b))}}).then(function(d){(new B({project:a.rootProject,
title:e.allUnits,data:d.items,columnSettings:d.billColumns,dynamicUnitStructure:d.gridStructure,selectedRows:a.arrayUnique(b),billId:a.billId,printURL:"printReport/printPostContractElementWithClaimByTypesBySelectedUnits",exportURL:"exportExcelReport/exportPostContractElementWithClaimByTypesBySelectedUnits"})).show();c.hide()},function(a){console.log(a);c.hide()})},arrayUnique:function(a){return a.reverse().filter(function(a,c,d){return-1===d.indexOf(a,c+1)}).reverse()}})});
