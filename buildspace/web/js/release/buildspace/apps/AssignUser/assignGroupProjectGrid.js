(function(){define("buildspace/apps/AssignUser/assignGroupProjectGrid","dojo/_base/declare dojo/aspect dojo/_base/array dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style ./groupSelectGrid buildspace/widget/grid/cells/Formatter dojox/grid/enhanced/plugins/IndirectSelection buildspace/widget/grid/Filter dojo/i18n!buildspace/nls/AssignUser".split(" "),function(h,k,f,u,g,v,w,x,l,m,n,p,y,q,e){var r=h("buildspace.apps.AssignUser.AssignGroupProjectGrid",dojox.grid.EnhancedGrid,
{style:"border-top:none;",region:"center",dialog:null,rootProject:null,userGroupId:-1,projectStatus:null,selectedItemIds:[],deselectedItemIds:[],constructor:function(a){this.plugins={indirectSelection:{headerSelector:!0,width:"20px",styles:"text-align:center;"}};this.inherited(arguments)},canSort:function(){return!1},postCreate:function(){var a=this;this.inherited(arguments);this.on("RowClick",function(b){var c=b.cell.field;b=this.getItem(b.rowIndex);"is_admin"==c&&0<b.id&&a.dialog.isAdminUpdate(b)},
!0);k.after(this,"_onFetchComplete",function(){a.markedCheckBoxObject(a.selectedItemIds,!0)});this._connects.push(g.connect(this,"onSelected",function(b){(b=a.getItem(b))&&0<b.id[0]&&a.pushItemIdIntoGridArray(b,!0)}));this._connects.push(g.connect(this,"onDeselected",function(b){(b=a.getItem(b))&&0<b.id[0]&&a.pushItemIdIntoGridArray(b,!1)}));this._connects.push(g.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)}))},markedCheckBoxObject:function(a,b){var c=this,d=
this.store;f.forEach(a,function(a){d.fetchItemByIdentity({identity:a,onItem:function(a){a&&(c.pushItemIdIntoGridArray(a,b),c.rowSelectCell.toggleRow(a._0,b))}})})},pushItemIdIntoGridArray:function(a,b){var c=dojo.indexOf(this.selectedItemIds,a.id[0]),d=dojo.indexOf(this.deselectedItemIds,a.id[0]);b?(-1===c&&this.selectedItemIds.push(a.id[0]),-1!==d&&this.deselectedItemIds.splice(d,1)):(-1!==c&&this.selectedItemIds.splice(c,1),-1===d&&this.deselectedItemIds.push(a.id[0]))},toggleAllSelection:function(a){var b=
this;var c=b.selection;a?c.selectRange(0,b.rowCount-1):c.deselectAll();return b.store.fetch({onComplete:function(c){dojo.forEach(c,function(c,d){0<c.id&&b.pushItemIdIntoGridArray(c,a)})}})},refreshGrid:function(){this.beginUpdate();this.store.close();this._refresh();this.endUpdate()},destroy:function(){this.inherited(arguments);f.forEach(this._connects,g.disconnect);return delete this._connects}});var t=h("buildspace.apps.AssignUser.AssignGroupProjectGridContainer",dijit.layout.BorderContainer,{style:"padding:0px;margin:0px;border:0px;width:100%;height:100%;overflow:hidden;",
region:"center",gutters:!1,filterToolbar:{},userGroupId:-1,dialog:null,store:null,rootProject:null,selectedItemIds:[],deselectedItemIds:[],gridId:null,postCreate:function(){this.inherited(arguments);var a=new p;a=this.grid=new r({id:this.gridId,dialog:this.dialog,rootProject:this.rootProject,projectStatus:this.projectStatus,userGroupId:this.userGroupId,selectedItemIds:this.selectedItemIds,deselectedItemIds:this.deselectedItemIds,store:new dojo.data.ItemFileWriteStore({clearOnClose:!0,url:"projectUserPermission/getUsersByGroup/id/"+
this.rootProject.id+"/st/"+this.projectStatus+"/gid/"+this.userGroupId}),structure:[{name:"No",field:"id",width:"30px",styles:"text-align: center;",formatter:a.rowCountCellFormatter},{name:e.name,field:"name",width:"auto"},{name:e.email,field:"email",width:"200px"},{name:e.admin,field:"is_admin",width:"60px",styles:"text-align: center;",formatter:a.setAdminButtonCellFormatter}]});this.addChild(this.filterToolbar=new q({region:"top",grid:a,editableGrid:!1,filterFields:["name","email"]}));this.addChild(a)}});
return h("buildspace.apps.AssignUser.GroupProjectAssignmentDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:null,rootProject:null,sysName:null,userGroups:[],projectStatus:null,assignedUserIds:[],selectedItemIds:[],deselectedItemIds:[],_csrf_token:null,buildRendering:function(){this.title||(this.title=e.assignUsersToProject+" ("+buildspace.truncateString(this.rootProject.title,80)+")");this.selectedItemIds=[];this.deselectedItemIds=[];var a=this.createContent();a.startup();this.content=
a;this.inherited(arguments)},postCreate:function(){var a=this;dojo.xhrGet({url:"projectUserPermission/getGroupsBySysName",content:{sys:a.sysName},handleAs:"json"}).then(function(b){a._csrf_token=b._csrf_token});m.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){if(a.keyCode===l.ESCAPE)return dojo.stopEvent(a)},onHide:function(){this.userGroups.length=0;return this.destroyRecursive()},createContent:function(){var a=
this;var b=new dijit.layout.BorderContainer({style:"padding:0px;width:750px;height:380px;",gutters:!1});var c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;width:100%;"});c.addChild(new dijit.form.Button({label:e.close,iconClass:"icon-16-container icon-16-close",onClick:function(){a.hide()}}));c.addChild(new dijit.ToolbarSeparator);c.addChild(a.saveButton=new dijit.form.Button({label:e.save,iconClass:"icon-16-container icon-16-save",disabled:1>a.userGroups.length,onClick:function(){a.save()}}));
c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({label:"Select Group",iconClass:"icon-16-container icon-16-home",onClick:function(){a.selectGroup()}}));b.addChild(c);c=a.tabContainer=new dijit.layout.TabContainer({region:"center",style:"padding:0px;margin:0px;border:0px;width:100%;height:100%;"});b.addChild(c);return b},addTab:function(a){var b=this,c="assignUserPermissionGridContainer-"+b.rootProject.id+"-"+a.id,d=dijit.byId(c);d||(b.userGroups.push(a),dojo.xhrGet({url:"projectUserPermission/getAssignedUsersByGroup",
content:{id:b.rootProject.id,st:b.projectStatus,group:a.id},handleAs:"json"}).then(function(e){f.forEach(e,function(a){b.pushUserIdIntoGridArray(a.id,!0)});d=new t({gridId:"assignUserPermissionGrid-"+b.rootProject.id+"-"+a.id,id:c,title:buildspace.truncateString(a.name,35),closable:!0,onClose:function(){b.userGroups=b.userGroups.filter(function(b){return b.id!=a.id});b.updateSaveButtonDisabledProperty();return!0},dialog:b,userGroupId:a.id,projectStatus:b.projectStatus,selectedItemIds:b.selectedItemIds,
deselectedItemIds:b.deselectedItemIds,rootProject:b.rootProject});b.tabContainer.addChild(d);b.tabContainer.selectChild(d);k.after(d.filterToolbar,"refreshGrid",function(){dojo.xhrGet({url:"projectUserPermission/getAssignedUsersByGroup",content:{id:b.rootProject.id,st:b.projectStatus,group:a.id},handleAs:"json"}).then(function(a){var b=[];f.forEach(a,function(a){b.push(a.id)});d.grid.markedCheckBoxObject(b,!0)})})}));d&&b.tabContainer.selectChild(d);b.updateSaveButtonDisabledProperty()},selectGroup:function(){var a=
this,b=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});b.show().then(function(){(new n({rootProject:a.rootProject,sysName:a.sysName,parent:a,projectStatus:a.projectStatus})).show();b.hide()})},updateSaveButtonDisabledProperty:function(){this.saveButton.set("disabled",1>this.userGroups.length)},pushUserIdIntoGridArray:function(a,b){var c=dojo.indexOf(this.selectedItemIds,a),d=dojo.indexOf(this.deselectedItemIds,a);b?(-1===c&&this.selectedItemIds.push(a),-1!==d&&this.deselectedItemIds.splice(d,
1)):(-1!==c&&this.selectedItemIds.splice(c,1),-1===d&&this.deselectedItemIds.push(a))},save:function(){var a=this,b=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});b.show().then(function(){dojo.xhrPost({url:"projectUserPermission/updateUserPermission",handleAs:"json",content:{id:a.rootProject.id,st:a.projectStatus,"uid1[]":a.selectedItemIds,"uid2[]":a.deselectedItemIds,_csrf_token:a._csrf_token},load:function(c){c.success&&(a.selectedItemIds=[],a.deselectedItemIds=[],a.reloadAllGrids(c.ids));
b.hide()},error:function(a){b.hide()}})})},isAdminUpdate:function(a){var b=this,c=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});c.show().then(function(){dojo.xhrPost({url:"projectUserPermission/isAdminUpdate",handleAs:"json",content:{id:a.id,pid:b.rootProject.id,st:b.projectStatus,_csrf_token:a._csrf_token},load:function(a){a.success&&(b.selectedItemIds=[],b.deselectedItemIds=[],b.reloadAllGrids(a.ids));c.hide()},error:function(a){c.hide()}})})},reloadAllGrids:function(a){var b=
this;f.forEach(a,function(a){b.pushUserIdIntoGridArray(a.id,!0)});f.forEach(b.userGroups,function(a){if(a=dijit.byId("assignUserPermissionGrid-"+b.rootProject.id+"-"+a.id))a.selection.deselectAll(),a.selectedItemIds=b.selectedItemIds,a.deselectedItemIds=b.deselectedItemIds,a.refreshGrid()})}})})}).call(this);
