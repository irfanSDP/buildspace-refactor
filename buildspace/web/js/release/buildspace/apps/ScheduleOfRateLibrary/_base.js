define("dojo/_base/declare dojo/aspect dojo/when dojo/_base/event dijit/Menu dojo/keys dojo/on dojo/dom-geometry dijit/Tooltip ./buildUpGrid ./buildUpSummary buildspace/widget/grid/cells/Formatter dojo/currency dijit/layout/AccordionContainer dijit/layout/AccordionPane ./AddResourceCategoryDialog dojo/i18n!buildspace/nls/ScheduleOfRateLibrary".split(" "),function(r,t,q,l,z,u,m,A,B,v,w,p,x,C,D,y,d){return r("buildspace.apps.ScheduleOfRateLibrary",buildspace.apps._App,{win:null,toolbarActions:["edit",
"delete"],init:function(a){var b=this;this.win=new buildspace.widget.Window({title:d.appName,onClose:dojo.hitch(this,"kill")});a=this.borderContainer=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});var c=new dijit.Toolbar({region:"top",style:"padding:2px;width:100%;"});c.addChild(new dijit.form.Button({label:d.newScheduleOfRate,iconClass:"icon-16-container icon-16-add",style:"outline:none!important;",onClick:dojo.hitch(b,"addScheduleOfRate")}));dojo.forEach(this.toolbarActions,
function(a){c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({id:"schedule_of_rate-toolbar_"+a,label:d[a],iconClass:"icon-16-container icon-16-"+a,style:"outline:none!important;",disabled:!0,onClick:dojo.hitch(b,a+"ScheduleOfRate")}))});c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({label:d.toggleSidebar,iconClass:"icon-16-container icon-16-arrow_bidirectional",style:"outline:none!important;",onClick:dojo.hitch(b,"toggleSidebar")}));var e=this.tabArea=
new dijit.layout.TabContainer({region:"center",style:"width:100%;height:100%;"}),f=this.libraryStore=new dojo.data.ItemFileWriteStore({url:"scheduleOfRate/scheduleOfRateList"}),g=new dijit.tree.ForestStoreModel({store:f,rootId:"root",rootLabel:d.scheduleOfRates,childrenAttrs:["__children"]}),h=this.left=new dijit.EditableTree({model:g,splitter:!0,region:"left",openOnClick:!0,ajaxSubmitUrl:"scheduleOfRate/scheduleOfRateUpdate",onSuccess:function(a){b.updateTabTitle(a)},labelAttr:"name",style:"background-color:#ecede9;width:170px;height:100%;",
getIconClass:dojo.hitch(f,function(b,a){return b.root?a?"icon-16-container icon-16-file":"icon-16-container icon-16-folder":"icon-16-container icon-16-list"}),onMouseDown:function(a){var c=dijit.getEnclosingWidget(a.target);c&&c.item&&c.item.root&&b.disableToolbarButtons(!0);if(dojo.mouseButtons.isRight(a))try{this.set("selectedNode",c)}catch(E){l.stop(a)}l.stop(a)},onClick:function(a,c){c.item&&"root"!=c.item.id&&b.disableToolbarButtons(!1)}});m(h.domNode,m.selector(".dijitTree","contextmenu"),function(a){l.stop(a)});
m(h.domNode,m.selector(".dijitTreeNode","contextmenu"),function(a){var c=new dijit.Menu,d={target:a.target,coords:a.keyCode!==u.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null};c&&h.selectedItem&&(b.disableToolbarButtons(h.selectedItem.root?!0:!1),b.treeContextMenuItems(c),c._openMyself(d));l.stop(a)});dojo.connect(h,"onDblClick",this,"onItem");a.addChild(c);a.addChild(h);a.addChild(e);this.win.addChild(a);this.win.show();this.win.startup()},toggleSidebar:function(){0<=this.borderContainer.getIndexOfChild(this.left)?
this.borderContainer.removeChild(this.left):this.borderContainer.addChild(this.left)},disableToolbarButtons:function(a){dojo.forEach(this.toolbarActions,function(b){dijit.byId("schedule_of_rate-toolbar_"+b)._setDisabledAttr(a)})},updateTabTitle:function(a){var b=this.tabArea,c=b.getChildren();this.left.model.store.fetchItemByIdentity({identity:a,onItem:function(a){for(var d in c)if("object"==typeof c[d].lib_info&&c[d].lib_info.id==a.id){c[d].lib_info.name=a.name;c[d].set("title",buildspace.truncateString(a.name,
25));b.resize();break}}})},addScheduleOfRate:function(){var a=this,b=this.libraryStore;dojo.xhrPost(xhrArgs={url:"scheduleOfRate/scheduleOfRateAdd",handleAs:"json",load:function(c){c.success&&(b.newItem({id:c.item.id,name:c.item.name,_csrf_token:c.item._csrf_token}),b.save(),0>a.borderContainer.getIndexOfChild(a.left)&&a.borderContainer.addChild(a.left))},error:function(a){}})},editScheduleOfRate:function(){this.left._itemNodesMap[this.left.selectedNode.item.id][0].labelWidget.edit()},deleteScheduleOfRate:function(){var a=
this,b=this.left.selectedNode.item,c=this.libraryStore,e=buildspace.dialog.indeterminateProgressBar({title:d.deleting+". "+d.pleaseWait+"..."}),f=dijit.byId("TreeInlineEditBox_error-tooltip");f&&f.destroyRecursive();var g={url:"scheduleOfRate/scheduleOfRateDelete",content:{id:b.id,_csrf_token:b._csrf_token},handleAs:"json",load:function(d){if(d.success){d=a.tabArea.getChildren();for(var g in d)if("object"==typeof d[g].lib_info&&d[g].lib_info.id==b.id){a.tabArea.removeChild(d[g]);break}c.deleteItem(b);
c.save();e.hide()}a.disableToolbarButtons(!0)},error:function(a){e.hide()}};buildspace.dialog.confirm(d.confirmation,"<div>"+d.deleteScheduleOfRateAndAllData+"</div>",60,280,function(){e.show();dojo.xhrPost(g)})},treeContextMenuItems:function(a){var b=this.left;"root"==this.left.selectedItem.id?(a.addChild(new dijit.MenuItem({label:d.newScheduleOfRate,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addScheduleOfRate")})),a.addChild(new dijit.MenuItem({label:d.reload,iconClass:"icon-16-container icon-16-reload",
onClick:function(){b.model._requeryTop();b.collapseAll();b.expandAll()}}))):(a.addChild(new dijit.MenuItem({label:d.edit,iconClass:"icon-16-container icon-16-edit",onClick:dojo.hitch(this,"editScheduleOfRate")})),a.addChild(new dijit.MenuItem({label:d.delete,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteScheduleOfRate")})))},makeTab:function(a,b,c){var e=dijit.byId("scheduleOfRate_"+a+"-stackContainer");e&&dijit.byId("scheduleOfRate_"+a+"-stackContainer").destroyRecursive();
e=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"scheduleOfRate_"+a+"-stackContainer"});e.addChild(new dijit.layout.ContentPane({title:d.trade,content:c,grid:c.grid}));c=new dijit.layout.StackController({region:"top",containerId:"scheduleOfRate_"+a+"-stackContainer"});var f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1});f.addChild(e);f.addChild(new dijit.layout.ContentPane({id:"scheduleOfRate_"+
a+"-controllerPane",style:"padding:0px;overflow:hidden;",class:"breadCrumbTrail",region:"top",content:c}));e=new dijit.layout.ContentPane({closable:!0,style:"padding: 0px; overflow: hidden;border:0px;",title:buildspace.truncateString(b,25),content:f});this.tabArea.addChild(e);this.tabArea.selectChild(e);dojo.subscribe("scheduleOfRate_"+a+"-stackContainer-selectChild","",function(b){var d=dijit.byId("scheduleOfRate_"+a+"-stackContainer");if(d){var c=d.getChildren(),e=dojo.indexOf(c,dijit.byId(b.id));
e+=1;if(c.length>e){for(;c.length>e;){d.removeChild(c[e]);c[e].destroyRecursive(!0);e+=1;var f=dijit.byId("add_resource_category_"+a+"-btn");f&&f.destroy()}var g=b.grid.selection.selectedIndex;b.grid.store.save();b.grid.store.close();var l=t.after(b.grid,"_onFetchComplete",function(){l.remove();-1<g&&(this.scrollToRow(g),this.selection.setSelected(g,!0))});b.grid.sort()}}});e.lib_info={name:b,id:a}},onItem:function(a){this.disableToolbarButtons(!0);var b=this.libraryStore;if(b.isItem(a)){var c=b.getValue(a,
"id");a=b.getValue(a,"name");if("root"!=c){b=this.tabArea.getChildren();for(var e in b)if("object"==typeof b[e].lib_info&&b[e].lib_info.id==c)return this.tabArea.selectChild(b[e]);b=dojo.data.ItemFileWriteStore({url:"scheduleOfRate/getTradeList/id/"+c,clearOnClose:!0});var f=this;e=new p;b=f.grid=buildspace.apps.ScheduleOfRateLibrary.grid({id:"trade-page-container-"+c,stackContainerTitle:a,pageId:"trade-page-"+c,libraryId:c,gridOpts:{store:b,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",
formatter:e.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea"},{name:d.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"},{name:d.recalculateResourceStatus,field:"recalculate_resource_status",width:"100px",styles:"text-align:center;",formatter:e.recalculateSorCellFormatter}],addUrl:"scheduleOfRate/tradeAdd",updateUrl:"scheduleOfRate/tradeUpdate",deleteUrl:"scheduleOfRate/tradeDelete",pasteUrl:"scheduleOfRate/tradePaste",
recalculateUrl:"scheduleOfRate/tradeRecalculate",onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&f.createItemGrid(c,a)}}});f.makeTab(c,a,b)}}},createItemGrid:function(a,b){var c=this,e=p(),f=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],g=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,
buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID],h=new dojo.data.ItemFileWriteStore({url:"scheduleOfRate/getItemList/id/"+b.id,clearOnClose:!0}),k=dojo.xhrGet({url:"scheduleOfRate/getUnits",handleAs:"json"}),l=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});l.show();return q(k,function(k){l.hide();buildspace.apps.ScheduleOfRateLibrary.grid({id:"item-page-container-"+a,stackContainerTitle:b.description,pageId:"item-page-"+b.id,libraryId:a,tradeId:b.id,type:"tree",gridOpts:{tradeGrid:c.grid,
store:h,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:e.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:e.treeCellFormatter},{name:d.type,field:"type",width:"70px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:f,values:g,formatter:e.typeCellFormatter},{name:d.unit,field:"uom_id",width:"70px",styles:"text-align:center;",editable:!0,
cellType:"dojox.grid.cells.Select",options:k.options,values:k.values,formatter:e.unitIdCellFormatter},{name:d.rate,field:"rate-value",field_name:"rate-value",width:"150px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:e.formulaCurrencyCellFormatter},{name:d.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"},{name:d.recalculateResourceStatus,field:"recalculate_resource_status",width:"100px",styles:"text-align:center;",
formatter:e.recalculateSorCellFormatter}],addUrl:"scheduleOfRate/itemAdd",updateUrl:"scheduleOfRate/itemUpdate",deleteUrl:"scheduleOfRate/itemDelete",deleteRateUrl:"scheduleOfRate/itemRateDelete",pasteUrl:"scheduleOfRate/itemPaste",indentUrl:"scheduleOfRate/itemIndent",outdentUrl:"scheduleOfRate/itemOutdent",recalculateUrl:"scheduleOfRate/itemRecalculate",onRowDblClick:function(b){b=this.getItem(b.rowIndex);0<b.id&&null!==b.description[0]&&b.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM&&
c.createBuildUpRateContainer(a,b,h)}}})},function(a){})},createBuildUpRateContainer:function(a,b,c){var e=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation,f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;outline:none;",gutters:!1}),g=new dijit.layout.AccordionContainer({id:"accordian_"+a+"_"+b.id+"-container",region:"center",style:"padding:0px;width:100%;height:100%;border:0px;outline:none;"}),h=dojo.xhrGet({url:"scheduleOfRate/resourceList/item_id/"+
b.id,handleAs:"json"}),k=new p;c=dojo.xhrGet({url:"scheduleOfRate/getUnits",handleAs:"json"});var l=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});l.show();c.then(function(c){q(h,function(h){if(0==h.length)g.addChild(new dijit.layout.ContentPane({title:d.emptyResourceCategoryTitle,style:"padding:0px;border:0px;",doLayout:!1,id:"accPane-empty_resource-"+b.id,content:'<div style="text-align:center;"><p><h1>'+d.emptyResourceCategory+"</h1></p></div> "}));else{var m=w({id:"buildUpRateSummary-"+
b.id,itemId:b.id,container:f,_csrf_token:b._csrf_token});dojo.forEach(h,function(a){var e=new dojo.data.ItemFileWriteStore({url:"scheduleOfRate/getBuildUpRateItemList/sor_item_id/"+b.id+"/resource_id/"+a.id,clearOnClose:!0});e=v({resource:a,scheduleOfRateItemId:b.id,gridOpts:{itemId:b.id,addUrl:"scheduleOfRate/buildUpRateItemAdd",updateUrl:"scheduleOfRate/buildUpRateItemUpdate",deleteUrl:"scheduleOfRate/buildUpRateItemDelete",pasteUrl:"scheduleOfRate/buildUpRateItemPaste",store:e,buildUpSummaryWidget:m,
structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:k.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:k.linkedCellFormatter},{name:d.number,field:"number-value",width:"100px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:k.formulaCurrencyCellFormatter},{name:d.constant,field:"constant-value",width:"100px",styles:"text-align:right;",
editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:k.formulaCurrencyCellFormatter},{name:d.qty,field:"quantity-value",width:"70px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:k.formulaNumberCellFormatter},{name:d.unit,field:"uom_id",width:"70px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:c.options,values:c.values,formatter:k.linkedUnitIdCellFormatter},{name:d.rate,field:"rate-value",
width:"120px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:k.formulaCurrencyCellFormatter},{name:d.total,field:"total",width:"120px",styles:"text-align:right;",formatter:k.linkedCurrencyCellFormatter},{name:d.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:k.formulaCurrencyCellFormatter},{name:d.lineTotal,field:"line_total",width:"120px",
styles:"text-align:right;",formatter:k.linkedCurrencyCellFormatter}]}});g.addChild(new dijit.layout.ContentPane({title:a.name+'<span style="color:blue;float:right;">'+buildspace.currencyAbbreviation+" "+x.format(a.total_build_up)+"</span>",style:"padding:0px;border:0px;",doLayout:!1,id:"accPane-"+a.id+"-"+b.id,content:e}))});f.addChild(m)}f.addChild(g);if(h=dijit.byId("scheduleOfRate_"+a+"-stackContainer")){var n=dijit.byId("scheduleOfRate_"+a+"-controllerPane"),p=new dijit.form.Button({id:"add_resource_category_"+
a+"-btn",label:d.addResourceCategory,style:"float:right;color:#333333!important;",iconClass:"icon-16-container icon-16-add",baseClass:"buildUpRateImportResourceCategory",onClick:function(c){y({libraryId:a,scheduleOfRateItem:b,currencyAbbr:e,baseContainer:f}).show()}});n.addChild(p);n=document.createElement("div");n=new dojox.layout.ContentPane({title:buildspace.truncateString(b.description,60)+" ("+d.buildUpRate+")",id:"buildUpRatePage-"+b.id,executeScripts:!0},n);h.addChild(n);n.set("content",f);
h.selectChild("buildUpRatePage-"+b.id)}l.hide()})})},kill:function(){var a=dijit.byId("TreeInlineEditBox_error-tooltip");a&&a.destroyRecursive();this.win&&"undefined"!=typeof this.win&&this.win.close()}})});
