define("buildspace/apps/ScheduleOfRateLibrary/fileImportDialog","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style buildspace/widget/grid/cells/Formatter dojox/grid/enhanced/plugins/IndirectSelection dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/text!./templates/fileImportForm.html dojo/text!./templates/previewForm.html dojo/i18n!buildspace/nls/FileImport dijit/form/ToggleButton dijit/form/RadioButton dojox/form/Uploader dijit/form/Select dijit/form/FilteringSelect dijit/Tooltip dojox/grid/enhanced/plugins/Pagination dojox/grid/enhanced/plugins/Filter dojox/form/uploader/plugins/Flash".split(" "),
function(f,p,h,H,I,J,m,n,k,K,q,r,t,u,x,y,e,z,L,M,N,l,A){var B=f("buildspace.apps.ScheduleOfRateLibrary.FileImportGrid",dojox.grid.EnhancedGrid,{type:null,selectedItem:null,scheduleOfRateId:0,dialogWidget:null,_csrf_token:null,scheduleOfRateGrid:null,escapeHTMLInData:!1,gridData:null,style:"border-top:none;",plugins:{pagination:{pageSizes:["20","40","80","All"],description:!0,sizeSwitch:!0,pageStepper:!0,gotoButton:!0,defaultPageSize:20,maxPageStep:4,position:"bottom"},filter:{closeFilterbarButton:!1,
ruleCount:5,itemsName:"files"}},constructor:function(a){this.itemIds=[];this.connects=[];"tree"!=a.type&&(this.plugins={indirectSelection:{headerSelector:!0,width:"20px",styles:"text-align:center;"}});this.inherited(arguments)},canSort:function(a){return!1},postCreate:function(){var a=this;a.inherited(arguments);this.on("RowClick",function(b){b=a.getItem(b.rowIndex);"tree"!=a.type&&(b&&0<=b.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0))});"tree"!=this.type&&(this._connects.push(h.connect(this,
"onCellClick",function(b){a.selectTree(b)})),this._connects.push(h.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)})))},dodblclick:function(a){this.onRowDblClick(a)},disableToolbarButtons:function(a){var b=dijit.byId("ImportItemGridPreview-"+this.scheduleOfRateId+"_Import-button");b&&b._setDisabledAttr(a)},"import":function(a){var b=this,c=b.itemIds;b.dialogWidget.hide();if(0<c.length){var d=buildspace.dialog.indeterminateProgressBar({title:e.savingData+". "+e.pleaseWait+
"..."});d.show();dojo.xhrPost({url:"scheduleOfRate/saveImportedExcel",content:{schedule_of_rate_id:b.scheduleOfRateId,ids:[c],with_rate:a,_csrf_token:b._csrf_token,filename:b.gridData.filename,uploadPath:b.gridData.uploadPath},handleAs:"json",load:function(a){var c=b.scheduleOfRateGrid.store;a.success&&c.fetchItemByIdentity({identity:buildspace.constants.GRID_LAST_ROW,onItem:function(d){dojo.forEach(a.items,function(a){if(0<a.id){a._csrf_token=d._csrf_token;a=c.newItem(a);c.save();a=b.scheduleOfRateGrid.getItemIndex(a);
var e=b.scheduleOfRateGrid.getItemIndex(d);b.scheduleOfRateGrid.rearranger.moveRows([a],e)}})}});b.itemIds=[];d.hide()},error:function(a){b.itemIds=[];d.hide()}})}},onCellMouseOver:function(a){var b=a.cell.field,c=this.getItem(a.rowIndex);void 0!=c[b+"-msg"]&&c[b+"-msg"][0]&&A.show(c[b+"-msg"][0],a.cellNode)},onCellMouseOut:function(a){dijit.hideTooltip(a.cellNode)},selectTree:function(a){var b=a.rowIndex;a=this.selection.selected[b];(b=this.getItem(b))&&this.pushItemIdIntoGridArray(b,a)},pushItemIdIntoGridArray:function(a,
b){var c=dojo.indexOf(this.itemIds,a.id[0]);b?-1==c&&this.itemIds.push(a.id[0]):-1!=c&&this.itemIds.splice(c,1)},toggleAllSelection:function(a){var b=this,c=b.selection;a?(c.selectRange(0,b.rowCount-1),b.itemIds=[],b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<=a.id&&b.itemIds.push(a.id[0])})}})):(c.deselectAll(),b.itemIds=[])},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,h.disconnect);delete this._connects}}),v=f("buildspace.apps.ScheduleOfRateLibrary.FileImportGridContainer",
dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0px;width:100%;height:100%;",gutters:!1,scheduleOfRateId:0,scheduleOfRateGrid:null,withRate:!1,gridOpts:{},postCreate:function(){var a=this;a.inherited(arguments);p.mixin(a.gridOpts,{type:a.type,scheduleOfRateId:a.scheduleOfRateId,region:"center"});var b=this.grid=new B(a.gridOpts);if("tree"!=a.type){var c=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});c.addChild(new dijit.form.Button({id:"ImportItemGridPreview-"+
a.scheduleOfRateId+"_Import-button",label:e["import"],iconClass:"icon-16-container icon-16-import",onClick:function(){b["import"](a.withRate)}}));c.addChild(new dijit.ToolbarSeparator);c.addChild(new z({name:"withRate",label:e.rate,iconClass:"dijitCheckBoxIcon",value:!0,checked:!1,onChange:function(b){a.withRate=b}}));a.addChild(c)}a.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}));if(c=dijit.byId("ScheduleOfRateLibrary-item_import_list_"+this.scheduleOfRateId+
"_"+this.scheduleOfRateTradeId+"-stackContainer")){var d=document.createElement("div"),d=new dojox.layout.ContentPane({title:buildspace.truncateString(a.stackContainerTitle,60),id:a.pageId,executeScripts:!0},d);c.addChild(d);d.set("content",a);c.selectChild(a.pageId)}}}),w=f("buildspace.apps.ScheduleOfRateLibrary.FileImportGridDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:e.importFile,selectedItem:null,scheduleOfRateId:0,elementId:0,scheduleOfRateGrid:null,gridData:null,excelType:buildspace.constants.EXCEL_TYPE_SINGLE,
buildRendering:function(){var a=this.createContent();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){n.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){key=a.keyCode;key==m.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},removeUploadedFile:function(){dojo.xhrPost({url:"scheduleOfRate/deleteTempFile",content:{filename:this.gridData.filename,extension:this.gridData.extension},
handleAs:"json"})},createContent:function(){var a=this,b=new dijit.layout.BorderContainer({style:"padding:0px;width:950px;height:500px;",gutters:!1}),c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:e.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:function(){a.removeUploadedFile();a.hide()}}));var d={identifier:"id",items:a.gridData.Trades},g=new k,d=dojo.data.ItemFileWriteStore({data:d}),
g=v({stackContainerTitle:e.elements,pageId:"import_list-page_library-"+this.scheduleOfRateId+"_"+this.elementId,scheduleOfRateId:this.scheduleOfRateId,scheduleOfRateTradeId:this.elementId,gridOpts:{store:d,gridData:this.gridData,scheduleOfRateGrid:a.scheduleOfRateGrid,dialogWidget:a,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:g.rowCountCellFormatter},{name:e.description,field:"description",width:"auto"},{name:e.itemCount,field:"count",width:"80px",styles:"text-align:center;",
formatter:g.infoFieldFormatter},{name:e.error,field:"error",width:"60px",styles:"text-align:center;",formatter:g.infoFieldFormatter}],onRowDblClick:function(b){b=this.getItem(b.rowIndex);1<=b.id&&null!==b.description[0]&&a.createItemGrid(b)}}}),g=this.makeGridContainer(g,e.elements);b.addChild(c);b.addChild(g);return b},createItemGrid:function(a){var b=new dojo.data.ItemFileWriteStore({data:{identifier:"id",items:this.gridData.TradesToItem[a.id]}});v({stackContainerTitle:a.description,pageId:"import_list-page_item-"+
this.scheduleOfRateId+"_"+this.elementId,scheduleOfRateId:this.scheduleOfRateId,scheduleOfRateTradeId:this.elementId,type:"tree",gridOpts:{store:b,dialogWidget:this,gridData:this.gridData,selectedItem:this.selectedItem,scheduleOfRateGrid:this.scheduleOfRateGrid,_csrf_token:a._csrf_token,structure:this.getStructureByExcelType()}})},getStructureByExcelType:function(){var a=null,b=k();switch(this.excelType){case buildspace.constants.EXCEL_TYPE_MULTIPLE:break;default:a=[{name:"No.",field:"id",width:"30px",
styles:"text-align:center;",formatter:b.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",formatter:b.treeCellFormatter},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",formatter:b.typeCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",formatter:b.unitIdCellFormatter},{name:e.rate,field:"rate-value",width:"80px",styles:"text-align:right;",formatter:b.formulaCurrencyCellFormatter}]}return a},makeGridContainer:function(a,
b){var c=this.scheduleOfRateId+"_"+this.elementId,d=dijit.byId("ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer");d&&dijit.byId("ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer").destroyRecursive();var d=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer"}),e=new dijit.layout.ContentPane({title:b,content:a});d.addChild(e);var e=new dijit.layout.StackController({region:"top",
containerId:"ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer"}),e=new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:e}),f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"});f.addChild(d);f.addChild(e);dojo.subscribe("ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer-selectChild","",function(a){var b=dijit.byId("ScheduleOfRateLibrary-item_import_list_"+
c+"-stackContainer");if(b){var d=b.getChildren();a=dojo.indexOf(d,dijit.byId(a.id));for(a+=1;d.length>a;)b.removeChild(d[a]),d[a].destroyRecursive(!0),a+=1}});return f}}),C=f("buildspace.apps.ScheduleOfRateLibrary.FilePreviewGrid",dojox.grid.EnhancedGrid,{type:null,selectedItem:null,dialogWidget:null,_csrf_token:null,escapeHTMLInData:!1,style:"border-top:none;",uploadUrl:null,constructor:function(a){this.itemIds=[];this.connects=[];this.inherited(arguments)},canSort:function(a){return!1},postCreate:function(){this.inherited(arguments)},
"import":function(){},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,h.disconnect);delete this._connects}}),D=f("buildspace.apps.ScheduleOfRateLibrary.FilePreviewGridContainer",dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0px;width:100%;height:100%;",gutters:!1,scheduleOfRateId:0,gridOpts:{},postCreate:function(){this.inherited(arguments);p.mixin(this.gridOpts,{type:this.type,scheduleOfRateId:this.scheduleOfRateId,region:"center"});var a=this.grid=
new C(this.gridOpts);this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:a,region:"center"}));if(a=dijit.byId("ScheduleOfRateLibrary-item_import_list_"+this.scheduleOfRateId+"-stackContainer")){var b=document.createElement("div"),b=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),id:this.pageId,executeScripts:!0},b);a.addChild(b);b.set("content",this);a.selectChild(this.pageId)}}}),E=f("buildspace.apps.ScheduleOfRateLibrary.PreviewForm",
[q,r,t,u],{templateString:y,baseClass:"buildspace-form",region:"center",dialogObj:null,scheduleOfRateId:-1,nls:e,uploadUrl:null,colData:null,fileName:null,extension:null,style:"padding:5px;overflow:auto;",constructor:function(a){this.inherited(arguments)},postCreate:function(){this.inherited(arguments);var a=this.options=[];dojo.forEach(this.colData,function(b,d){a.push({label:b.name,value:b.name})});var b=new dojo.data.ItemFileReadStore({data:{label:"label",identifier:"value",items:a}});this.descriptionSelectFrom=
(new l({name:"colDescriptionFrom",store:b,style:"padding:2px;width: 70px;",searchAttr:"label"})).placeAt(this.descriptionFromSelectDivNode);this.descriptionSelectTo=(new l({name:"colDescriptionTo",store:b,style:"padding:2px;width: 70px;",searchAttr:"label"})).placeAt(this.descriptionToSelectDivNode);this.unitSelect=(new l({name:"colUnit",store:b,required:!1,style:"padding:2px;width: 70px;",searchAttr:"label"})).placeAt(this.unitSelectDivNode);this.rateSelect=(new l({name:"colRate",store:b,required:!1,
style:"padding:2px;width: 70px;",searchAttr:"label"})).placeAt(this.rateSelectDivNode)},startup:function(){this.inherited(arguments)},close:function(){},"import":function(){var a=buildspace.dialog.indeterminateProgressBar({title:e.savingData+"..."}),b=this,c=dojo.formToObject(b.fileImportPreviewForm.id),c={url:b.uploadUrl,content:c,handleAs:"json",load:function(c){c.success&&(c=b.importGridDialog=new w({scheduleOfRateId:b.scheduleOfRateId,gridData:c,excelType:c.excelType,scheduleOfRateGrid:b.scheduleOfRateGrid}),
a.hide(),c.show())},error:function(b){a.hide();console.log(b)}};this.fileImportPreviewForm.validate()&&(b.dialogObj.hide(),a.show(),dojo.xhrPost(c))},onCancel:function(){}}),F=f("buildspace.apps.ScheduleOfRateLibrary.FilePreviewGridDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:e.importFile,selectedItem:null,scheduleOfRateId:0,scheduleOfRateGrid:null,previewData:null,displayForm:!0,fileName:null,extension:null,colData:null,buildRendering:function(){var a;a=this.displayForm?this.createForm():
this.createContent();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){n.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){key=a.keyCode;key==m.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},removeUploadedFile:function(){dojo.xhrPost({url:"scheduleOfRate/deleteTempFile",content:{filename:this.fileName,extension:this.extension},handleAs:"json"})},createContent:function(){var a=
this,b=new dijit.layout.BorderContainer({style:"padding:0px;width:950px;height:500px;",gutters:!1}),c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:e.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:function(){a.removeUploadedFile();a.hide()}}));var d={identifier:"id",items:a.previewData};new k;d=dojo.data.ItemFileWriteStore({data:d});d=D({pageId:"import_list-page_library-"+
this.scheduleOfRateId,scheduleOfRateId:this.scheduleOfRateId,uploadUrl:"scheduleOfRate/importExcel",gridOpts:{store:d,gridData:this.gridData,dialogWidget:a,structure:a.generateStructure()}});d=this.makeGridContainer(d,"Preview");b.addChild(c);b.addChild(d);return b},createForm:function(){var a=this,b=new dijit.layout.BorderContainer({style:"padding:0px;width:400px;height:170px;",gutters:!1}),c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:e.close,
iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:function(){a.removeUploadedFile();a.hide()}}));var d=new E({dialogObj:a,scheduleOfRateId:a.scheduleOfRateId,uploadUrl:"scheduleOfRate/importExcel",colData:a.colData,fileName:a.fileName,scheduleOfRateGrid:a.scheduleOfRateGrid,extension:a.extension});c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({id:"ImportItemGrid-"+a.scheduleOfRateId+"_Import-button",label:e["import"],iconClass:"icon-16-container icon-16-import",
onClick:function(){d["import"]()}}));var f=this.makeGridContainer(d,"Preview");b.addChild(c);b.addChild(f);return b},generateStructure:function(){var a=[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:k().rowCountCellFormatter}];dojo.forEach(this.colData,function(b,c){a.push({name:b.name,field:b.slug,width:"auto"})});return a},makeGridContainer:function(a,b){var c=this.scheduleOfRateId,d=dijit.byId("ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer");d&&dijit.byId("ScheduleOfRateLibrary-item_import_list_"+
c+"-stackContainer").destroyRecursive();d=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"ScheduleOfRateLibrary-item_import_list_"+c+"-stackContainer"});c=new dijit.layout.ContentPane({title:b,content:a});d.addChild(c);c=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"});c.addChild(d);return c}}),G=f("buildspace.apps.ScheduleOfRateLibrary.FileImportForm",[q,r,t,u],{templateString:x,baseClass:"buildspace-form",
region:"center",dialogObj:null,scheduleOfRateId:-1,scheduleOfRateGrid:null,nls:e,uploadUrl:"scheduleOfRate/importBuildspaceExcel",style:"padding:5px;overflow:auto;",postCreate:function(){this.inherited(arguments);var a=this.fileUploaderNode;a.on("Complete",dojo.hitch(this,"uploadComplete"));a.on("Begin",dojo.hitch(this,"uploadBegin"))},startup:function(){this.inherited(arguments)},doImportFile:function(){},uploadBegin:function(a){(this.pb=buildspace.dialog.indeterminateProgressBar({title:e.uploadingData+
". "+e.pleaseWait+"..."})).show();this.dialogObj.hide()},uploadComplete:function(a){this.pb.hide();a.preview?(this.previewGridDialog=new F({scheduleOfRateId:this.scheduleOfRateId,previewData:a.previewData,colData:a.colData,fileName:a.fileName,extension:a.extension,scheduleOfRateGrid:this.scheduleOfRateGrid})).show():(this.importGridDialog=new w({scheduleOfRateId:this.scheduleOfRateId,gridData:a,excelType:a.excelType,scheduleOfRateGrid:this.scheduleOfRateGrid})).show()},close:function(){},onCancel:function(){}});
return f("buildspace.apps.ScheduleOfRateLibrary.FileImportDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:e.importFile,selectedItem:null,scheduleOfRateId:0,scheduleOfRateGrid:null,uploadUrl:null,importType:null,buildRendering:function(){var a=this.createForm();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){n.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){key=a.keyCode;
key==m.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createForm:function(){var a=new dijit.layout.BorderContainer({style:"padding:0px;width:400px;height:80px;",gutters:!1}),b=new G({dialogObj:this,scheduleOfRateId:this.scheduleOfRateId,uploadUrl:this.uploadUrl,importType:this.importType,scheduleOfRateGrid:this.scheduleOfRateGrid}),c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:e.close,
iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));c.addChild(new dijit.ToolbarSeparator);a.addChild(c);a.addChild(b);return a},makeGridContainer:function(a,b){var c=this.scheduleOfRateId,d=dijit.byId("ScheduleOfRateLibrary-file_import_"+c+"-stackContainer");d&&dijit.byId("ScheduleOfRateLibrary-file_import_"+c+"-stackContainer").destroyRecursive();var d=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",
id:"ScheduleOfRateLibrary-file_import_"+c+"-stackContainer"}),e=new dijit.layout.ContentPane({title:b,content:a});d.addChild(e);c=new dijit.layout.StackController({region:"top",containerId:"ScheduleOfRateLibrary-file_import_"+c+"-stackContainer"});new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:c});c=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"});c.addChild(d);return c}})});
