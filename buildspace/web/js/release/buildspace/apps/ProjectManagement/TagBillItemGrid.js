define("buildspace/apps/ProjectManagement/TagBillItemGrid","dojo/_base/declare dojo/_base/lang dojo/aspect dijit/focus dojo/_base/connect dojo/when dojo/dom dojo/dom-construct dojo/keys dojo/dom-style dojo/currency dojo/number dojox/grid/EnhancedGrid dojox/grid/enhanced/plugins/IndirectSelection buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/Formatter ./ClaimUpdateDialog dojo/i18n!buildspace/nls/ProjectManagement".split(" "),function(m,x,n,u,r,F,p,G,y,z,A,g,v,H,I,l,B,d){var C=
m("buildspace.apps.ProjectManagement.BillGrid",v,{style:"border-top:none;",type:-1,rowSelector:"0px",region:"center",projectScheduleId:-1,scheduleTaskItem:null,tagBillItemGrid:null,dialogWidget:null,initialCheckboxSelection:!1,constructor:function(a){this.selectedItemIds=[];this.unSelectedItemIds=[];this.connects=[];if("bill_item"==a.type||"update_total_unit"==a.type)this.plugins={indirectSelection:{headerSelector:!0,width:"20px",styles:"text-align:center;"}};this.inherited(arguments)},canSort:function(a){return!1},
dodblclick:function(a){this.onRowDblClick(a)},postCreate:function(){var a=this;this.inherited(arguments);if("bill_item"==this.type||"update_total_unit"==this.type)n.after(this,"_onFetchComplete",function(){a.initialCheckboxSelection||(this.store.fetch({query:{selected:!0},queryOptions:{ignoreCase:!0},onComplete:this.markSelectedCheckBoxes,scope:this}),a.initialCheckboxSelection=!0)}),this._connects.push(r.connect(this,"onCellClick",function(c){a.selectItem(c)})),this._connects.push(r.connect(this.rowSelectCell,
"toggleAllSelection",function(c){a.toggleAllSelection(c)}))},markSelectedCheckBoxes:function(a,c){for(var b=0;b<a.length;b++){var e=a[b]._0;this.pushItemIdIntoGridArray(a[b],!0);this.selection.setSelected(e,!0)}},selectItem:function(a){var c=a.rowIndex;a=this.selection.selected[c];c=this.getItem(c);switch(this.type){case "bill_item":c.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&c.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&c.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&
0!=c.grand_total[0]&&this.pushItemIdIntoGridArray(c,a);break;case "update_total_unit":this.pushItemIdIntoGridArray(c,a)}},pushItemIdIntoGridArray:function(a,c){var b=dojo.indexOf(this.selectedItemIds,a.id[0]),e=dojo.indexOf(this.unSelectedItemIds,a.id[0]);c?(-1==b&&this.selectedItemIds.push(a.id[0]),-1!=e&&this.unSelectedItemIds.splice(e,1)):(-1!=b&&this.selectedItemIds.splice(b,1),-1==e&&this.unSelectedItemIds.push(a.id[0]))},toggleAllSelection:function(a){var c=this,b=c.selection;a?(b.selectRange(0,
c.rowCount-1),c.selectedItemIds=[],c.store.fetch({onComplete:function(b){dojo.forEach(b,function(b,a){if(b)switch(c.type){case "bill_item":b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&0!=b.grand_total[0]&&c.selectedItemIds.push(b.id[0]);break;case "update_total_unit":c.selectedItemIds.push(b.id[0])}})}}),c.unSelectedItemIds=[]):(c.unSelectedItemIds=
[],c.store.fetch({onComplete:function(b){dojo.forEach(b,function(b,a){if(b)switch(c.type){case "bill_item":b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&0!=b.grand_total[0]&&c.unSelectedItemIds.push(b.id[0]);break;case "update_total_unit":c.unSelectedItemIds.push(b.id[0])}})}}),b.deselectAll(),c.selectedItemIds=[])},destroy:function(){this.inherited(arguments);
dojo.forEach(this._connects,r.disconnect);delete this._connects},tagBillItems:function(a){var c=this.scheduleTaskItem.hasOwnProperty("idFromDB")&&!isNaN(parseInt(this.scheduleTaskItem.idFromDB))?this.scheduleTaskItem.idFromDB:this.scheduleTaskItem.id,b=this,e=buildspace.dialog.indeterminateProgressBar({title:d.savingData+". "+d.pleaseWait+"..."}),f={url:"projectManagement/tagBillItems",content:{id:c,uid:a.id,sid:[this.selectedItemIds],usid:[this.unSelectedItemIds],_csrf_token:this.scheduleTaskItem._csrf_token},
handleAs:"json",load:function(a){a.success&&b.tagBillItemGrid&&(b.tagBillItemGrid.store.save(),b.tagBillItemGrid.store.close(),b.tagBillItemGrid.refreshGrid());b.selectedItemIds=[];b.unSelectedItemIds=[];e.hide();b.dialogWidget.hide()},error:function(a){b.selectedItemIds=[];b.unSelectedItemIds=[];e.hide();b.dialogWidget.hide()}};0==this.selectedItemIds.length?buildspace.dialog.confirm(d.confirmation,"<div>"+d.areYouSureToRemoveAllTaggedBillItems+"</div>",75,280,function(){e.show().then(function(){dojo.xhrPost(f)})}):
e.show().then(function(){dojo.xhrPost(f)})},updateTotalUnits:function(a){var c=this,b=buildspace.dialog.indeterminateProgressBar({title:d.savingData+". "+d.pleaseWait+"..."}),e={url:"projectManagement/totalUnitsUpdate",content:{id:a.id,sid:[this.selectedItemIds],usid:[this.unSelectedItemIds],_csrf_token:this.scheduleTaskItem._csrf_token},handleAs:"json",load:function(a){a.success&&c.tagBillItemGrid&&(c.tagBillItemGrid.store.save(),c.tagBillItemGrid.store.close(),c.tagBillItemGrid.refreshGrid());c.selectedItemIds=
[];c.unSelectedItemIds=[];b.hide();c.dialogWidget.hide()},error:function(a){c.selectedItemIds=[];c.unSelectedItemIds=[];b.hide();c.dialogWidget.hide()}};0==this.selectedItemIds.length?buildspace.dialog.confirm(d.confirmation,"<div>"+d.areYouSureToRemoveAllTaggedUnits+"</div>",75,280,function(){b.show().then(function(){dojo.xhrPost(e)})}):b.show().then(function(){dojo.xhrPost(e)})}}),q=m("buildspace.apps.ProjectManagement.BillGridContainer",dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0;margin:0;width:100%;height:100%;",
gutters:!1,projectScheduleId:-1,scheduleTaskItem:null,typeReferenceUnit:null,scheduleTaskItemBillItem:null,tagBillItemGrid:null,dialogWidget:null,gridOpts:{},pageId:0,type:-1,postCreate:function(){this.inherited(arguments);x.mixin(this.gridOpts,{scheduleTaskItem:this.scheduleTaskItem,dialogWidget:this.dialogWidget,tagBillItemGrid:this.tagBillItemGrid,type:this.type});var a=this.grid=new C(this.gridOpts),c=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});c.addChild(new dijit.form.Button({label:d.close,
iconClass:"icon-16-container icon-16-close",onClick:dojo.hitch(this.dialogWidget,"hide")}));if("bill_item"==this.type||"update_total_unit"==this.type)c.addChild(new dijit.ToolbarSeparator),c.addChild(new dijit.form.Button({label:d.save,iconClass:"icon-16-container icon-16-save",style:"outline:none!important;",onClick:"bill_item"==this.type?dojo.hitch(a,"tagBillItems",this.typeReferenceUnit):dojo.hitch(a,"updateTotalUnits",this.scheduleTaskItemBillItem)}));this.addChild(c);this.addChild(new dijit.layout.ContentPane({style:"width:100%",
content:a,region:"center"}));if(c=dijit.byId("tagBillItemGrid-"+this.projectScheduleId+"_"+this.scheduleTaskItem.id+"-stackContainer")){var b=document.createElement("div"),a=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,45),id:this.pageId,content:this,grid:a,executeScripts:!0},b);c.addChild(a);c.selectChild(this.pageId)}}}),D=function(a,c){return buildspace.getBillTypeText(a)},E=function(a,c,b){c=this.grid.getItem(c);a=0<parseInt(a)?a:"&nbsp;";if(c.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||
c.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||c.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID||c.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY)b.customClasses.push("disable-cell"),a="&nbsp;";void 0!=c.type&&1>c.type&&b.customClasses.push("invalidTypeItemCell");return a},w=m("buildspace.apps.ProjectManagement.BillDialog",dijit.Dialog,{style:"padding:0;margin:0;",title:d.tagBillItems,projectScheduleId:-1,scheduleTaskItem:null,tagBillItemGrid:null,
type:-1,scheduleTaskItemBillItem:null,buildRendering:function(){this.title="update_total_unit"==this.type?d.tagUnitsToBillItem:d.tagBillItems;var a=this,c,b,e,f;f=new l;var h=function(b){};"update_total_unit"==this.type?(c=dojo.data.ItemFileWriteStore({url:"projectManagement/getScheduleTaskItemBillItemUnitList/id/"+this.scheduleTaskItemBillItem.id,clearOnClose:!0}),b=[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:f.rowCountCellFormatter},{name:d.description,field:"description",
width:"auto",formatter:f.typeListTreeCellFormatter}],e="update_total_unit",f=d.units):(c=dojo.data.ItemFileWriteStore({url:"projectManagement/getBillList/id/"+this.projectScheduleId,clearOnClose:!0}),b=[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:f.rowCountCellFormatter},{name:d.title,field:"title",width:"auto"},{name:d.billType,field:"bill_type",width:"120px",styles:"text-align:center;",formatter:D}],h=function(b){b=this.getItem(b.rowIndex);0<b.id&&a.createTypeReferenceGrid(b)},
e=null,f=d.bills);c=new q({projectScheduleId:this.projectScheduleId,scheduleTaskItem:this.scheduleTaskItem,tagBillItemGrid:this.tagBillItemGrid,dialogWidget:this,type:e,scheduleTaskItemBillItem:this.scheduleTaskItemBillItem,gridOpts:{store:c,structure:b,onRowDblClick:h}});c=this.makeGridContainer(c,f);c.startup();this.content=c;this.inherited(arguments)},postCreate:function(){z.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},
_onKey:function(a){a.keyCode==y.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createTypeReferenceGrid:function(a){var c=this,b=new l,e=this.scheduleTaskItem.hasOwnProperty("idFromDB")&&!isNaN(parseInt(this.scheduleTaskItem.idFromDB))?this.scheduleTaskItem.idFromDB:this.scheduleTaskItem.id;new q({stackContainerTitle:a.title,projectScheduleId:this.projectScheduleId,scheduleTaskItem:this.scheduleTaskItem,tagBillItemGrid:this.tagBillItemGrid,dialogWidget:this,pageId:"tagBillItemTypeReference-"+
this.projectScheduleId+"_"+this.scheduleTaskItem.id,gridOpts:{store:dojo.data.ItemFileWriteStore({url:"projectManagement/getTypeReferenceList/id/"+e+"/bid/"+a.id,clearOnClose:!0}),structure:[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:b.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",formatter:b.typeListTreeCellFormatter}],onRowDblClick:function(b){b=this.getItem(b.rowIndex);0<b.level&&c.createBillElementGrid(b,a)}}})},createBillElementGrid:function(a,
c){var b=this,e=new l,f=this.scheduleTaskItem.hasOwnProperty("idFromDB")&&!isNaN(parseInt(this.scheduleTaskItem.idFromDB))?this.scheduleTaskItem.idFromDB:this.scheduleTaskItem.id;new q({stackContainerTitle:a.description,projectScheduleId:this.projectScheduleId,scheduleTaskItem:this.scheduleTaskItem,tagBillItemGrid:this.tagBillItemGrid,dialogWidget:this,pageId:"tagBillItemElement-"+this.projectScheduleId+"_"+this.scheduleTaskItem.id,gridOpts:{store:dojo.data.ItemFileWriteStore({url:"projectManagement/getBillElementList/id/"+
f+"/bid/"+c.id+"/tid/"+a.id,clearOnClose:!0}),structure:[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:e.rowCountCellFormatter},{name:d.description,field:"description",width:"auto"}],onRowDblClick:function(e){e=this.getItem(e.rowIndex);0<e.id&&b.createBillItemGrid(c,e,a)}}})},createBillItemGrid:function(a,c,b){var e=this.scheduleTaskItem.hasOwnProperty("idFromDB")&&!isNaN(parseInt(this.scheduleTaskItem.idFromDB))?this.scheduleTaskItem.idFromDB:this.scheduleTaskItem.id;a=
new l;e=dojo.data.ItemFileWriteStore({url:"projectManagement/getBillItemList/eid/"+c.id+"/tid/"+b.id+"/id/"+e,clearOnClose:!0});new q({stackContainerTitle:c.description,projectScheduleId:this.projectScheduleId,scheduleTaskItem:this.scheduleTaskItem,tagBillItemGrid:this.tagBillItemGrid,typeReferenceUnit:b,dialogWidget:this,pageId:"tagBillItemItem-"+this.projectScheduleId+"_"+this.scheduleTaskItem.id,type:"bill_item",gridOpts:{store:e,escapeHTMLInData:!1,structure:[{name:d.billReference,field:"bill_ref",
styles:"text-align:center;color:red;",width:"80px",formatter:a.unEditableCellFormatter},{name:d.description,field:"description",width:"auto",formatter:a.treeCellFormatter},{name:d.type,field:"type",width:"70px",styles:"text-align:center;",formatter:a.typeCellFormatter},{name:d.grandTotal,field:"grand_total",styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0}]}})},makeGridContainer:function(a,c){var b=this.projectScheduleId+"_"+this.scheduleTaskItem.id,
e=dijit.byId("tagBillItemGrid-"+b+"-stackContainer");e&&dijit.byId("tagBillItemGrid-"+b+"-stackContainer").destroyRecursive();var e=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:none;",region:"center",id:"tagBillItemGrid-"+b+"-stackContainer"}),f=new dijit.layout.ContentPane({title:c,content:a,grid:a.grid});e.addChild(f);var f=new dijit.layout.StackController({region:"top",containerId:"tagBillItemGrid-"+b+"-stackContainer"}),f=new dijit.layout.ContentPane({style:"padding:0;margin:0;overflow:hidden;",
"class":"breadCrumbTrail",region:"top",content:f}),d=new dijit.layout.BorderContainer({style:"padding:0;margin:0;width:780px;height:420px;border:0px;",gutters:!1});d.addChild(e);d.addChild(f);dojo.subscribe("tagBillItemGrid-"+b+"-stackContainer-selectChild","",function(a){var c=dijit.byId("tagBillItemGrid-"+b+"-stackContainer");if(c){var e=c.getChildren(),d=dojo.indexOf(e,a);if(e.length>d+1){a.grid.store.save();a.grid.store.close();var f=n.after(a.grid,"_onFetchComplete",function(){f.remove();this.scrollToRow(this.selection.selectedIndex)});
a.grid._refresh()}for(;e.length>d+1;)d+=1,c.removeChild(e[d]),e[d].destroyRecursive()}});return d}});return m("buildspace.apps.ProjectManagement.TagBillItemGrid",v,{escapeHTMLInData:!1,style:"border-top:none;",keepSelection:!0,scheduleTaskItem:null,id:"taggedBillItemEnhancedGrid",constructor:function(a,c){this.structure=this.constructStructure()},postCreate:function(){var a=this;this.inherited(arguments);this.on("RowClick",function(b){(b=a.getItem(b.rowIndex))&&0<b.id&&b.hasOwnProperty("type")&&0<
b.type&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0)});var a=this,c=n.after(this,"_onFetchComplete",function(){c.remove();a.getTotalDurationAndProductivity()})},_refresh:function(a){this._clearData();this._fetch(0,a);var c=this,b=u.on("widget-focus",function(a){"TaskEditor-TabContainer_tablist_tabChild-billItemList"==
a.id&&(u.focus(p.byId("taggedBillItemEnhancedGrid")),b.remove(),c.focus&&0<=c.focus.rowIndex&&0<=c.focus.cell.index&&c.focus.setFocusIndex(c.focus.rowIndex,c.focus.cell.index))})},getTotalDurationAndProductivity:function(){var a=this.store;a.fetch({onComplete:function(c){var b=0,e=0,d=0,h=0,t=0,k=0;dojo.forEach(c,function(c){h=g.parse(a.getValue(c,"duration_days"));t=g.parse(a.getValue(c,"up_to_date_claim_amount"));k=g.parse(a.getValue(c,"contract_amt"));isNaN(h)||(b+=h);isNaN(t)||(e+=t);isNaN(k)||
(d+=k)});p.byId("totalDurationNode").textContent=g.format(b,{places:2});c=0!=d?e/d*100:0;p.byId("completionPercentageNode").textContent=g.format(c,{places:2});p.byId("contractAmountNode").textContent=g.format(d,{places:2})}})},refreshGrid:function(){this.beginUpdate();this.store.close();var a=this,c=n.after(this,"_onFetchComplete",function(){c.remove();a.getTotalDurationAndProductivity()});this._refresh();this.endUpdate()},constructStructure:function(){var a=new l,c=function(b,a,c){a=this.grid.getItem(a);
b=g.parse(b);if(isNaN(b)||0==b||null==b||a&&a.hasOwnProperty("type")&&a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)b="&nbsp;";else{var e=g.format(b,{places:2});b=0<=b?e:'<span style="color:#FF0000">'+e+"</span>"}(a&&!a.hasOwnProperty("type")||a.hasOwnProperty("type")&&0<a.type&&a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||
a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)&&c.customClasses.push("disable-cell");a.hasOwnProperty("type")&&1>a.type&&(c.customClasses.push("invalidTypeItemCell"),b="&nbsp;");return b};return[{cells:[[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",rowSpan:2,formatter:a.rowCountCellFormatter},{name:d.total+" "+d.unit,field:"total_unit",width:"70px",rowSpan:2,styles:"text-align:center;",formatter:E},{name:d.description,field:"description",width:"680px",rowSpan:2,formatter:a.analysisTreeCellFormatter},
{name:d.unit,field:"uom_symbol",width:"70px",rowSpan:2,styles:"text-align:center;",formatter:a.unitIdCellFormatter},{name:d.qty+"/"+d.unit,field:"qty_per_unit",width:"80px",rowSpan:2,styles:"text-align:right;",formatter:a.unEditableNumberCellFormatter},{name:d.total+" "+d.qty,field:"total_qty",width:"80px",rowSpan:2,styles:"text-align:right;",formatter:a.unEditableNumberCellFormatter},{field:"productivity",name:d.productivity,width:"80px",styles:"text-align:center;",rowSpan:2,editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",
formatter:c},{field:"productivity_type",name:d.productivityType,width:"120px",styles:"text-align:center;",rowSpan:2,formatter:function(b,a,c){if((b=this.grid.getItem(a))&&b.hasOwnProperty("productivity_type")&&b.hasOwnProperty("type")&&0<b.type&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)switch(b.productivity_type[0]){case buildspace.constants.PROJECT_SCHEDULE_PRODUCTIVITY_TYPE_UNIT_PER_HOUR:b=
buildspace.constants.PROJECT_SCHEDULE_PRODUCTIVITY_TYPE_UNIT_PER_HOUR_TEXT;break;default:b="&nbsp;"}else b&&b.hasOwnProperty("type")&&1>b.type?c.customClasses.push("invalidTypeItemCell"):c.customClasses.push("disable-cell"),b="&nbsp;";return b}},{name:d.noOfGang,field:"number_of_gang",width:"60px",styles:"text-align:center;",rowSpan:2,editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:c},{name:d.hours,field:"duration_hours",width:"70px",editable:!0,styles:"text-align:center;",
cellType:"buildspace.widget.grid.cells.Textarea",formatter:c},{name:d.days,field:"duration_days",width:"70px",editable:!0,styles:"text-align:center;",cellType:"buildspace.widget.grid.cells.Textarea",formatter:c},{field:"contract_amt",name:d.contractAmount,width:"120px",styles:"text-align:right;",rowSpan:2,formatter:a.unEditableCurrencyCellFormatter},{field:"up_to_date_claim_percentage",name:"%",width:"70px",styles:"text-align:right;",editable:!0,formatter:function(b,a,c){b=this.grid.getItem(a);a=
"&nbsp;";b&&b.hasOwnProperty("type")&&1>b.type&&c.customClasses.push("invalidTypeItemCell");b&&b.hasOwnProperty("bill_type")&&b.bill_type==buildspace.constants.BILL_TYPE_PRELIMINARY&&c.customClasses.push("disable-cell");if(b.hasOwnProperty("up_to_date_claim_percentage")&&0<b.id)if("MULTI"==b.up_to_date_claim_percentage[0])a='<span style="color:#ee9f05;">MULTI&nbsp;&nbsp;&nbsp;</span>';else{a=g.parse(b.up_to_date_claim_percentage[0]);if(isNaN(a)||0==a||null==a)a="&nbsp;";else{var e=g.format(a,{places:2})+
"%";a=0<=a?'<span style="color:blue;">'+e+"</span>":'<span style="color:#FF0000">'+e+"</span>"}if(0<b.type&&b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)c.customClasses.push("disable-cell"),a="&nbsp;"}return a}},{field:"up_to_date_claim_amount",name:d.amount,width:"120px",styles:"text-align:right;",editable:!0,formatter:function(b,a,c){b=this.grid.getItem(a);
a="&nbsp;";b&&b.hasOwnProperty("type")&&1>b.type&&c.customClasses.push("invalidTypeItemCell");b&&b.hasOwnProperty("bill_type")&&b.bill_type==buildspace.constants.BILL_TYPE_PRELIMINARY&&c.customClasses.push("disable-cell");if(b.hasOwnProperty("up_to_date_claim_amount")&&0<b.id)if("MULTI"==b.up_to_date_claim_amount[0])a='<span style="color:#ee9f05;">MULTI&nbsp;&nbsp;&nbsp;</span>';else{var d=g.parse(b.up_to_date_claim_amount[0]);a=isNaN(d)||0==d||null==d?"&nbsp;":A.format(d);a=0<=d?a:'<span style="color:#FF0000">'+
a+"</span>";if(0<b.type&&b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)c.customClasses.push("disable-cell"),a="&nbsp;"}return a}}],[{name:d.duration,styles:"text-align:center;",noresize:!0,colSpan:2,headerClasses:"staticHeader "},{name:d.actualWorkDone,styles:"text-align:center;",noresize:!0,colSpan:2,headerClasses:"staticHeader "}]]}]},doApplyCellEdit:function(a,
c,b){var e=this,f=this.getItem(c),h=this.store,g=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."}),k;"up_to_date_claim_percentage"==b||"up_to_date_claim_amount"==b?(k=this.getCellByField(b),g.show().then(function(){dojo.xhrPost({url:"projectManagement/updateClaim",content:{id:f.id[0],attr_name:b,val:a,t:"up_to_date_claim_percentage"==b?"p":"a",_csrf_token:f._csrf_token?f._csrf_token:null},handleAs:"json",load:function(a){if(a.success){if(0<f.id){for(var b in a.data)b!=h._getIdentifierAttribute()&&
f.hasOwnProperty(b)&&h.setValue(f,b,a.data[b]);h.save()}window.setTimeout(function(){e.focus.setFocusIndex(c,k.index)},10);g.hide()}e.refreshGrid()},error:function(a){g.hide()}})})):(a!==f[b][0]&&0<f.id&&(k=this.getCellByField(b),g.show().then(function(){dojo.xhrPost({url:"projectManagement/taggedBillItemUpdate",content:{id:f.id[0],attr_name:b,val:a,_csrf_token:f._csrf_token?f._csrf_token:null},handleAs:"json",load:function(a){if(a.success){if(0<f.id){for(var b in a.data)b!=h._getIdentifierAttribute()&&
f.hasOwnProperty(b)&&h.setValue(f,b,a.data[b]);h.save()}window.setTimeout(function(){e.focus.setFocusIndex(c,k.index)},10);g.hide()}e.refreshGrid()},error:function(a){g.hide()}})})),this.inherited(arguments))},canSort:function(a){return!1},doCancelEdit:function(a){this.inherited(arguments);this.views.renormalizeRow(a);this.scroller.rowHeightChanged(a,!0)},canEdit:function(a,c){if(void 0!=a){var b=this.getItem(c);if(b&&0<b.id&&b.hasOwnProperty("type")&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID)if("up_to_date_claim_percentage"==a.field||"up_to_date_claim_amount"==a.field){if(!b.hasOwnProperty("bill_type")||b.bill_type!=buildspace.constants.BILL_TYPE_PRELIMINARY)return!0}else return this._canEdit}return!1},openBillDialog:function(){(new w({projectScheduleId:this.projectSchedule.id[0],scheduleTaskItem:this.scheduleTaskItem,tagBillItemGrid:this})).show()},dodblclick:function(a){var c=
a.cell.field;(a=this.getItem(a.rowIndex))&&0<a.id&&a.hasOwnProperty("type")&&0<a.type[0]&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&("total_unit"==c&&(new w({type:"update_total_unit",scheduleTaskItemBillItem:a,projectScheduleId:this.projectSchedule.id[0],scheduleTaskItem:this.scheduleTaskItem,tagBillItemGrid:this})).show(),"up_to_date_claim_percentage"!=
c&&"up_to_date_claim_amount"!=c||!a.hasOwnProperty("bill_type")||a.bill_type==buildspace.constants.BILL_TYPE_PRELIMINARY||(new B({scheduleTaskItemBillItem:a,type:c,tagBillItemGrid:this,title:"up_to_date_claim_percentage"==c?d.actualWorkDone+" (%)":d.actualWorkDone+" ("+d.amount+")"})).show())},deleteRow:function(a){var c=this,b=buildspace.dialog.indeterminateProgressBar({title:d.deleting+". "+d.pleaseWait+"..."});buildspace.dialog.confirm(d.confirmation,d.deleteTaggedBillItemAndAllData,90,310,function(){b.show().then(function(){dojo.xhrPost({url:"projectManagement/taggedBillItemDelete",
content:{id:a.id,_csrf_token:a._csrf_token},handleAs:"json",load:function(a){a.success&&(c.store.save(),c.store.close(),c.sort());b.hide();c.selection.clear();c.disableToolbarButtons(!0)},error:function(a){b.hide();c.selection.clear();c.disableToolbarButtons(!0)}})})})},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var c=a.node.children[0].children[0].rows[1],b=a.node.children[0].children[0].rows[0].children;c.parentNode.removeChild(c);
dojo.forEach(b,function(a,b){var c=dojo.attr(a,"rowSpan");(!c||2>c)&&dojo.attr(a,"rowSpan",2)})}},disableToolbarButtons:function(a){var c=dijit.byId("ProjectManagement"+this.scheduleTaskItem.id+"-TaggedBillItemDeleteRow-button");c&&c._setDisabledAttr(a)}})});
