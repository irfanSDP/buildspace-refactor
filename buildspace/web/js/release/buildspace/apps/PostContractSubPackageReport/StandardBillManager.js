define("buildspace/apps/PostContractSubPackageReport/StandardBillManager","dojo/_base/declare dojo/_base/connect dojo/dom-style dojo/when dojo/number dojo/currency dijit/layout/ContentPane dojox/grid/EnhancedGrid buildspace/widget/grid/cells/Formatter buildspace/apps/ProjectBuilder/BillManager/ScheduleOfQuantityGrid ./BillManager/buildUpQuantityGrid ./BillManager/buildUpQuantitySummary dojo/request dojo/aspect dojo/json dojo/store/Memory dojox/grid/enhanced/plugins/IndirectSelection dijit/DropDownMenu dijit/form/DropDownButton dijit/MenuItem ./BillManager/StandardBillGrid ./BillManager/PrintPreviewElementByTypesDialog ./BillManager/PrintPreviewElementByTypesByUnitsWithClaimDialog dojo/i18n!buildspace/nls/PostContract".split(" "),
function(w,x,N,O,u,P,Q,C,y,D,R,E,q,S,z,k,T,F,G,v,A,H,B,e){var I=function(a,b,c){b=this.grid.getItem(b);void 0!=b.type&&1>b.type&&c.customClasses.push("invalidTypeItemCell");return 0<a?a:""},L=w("buildspace.apps.PostContractSubPackageReport.TypeGrid",C,{rootProject:null,style:"border:none;",region:"center",pageId:null,billId:null,subPackage:null,updateUrl:null,keepSelection:!0,rowSelector:"0px",constructor:function(a){var b=new y;this.structure={noscroll:!1,cells:[[{name:"No.",field:"count",width:"30px",
styles:"text-align:center;",formatter:I,rowSpan:2},{name:e.description,field:"description",width:"auto",formatter:b.typeListTreeCellFormatter,rowSpan:2},{name:e.amount,field:"total_per_unit",width:"120px",styles:"text-align: right;color:blue;",formatter:b.unEditableCurrencyCellFormatter,rowSpan:2},{name:e.percent,field:"up_to_date_percentage",width:"120px",headerClasses:"typeHeader1",formatter:b.unEditablePercentageCellFormatter,styles:"text-align: right;"},{name:e.amount,field:"up_to_date_amount",
width:"120px",headerClasses:"typeHeader1",formatter:b.unEditableCurrencyCellFormatter,styles:"text-align: right;"}],[{name:e.upToDateClaim,styles:"text-align:center;",headerClasses:"staticHeader typeHeader1",colSpan:2}]]};this.plugins={indirectSelection:{headerSelector:!0,width:"40px",styles:"text-align: center;"}};this.inherited(arguments)},postCreate:function(){this.inherited(arguments);var a=this;this._connects.push(x.connect(this,"onCellClick",function(b){""===b.cell.name&&a.singleCheckBoxSelection(b)}));
this._connects.push(x.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)}))},canSort:function(a){return!1},dodblclick:function(a){this.onRowDblClick(a)},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);dojo.forEach(c,function(a,b){b=dojo.attr(a,"rowSpan");(!b||2>b)&&dojo.attr(a,
"rowSpan",2)})}},reload:function(){this.store.close();this._refresh()},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);this.removedIds=[];if(a)return this.gridContainer.typesPreviewStore.put({id:b.id[0]}),this.getAffectedElementsAndItemsByBillId(b,"add");this.gridContainer.typesPreviewStore.remove(b.id[0]);this.removedIds.push(b.id[0]);return this.getAffectedElementsAndItemsByBillId(b,"remove")},toggleAllSelection:function(a){var b=this,c=this.selection;
b.removedIds=[];if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){a.id&&b.gridContainer.typesPreviewStore.put({id:a.id[0]})})}}),b.getAffectedElementsAndItemsByBillId(null,"add");c.deselectAll();b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){a.id&&(b.gridContainer.typesPreviewStore.remove(a.id[0]),b.removedIds.push(a.id[0]))})}});return b.getAffectedElementsAndItemsByBillId(null,"remove")},getAffectedElementsAndItemsByBillId:function(a,
b){var c=this;a=c.gridContainer.typesPreviewStore;var d=[],l=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});l.show();if("add"===b)a.query().forEach(function(a){d.push(a.id)});else for(var f in c.removedIds)d.push(c.removedIds[f]);d=d.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse();l.show();q.post("postContractStandardBillClaimReporting/getAffectedElementsAndItems",{handleAs:"json",data:{id:c.billId,type_ids:z.stringify(d)}}).then(function(a){if("add"===
b)for(var d in a){c.gridContainer.elementPreviewStore[d]||(c.gridContainer.elementPreviewStore[d]=new k({idProperty:"id"}));c.gridContainer.itemPreviewStore[d]||(c.gridContainer.itemPreviewStore[d]=new k({idProperty:"id"}));for(var g in a[d]){c.gridContainer.elementPreviewStore[d].put({id:g});for(var e in a[d][g])c.gridContainer.itemPreviewStore[d].put({id:a[d][g][e]})}}else for(var f in c.removedIds)c.gridContainer.elementPreviewStore[c.removedIds[f]]=new k({idProperty:"id"}),c.gridContainer.itemPreviewStore[c.removedIds[f]]=
new k({idProperty:"id"});l.hide()},function(a){l.hide();console.log(a)})}});return w("buildspace.apps.PostContractSubPackageReport.StandardBillManager",dijit.layout.BorderContainer,{style:"padding:0px;border:0px;width:100%;height:100%;",gutters:!1,billId:null,subPackage:null,rootProject:null,typesPreviewStore:[],elementPreviewStore:[],itemPreviewStore:[],constructor:function(a){this.typesPreviewStore=[];this.elementPreviewStore=[];this.itemPreviewStore=[];this.inherited(arguments)},postCreate:function(){this.inherited(arguments);
var a=this;a.createTypeGrid();dojo.subscribe("subPackagePostContractReportStandardBill"+a.billId+"-stackContainer-selectChild","",function(b){var c=dijit.byId("subPackagePostContractReportStandardBill"+a.billId+"-stackContainer");if(c){var d=c.getChildren();b=dojo.indexOf(d,dijit.byId(b));b+=1;if(d.length>b)for(;d.length>b;)c.removeChild(d[b]),d[b].destroyDescendants(),d[b].destroyRecursive(),b+=1}})},createTypeGrid:function(){var a=this,b=dijit.byId("subPackagePostContractReportStandardBill"+this.billId+
"-stackContainer");b&&dijit.byId("subPackagePostContractReportStandardBill"+this.billId+"-stackContainer").destroyRecursive();b=this.stackContainer=new dijit.layout.StackContainer({style:"border:0px;width:100%;height:100%;",region:"center",id:"subPackagePostContractReportStandardBill"+this.billId+"-stackContainer"});var c=this;dojo.xhrGet({url:"postContract/getBillInfo",handleAs:"json",content:{id:this.billId}}).then(function(d){a.typesPreviewStore=new k({idProperty:"id"});a.billInfo=d;try{var l=
dojo.data.ItemFileWriteStore({url:"subPackagePostContractStandardBillClaim/getTypeList/id/"+a.billId+"/sub_package_id/"+a.subPackage.id,clearOnClose:!0}),f=new L({billId:c.billId,rootProject:c.rootProject,subPackage:c.subPackage,pageId:"type-page-"+c.billId,id:"postContractReport-type-page-container-"+c.billId,updateUrl:"subPackagePostContractStandardBillClaim/updateTypeList",store:l,gridContainer:a,onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.level[0]&&c.createElementGrid(a,d,f)}}),h=
new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",stackContainerTitle:"",gutters:!1}),m=new dijit.Toolbar({region:"top",style:"outline:none!important; border-bottom:none; padding:2px; width:100%;"}),g=new F({style:"display: none;"}),J=new v({label:e.types,onClick:function(){a.openPrintPreviewDialogByTypes()}});g.addChild(J);var K=new v({label:e.unitsWithClaimOnly,onClick:function(){a.openPrintPreviewDialogByUnitsWithClaim()}});g.addChild(K);var r=new v({label:e.allUnits,
onClick:function(){a.openPrintPreviewDialogByAllUnits()}});g.addChild(r);m.addChild(new G({label:e.type+" / "+e.unit,iconClass:"icon-16-container icon-16-print",dropDown:g}));h.addChild(m);h.addChild(new dijit.layout.ContentPane({style:"width:100%",content:f,region:"center"}));var t=new dijit.layout.ContentPane({title:e.type+" / "+e.unit,content:h,grid:f}),n=new dijit.layout.StackController({region:"top",containerId:"subPackagePostContractReportStandardBill"+c.billId+"-stackContainer"});b.addChild(t);
var M=new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;",baseClass:"breadCrumbTrail",region:"top",id:"billGrid"+c.billId+"-controllerPane",content:n});c.addChild(b);c.addChild(M)}catch(p){console.debug(p)}})},createElementGrid:function(a,b,c){var d=this,e=a.id[0];d.elementPreviewStore[e]||(d.elementPreviewStore[e]=new k({idProperty:"id"}));d.itemPreviewStore[e]||(d.itemPreviewStore[e]=new k({idProperty:"id"}));dojo.xhrGet({url:"subPackagePostContractStandardBillClaim/getTypeItem",
handleAs:"json",content:{type_id:a.relation_id,project_id:d.rootProject.id,counter:a.count}}).then(function(a){var c=dojo.data.ItemFileWriteStore({url:"subPackagePostContractStandardBillClaim/getBillElementList/id/"+d.billId+"/project_id/"+d.rootProject.id+"/sub_package_id/"+d.subPackage.id+"/type_ref_id/"+a.id,clearOnClose:!0,urlPreventCache:!0}),f=new A({stackContainerTitle:0<a.new_name.length?a.relation_name+" :: "+a.new_name:a.relation_name+" :: "+a.description,billId:d.billId,subPackage:d.subPackage,
rootProject:d.rootProject,pageId:"element-page-"+d.billId,id:"postContractReport-element-page-container-"+d.billId,typeItem:a,type:"element",gridOpts:{typeItemId:e,store:c,typeColumns:b.column_settings,bqCSRFToken:b.bqCSRFToken,claimRevision:b.claim_project_revision_status,selectedClaimRevision:b.current_selected_claim_project_revision_status,currentGridType:"element",gridContainer:d,onRowDblClick:function(c){c=this.getItem(c.rowIndex);0<c.id[0]&&null!==c.description[0]&&""!==c.description[0]&&d.createItemGrid(c,
e,a,b,f)}}})})},createItemGrid:function(a,b,c,d,l){var f=this.billId,h=this,m=new dojo.data.ItemFileWriteStore({url:"subPackagePostContractStandardBillClaim/getItemList/id/"+a.id+"/bill_id/"+f+"/type_ref_id/"+a.claim_type_ref_id+"/project_id/"+h.rootProject.id+"/sub_package_id/"+h.subPackage.id,clearOnClose:!0});try{new A({stackContainerTitle:a.description,billId:f,disableEditing:!1,rootProject:h.rootProject,subPackage:h.subPackage,id:"postContractReport-item-page-container-"+f,elementId:a.id,pageId:"item-page-"+
f,type:"tree",typeItem:c,gridOpts:{typeItemId:b,store:m,escapeHTMLInData:!1,elementGridStore:l,claimRevision:d.claim_project_revision_status,selectedClaimRevision:d.current_selected_claim_project_revision_status,currentGridType:"item",gridContainer:h,onRowDblClick:function(a){var b=a.cell.field,d=this.getItem(a.rowIndex);if("qty_per_unit"==b&&d[b+"-has_build_up"][0]){var g=c.relation_id;a=dojo.xhrPost({url:"billBuildUpQuantity/getDimensionColumnStructure",content:{uom_id:d.uom_id[0]},handleAs:"json"});
var f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();a.then(function(a){h.createBuildUpQuantityContainer(d,a,g);f.hide()})}},editableCellDblClick:function(a){var b=a.cell.field;a=this.getItem(a.rowIndex);var c=this.store,d=!1;if("rate"==b&&0<a.id){if(u.parse(a.up_to_date_percentage)||u.parse(a.current_percentage)||u.parse(a.prev_percentage))d=!0;a.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&(new LumpSumPercentDialog({itemObj:a,projectId:h.rootProject.id,
billGridStore:c,elementGridStore:l,disableEditingMode:d})).show()}}}})}catch(g){console.debug(g)}},createBuildUpQuantityContainer:function(a,b,c){var d=this,l,f=new dijit.layout.BorderContainer({style:"padding:0;margin:0;width:100%;height:100%;border:none;outline:none;",gutters:!1}),h=new dijit.layout.TabContainer({nested:!0,style:"padding:0;border:none;margin:0;width:100%;height:100%;",region:"center"}),m=buildspace.constants.QUANTITY_PER_UNIT_ORIGINAL,g=new y,k=dojo.xhrGet({url:"billBuildUpQuantity/getLinkInfo/id/"+
a.id+"/bcid/"+c+"/t/"+m,handleAs:"json"}),q=new dojo.data.ItemFileWriteStore({url:"billBuildUpQuantity/getBuildUpQuantityItemList/bill_item_id/"+a.id+"/bill_column_setting_id/"+c+"/type/"+m,clearOnClose:!0}),r=!1,t=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});t.show();k.then(function(n){var k=[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:g.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea"},
{name:e.factor,field:"factor-value",width:"100px",styles:"text-align:right;",formatter:g.formulaNumberCellFormatter}];dojo.forEach(b,function(a){k.push({name:a.title,field:a.field_name,width:"100px",styles:"text-align:right;",formatter:g.formulaNumberCellFormatter})});k.push({name:e.total,field:"total",width:"100px",styles:"text-align:right;",formatter:g.numberCellFormatter});k.push({name:e.sign,field:"sign",width:"70px",styles:"text-align:center;",formatter:g.signCellFormatter});var p=new E({itemId:a.id,
billColumnSettingId:c,type:m,hasLinkedQty:n.has_linked_qty,container:f,_csrf_token:a._csrf_token,disableEditingMode:!0});n.has_linked_qty&&(r=!0,l=D({title:e.scheduleOfQuantities,BillItem:a,billColumnSettingId:c,disableEditingMode:!0,stackContainerId:"subPackagePostContractReportStandardBill"+d.billId+"-stackContainer",gridOpts:{qtyType:m,buildUpSummaryWidget:p,store:new dojo.data.ItemFileWriteStore({url:"billBuildUpQuantity/getScheduleOfQuantities/id/"+a.id+"/bcid/"+c+"/type/"+m,clearOnClose:!0}),
structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:g.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",formatter:g.treeCellFormatter},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",formatter:g.typeCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",formatter:g.unitIdCellFormatter},{name:e.qty,field:"quantity-value",width:"100px",styles:"text-align:right;",formatter:g.formulaNumberCellFormatter}]}}));
n=new dojox.grid.EnhancedGrid({title:e.manualQtyItems,region:"center",store:q,structure:k});h.addChild(n);r&&h.addChild(l);f.addChild(h);f.addChild(p);if(p=dijit.byId("subPackagePostContractReportStandardBill"+d.billId+"-stackContainer"))n=document.createElement("div"),n=new dojox.layout.ContentPane({title:buildspace.truncateString(a.description,45)+" ("+e.buildUpQuantity+" - "+a.uom_symbol+")",id:"subPackageBuildUpQuantityPage-"+a.id,style:"padding:0px;border:0px;",content:f,grid:r?l.grid:null,executeScripts:!0},
n),p.addChild(n),p.selectChild("subPackageBuildUpQuantityPage-"+a.id);t.hide()})},markedCheckBoxObject:function(a,b){var c=a.store;b.query().forEach(function(b){b.id!=buildspace.constants.GRID_LAST_ROW&&c.fetchItemByIdentity({identity:b.id,onItem:function(b){if(b)return a.rowSelectCell.toggleRow(b._0,!0)}})})},openPrintPreviewDialogByTypes:function(){var a=this,b=a.billInfo.column_settings,c=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});c.show();q.post("postContractSubPackageStandardBill/getPrintingPreviewDataByTypes",
{handleAs:"json",data:{subPackageId:a.subPackage.id,bill_id:a.billId}}).then(function(d){(new H({project:a.rootProject,title:e.types,data:d,subPackageId:a.subPackage.id,billId:a.billId,columnSettings:b})).show();c.hide()},function(a){console.log(a);c.hide()})},openPrintPreviewDialogByUnitsWithClaim:function(){var a=this,b=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});b.show();q.post("postContractSubPackageStandardBill/getPrintingPreviewDataByUnitsWithClaim",{handleAs:"json",
data:{subPackageId:a.subPackage.id,bill_id:a.billId}}).then(function(c){(new B({project:a.rootProject,title:e.unitsWithClaimOnly,data:c.items,subPackageId:a.subPackage.id,billId:a.billId,columnSettings:c.billColumns,dynamicUnitStructure:c.gridStructure,printURL:"postContractSubPackageStandardBill/printElementWithClaimByTypes",exportURL:"postContractSubPackageStandardBillExportExcelReporting/exportExcelElementWithClaimByTypes"})).show();b.hide()},function(a){console.log(a);b.hide()})},openPrintPreviewDialogByAllUnits:function(){var a=
this,b=[];a.typesPreviewStore.query().forEach(function(a){b.push(a.id)});var c=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});c.show();q.post("postContractSubPackageStandardBill/getPrintingPreviewDataBySelectedUnits",{handleAs:"json",data:{subPackageId:a.subPackage.id,bill_id:a.billId,itemIds:z.stringify(a.arrayUnique(b))}}).then(function(d){(new B({project:a.rootProject,title:e.allUnits,data:d.items,columnSettings:d.billColumns,dynamicUnitStructure:d.gridStructure,selectedRows:a.arrayUnique(b),
subPackageId:a.subPackage.id,billId:a.billId,printURL:"postContractSubPackageStandardBill/printElementWithClaimByTypesBySelectedUnits",exportURL:"postContractSubPackageStandardBillExportExcelReporting/exportExcelElementWithClaimByTypesBySelectedUnits"})).show();c.hide()},function(a){console.log(a);c.hide()})},arrayUnique:function(a){return a.reverse().filter(function(a,c,d){return-1===d.indexOf(a,c+1)}).reverse()}})});
