define("buildspace/apps/CostData/ProvisionalSumGrid","dojo/_base/declare dojo/_base/lang dojo/number dojo/currency dojox/grid/EnhancedGrid buildspace/widget/grid/cells/DateTextBox dojo/i18n!buildspace/nls/CostData".split(" "),function(n,r,p,q,s,w,c){var t=n("buildspace.apps.CostData.ProvisionalSumGrid",s,{style:"border:none;",region:"center",keepSelection:!0,rowSelector:"0px",escapeHTMLInData:!1,costData:null,addUrl:"provisionalSum/addNewItem",updateUrl:"provisionalSum/updateItem",constructor:function(a){this.inherited(arguments);
this.createHeaderCtxMenu()},canSort:function(a){return!1},postCreate:function(){var a=this;this.inherited(arguments);this.on("RowClick",function(b){if(b.cell){var c=!1;0<this.getItem(b.rowIndex).id[0]&&(c=!0);this.editable&&a.enableToolbarButtons(c)}});this.createHeaderCtxMenuItems()},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);
dojo.forEach(c,function(a,b){var c=dojo.attr(a,"rowSpan");(!c||2>c)&&dojo.attr(a,"rowSpan",2)})}},enableToolbarButtons:function(a){dijit.byId(this.costData.id+"provisional-sum-item-delete-button")._setDisabledAttr(!a)},doApplyCellEdit:function(a,b,f){var d=this,e=d.getItem(b),g=d.store;if(a!==e[f][0]){var m=buildspace.dialog.indeterminateProgressBar({title:c.savingData+". "+c.pleaseWait+"..."}),l={id:e.id,attr_name:f,val:a,cost_data_id:d.costData.id,_csrf_token:e._csrf_token?e._csrf_token:null},h=
this.updateUrl;e.id==buildspace.constants.GRID_LAST_ROW&&(h=0<b?d.getItem(b-1):!1,r.mixin(l,{prev_item_id:h?h.id:0}),h=this.addUrl);var k=function(a,b){for(var c in a)e.hasOwnProperty(c)&&c!=b._getIdentifierAttribute()&&b.setValue(e,c,a[c]);b.save()},l={url:h,content:l,handleAs:"json",load:function(a){if(a.success){0<e.id?k(a.data,g):(g.deleteItem(e),g.save(),dojo.forEach(a.items,function(a){g.newItem(a)}),g.save());var c=d.getCellByField(f);window.setTimeout(function(){d.focus.setFocusIndex(b,c.index)},
10);m.hide()}},error:function(a){m.hide()}};m.show();dojo.xhrPost(l)}d.inherited(arguments)},canEdit:function(a,b){return!0},createHeaderCtxMenu:function(){this.plugins={menus:{headerMenu:new dijit.Menu}}},createHeaderCtxMenuItems:function(){menusObject=this.plugins.menus;if("undefined"!==typeof this.structure){var a=this;dojo.forEach(this.structure.cells[0],function(b,f){if(b.showInCtxMenu){var d=b.name,e=b.field;switch(e){case "approved_cost":d=c.budget;break;case "awarded_cost":d=c.contractSum;
break;case "adjusted_sum":d=c.adjustedSum;break;default:d=b.name}menusObject.headerMenu.addChild(new dijit.CheckedMenuItem({label:d,checked:"undefined"===typeof b.hidden||!1===b.hidden?!0:!1,onChange:function(b){var c=!1;b&&(c=!0);a.showHideColumn(c,f,e);setCookie("CostData.hiddenColumns."+e,!c)}}))}})}},getCellIndexByAttribute:function(a,b){var c;dojo.forEach(this.layout.cells,function(d,e){d[a]&&d[a]==b&&(c=e)});return c},showHideColumn:function(a,b,f){this.beginUpdate();b=[b];"awarded_cost"==f&&
(b.push(this.getCellIndexByAttribute("field","awarded_date")),b.push(this.getCellIndexByAttribute("originalName",c.contractSum)));for(var d in b)this.layout.setColumnVisibility(b[d],a);this.endUpdate()},reload:function(){this.store.close();this._refresh()}}),u=function(a,b){return parseInt(b)+1},k=function(a,b,c){b=p.parse(a);return a=isNaN(b)||0==b||null==b?"&nbsp;":q.format(a)},v=function(a,b,c){this.grid.getItem(b);a=p.parse(a);a=isNaN(a)||0==a||null==a?"&nbsp;":q.format(a);c.customClasses.push("disable-cell");
return a};return n("buildspace.apps.CostData.ProvisionalSumContainer",dijit.layout.BorderContainer,{region:"center",title:"",style:"padding:0px;border:none;width:100%;height:100%;",gutters:!1,costData:null,grid:null,stackContainer:null,editable:!1,postCreate:function(){this.inherited(arguments);var a=this.createBreakdownGrid(),a=new dijit.layout.ContentPane({style:"padding:0px;border:none;width:100%;height:100%;",region:"center",content:a,grid:a});this.addChild(this.createToolbar());this.addChild(a)},
createToolbar:function(){var a=this,b=new dijit.Toolbar({region:"top",style:"outline:none!important;border:none;padding:2px;width:100%;"});b.addChild(new dijit.form.Button({id:this.costData.id+"provisional-sum-item-delete-button",label:c.delete,iconClass:"icon-16-container icon-16-delete",disabled:!0,style:"outline:none!important;",onClick:function(){if(-1<a.grid.selection.selectedIndex){var b=a.grid.getItem(a.grid.selection.selectedIndex);0<b.id[0]&&a.deleteRow(b)}}}));b.addChild(new dijit.ToolbarSeparator);
b.addChild(new dijit.form.Button({id:this.costData.id+"provisional-sum-refresh-button",label:c.refresh,iconClass:"icon-16-container icon-16-reload",style:"outline:none!important;",onClick:function(){a.grid.reload()}}));return b},getGridStructure:function(){return{nosroll:!1,cells:[[{name:"No.",field:"count",width:"30px",styles:"text-align:center;",rowSpan:2,formatter:u},{name:c.description,field:"description",width:"auto",rowSpan:2,cellType:"buildspace.widget.grid.cells.Textarea",editable:this.editable},
{name:this.costData.approved_date?c.budget+" ("+this.costData.approved_date+")":c.budget,field:"approved_cost",width:"140px",rowSpan:2,cellType:"buildspace.widget.grid.cells.Textarea",editable:this.editable,showInCtxMenu:!0,hidden:getCookieBoolean("CostData.hiddenColumns.approved_cost"),styles:"text-align:right;",formatter:k},{name:c.totalAmount,field:"awarded_cost",width:"140px",cellType:"buildspace.widget.grid.cells.Textarea",editable:this.editable,showInCtxMenu:!0,hidden:getCookieBoolean("CostData.hiddenColumns.awarded_cost"),
styles:"text-align:right;",formatter:k},{name:c.awardedDate,field:"awarded_date",width:"120px",cellType:"buildspace.widget.grid.cells.DateTextBox",editable:this.editable,hidden:getCookieBoolean("CostData.hiddenColumns.awarded_cost"),styles:"text-align:center;"},{name:this.costData.adjusted_date?c.adjustedSum+" ("+this.costData.adjusted_date+")":c.adjustedSum,originalName:c.adjustedSum,field:"adjusted_sum",width:"150px",rowSpan:2,showInCtxMenu:!0,styles:"text-align:right;",hidden:getCookieBoolean("CostData.hiddenColumns.adjusted_cost"),
formatter:v},{name:c.variationOrderCost,field:"variation_order_cost",width:"140px",rowSpan:2,cellType:"buildspace.widget.grid.cells.Textarea",editable:this.editable,showInCtxMenu:!0,hidden:getCookieBoolean("CostData.hiddenColumns.variation_order_cost"),styles:"text-align:right;",formatter:k}],[{name:this.costData.awarded_date?c.contractSum+" ("+this.costData.awarded_date+")":c.contractSum,originalName:c.contractSum,hidden:getCookieBoolean("CostData.hiddenColumns.awarded_cost"),styles:"text-align:center;",
headerClasses:"staticHeader",colSpan:2}]]}},createBreakdownGrid:function(){return this.grid=t({id:"costData-provisionalSumGrid",costData:this.costData,structure:this.getGridStructure(),store:new dojo.data.ItemFileWriteStore({clearOnClose:!0,url:"provisionalSum/getProvisionalSumBreakdown/costData/"+this.costData.id})})},deleteRow:function(a){var b=this,f=buildspace.dialog.indeterminateProgressBar({title:c.deleting+". "+c.pleaseWait+"..."});buildspace.dialog.confirm(c.confirmation,c.confirmationMessage+
"<br/>"+c.cannotBeUndone,80,300,function(){f.show().then(function(){dojo.xhrPost({url:"provisionalSum/deleteItem",content:{id:a.id,_csrf_token:a._csrf_token},handleAs:"json",load:function(a){a.success&&b.grid.reload();f.hide();b.grid.selection.clear();b.grid.enableToolbarButtons(!1)},error:function(a){f.hide();b.grid.selection.clear();b.grid.enableToolbarButtons(!1)}})})})}})});
