define("buildspace/apps/ProjectAnalyzerReport/ResourceContainer","dojo/_base/declare dojo/aspect dojo/store/Memory dojo/request ./ResourceGrid buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/ProjectAnalyzer".split(" "),function(r,t,m,q,n,p,f){return r("buildspace.apps.ProjectAnalyzerReport.ResourceContainer",dijit.layout.BorderContainer,{style:"padding:0px;width:100%;margin:0px;border:0px;height:100%;",gutters:!1,project:null,tradeSelectBoxStore:[],tradeItemSelectBoxStore:[],tradeBillItemSelectBoxStore:[],
type:null,postCreate:function(){this.inherited(arguments);var c=this,d=new p,b=dojo.data.ItemFileWriteStore({url:"projectAnalyzer/getResources/pid/"+c.project.id,clearOnClose:!0}),d=new n({id:"report_resource_analysis_category-"+c.project.id,stackContainerTitle:f.resources,pageId:"report_resource_analysis_category-"+c.project.id,project:c.project,gridOpts:{gridContainer:c,type:"resource",escapeHTMLInData:!1,store:b,structure:[{name:"No.",field:"id",width:"40px",styles:"text-align:center;",formatter:d.rowCountCellFormatter},
{name:f.description,field:"name",width:"auto",formatter:d.analyzerDescriptionCellFormatter},{name:f.totalCost,field:"total_cost",width:"150px",styles:"text-align:right;",formatter:d.unEditableCurrencyCellFormatter}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.name[0]&&c.createTradeGrid(a)}}}),d=this.makeGridContainer(d,f.resources);this.addChild(d)},createTradeGrid:function(c){var d=this,b=p(),a=new dojo.data.ItemFileWriteStore({url:"projectAnalyzer/getResourceTrades/pid/"+
d.project.id+"/id/"+c.id,clearOnClose:!0});d.tradeSelectBoxStore=new m({idProperty:"id"});d.tradeItemSelectBoxStore=new m({idProperty:"id"});d.tradeBillItemSelectBoxStore=[];n({id:"report_resource_analysis_trade-"+d.project.id,stackContainerTitle:c.name,pageId:"report_resource_analysis_trade-"+d.project.id+"_"+c.id,project:d.project,resource:c,type:d.type,gridOpts:{gridContainer:d,type:"trade",escapeHTMLInData:!1,store:a,structure:[{name:"No.",field:"id",width:"40px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},
{name:f.description,field:"description",width:"auto",formatter:b.analyzerDescriptionCellFormatter},{name:f.totalCost,field:"total_cost",width:"150px",styles:"text-align:right;",formatter:b.unEditableCurrencyCellFormatter}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);("unsorted"==a.id||0<a.id)&&null!==a.description[0]&&d.createItemGrid(a,c)},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);return a?(d.tradeSelectBoxStore.put({id:b.id[0]}),
this.getAffectedTradeItemsAndBillItems(b,"add")):this.getAffectedTradeItemsAndBillItems(b,"remove")},toggleAllSelection:function(a){var b=this,d=b.selection;if(a)return d.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,e){0<a.id&&b.gridContainer.tradeSelectBoxStore.put({id:a.id[0]})})}}),b.getAffectedTradeItemsAndBillItems(null,"add");d.deselectAll();return b.getAffectedTradeItemsAndBillItems(null,"remove")},getAffectedTradeItemsAndBillItems:function(a,
b){var c=d.tradeSelectBoxStore,e=[],h=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."});h.show();a?e.push(a.id[0]):(c.query().forEach(function(a){e.push(a.id)}),e=e.reverse().filter(function(a,b,e){return-1===e.indexOf(a,b+1)}).reverse());c=JSON.stringify(e);h.show();q.post("resourceProjectAnalyzerReport/getAffectedSelectionTradeItemsAndBillItems",{handleAs:"json",data:{pid:d.project.id,trade_ids:c}}).then(function(a){for(var e in a)d.tradeBillItemSelectBoxStore[e]||(d.tradeBillItemSelectBoxStore[e]=
new m({idProperty:"id"}));if("add"===b)for(e in a)for(var c in a[e]){d.tradeItemSelectBoxStore.put({id:c});for(var f in a[e][c])d.tradeBillItemSelectBoxStore[e].put({id:a[e][c][f]})}else for(e in a)for(c in d.tradeSelectBoxStore.remove(e),a[e])for(f in d.tradeItemSelectBoxStore.remove(c),a[e][c])d.tradeBillItemSelectBoxStore[e].remove(a[e][c][f]);h.hide()},function(a){h.hide();console.log(a)})}}})},createItemGrid:function(c,d){var b=this,a=p(),g=new dojo.data.ItemFileWriteStore({url:"projectAnalyzer/getResourceItems/pid/"+
b.project.id+"/rid/"+d.id+"/id/"+c.id,clearOnClose:!0}),k=[{name:"No.",field:"id",width:"40px",styles:"text-align:center;",formatter:a.rowCountCellFormatter},{name:f.description,field:"description",width:"auto",formatter:a.treeCellFormatter},{name:f.unit,field:"uom_id",width:"70px",styles:"text-align:center;",formatter:a.unitIdCellFormatter},{name:f.rate,field:"rate-value",width:"120px",styles:"text-align:right;",formatter:a.analyzerRateCellFormatter},{name:f.wastage+" (%)",field:"wastage-value",
width:"70px",styles:"text-align:right;",formatter:a.analyzerWastageCellFormatter},{name:f.totalQty,field:"total_qty",width:"120px",styles:"text-align:right;",formatter:a.unEditableNumberCellFormatter},{name:f.totalCost,field:"total_cost",width:"120px",styles:"text-align:right;",formatter:a.unEditableCurrencyCellFormatter}];this.type==buildspace.constants.STATUS_POSTCONTRACT&&(k.push({name:f.claimedQty,field:"claim_quantity",width:"120px",styles:"text-align:right;",formatter:a.unEditableNumberCellFormatter}),
k.push({name:f.claimedAmount,field:"claim_amount",width:"120px",styles:"text-align:right;",formatter:a.unEditableCurrencyCellFormatter}));n({id:"report_resource_analysis_item-"+b.project.id,stackContainerTitle:c.description,pageId:"report_resource_analysis_item-"+b.project.id+"_"+c.id,project:b.project,resource:d,type:b.type,gridOpts:{gridContainer:b,trade:c,type:"tradeItem",escapeHTMLInData:!1,store:g,unsorted:"unsorted"==c.id,updateUrl:"projectAnalyzer/resourceItemUpdate",structure:k,onRowDblClick:function(a){var e=
this.getItem(a.rowIndex);e.hasOwnProperty("multi-rate")&&e["multi-rate"][0]&&"rate-value"==a.cell.field||e.hasOwnProperty("multi-wastage")&&e["multi-wastage"][0]&&"wastage-value"==a.cell.field||0<e.id&&null!==e.description[0]&&e.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.createBillGrid(e,c,d)},singleCheckBoxSelection:function(a){var e=a.rowIndex;a=this.selection.selected[e];e=this.getItem(e);return a?(b.tradeItemSelectBoxStore.put({id:e.id[0]}),this.getAffectedTradeAndBillItems(e,
"add")):this.getAffectedTradeAndBillItems(e,"remove")},toggleAllSelection:function(a){var e=this,b=e.selection;if(a)return b.selectRange(0,e.rowCount-1),e.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&e.gridContainer.tradeItemSelectBoxStore.put({id:a.id[0]})})}}),e.getAffectedTradeAndBillItems(null,"add");b.deselectAll();return e.getAffectedTradeAndBillItems(null,"remove")},getAffectedTradeAndBillItems:function(a,e){var c=b.tradeItemSelectBoxStore,d=[],g=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+
"..."});g.show();a?d.push(a.id[0]):(c.query().forEach(function(a){d.push(a.id)}),d=d.reverse().filter(function(a,e,b){return-1===b.indexOf(a,e+1)}).reverse());c=JSON.stringify(d);g.show();q.post("resourceProjectAnalyzerReport/getAffectedSelectionTradeAndBillItems",{handleAs:"json",data:{pid:b.project.id,trade_item_ids:c}}).then(function(a){var d=dijit.byId("report_resource_analysis_trade-"+b.project.id),c;for(c in a)b.tradeBillItemSelectBoxStore[c]||(b.tradeBillItemSelectBoxStore[c]=new m({idProperty:"id"}));
if("add"===e)for(c in a){d.grid.store.fetchItemByIdentity({identity:c,onItem:function(a){if(a)return b.tradeSelectBoxStore.put({id:c}),d.grid.rowSelectCell.toggleRow(a._0,!0)}});for(var f in a[c]){b.tradeItemSelectBoxStore.put({id:f});for(var h in a[c][f])b.tradeBillItemSelectBoxStore[c].put({id:a[c][f][h]})}}else for(c in a){for(f in a[c])for(h in b.tradeItemSelectBoxStore.remove(f),a[c][f])b.tradeBillItemSelectBoxStore[c].remove(a[c][f][h]);d.grid.store.fetchItemByIdentity({identity:c,onItem:function(a){if(a&&
0===b.tradeItemSelectBoxStore.data.length)return b.tradeSelectBoxStore.remove(c),d.grid.rowSelectCell.toggleRow(a._0,!1)}})}g.hide()},function(a){g.hide();console.log(a)})}}})},createBillGrid:function(c,d,b){var a=this,g=p(),k=new dojo.data.ItemFileWriteStore({url:"projectAnalyzer/getBills/pid/"+a.project.id+"/rid/"+b.id+"/tid/"+d.id+"/id/"+c.id,clearOnClose:!0}),l=[{name:"No.",field:"id",width:"40px",styles:"text-align:center;",formatter:g.rowCountCellFormatter},{name:f.description,field:"description",
width:"auto",formatter:g.analysisTreeCellFormatter},{name:f.unit,field:"uom_id",width:"70px",styles:"text-align:center;",formatter:g.unitIdCellFormatter},{name:f.totalQty,field:"total_qty",width:"120px",styles:"text-align:right;",formatter:g.unEditableNumberCellFormatter},{name:f.rate,field:"rate-value",width:"120px",styles:"text-align:right;",formatter:g.formulaCurrencyCellFormatter},{name:f.totalCost,field:"total_cost",width:"120px",styles:"text-align:right;",formatter:g.unEditableCurrencyCellFormatter},
{name:f.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",formatter:g.formulaCurrencyCellFormatter}];this.type==buildspace.constants.STATUS_POSTCONTRACT&&(l.push({name:f.claimedQty,field:"claim_quantity",width:"120px",styles:"text-align:right;",formatter:g.unEditableNumberCellFormatter}),l.push({name:f.claimedAmount,field:"claim_amount",width:"120px",styles:"text-align:right;",formatter:g.unEditableCurrencyCellFormatter}));n({id:"report_resource_analysis_bill-"+a.project.id,
stackContainerTitle:c.description,pageId:"report_resource_analysis_bill-"+a.project.id+"_"+c.id,project:a.project,resource:b,gridOpts:{gridContainer:a,trade:d,tradeItem:c,type:"billItem",escapeHTMLInData:!1,store:k,unsorted:"unsorted"==d.id,updateUrl:"projectAnalyzer/billItemUpdate/rid/"+c.id,structure:l,singleCheckBoxSelection:function(c){var b=c.rowIndex;c=this.selection.selected[b];b=this.getItem(b);a.tradeBillItemSelectBoxStore[this.trade.id[0]]||(a.tradeBillItemSelectBoxStore[this.trade.id[0]]=
new m({idProperty:"id"}));return c?(a.tradeBillItemSelectBoxStore[this.trade.id[0]].put({id:b.id[0]}),this.getAffectedTradeAndTradeItems(b,"add")):this.getAffectedTradeAndTradeItems(b,"remove")},toggleAllSelection:function(c){var b=this,e=b.selection;a.tradeBillItemSelectBoxStore[b.trade.id[0]]||(a.tradeBillItemSelectBoxStore[b.trade.id[0]]=new m({idProperty:"id"}));if(c)return e.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(c){dojo.forEach(c,function(c,e){0<c.id&&a.tradeBillItemSelectBoxStore[b.trade.id[0]].put({id:c.id[0]})})}}),
b.getAffectedTradeAndTradeItems(null,"add");e.deselectAll();return b.getAffectedTradeAndTradeItems(null,"remove")},getAffectedTradeAndTradeItems:function(b,c){var e=this,d=a.tradeBillItemSelectBoxStore[e.trade.id[0]],g=[],h=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."});h.show();b?e.isInteger(b.id[0])&&g.push(b.id[0]):(d.query().forEach(function(a){g.push(a.id);e.isInteger(a.id)&&g.push(a.id)}),g=g.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse());d=
JSON.stringify(g);h.show();q.post("resourceProjectAnalyzerReport/getAffectedSelectionTradeAndTradeItems",{handleAs:"json",data:{pid:a.project.id,trade_id:e.trade.id,trade_item_id:e.tradeItem.id,bill_item_ids:d}}).then(function(b){var e=dijit.byId("report_resource_analysis_trade-"+a.project.id),d=dijit.byId("report_resource_analysis_item-"+a.project.id);if("add"===c)for(var f in b){e.grid.store.fetchItemByIdentity({identity:f,onItem:function(b){if(b)return a.tradeSelectBoxStore.put({id:f}),e.grid.rowSelectCell.toggleRow(b._0,
!0)}});for(var g in b[f]){d.grid.store.fetchItemByIdentity({identity:g,onItem:function(b){if(b)return a.tradeItemSelectBoxStore.put({id:g}),d.grid.rowSelectCell.toggleRow(b._0,!0)}});for(var l in b[f][g])a.tradeBillItemSelectBoxStore[f].put({id:b[f][g][l]})}}else for(f in b){for(g in b[f]){for(l in b[f][g])a.tradeBillItemSelectBoxStore[f].remove(b[f][g][l]);d.grid.store.fetchItemByIdentity({identity:g,onItem:function(b){if(b&&0===a.tradeBillItemSelectBoxStore[f].data.length)return a.tradeItemSelectBoxStore.remove(g),
d.grid.rowSelectCell.toggleRow(b._0,!1)}})}e.grid.store.fetchItemByIdentity({identity:f,onItem:function(b){if(b&&0===a.tradeItemSelectBoxStore.data.length)return a.tradeSelectBoxStore.remove(f),e.grid.rowSelectCell.toggleRow(b._0,!1)}})}h.hide()},function(a){h.hide();console.log(a)})}}})},makeGridContainer:function(c,d){var b=this.project.id,a=dijit.byId("projectAnalyzerReport-resource_project_"+b+"-stackContainer");a&&dijit.byId("projectAnalyzerReport-resource_project_"+b+"-stackContainer").destroyRecursive();
var a=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"projectAnalyzerReport-resource_project_"+b+"-stackContainer"}),f=new dijit.layout.ContentPane({title:d,content:c,grid:c.grid});a.addChild(f);var f=new dijit.layout.StackController({region:"top",containerId:"projectAnalyzerReport-resource_project_"+b+"-stackContainer"}),f=new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:f}),k=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",
gutters:!1,region:"center"});k.addChild(a);k.addChild(f);dojo.subscribe("projectAnalyzerReport-resource_project_"+b+"-stackContainer-selectChild","",function(a){var c=dijit.byId("projectAnalyzerReport-resource_project_"+b+"-stackContainer");if(c){var d=c.getChildren();for(a=dojo.indexOf(d,a);d.length>a+1;)a+=1,c.removeChild(d[a]),d[a].destroyRecursive(!0)}});return k},markedCheckBoxObject:function(c,d){var b=c.store;d.query().forEach(function(a){a.id!=buildspace.constants.GRID_LAST_ROW&&b.fetchItemByIdentity({identity:a.id,
onItem:function(a){if(a)return c.rowSelectCell.toggleRow(a._0,!0)}})})}})});
