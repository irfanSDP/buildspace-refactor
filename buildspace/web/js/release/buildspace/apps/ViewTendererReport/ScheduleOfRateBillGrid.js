define("buildspace/apps/ViewTendererReport/ScheduleOfRateBillGrid","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/array dojo/dom-attr dojo/json dojo/request dojo/aspect dijit/Menu dojox/grid/enhanced/plugins/Rearrange dojox/grid/enhanced/plugins/IndirectSelection buildspace/widget/grid/plugins/FormulatedColumn dojo/_base/event dojo/keys dijit/focus dojo/store/Memory dijit/DropDownMenu dijit/form/DropDownButton dijit/MenuItem dijit/PopupMenuItem buildspace/widget/grid/cells/Formatter ./PrintPreviewDialog/PrintSelectedElementGridDialog ./PrintPreviewDialog/PrintSelectedItemRateGridDialog ./PrintPreviewDialog/PrintSelectedItemTotalGridDialog ./PrintPreviewDialog/PrintSelectedItemRateAndTotalGridDialog ./PrintPreviewDialog/PrintSelectedElementByTypeAndTendererGridDialog ./PrintPreviewDialog/PrintSelectedScheduleOfRateItemGridDialog dojo/i18n!buildspace/nls/TenderingReport".split(" "),
function(p,x,l,C,D,k,m,y,q,E,F,G,H,I,J,r,t,u,n,v,z,K,L,M,N,O,A,f){var B=p("buildspace.apps.ViewTendererReport.ScheduleOfRateBillGrid",dojox.grid.EnhancedGrid,{type:null,billId:-1,elementId:0,itemId:-1,style:"border-top:none;",selectedItem:null,borderContainerWidget:null,keepSelection:!0,rowSelector:"0px",headerMenu:null,typeColumns:null,markupSettings:null,parentGrid:null,elementGridStore:null,project:null,gridContainer:null,constructor:function(a){this.type=a.type;this.billId=a.billId;this.elementId=
a.elementId;this.itemId=a.itemId;this.hierarchyTypes=a.hierarchyTypes;this.hierarchyTypesForHead=a.hierarchyTypesForHead;this.unitOfMeasurements=a.unitOfMeasurements;this.columnGroup=a.columnGroup;this.typeColumns=a.typeColumns;this.tender_setting=a.tender_setting;this.tender_companies=a.tender_companies;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;this.gridContainer=a.gridContainer;this.formatter=new z;this.setColumnStructure();
this.plugins={indirectSelection:{headerSelector:!0,width:"40px",styles:"text-align: center;"}};this.inherited(arguments)},postCreate:function(){var a=this;a.inherited(arguments);var b="tree"===a.type?"viewTendererItemPreviewStore":"viewTendererElementPreviewStore";y.after(a,"_onFetchComplete",function(){a.gridContainer.markedCheckBoxObject(a,a.gridContainer[b][a.billId])})},startup:function(){var a=this;a.inherited(arguments);this._connects.push(l.connect(this,"onCellClick",function(b){""===b.cell.name&&
a.singleCheckBoxSelection(b)}));this._connects.push(l.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)}))},singleCheckBoxSelection:function(a){var b=a.rowIndex;a=this.selection.selected[b];b=this.getItem(b);return a?"tree"===this.type?this.getAffectedElementAndBillsByItems(b,"add"):this.getAffectedItemsAndBillsByElement(b,"add"):"tree"===this.type?this.getAffectedElementAndBillsByItems(b,"remove"):this.getAffectedItemsAndBillsByElement(b,"remove")},toggleAllSelection:function(a){var b=
this,c=this.selection;var e="tree"===b.type?"viewTendererItemPreviewStore":"viewTendererElementPreviewStore";if(a)return c.selectRange(0,b.rowCount-1),b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.gridContainer[e][b.billId].put({id:a.id[0]})})}}),"tree"===b.type?b.getAffectedElementAndBillsByItems(null,"add"):b.getAffectedItemsAndBillsByElement(null,"add");c.deselectAll();return"tree"===b.type?(b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&
b.gridContainer[e][b.billId].remove(a.id[0])})}}),b.getAffectedElementAndBillsByItems(null,"remove")):b.getAffectedItemsAndBillsByElement(null,"remove")},getAffectedItemsAndBillsByElement:function(a,b){var c=this,e=c.gridContainer.viewTendererElementPreviewStore[c.billId],d=[],h=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."});h.show();a?(c.gridContainer.viewTendererElementPreviewStore[c.billId].put({id:a.id[0]}),d.push(a.id[0])):e.query().forEach(function(a){d.push(a.id)});
m.post("viewTendererReporting/getAffectedScheduleOfRateBillsAndItems",{handleAs:"json",data:{bill_id:c.billId,element_ids:k.stringify(c.borderContainerWidget.arrayUnique(d))}}).then(function(a){var e=dijit.byId("viewTenderer-bill-page-container-"+c.project.id);if("add"===b)for(var d in a){e.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return c.gridContainer.viewTendererBillPreviewStore.put({id:d}),e.rowSelectCell.toggleRow(a._0,!0)}});for(var g in a[d])for(var f in a[d][g])c.gridContainer.viewTendererItemPreviewStore[c.billId].put({id:a[d][g][f]})}else for(d in a){for(g in a[d])for(f in c.gridContainer.viewTendererElementPreviewStore[c.billId].remove(g),
a[d][g])c.gridContainer.viewTendererItemPreviewStore[c.billId].remove(a[d][g][f]);e.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0===c.gridContainer.viewTendererElementPreviewStore[c.billId].data.length)return c.gridContainer.viewTendererBillPreviewStore.remove(d),e.rowSelectCell.toggleRow(a._0,!1)}})}h.hide()},function(a){h.hide();console.log(a)})},getAffectedElementAndBillsByItems:function(a,b){var c=this,e=[],d=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."});
d.show();a&&("remove"===b?c.gridContainer.viewTendererItemPreviewStore[c.billId].remove(a.id[0]):c.gridContainer.viewTendererItemPreviewStore[c.billId].put({id:a.id[0]}));c.gridContainer.viewTendererItemPreviewStore[c.billId].query().forEach(function(a){e.push(a.id)});m.post("viewTendererReporting/getAffectedScheduleOfRateBillsAndElements",{handleAs:"json",data:{bill_id:c.billId,itemIds:k.stringify(c.borderContainerWidget.arrayUnique(e))}}).then(function(a){c.gridContainer.viewTendererBillPreviewStore=
new r({idProperty:"id"});c.gridContainer.viewTendererElementPreviewStore[c.billId]=new r({idProperty:"id"});c.ScheduleOfRateupdateElementAndBillGridSelectBox(a);d.hide()},function(a){d.hide();console.log(a)})},ScheduleOfRateupdateElementAndBillGridSelectBox:function(a){var b=this,c=dijit.byId("viewTenderer-bill-page-container-"+b.project.id),e=dijit.byId("viewTenderer-sorb_element-page-container-"+b.billId);c.store.fetch({onItem:function(a){if(a)return c.rowSelectCell.toggleRow(a._0,!1)}});e.grid.store.fetch({onItem:function(a){if(a)return e.grid.rowSelectCell.toggleRow(a._0,
!1)}});for(var d in a){c.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return b.gridContainer.viewTendererBillPreviewStore.put({id:d}),c.rowSelectCell.toggleRow(a._0,!0)}});for(var f in a[d])e.grid.store.fetchItemByIdentity({identity:f,onItem:function(a){if(a)return b.gridContainer.viewTendererElementPreviewStore[b.billId].put({id:f}),e.grid.rowSelectCell.toggleRow(a._0,!0)}})}},pushIntoStore:function(a,b){a&&a.id&&b.put({id:a.id[0]});return b},removeFromStore:function(a,b){a&&a.id&&
b.remove(a.id[0]);return b},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},editableCellDblClick:function(a){var b=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(b.cell,b.rowIndex);this.onRowClick(b);this.onRowDblClick(a)},setColumnStructure:function(){var a=this.formatter,b="auto";if("tree"==this.type){0<
this.tender_companies.length&&(b="500px");a=this.fixedColumns={noscroll:!1,width:57.8,cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0,showInCtxMenu:!0},{name:f.description,field:"description",width:b,formatter:a.treeCellFormatter,noresize:!0,showInCtxMenu:!0},{name:f.type,field:"type",width:"70px",styles:"text-align:center;",formatter:a.typeCellFormatter,noresize:!0,showInCtxMenu:!0},{name:f.unit,field:"uom_id",width:"50px",styles:"text-align:center;",
formatter:a.unitIdCellFormatter,noresize:!0,showInCtxMenu:!0},{name:f.estimationRate+" ("+this.currencySetting+")",field:"estimation_rate",styles:"text-align:right;",width:"120px",formatter:a.rateAfterMarkupCellFormatter,noresize:!0}]]};b=[];var c=this.generateContractorRateColumn(a)}else 5<this.tender_companies.length&&(b="480px"),a=this.fixedColumns={noscroll:!1,width:"50",cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0},{name:f.description,
field:"description",width:b,formatter:a.treeCellFormatter,noresize:!0}]]},b=[],c=a;dojo.forEach(b,function(a){c.cells[0].push(a)});this.structure=c},generateContractorRateColumn:function(a){var b=this,c=0;dojo.forEach(this.tender_companies,function(e){c++;var d=e.awarded?'<span style="color:blue;">'+buildspace.truncateString(e.name,28)+"</span>":buildspace.truncateString(e.name,28);a.cells[0].push({name:d,field:e.id+"-contractor_rate",width:"185px",styles:"text-align:right;",formatter:b.formatter.companyRateCurrencyCellFormatter})});
return a},canSort:function(a){return!1},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);dojo.forEach(c,function(a,b){b=dojo.attr(a,"rowSpan");(!b||2>b)&&dojo.attr(a,"rowSpan",2)})}},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,l.disconnect);delete this._connects}});return p("buildspace.apps.ViewTendererReport.ScheduleOfRateBillGridBuilder",
dijit.layout.BorderContainer,{pageId:"page-00",style:"padding:0px;width:100%;height:100%;",gutters:!1,stackContainerTitle:"",rootProject:null,billId:-1,elementId:0,itemId:-1,rowSelector:null,gridOpts:{},type:null,postCreate:function(){var a=this;a.inherited(arguments);x.mixin(a.gridOpts,{billId:a.billId,project:a.rootProject,elementId:a.elementId,type:a.type,region:"center",borderContainerWidget:a});var b=this.grid=new B(a.gridOpts),c=new dijit.Toolbar({region:"top",style:"outline:none!important; border-bottom:none; padding:2px; width:100%;"}),
e=["summaryAllTenderersLowToHighest","summaryAllTenderersHighToLowest"];if("element"===this.type){var d=new t({style:"display: none;"}),h=new q;dojo.forEach(e,function(b){var c=new n({id:b+"-"+a.rootProject.id+"-"+a.type+"-menuElement",label:f[b],onClick:function(){a.openElementPreviewDialogForAllTenderers(b)}});h.addChild(c)});d.addChild(new n({id:a.rootProject.id+"-"+this.type+"-ProjectElementSummaryPerUnitTypeByTenderers-button",label:f.summaryPerUnit,iconClass:"icon-16-container icon-16-print",
onClick:function(){a.openElementPreviewDialogAmountPerUnitTypeForSelectedTenderer()}}));var g=new v({label:f.projectSummaryAllTenderers,iconClass:"icon-16-container icon-16-print",popup:h});d.addChild(g);c.addChild(new u({label:f.summary,iconClass:"icon-16-container icon-16-print",dropDown:d}));c.addChild(new dijit.ToolbarSeparator)}d=new t({style:"display: none;"});var w=new q;dojo.forEach(e,function(b){var c=new n({id:b+"-"+a.rootProject.id+"-"+a.type+"-menuItemRate",label:f[b],onClick:function(){a.openItemRatePreviewDialogForAllTenderers(b)}});
w.addChild(c)});e=new v({label:f.itemRateAllTenderers,iconClass:"icon-16-container icon-16-print",popup:w});d.addChild(e);c.addChild(new u({label:f.itemRate,id:a.rootProject.id+"-"+this.type+"-ProjectItemRateAllTenderersPrint-button",iconClass:"icon-16-container icon-16-print",dropDown:d}));a.addChild(c);a.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}));if(b=dijit.byId("viewTendererReportBreakdown"+this.rootProject.id+"-stackContainer"))c=document.createElement("div"),
c=new dojox.layout.ContentPane({title:buildspace.truncateString(a.stackContainerTitle,60),id:a.pageId},c),b.addChild(c),c.set("content",a),b.selectChild(a.pageId)},openItemRatePreviewDialogForAllTenderers:function(a){var b=this,c=b.gridOpts.tender_companies,e=b.gridOpts.gridContainer.viewTendererItemPreviewStore[b.billId],d=[],h=[];b.gridOpts.builderContainer.selectedTenderers.query().forEach(function(a){d.push(a.id)});e.query().forEach(function(a){h.push(a.id)});var g=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+
"..."});g.show();m.post("viewTendererReporting/getSelectedScheduleOfRateItemByAllTenderers",{handleAs:"json",data:{bill_id:b.billId,tendererIds:k.stringify(b.arrayUnique(d)),itemIds:k.stringify(b.arrayUnique(h)),type:a}}).then(function(e){(new A({project:b.rootProject,title:f.itemRateAllTenderers+" ("+f[a]+")",companies:c,data:e,selectedTenderers:d,selectedItems:h,billId:b.billId,elementId:b.elementId,type:a})).show();g.hide()},function(a){console.log(a);g.hide()})},arrayUnique:function(a){return a.reverse().filter(function(a,
c,e){return-1===e.indexOf(a,c+1)}).reverse()}})});
