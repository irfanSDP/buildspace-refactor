define("buildspace/apps/PostContract/MaterialOnSite/MaterialOnSiteGrid","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/html dojo/dom-style dojo/number dijit/focus dojo/_base/event dojo/keys dijit/TooltipDialog dijit/popup dojox/grid/EnhancedGrid ./StockOutImportDialog ./MaterialOnSiteImportDialog dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/PostContract".split(" "),function(p,
q,n,r,B,C,m,t,u,D,E,v,w,x,y,z,F,f){var A=p("buildspace.apps.PostContract.MaterialOnSite.MaterialOnSiteEnhancedGrid",v,{type:null,style:"border-top:none;",rowSelector:"0px",selectedItem:null,region:"center",project:null,locked:!1,keepSelection:!0,addUrl:null,updateUrl:null,deleteUrl:null,pasteUrl:null,indentUrl:null,outdentUrl:null,constructor:function(){this.connects=[];this.rearranger=y(this,{});this.formulatedColumn=z(this,{})},canSort:function(){return!1},postCreate:function(){var a=this;this.inherited(arguments);
this.locked||(this.on("RowContextMenu",function(c){a.selection.clear();var b=a.getItem(c.rowIndex);a.selection.setSelected(c.rowIndex,!0);if("vo"==a.type||"vo-items"==a.type&&a.materialOnSite.status[0]==buildspace.apps.PostContract.ProjectStructureConstants.MATERIAL_ON_SITE_THIS_CLAIM)a.contextMenu(c),0<b.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0,["Add","ImportFromStockOut","ImportFromMaterialOnSite"])},!0),this.on("RowClick",function(c){(c=a.getItem(c.rowIndex))&&0<c.id?a.disableToolbarButtons(!1):
a.disableToolbarButtons(!0,["Add","ImportFromStockOut","ImportFromMaterialOnSite"])}))},canEdit:function(a,c){var b=this;if(void 0!=a){var d=this.getItem(c),e=a.field;if("vo"==this.type){if("status"===e&&d.id==buildspace.constants.GRID_LAST_ROW){window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}if("status"===e&&0<d.id)return!0;if(0<d.id&&d.status[0]==buildspace.apps.PostContract.ProjectStructureConstants.MATERIAL_ON_SITE_CLAIMED){window.setTimeout(function(){b.disableToolbarButtons(!0);
b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}}else if("vo-items"==this.type){if("description"!=e&&"type"!=e&&0<d.id&&d.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER){window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}if((d.id==buildspace.constants.GRID_LAST_ROW||d.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER)&&"rate-value"==e){window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);
return}}}return this._canEdit},doApplyCellEdit:function(a,c,b){var d=this,e=d.getItem(c),h=d.store,k=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),g=b.replace("-value","");-1!==b.indexOf("-value")&&(a=this.formulatedColumn.convertRowIndexToItemId(a,c));if(a!==e[b][0]){var g={id:e.id,attr_name:g,val:a,_csrf_token:e._csrf_token?e._csrf_token:null},l=this.updateUrl;e.id==buildspace.constants.GRID_LAST_ROW&&(l=0<c?d.getItem(c-1):!1,n.mixin(g,{prev_item_id:l?l.id:0,relation_id:e.relation_id}),
l=this.addUrl);g={url:l,content:g,handleAs:"json",load:function(a){if(a.success){if(0<e.id){for(var g in a.data)e.hasOwnProperty(g)&&g!=h._getIdentifierAttribute()&&h.setValue(e,g,a.data[g]);h.save()}else h.deleteItem(e),h.save(),dojo.forEach(a.items,function(a){h.newItem(a)}),h.save(),d.disableToolbarButtons(!0);var f=d.getCellByField(b);window.setTimeout(function(){d.focus.setFocusIndex(c,f.index)},10);k.hide()}},error:function(){k.hide()}};k.show();dojo.xhrPost(g)}d.inherited(arguments)},doCancelEdit:function(a){this.inherited(arguments);
this.views.renormalizeRow(a);this.scroller.rowHeightChanged(a,!0)},editableCellDblClick:function(a){var c;c=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(c.cell,c.rowIndex);this.onRowClick(c);this.onRowDblClick(a)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},contextMenu:function(a){var c=this.rowCtxMenu=
new dijit.Menu;this.contextMenuItems(a);var b={target:a.target,coords:a.keyCode!==u.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null},d=this.getItem(a.rowIndex);c&&d&&(this.selection.isSelected(a.rowIndex)||a.rowNode&&r.hasClass(a.rowNode,"dojoxGridRowbar"))&&(c._openMyself(b),t.stop(a))},contextMenuItems:function(a){var c=this.getItem(a.rowIndex);0<c.id&&"vo-items"==this.type&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.cut,iconClass:"icon-16-container icon-16-cut",onClick:dojo.hitch(this,"cutItems")}));
"vo-items"==this.type&&this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,"pasteItem",a.rowIndex),disabled:this.selectedItem?!1:!0}));0<c.id&&"vo-items"==this.type&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.indent,iconClass:"icon-16-container icon-16-indent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"indent")})),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.outdent,iconClass:"icon-16-container icon-16-outdent",
onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"outdent")})));this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow",a.rowIndex)}));0<c.id&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow",a.rowIndex)}))},cutItems:function(){this.selectedItem=this.selection.getFirstSelected()},pasteItem:function(a){var c=this,b=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+
"..."}),d=c.store,e=c.selection.getFirstSelected(),h=e.id==buildspace.constants.GRID_LAST_ROW&&0<a?c.getItem(a-1).id:0;b.show();dojo.xhrPost({url:this.pasteUrl,content:{type:"cut",target_id:e.id,prev_item_id:h,id:c.selectedItem.id,_csrf_token:c.selectedItem._csrf_token},handleAs:"json",load:function(e){var g=[];if(e.success){var f=e.c;d.fetchItemByIdentity({identity:e.data.id,onItem:function(b){b=c.getItemIndex(b);g.push(b);for(var e=0,k=f.length;e<k;++e)d.fetchItemByIdentity({identity:f[e].id,onItem:function(a){a=
c.getItemIndex(a);g.push(a)}});0<g.length&&c.rearranger.moveRows(g,a);b=b>a?a:a-1;c.selection.clear();c.selectedItem=null;c.selection.setSelected(b,!0);c.scrollToRow(0<b-3?b-3:b);c.disableToolbarButtons(!1)}});d.fetchItemByIdentity({identity:e.data.id,onItem:function(a){for(var c in e.data)a.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&d.setValue(a,c,e.data[c]);d.save();var b=0;for(a=f.length;b<a;++b)d.fetchItemByIdentity({identity:f[b].id,onItem:function(a){for(var c in f[b])a.hasOwnProperty(c)&&
c!=d._getIdentifierAttribute()&&d.setValue(a,c,f[b][c]);d.save()}})}})}g.length=0;b.hide()},error:function(){c.selection.clear();c.disableToolbarButtons(!0);c.selectedItem=null;b.hide()}})},addRow:function(a){m.curNode.blur();m.curNode=null;var c=this,b=buildspace.dialog.indeterminateProgressBar({title:f.addingRow+". "+f.pleaseWait+"..."}),d=c.store,e=c.getItem(a);if(0<e.id)e={before_id:e.id,_csrf_token:e._csrf_token};else var h=0<a?c.getItem(a-1).id:0,e={id:e.id,prev_item_id:h,relation_id:e.relation_id,
_csrf_token:e._csrf_token};b.show();dojo.xhrPost({url:this.addUrl,content:e,handleAs:"json",load:function(e){e.success&&dojo.forEach(e.items,function(b){0<b.id&&(b=d.newItem(b),d.save(),b=c.getItemIndex(b),c.rearranger.moveRows([b],a),c.selection.clear())});window.setTimeout(function(){c.selection.setSelected(a,!0);c.focus.setFocusIndex(a,"vo-items"==c.type?3:1)},30);b.hide()},error:function(){c.selection.clear();c.disableToolbarButtons(!0);b.hide()}})},deleteRow:function(a){var c=this,b=null,d=null,
b=c.getItem(a),e=buildspace.dialog.indeterminateProgressBar({title:f.deleting+". "+f.pleaseWait+"..."});m.curNode.blur();m.curNode=null;e.show();var h={url:this.deleteUrl,content:{id:b.id,_csrf_token:b._csrf_token},handleAs:"json",load:function(b){if(b.success){b=b.items;for(var d=c.store,f=0,h=b.length;f<h;++f)d.fetchItemByIdentity({identity:b[f].id,onItem:function(a){d.deleteItem(a);d.save()}});b.length=0}e.hide();c.selection.clear();c.disableToolbarButtons(!0);window.setTimeout(function(){c.focus.setFocusIndex(a,
0)},10);c.selectedItem=null;c.pasteOp=null},error:function(){c.selection.clear();c.disableToolbarButtons(!0);c.selectedItem=null;c.pasteOp=null;e.hide()}};"vo"==this.type?(b=f.deleteMaterialOnSiteDialogBoxTitle,d=f.deleteMaterialOnSiteDialogBoxMsg):(b=f.deleteMaterialOnSiteItemDialogBoxTitle,d=f.deleteMaterialOnSiteItemDialogBoxMsg);new buildspace.dialog.confirm(b,d,80,320,function(){dojo.xhrPost(h)},function(){e.hide()})},indentOutdent:function(a,c){var b=this,d=b.store;if(0<a){var e=b.getItem(a),
h=buildspace.dialog.indeterminateProgressBar({title:f.recalculateRows+". "+f.pleaseWait+"..."});h.show();0<e.id&&dojo.xhrPost({url:this[c+"Url"],content:{id:e.id,_csrf_token:e._csrf_token},handleAs:"json",load:function(a){if(a.success){var b=a.c,c;for(c in a.item)a.item.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&d.setValue(e,c,a.item[c]);var f=0;for(a=b.length;f<a;++f)d.fetchItemByIdentity({identity:b[f].id,onItem:function(a){for(var c in b[f])a.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&
d.setValue(a,c,b[f][c])}});d.save()}h.hide()},error:function(){b.selection.clear();b.disableToolbarButtons(!0);h.hide()}})}},openImportFromStockOutDialog:function(a){-1<a&&(a=this.getItem(a),(new w({itemListGrid:this,title:f.importFromStockOut,materialOnSiteItem:a,project:this.project})).show())},openImportFromMaterialOnSiteDialog:function(a){-1<a&&(a=this.getItem(a),(new x({itemListGrid:this,title:f.importFromMaterialOnSite,materialOnSiteItem:a,project:this.project})).show())},disableToolbarButtons:function(a,
c){a=this.locked?!0:a;var b;switch(this.type){case "vo":b="materialOnSite-"+this.project.id;break;case "vo-items":b="materialOnSite-"+this.project.id+"_"+this.materialOnSite.id+"-items";break;default:throw Error("type must be set!");}var d=dijit.byId(b+"AddRow-button"),e=dijit.byId(b+"DeleteRow-button"),f=dijit.byId(b+"IndentRow-button"),k=dijit.byId(b+"OutdentRow-button"),g=dijit.byId(b+"ImportFromStockOutRow-button");importFromMaterialOnSiteBtn=dijit.byId(b+"ImportFromMaterialOnSiteRow-button");
f&&f._setDisabledAttr(a);k&&k._setDisabledAttr(a);g&&g._setDisabledAttr(a);importFromMaterialOnSiteBtn&&importFromMaterialOnSiteBtn._setDisabledAttr(a);d&&d._setDisabledAttr(a);e&&e._setDisabledAttr(a);a&&c instanceof Array&&!this.locked&&dojo.forEach(c,function(a){(a=dijit.byId(b+a+"Row-button"))&&a._setDisabledAttr(!1)})},refreshGrid:function(){this.store.save();this.store.close();return this.setStore(this.store)},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,q.disconnect);
delete this._connects}});return p("buildspace.apps.PostContract.MaterialOnSite.MaterialOnSiteGrid",dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0;margin:0;width:100%;height:100%;",gutters:!1,project:null,materialOnSite:null,gridOpts:{},locked:!1,type:null,pageId:0,postCreate:function(){var a,c;this.inherited(arguments);n.mixin(this.gridOpts,{type:this.type,project:this.project,materialOnSite:this.materialOnSite,locked:this.locked});var b=this.grid=new A(this.gridOpts);switch(this.type){case "vo":a=
"materialOnSite-"+this.project.id;c="materialOnSite-"+this.project.id;break;case "vo-items":a="materialOnSite-"+this.project.id+"_"+this.materialOnSite.id+"-items";c="materialOnSiteItems-"+this.project.id+"_"+this.materialOnSite.id;break;default:throw Error("type must be set!");}if(!this.locked){var d=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});d.addChild(new dijit.form.Button({id:a+"AddRow-button",label:f.addRow,iconClass:"icon-16-container icon-16-add",disabled:0>
b.selection.selectedIndex,onClick:function(){-1<b.selection.selectedIndex&&b.addRow(b.selection.selectedIndex)}}));d.addChild(new dijit.ToolbarSeparator);"vo-items"==this.type&&(d.addChild(new dijit.form.Button({id:a+"IndentRow-button",label:f.indent,iconClass:"icon-16-container icon-16-indent",disabled:0>b.selection.selectedIndex,onClick:function(){-1<b.selection.selectedIndex&&b.indentOutdent(b.selection.selectedIndex,"indent")}})),d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:a+
"OutdentRow-button",label:f.outdent,iconClass:"icon-16-container icon-16-outdent",disabled:0>b.selection.selectedIndex,onClick:function(){-1<b.selection.selectedIndex&&b.indentOutdent(b.selection.selectedIndex,"outdent")}})),d.addChild(new dijit.ToolbarSeparator));d.addChild(new dijit.form.Button({id:a+"DeleteRow-button",label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",disabled:0>b.selection.selectedIndex,onClick:function(){-1<b.selection.selectedIndex&&b.deleteRow(b.selection.selectedIndex)}}));
"vo-items"==this.type&&(d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:a+"ImportFromStockOutRow-button",label:f.importFromStockOut,iconClass:"icon-16-container icon-16-import",disabled:0>b.selection.selectedIndex,onClick:function(){-1<b.selection.selectedIndex&&b.openImportFromStockOutDialog(b.selection.selectedIndex)}})),d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:a+"ImportFromMaterialOnSiteRow-button",label:f.importFromMaterialOnSite,
iconClass:"icon-16-container icon-16-import",disabled:0>b.selection.selectedIndex,onClick:function(){-1<b.selection.selectedIndex&&b.openImportFromMaterialOnSiteDialog(b.selection.selectedIndex)}})));this.addChild(d)}this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}));if(a=dijit.byId(c+"-stackContainer"))c=document.createElement("div"),c=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),content:this,id:this.pageId,executeScripts:!0},
c),a.addChild(c),n.mixin(c,{grid:b}),a.selectChild(this.pageId)}})});
