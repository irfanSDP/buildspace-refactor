define("buildspace/apps/PostContract/VariationOrder/VariationOrderGrid","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/html dojo/dom-style dojo/number dijit/focus dojo/_base/event dojo/keys dojo/has dijit/TooltipDialog dijit/popup dojox/grid/EnhancedGrid ./BillDialog ./ImportedVariationOrderContainer dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/PostContract".split(" "),function(x,
v,y,z,M,N,t,A,B,C,D,w,E,F,G,H,I,O,h){var L=x("buildspace.apps.PostContract.VariationOrder.VariationOrderEnhancedGrid",E,{type:null,style:"border-top:none;",rowSelector:"0px",selectedItem:null,region:"center",project:null,locked:!1,keepSelection:!0,addUrl:null,updateUrl:null,deleteUrl:null,pasteUrl:null,indentUrl:null,outdentUrl:null,variationOrderFirstLevelContainer:null,variationOrderItemContainer:null,constructor:function(a){this.connects=[];this.rearranger=H(this,{});this.formulatedColumn=I(this,
{})},canSort:function(a){return!1},postCreate:function(){var a=this;this.inherited(arguments);var c=null;this._connects.push(v.connect(this,"onCellMouseOver",function(b){var d=a.getItem(b.rowIndex),e=b.rowIndex,f=b.cell.field.replace("-value","");d&&d.hasOwnProperty(f+"-has_formula")&&"undefined"!==typeof d[f+"-has_formula"]&&d[f+"-has_formula"][0]&&(d=d[f+"-value"][0],d=this.formulatedColumn.convertItemIdToRowIndex(d,e),null===c&&(c=new D({content:d,onMouseLeave:function(){w.close(c)}}),w.open({popup:c,
around:b.cellNode})))}));this._connects.push(v.connect(this,"onCellMouseOut",function(b){null!==c&&(w.close(c),c=null)}));this.locked||(this.on("RowContextMenu",function(b){a.selection.clear();var d=a.getItem(b.rowIndex);a.selection.setSelected(b.rowIndex,!0);if("vo"==a.type||"vo-items"==a.type&&"false"==a.variationOrder.is_approved[0]){var e=[];a.contextMenu(b);d&&!isNaN(parseInt(String(d.id)))&&!d.is_from_rfv[0]&&d.can_be_edited[0]?(b=0<b.rowIndex?a.getItem(b.rowIndex-1):null,d=!1,"vo-items"!=a.type||
b&&!b.is_from_rfv[0]||(d=!0,e=["Add","Delete","OmitFromBill"]),a.disableToolbarButtons(d,e)):(e="vo-items"==a.type&&d.is_from_rfv[0]?["OmitFromBill"]:["Add","OmitFromBill"],a.disableToolbarButtons(!0,e))}},!0),this.on("RowClick",function(b){var d=a.getItem(b.rowIndex),e=[];d&&!isNaN(parseInt(String(d.id)))&&d.can_be_edited[0]&&!d.is_from_rfv[0]?(b=0<b.rowIndex?a.getItem(b.rowIndex-1):null,d=!1,"vo-items"!=a.type||b&&!b.is_from_rfv[0]||(d=!0,e=["Add","Delete","OmitFromBill"]),a.disableToolbarButtons(d,
e)):(e="vo-items"==a.type&&d.is_from_rfv[0]?["OmitFromBill"]:["Add","OmitFromBill"],a.disableToolbarButtons(!0,e))}));this.on("CellClick",function(b){var d=b.cell.field;b=this.getItem(b.rowIndex);"attachment"==d&&"VariationOrder"==b.class?this.variationOrderFirstLevelContainer.addUploadAttachmentContainer(b):"attachment"==d&&"VariationOrderItem"==b.class&&this.variationOrderItemContainer.addUploadAttachmentContainer(b)})},canEdit:function(a,c){var b=this;if(void 0!=a){var d=this.getItem(c),e=a.field;
if("vo"==this.type){if(!d.can_be_edited[0]||b.locked)return!1;if("is_approved"===e&&String(d.id)==buildspace.constants.GRID_LAST_ROW)return window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1;if(!isNaN(parseInt(String(d.id)))&&!d.can_be_edited[0])return window.setTimeout(function(){b.disableToolbarButtons(!0);b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1}else if("vo-items"==this.type){if(!d.can_be_edited[0])return!1;if("addition_quantity-value"!=e&&"current_percentage-value"!=
e&&"current_amount-value"!=e&&"up_to_date_percentage-value"!=e&&"up_to_date_amount-value"!=e&&!isNaN(parseInt(d.id[0]))&&0<d.bill_item_id[0]||!isNaN(parseInt(String(d.id)))&&d.is_from_rfv[0]&&("type"==e||"uom_id"==e||"reference_rate-value"==e||"reference_quantity-value"==e)||"description"!=e&&"type"!=e&&!isNaN(parseInt(String(d.id)))&&d.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||!(String(d.id)!=buildspace.constants.GRID_LAST_ROW&&d.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||
"rate-value"!=e&&"addition_quantity-value"!=e&&"reference_rate-value"!=e&&"reference_quantity-value"!=e))return window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1}else if("vo-claims"==this.type){if(!d.can_claim[0])return!1;if(String(d.id)==buildspace.constants.GRID_LAST_ROW||d.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER)return window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10),!1}}return this._canEdit},doApplyCellEdit:function(a,
c,b){var d=this,e=this.getItem(c),f=this.store,g=b.replace("-value","");-1!==b.indexOf("-value")&&(a=this.formulatedColumn.convertRowIndexToItemId(a,c));if(a!==e[b][0]){var l=buildspace.dialog.indeterminateProgressBar({title:h.pleaseWait+"..."}),k={id:e.id,attr_name:g,val:a,_csrf_token:e._csrf_token?e._csrf_token:null},n=this.updateUrl;if(e&&isNaN(parseInt(String(e.id)))){var m=0<c?this.getItem(c-1):!1;y.mixin(k,{prev_item_id:m?m.id:0,relation_id:e.relation_id});n=this.addUrl}var r=function(){var p=
buildspace.dialog.indeterminateProgressBar({title:h.pleaseWait+"..."});p.show().then(function(){dojo.xhrPost({url:n,content:k,handleAs:"json",load:function(q){if(q.success){if(isNaN(parseInt(String(e.id))))f.deleteItem(e),f.save(),dojo.forEach(q.items,function(J){f.newItem(J)}),f.save(),d.disableToolbarButtons(!0);else{for(var u in q.data)e.hasOwnProperty(u)&&u!=f._getIdentifierAttribute()&&f.setValue(e,u,q.data[u]);f.save()}e.can_be_edited[0]||d.disableToolbarButtons(!0,["Add","OmitFromBill"]);var K=
d.getCellByField(b);window.setTimeout(function(){d.focus.setFocusIndex(c,K.index)},10);p.hide()}},error:function(q){p.hide()}})})};"vo-items"!=this.type||"type"!=g&&"uom_id"!=g&&"addition_quantity"!=g||!e.has_addition_build_up_quantity[0]?"status"==g&&a==buildspace.apps.PostContract.ProjectStructureConstants.STATUS_PENDING?l.show().then(function(){dojo.xhrGet({url:"variationOrder/getVerifierList",content:{pid:d.project.id,variationOrderId:e.id},handleAs:"json",load:function(p){var q=0+Object.keys(p.verifiers).length;
q+=p.topManagementVerifiers.length;p.success?buildspace.dialog.confirm(h.confirmSubmit,"<div>"+h.numberOfReviewers+": "+q+"</div>",60,200,function(){r()},function(){f.setValue(e,"status",buildspace.apps.PostContract.ProjectStructureConstants.STATUS_PREPARING)}):(d.doCancelEdit(c),f.setValue(e,"status",buildspace.apps.PostContract.ProjectStructureConstants.STATUS_PREPARING),buildspace.dialog.alert("Warning",p.errorMsg,100,300));l.hide()},error:function(p){l.hide()}})}):r():(buildspace.dialog.confirm(h.confirmation,
"<div>"+h.detachAllBuildUpAndLink+"</div>",90,380,r),this.doCancelEdit(c))}this.inherited(arguments)},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var c=a.node.children[0].children[0].rows[1],b=a.node.children[0].children[0].rows[0].children;c.parentNode.removeChild(c);dojo.forEach(b,function(d,e){e=dojo.attr(d,"rowSpan");(!e||2>e)&&dojo.attr(d,"rowSpan",2)})}},doCancelEdit:function(a){this.inherited(arguments);this.views.renormalizeRow(a);
this.scroller.rowHeightChanged(a,!0)},editableCellDblClick:function(a){var c=1<this._click.length&&C("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(c.cell,c.rowIndex);this.onRowClick(c);this.onRowDblClick(a)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},contextMenu:function(a){var c=this.rowCtxMenu=new dijit.Menu;this.contextMenuItems(a);
var b={target:a.target,coords:a.keyCode!==B.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null},d=this.getItem(a.rowIndex);c&&d&&(this.selection.isSelected(a.rowIndex)||a.rowNode&&z.hasClass(a.rowNode,"dojoxGridRowbar"))&&(c._openMyself(b),A.stop(a))},contextMenuItems:function(a){var c=this.getItem(a.rowIndex);!c||isNaN(parseInt(String(c.id)))||"vo-items"!=this.type||c.is_from_rfv[0]||this.rowCtxMenu.addChild(new dijit.MenuItem({label:h.cut,iconClass:"icon-16-container icon-16-cut",onClick:dojo.hitch(this,
"cutItems")}));"vo-items"!=this.type||c.is_from_rfv[0]||this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:h.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,"pasteItem"),disabled:this.selectedItem?!1:!0}));!c||isNaN(parseInt(String(c.id)))||"vo-items"!=this.type||c.is_from_rfv[0]||(a=0<a.rowIndex?this.getItem(a.rowIndex-1):null)&&!a.is_from_rfv[0]&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:h.indent,iconClass:"icon-16-container icon-16-indent",onClick:dojo.hitch(this,
"indentOutdent","indent")})),this.rowCtxMenu.addChild(new dijit.MenuItem({label:h.outdent,iconClass:"icon-16-container icon-16-outdent",onClick:dojo.hitch(this,"indentOutdent","outdent")})));c&&("vo"==this.type||"vo-items"==this.type&&!c.is_from_rfv[0])&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:h.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow")}));c&&!isNaN(parseInt(String(c.id)))&&!c.is_from_rfv[0]&&c.can_be_edited[0]&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:h.deleteRow,
iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow")}))},cutItems:function(){this.selectedItem=this.selection.getFirstSelected()},pasteItem:function(){if(this.selectedItem&&-1<this.selection.selectedIndex){var a=this,c=buildspace.dialog.indeterminateProgressBar({title:h.pleaseWait+"..."}),b=this.store,d=this.selection.selectedIndex,e=this.selection.getFirstSelected(),f=isNaN(parseInt(e.id[0]))&&0<d?this.getItem(d-1).id:0;c.show().then(function(){dojo.xhrPost({url:a.pasteUrl,
content:{type:"cut",target_id:e.id,prev_item_id:f,id:a.selectedItem.id,_csrf_token:a.selectedItem._csrf_token},handleAs:"json",load:function(g){var l=[];if(g.success){var k=g.c;b.fetchItemByIdentity({identity:g.data.id,onItem:function(n){n=a.getItemIndex(n);l.push(n);for(var m=0,r=k.length;m<r;++m)b.fetchItemByIdentity({identity:k[m].id,onItem:function(p){p=a.getItemIndex(p);l.push(p)}});0<l.length&&a.rearranger.moveRows(l,d);a.selectAfterPaste(n>d?d:d-1,!0)}});b.fetchItemByIdentity({identity:g.data.id,
onItem:function(n){for(var m in g.data)n.hasOwnProperty(m)&&m!=b._getIdentifierAttribute()&&b.setValue(n,m,g.data[m]);b.save();var r=0;for(n=k.length;r<n;++r)b.fetchItemByIdentity({identity:k[r].id,onItem:function(p){for(var q in k[r])p.hasOwnProperty(q)&&q!=b._getIdentifierAttribute()&&b.setValue(p,q,k[r][q]);b.save()}})}})}a.disableToolbarButtons(!1);l.length=0;c.hide()},error:function(g){a.selection.clear();a.disableToolbarButtons(!0);a.selectedItem=null;c.hide()}})})}},selectAfterPaste:function(a,
c){this.selection.clear();this.selectedItem=null;this.selection.setSelected(a,!0);c&&this.scrollToRow(0<a-3?a-3:a)},addRow:function(){t.curNode.blur();t.curNode=null;if(-1<this.selection.selectedIndex){var a=this.selection.selectedIndex,c=this,b=buildspace.dialog.indeterminateProgressBar({title:h.addingRow+". "+h.pleaseWait+"..."}),d=this.store,e=this.getItem(a);if(isNaN(parseInt(String(e.id)))){var f=0<a?this.getItem(a-1).id:0;var g={id:e.id,prev_item_id:f,relation_id:e.relation_id,_csrf_token:e._csrf_token}}else g=
{before_id:e.id,_csrf_token:e._csrf_token};b.show().then(function(){dojo.xhrPost({url:c.addUrl,content:g,handleAs:"json",load:function(l){l.success&&dojo.forEach(l.items,function(k){0<k.id&&(k=d.newItem(k),d.save(),k=c.getItemIndex(k),c.rearranger.moveRows([k],a),c.selection.clear())});window.setTimeout(function(){c.selection.setSelected(a,!0);c.focus.setFocusIndex(a,"vo-items"==c.type?3:1)},30);b.hide()},error:function(l){c.selection.clear();c.disableToolbarButtons(!0);b.hide()}})})}},deleteRow:function(){var a=
this.selection.selectedIndex,c=this.getItem(a);t.curNode.blur();t.curNode=null;if(-1<this.selection.selectedIndex&&c&&!isNaN(parseInt(String(c.id)))&&!c.is_from_rfv[0]){var b=this,d=null,e=null,f=buildspace.dialog.indeterminateProgressBar({title:h.deleting+". "+h.pleaseWait+"..."});"vo"==this.type?(d=h.deleteVariationOrderDialogBoxTitle,e=h.deleteVariationOrderDialogBoxMsg):(d=h.deleteVariationOrderItemDialogBoxTitle,e=h.deleteVariationOrderItemDialogBoxMsg);new buildspace.dialog.confirm(d,e,90,380,
function(){f.show().then(function(){dojo.xhrPost({url:b.deleteUrl,content:{id:c.id,_csrf_token:c._csrf_token},handleAs:"json",load:function(g){if(g.success){g=g.items;for(var l=b.store,k=0,n=g.length;k<n;++k)l.fetchItemByIdentity({identity:g[k].id,onItem:function(m){l.deleteItem(m);l.save()}});g.length=0}f.hide();b.selection.clear();b.disableToolbarButtons(!0);window.setTimeout(function(){b.focus.setFocusIndex(a,0)},10);b.selectedItem=null;b.pasteOp=null},error:function(g){b.selection.clear();b.disableToolbarButtons(!0);
b.selectedItem=null;b.pasteOp=null;f.hide()}})})},function(){})}},indentOutdent:function(a){var c=this.getItem(this.selection.selectedIndex);if(0<this.selection.selectedIndex&&c&&!isNaN(parseInt(String(c.id)))){var b=this,d=this.store,e=buildspace.dialog.indeterminateProgressBar({title:h.recalculateRows+". "+h.pleaseWait+"..."});e.show().then(function(){dojo.xhrPost({url:b[a+"Url"],content:{id:c.id,_csrf_token:c._csrf_token},handleAs:"json",load:function(f){if(f.success){var g=f.c,l;for(l in f.item)f.item.hasOwnProperty(l)&&
l!=d._getIdentifierAttribute()&&d.setValue(c,l,f.item[l]);var k=0;for(f=g.length;k<f;++k)d.fetchItemByIdentity({identity:g[k].id,onItem:function(n){for(var m in g[k])n.hasOwnProperty(m)&&m!=d._getIdentifierAttribute()&&d.setValue(n,m,g[k][m])}});d.save()}e.hide()},error:function(f){b.selection.clear();b.disableToolbarButtons(!0);e.hide()}})})}},openBillDialog:function(){var a=this.getItem(this.selection.selectedIndex);-1<this.selection.selectedIndex&&a&&F({variationOrderItem:a,variationOrder:this.variationOrder,
isLastItem:a.id[0]==buildspace.constants.GRID_LAST_ROW,type:"omit_from_bill",locked:this.locked,variationOrderItemGrid:this}).show()},disableToolbarButtons:function(a,c){a=this.locked?!0:a;switch(this.type){case "vo":var b="variationOrder-"+this.project.id;break;case "vo-items":b="variationOrder-"+this.project.id+"_"+this.variationOrder.id+"-items";break;default:return}var d=dijit.byId(b+"AddRow-button"),e=dijit.byId(b+"DeleteRow-button"),f=dijit.byId(b+"IndentRow-button"),g=dijit.byId(b+"OutdentRow-button"),
l=dijit.byId(b+"OmitFromBillRow-button");f&&f._setDisabledAttr(a);g&&g._setDisabledAttr(a);l&&l._setDisabledAttr(a);d&&d._setDisabledAttr(a);e&&e._setDisabledAttr(a);a&&c instanceof Array&&!this.locked&&dojo.forEach(c,function(k){(k=dijit.byId(b+k+"Row-button"))&&k._setDisabledAttr(!1)})},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,v.disconnect);delete this._connects}});return x("buildspace.apps.PostContract.VariationOrder.VariationOrderGrid",dijit.layout.BorderContainer,
{stackContainerTitle:"",style:"padding:0;margin:0;width:100%;height:100%;",gutters:!1,project:null,variationOrder:null,variationOrderFirstLevelContainer:null,variationOrderItemContainer:null,gridOpts:{},locked:!1,type:null,pageId:0,claimCertificate:null,postCreate:function(){this.inherited(arguments);y.mixin(this.gridOpts,{type:this.type,project:this.project,variationOrder:this.variationOrder,locked:this.locked,variationOrderFirstLevelContainer:this.variationOrderFirstLevelContainer,variationOrderItemContainer:this.variationOrderItemContainer});
var a=this.grid=new L(this.gridOpts);switch(this.type){case "vo":var c="variationOrder-"+this.project.id;var b="variationOrder-"+this.project.id;break;case "vo-items":c="variationOrder-"+this.project.id+"_"+this.variationOrder.id+"-items";b="variationOrderItems-"+this.project.id+"_"+this.variationOrder.id;break;case "vo-claims":c="variationOrder-"+this.project.id+"_"+this.variationOrder.id+"-claims";break;default:throw Error("type must be set!");}if(!this.locked){var d=new dijit.Toolbar({region:"top",
style:"padding:2px;border-bottom:none;width:100%;"});d.addChild(new dijit.form.Button({id:c+"AddRow-button",label:h.addRow,iconClass:"icon-16-container icon-16-add",disabled:0>a.selection.selectedIndex,onClick:dojo.hitch(a,"addRow")}));d.addChild(new dijit.ToolbarSeparator);"vo-items"==this.type&&(d.addChild(new dijit.form.Button({id:c+"IndentRow-button",label:h.indent,iconClass:"icon-16-container icon-16-indent",disabled:0>a.selection.selectedIndex,onClick:dojo.hitch(a,"indentOutdent","indent")})),
d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:c+"OutdentRow-button",label:h.outdent,iconClass:"icon-16-container icon-16-outdent",disabled:0>a.selection.selectedIndex,onClick:dojo.hitch(a,"indentOutdent","outdent")})),d.addChild(new dijit.ToolbarSeparator));d.addChild(new dijit.form.Button({id:c+"DeleteRow-button",label:h.deleteRow,iconClass:"icon-16-container icon-16-delete",disabled:0>a.selection.selectedIndex,onClick:dojo.hitch(a,"deleteRow")}));d.addChild(new dijit.ToolbarSeparator);
d.addChild(new dijit.form.Button({label:h.importedVariationOrders,iconClass:"icon-16-container icon-16-contrast",onClick:dojo.hitch(this,"createImportedVariationOrdersContainer")}));"vo-items"==this.type&&(d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:c+"OmitFromBillRow-button",label:h.omitFromBills,iconClass:"icon-16-container icon-16-eject",disabled:0>a.selection.selectedIndex,onClick:dojo.hitch(a,"openBillDialog")})));this.addChild(d)}this.addChild(a);"vo-claims"!==
this.type&&(c=dijit.byId(b+"-stackContainer"))&&(c.addChild(new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),content:this,grid:a,id:this.pageId,executeScripts:!0})),c.selectChild(this.pageId))},createImportedVariationOrdersContainer:function(){var a=dijit.byId("variationOrderContainer"),c=dijit.byId("importedVariationOrdersContainer-variationOrderListingGrid");c&&(a.removeChild(c),c.destroy());c=new G({id:"importedVariationOrdersContainer-variationOrderListingGrid",
title:h.importedVariationOrders,region:"bottom",parentContainer:a,project:this.project,claimCertificate:this.claimCertificate});a.addChild(c)}})});
