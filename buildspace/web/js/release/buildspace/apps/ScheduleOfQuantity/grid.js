define("buildspace/apps/ScheduleOfQuantity/grid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-attr dojox/grid/enhanced/plugins/Menu dijit/MenuSeparator dojo/number dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn dojo/_base/event dojo/keys dijit/focus dojo/_base/html dojo/request/xhr dijit/PopupMenuItem buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dojox/grid/enhanced/plugins/IndirectSelection dojo/i18n!buildspace/nls/ScheduleOfQuantity".split(" "),
function(r,t,B,C,D,u,E,F,v,w,x,y,n,z,G,H,I,J,K,L,M,N,f){return r("buildspace.apps.ScheduleOfQuantity.Grid",dojox.grid.EnhancedGrid,{type:null,project:null,editable:!0,region:"center",style:"border-top:none;",selectedItem:null,borderContainerWidget:null,billColumnSetting:null,keepSelection:!0,addUrl:null,updateUrl:null,deleteUrl:null,pasteUrl:null,indentUrl:null,outdentUrl:null,constructor:function(a){this.rearranger=v(this,{});this.formulatedColumn=w(this,{});"linkTo_ItemGrid"==a.type&&(this.plugins=
{indirectSelection:{headerSelector:!0,width:"20px",styles:"text-align:center;"}});"linkTo_BillItemGrid"==a.type&&(this.escapeHTMLInData=!1)},canSort:function(a){return!1},canEdit:function(a,b){var c=this;if(!this.editable||"linkTo_Grid"==this.type&&"linkTo_ItemGrid"==this.type&&"linkTo_BillItemGrid"==this.type)return!1;if("item_grid"==this.type&&void 0!=a){var d=this.getItem(b),e=a.field;if("type"===e){var f=this.getItem(b+1);if(0<d.id[0]&&d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&
void 0!==f&&d.level[0]<f.level[0]){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}}if(0<d.id[0]&&d.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM&&("quantity-value"==e||"uom_id"==e))return window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10),!1}return this._canEdit},postCreate:function(){var a=this;this.inherited(arguments);this.editable&&"linkTo_Grid"!=this.type&&"linkTo_ItemGrid"!=this.type&&"linkTo_BillItemGrid"!=
this.type&&(this.on("RowContextMenu",function(b){a.selection.clear();var c=a.getItem(b.rowIndex);a.selection.setSelected(b.rowIndex,!0);a.contextMenu(b);0<c.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0,["Add"])},!0),this.on("RowClick",function(b){(b=a.getItem(b.rowIndex))&&0<b.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0,["Add"])}));if("linkTo_BillItemGrid"==this.type)this.on("RowClick",function(b){var c=b.cell.field;b=this.getItem(b.rowIndex);("quantity_import"==c||"quantity_remeasurement_import"==
c)&&0<b.id&&null!==b.description[0]&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.linkScheduleOfQuantities(b,c)},!0)},doApplyCellEdit:function(a,b,c){var d=this,e=d.getItem(b),k=d.store,h=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),g=c.replace("-value","");-1!==c.indexOf("-value")&&(a=this.formulatedColumn.convertRowIndexToItemId(a,b));if(a!==e[c][0]){var l={id:e.id,attr_name:g,val:a,_csrf_token:e._csrf_token?e._csrf_token:null},m=this.updateUrl;e.id==
buildspace.constants.GRID_LAST_ROW&&(m=0<b?d.getItem(b-1):!1,t.mixin(l,{prev_item_id:m?m.id:0,relation_id:e.relation_id}),m=this.addUrl);var p=d.getCellByField(c),A=function(a,b){for(var d in a)e.hasOwnProperty(d)&&d!=b._getIdentifierAttribute()&&b.setValue(e,d,a[d]),dojo.forEach(a.affected_nodes,function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(d){for(var c in a)e.hasOwnProperty(c)&&c!=b._getIdentifierAttribute()&&b.setValue(d,c,a[c])}})});b.save()},q={url:m,content:l,handleAs:"json",
load:function(a){a.success&&(0<e.id?A(a.data,k):(k.deleteItem(e),k.save(),dojo.forEach(a.items,function(a){k.newItem(a)}),k.save(),d.disableToolbarButtons(!0)),window.setTimeout(function(){d.focus.setFocusIndex(b,p.index)},10),h.hide())},error:function(a){h.hide()}};void 0!=e[g+"-has_build_up"]&&e[g+"-has_build_up"][0]?(buildspace.dialog.confirm(f.confirmation,"<div>"+f.detachAllBuildUpAndLink+"</div>",85,280,function(){dojo.xhrPost(q)},function(){h.hide();window.setTimeout(function(){d.focus.setFocusIndex(b,
p.index)},10)}),d.doCancelEdit(b)):(h.show(),dojo.xhrPost(q),d.inherited(arguments))}else d.inherited(arguments)},doCancelEdit:function(a){this.inherited(arguments);this.views.renormalizeRow(a);this.scroller.rowHeightChanged(a,!0)},editableCellDblClick:function(a){var b;b=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(b.cell,b.rowIndex);this.onRowClick(b);this.onRowDblClick(a)},dodblclick:function(a){if(a.cellNode)a.cell.editable?
this.editableCellDblClick(a):(this.onCellDblClick(a),this.customCellDblClick&&this.customCellDblClick(a));else this.onRowDblClick(a)},contextMenu:function(a){var b=this.rowCtxMenu=new dijit.Menu;this.contextMenuItems(a);var c={target:a.target,coords:a.keyCode!==y.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null},d=this.getItem(a.rowIndex);b&&d&&(this.selection.isSelected(a.rowIndex)||a.rowNode&&z.hasClass(a.rowNode,"dojoxGridRowbar"))&&(b._openMyself(c),x.stop(a))},contextMenuItems:function(a){var b=this.getItem(a.rowIndex);
0<b.id&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.cut,iconClass:"icon-16-container icon-16-cut",onClick:dojo.hitch(this,"cutItems")})),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.copy,iconClass:"icon-16-container icon-16-copy",onClick:dojo.hitch(this,"copyItems")})));var c=this.selectedItem?!1:!0;this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,"pasteItem",a.rowIndex),disabled:c}));0<b.id&&
"item_grid"==this.type&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.indent,iconClass:"icon-16-container icon-16-indent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"indent")})),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.outdent,iconClass:"icon-16-container icon-16-outdent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"outdent")})));this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow",
a.rowIndex)}));0<b.id&&(this.rowCtxMenu.addChild(new u),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow",a.rowIndex)})))},cutItems:function(){this.selectedItem=this.selection.getFirstSelected();this.pasteOp="cut"},copyItems:function(){this.selectedItem=this.selection.getFirstSelected();this.pasteOp="copy"},pasteItem:function(a){var b=this,c=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+
"..."}),d=this.store,e=this.selection.getFirstSelected(),k=e.id==buildspace.constants.GRID_LAST_ROW&&0<a?this.getItem(a-1).id:0;c.show();dojo.xhrPost({url:this.pasteUrl,content:{type:this.pasteOp,target_id:e.id,prev_item_id:k,id:this.selectedItem.id,_csrf_token:this.selectedItem._csrf_token},handleAs:"json",load:function(e){var g=[];if(e.success){var l=e.c;switch(b.pasteOp){case "cut":d.fetchItemByIdentity({identity:e.data.id,onItem:function(c){c=b.getItemIndex(c);g.push(c);for(var e=0,h=l.length;e<
h;++e)d.fetchItemByIdentity({identity:l[e].id,onItem:function(a){a=b.getItemIndex(a);g.push(a)}});0<g.length&&b.rearranger.moveRows(g,a);b.selectAfterPaste(c>a?a:a-1,!0)}});d.fetchItemByIdentity({identity:e.data.id,onItem:function(a){for(var b in e.data)a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&d.setValue(a,b,e.data[b]);d.save();var c=0;for(a=l.length;c<a;++c)d.fetchItemByIdentity({identity:l[c].id,onItem:function(a){for(var b in l[c])a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&
d.setValue(a,b,l[c][b]);d.save()}})}});break;case "copy":var m=d.newItem(e.data);d.save();m=b.getItemIndex(m);g.push(m);for(var m=0,f=l.length;m<f;++m){var h=d.newItem(l[m]);d.save();h=b.getItemIndex(h);g.push(h)}0<g.length&&(b.rearranger.moveRows(g,a),b.selectAfterPaste(a,!1))}}b.disableToolbarButtons(!1);b.pasteOp=null;g.length=0;c.hide()},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null;c.hide()}})},selectAfterPaste:function(a,b){this.selection.clear();
this.selectedItem=null;this.selection.setSelected(a,!0);b&&this.scrollToRow(0<a-3?a-3:a)},addRow:function(a){n.curNode.blur();n.curNode=null;var b,c=this,d=buildspace.dialog.indeterminateProgressBar({title:f.addingRow+". "+f.pleaseWait+"..."}),e=this.store;b=this.getItem(a);if(0<b.id)b={before_id:b.id,relation_id:b.relation_id,_csrf_token:b._csrf_token};else{var k=0<a?this.getItem(a-1).id:0;b={id:b.id,prev_item_id:k,relation_id:b.relation_id,_csrf_token:b._csrf_token}}d.show();dojo.xhrPost({url:this.addUrl,
content:b,handleAs:"json",load:function(b){b.success&&dojo.forEach(b.items,function(b){0<b.id&&(b=e.newItem(b),e.save(),b=c.getItemIndex(b),c.rearranger.moveRows([b],a),c.selection.clear())});window.setTimeout(function(){c.selection.setSelected(a,!0);c.focus.setFocusIndex(a,1)},30);d.hide()},error:function(a){c.selection.clear();c.disableToolbarButtons(!0);d.hide()}})},deleteRow:function(a){var b=this,c=null,d=this.getItem(a),e=buildspace.dialog.indeterminateProgressBar({title:f.deleting+". "+f.pleaseWait+
"..."});n.curNode.blur();n.curNode=null;e.show();var k={url:this.deleteUrl,content:{id:d.id,_csrf_token:d._csrf_token},handleAs:"json",load:function(c){if(c.success){var g=c.items,f=b.store;if(void 0!=c.affected_nodes){c=c.affected_nodes;for(var h=0,l=c.length;h<l;++h)dojo.forEach(c[h],function(a){f.fetchItemByIdentity({identity:a.id,onItem:function(b){for(var c in a)d.hasOwnProperty(c)&&c!=f._getIdentifierAttribute()&&f.setValue(b,c,a[c])}})})}c=0;for(h=g.length;c<h;++c)f.fetchItemByIdentity({identity:g[c].id,
onItem:function(a){f.deleteItem(a);f.save()}});g.length=0;if("main_grid"==b.type&&void 0!=b.tabContainer){var g=b.tabContainer.getChildren(),k;for(k in g)if("object"==typeof g[k].lib_info&&g[k].lib_info.id==b.project.id+"_"+d.id){b.tabContainer.removeChild(g[k]);break}}}e.hide();b.selection.clear();window.setTimeout(function(){b.focus.setFocusIndex(a,0)},10);b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);b.selectedItem=
null;b.pasteOp=null;e.hide()}},h,g;switch(this.type){case "item_grid":c=d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER?f.confirmDeleteItemHead:f.confirmDeleteItem;h=320;g=95;break;case "trade_grid":c=f.confirmDeleteTrade;h=250;g=90;break;default:c=f.confirmDeleteSOQ,h=320,g=95}new buildspace.dialog.confirm(f.confirmation,c,g,h,function(){dojo.xhrPost(k)},function(){e.hide()})},indentOutdent:function(a,b){var c=this,d=this.store;if(0<a){var e=this.getItem(a),k=buildspace.dialog.indeterminateProgressBar({title:f.recalculateRows+
". "+f.pleaseWait+"..."});k.show();0<e.id&&dojo.xhrPost({url:this[b+"Url"],content:{id:e.id,_csrf_token:e._csrf_token},handleAs:"json",load:function(a){if(a.success){var b=a.c,c;for(c in a.item)a.item.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&d.setValue(e,c,a.item[c]);var f=0;for(a=b.length;f<a;++f)d.fetchItemByIdentity({identity:b[f].id,onItem:function(a){for(var c in b[f])a.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&d.setValue(a,c,b[f][c])}});d.save()}k.hide()},error:function(a){c.selection.clear();
c.disableToolbarButtons(!0);k.hide()}})}},disableToolbarButtons:function(a,b){if("linkTo_Grid"!=this.type&&"linkTo_ItemGrid"!=this.type&&"linkTo_BillItemGrid"!=this.type){var c;c="trade_grid"==this.type||"item_grid"==this.type?this.project.id+"_"+this.scheduleOfQuantity.id+"_"+this.type:this.project.id+"_"+this.type;var d=dijit.byId(c+"_AddSOQRow-button"),e=dijit.byId(c+"_DeleteSOQRow-button"),f=dijit.byId(c+"_IndentSOQ-button"),h=dijit.byId(c+"_OutdentSOQ-button"),g=dijit.byId(c+"_ImportDropDownRow-button");
d._setDisabledAttr(a);e._setDisabledAttr(a);g&&g._setDisabledAttr(a);f&&f._setDisabledAttr(a);h&&h._setDisabledAttr(a);a&&b instanceof Array&&dojo.forEach(b,function(a){(a=dijit.byId(c+"_"+a+"SOQRow-button"))&&a._setDisabledAttr(!1)})}},linkScheduleOfQuantities:function(a,b){var c=dijit.byId("linkToItemGrid_"+this.project.id);if("undefined"==typeof c)buildspace.dialog.alert(f.noSoqItemAlert,f.pleaseOpenSoqItem+".",90,300);else{var d=[];dojo.forEach(c.selection.getSelected(),function(a){a&&0<a.id&&
a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&d.push(a.id[0])});if(0<d.length&&null!=this.billColumnSetting){var e=this,k="quantity_remeasurement_import"==b?2:1,h=buildspace.dialog.indeterminateProgressBar({title:f.linkingData+". "+f.pleaseWait+"..."});h.show();dojo.xhrPost({url:"scheduleOfQuantity/linkToBillItem",content:{bid:a.id,bcid:this.billColumnSetting.id,type:k,_csrf_token:a._csrf_token,ids:d.toString()},handleAs:"json",load:function(a){a.success&&(e.store.fetchItemByIdentity({identity:a.item.id,
onItem:function(b){for(var c in a.item)b.hasOwnProperty(c)&&c!=e.store._getIdentifierAttribute()&&e.store.setValue(b,c,a.item[c])}}),e.store.save());h.hide();c.selection.clear()},error:function(a){h.hide();c.selection.clear()}})}else buildspace.dialog.alert(f.noItemSelectedAlert,f.pleaseSelectItem+".",90,300)}}})});
