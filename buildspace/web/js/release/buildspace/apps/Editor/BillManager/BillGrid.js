define("buildspace/apps/Editor/BillManager/BillGrid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-attr dijit/TooltipDialog dijit/popup dijit/Menu dojo/number dijit/CheckedMenuItem dojox/grid/enhanced/plugins/Menu dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn ./editBillNoteDialog ./PrintBillDialog dojo/_base/event dojo/keys dijit/focus dojo/_base/connect dojo/_base/html dojo/request/xhr dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dijit/PopupMenuItem dijit/MenuSeparator buildspace/widget/grid/cells/Select buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox buildspace/apps/Tendering/BillManager/primeCostRateDialog buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/Tendering dojo/on dojox/grid/_Grid dojox/widget/PlaceholderMenuItem buildspace/widget/grid/cells/TextBox".split(" "),
function(n,p,C,D,r,k,E,q,F,G,H,t,u,I,v,J,K,L,l,M,N,w,x,y,O,P,Q,R,S,z,A,e,T){var B=n("buildspace.apps.Editor.BillManager.BillGrid",dojox.grid.EnhancedGrid,{type:null,bill:null,elementId:0,itemId:-1,style:"border-top:none;",selectedItem:null,borderContainerWidget:null,keepSelection:!0,rowSelector:"0px",rowUpdateUrl:null,headerMenu:null,typeColumns:null,parentGrid:null,elementGridStore:null,currentPrintableRevision:null,currentBillVersion:0,currentGridType:"element",currentBillType:null,typeColumsToQtyUsed:[],
constructor:function(a){this.bill=a.bill;this.type=a.type;this.columnGroup=a.columnGroup;this.typeColumns=a.typeColumns;this.unitOfMeasurements=a.unitOfMeasurements;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;this.currentPrintableVersion=a.currentPrintableRevision;this.currentBillVersion=a.currentBillVersion;this.currentGridType=a.currentGridType;a=this.formatter=new A;this.typeColumnChildren="tree"!=this.type?[{name:"% "+
e.job,field_name:"total",width:"60px",styles:"text-align:right;",editable:!1,formatter:a.elementTypeJobPercentageCellFormatter},{name:e.costPerMetreSquare,field_name:"total_cost",width:"100px",styles:"text-align:right;",editable:!1,formatter:a.unEditableCurrencyCellFormatter},{name:e.total+"/"+e.unit,field_name:"total_per_unit",width:"100px",styles:"text-align:right;",editable:!1,formatter:a.elementTotalPerUnitCellFormatter}]:[{name:e.qty+"/"+e.unit,field_name:"quantity_per_unit-value",width:"70px",
styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:{billQuantityCellFormatter:function(a,b,d){b=this.grid.getItem(b);q.parse(a);a=this.field.replace("-value","");a=b[a+"-final_value"][0];var c=isNaN(a)||0==a||null==a?"&nbsp;":q.format(a,{places:2});a=0<=a?c:'<span style="color:#FF0000">'+c+"</span>";this.field.split("-");void 0!=b.type&&1>b.type?(d.customClasses.push("invalidTypeItemCell"),a="&nbsp;"):b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED&&
(d.customClasses.push("disable-cell"),b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY)&&(a=b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY?e.rateOnly:"&nbsp;");void 0!=b.version&&0<b.version&&(void 0!=this.grid.currentBillVersion&&this.grid.currentBillVersion==b.version?
d.customClasses.push("hasCurrentAddendumTypeItemCell"):d.customClasses.push("hasAddendumTypeItemCell"));return a}}.billQuantityCellFormatter},{name:e.total+"/"+e.unit,field_name:"total_per_unit",width:"100px",styles:"text-align:right;",editable:!1,formatter:a.itemTotalPerUnitCellFormatter}];this.rearranger=t(this,{});this.formulatedColumn=u(this,{});this.setColumnStructure();this.createHeaderCtxMenu()},canSort:function(a){return!1},postCreate:function(){this.inherited(arguments);var a=null;"tree"!=
this.type&&this._connects.push(l.connect(this,"onCellMouseOver",function(c){var b=c.cell.field,d=this.getItem(c.rowIndex);d&&"addendum_version"==b&&d.hasOwnProperty("addendum_version")&&"undefined"!==typeof d.addendum_version&&parseInt(d.addendum_version)&&null===a&&dojo.xhrGet({url:"addendumInfoByElement/"+String(d.id),handleAs:"json",sync:!0,preventCache:!0}).then(function(b){if(b.length){for(var d='<table class="buildspace-table"><thead><tr><th class="gridCell" style="text-align:center;padding:2px;">'+
e.version+'</th><th class="gridCell" style="text-align:center;padding:2px;">'+e.revision+"</th></tr><tbody>",f=0;f<b.length;f++)d+='<tr><td class="gridCell" style="text-align:center;">'+b[f].version+'</td><td class="gridCell" style="text-align:center;padding-left:4px;padding-right:4px;">'+b[f].revision+"</td></tr>";a=new r({content:d+"</tbody></table>",onMouseLeave:function(){k.close(a)}});k.open({popup:a,around:c.cellNode})}})}));this._connects.push(l.connect(this,"onCellMouseOut",function(){null!==
a&&(k.close(a),a=null)}));this._connects.push(l.connect(this,"onStartEdit",function(){null!==a&&(k.close(a),a=null)}))},doApplyCellEdit:function(a,c,b){var d=this,f=this.getItem(c),g=this.store,h=b.replace("-value","");-1!==b.indexOf("-value")&&(a=this.formulatedColumn.convertRowIndexToItemId(a,c));if(a!==f[b][0]){var m=buildspace.dialog.indeterminateProgressBar({title:e.savingData+". "+e.pleaseWait+"..."}),k=function(a,b){for(var c in a)f.hasOwnProperty(c)&&c!=b._getIdentifierAttribute()&&b.setValue(f,
c,a[c]);a.affected_nodes.hasOwnProperty("affected_bill_items")&&dojo.forEach(a.affected_nodes.affected_bill_items,function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(c){for(var d in a)c.hasOwnProperty(d)&&d!=b._getIdentifierAttribute()&&b.setValue(c,d,a[d])}})});a.affected_nodes.hasOwnProperty("affected_bill_item_type_references")&&dojo.forEach(a.affected_nodes.affected_bill_item_type_references,function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(c){for(var d in a)c.hasOwnProperty(d)&&
d!=b._getIdentifierAttribute()&&b.setValue(c,d,a[d])}})});dojo.forEach(a.affected_nodes,function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(d){for(var c in a)d.hasOwnProperty(c)&&c!=b._getIdentifierAttribute()&&b.setValue(d,c,a[c])}})});"tree"!=d.type&&dojo.forEach(a.other_elements,function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(c){for(var d in a)c.hasOwnProperty(d)&&d!=b._getIdentifierAttribute()&&b.setValue(c,d,a[d])}})});b.save()},l={url:this.rowUpdateUrl,content:{id:f.id,
attr_name:h,val:a,_csrf_token:f._csrf_token?f._csrf_token:null},handleAs:"json",load:function(a){if(a.success){f&&!isNaN(parseInt(f.id[0]))&&k(a.data,g);var e=d.getCellByField(b);window.setTimeout(function(){d.focus.setFocusIndex(c,e.index)},10);m.hide()}},error:function(a){m.hide()}};m.show().then(function(){dojo.xhrPost(l)})}this.inherited(arguments)},canEdit:function(a,c){var b=this;if("tree"==this.type&&void 0!=a){var d=this.getItem(c),e=a.field,g=e.split("-");if(d&&void 0!==d.project_revision_deleted_at&&
d.project_revision_deleted_at[0]){window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}3==g.length&&(e=g[1]);if(d&&!isNaN(parseInt(d.id.toString())))switch(e){case "rate-value":if(0<=[buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,
buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N].indexOf(d.type.toString())){d.type.toString()==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE&&(new z({itemObj:d,billGridStore:b.store,elementGridStore:b.elementGridStore,currentBillLockedStatus:b.currentBillLockedStatus,currentBillVersion:b.currentBillVersion,currentItemVersion:d.version.toString(),disableEditingMode:!0})).show();window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}break;
case "quantity_per_unit":case "description":case "uom_id":if(d.type.toString()!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED){window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}}else{window.setTimeout(function(){b.edit.cancel();b.focus.setFocusIndex(c,a.index)},10);return}}return this._canEdit},doCancelEdit:function(a){this.inherited(arguments);this.views.renormalizeRow(a);this.scroller.rowHeightChanged(a,!0)},setColumnStructure:function(){var a=
this.formatter,c="auto";2<this.typeColumns.length&&(c="600px");if("tree"==this.type)var c=this.fixedColumns={noscroll:!1,width:57.8,cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:e.billReference,field:"bill_ref",styles:"text-align:center; color: red;",width:"80px",noresize:!0,hidden:!0,rowSpan:2,showInCtxMenu:!0,formatter:a.billRefCellFormatter},{name:e.description,field:"description",width:c,editable:!0,
cellType:"buildspace.widget.grid.cells.Textarea",formatter:a.treeCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",formatter:a.typeCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:e.unit,field:"uom_id",width:"70px",editable:!0,styles:"text-align:center;",type:"dojox.grid.cells.Select",options:this.unitOfMeasurements.options,values:this.unitOfMeasurements.values,formatter:a.unitIdCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},
{name:e.grandTotalQty,field:"grand_total_quantity",styles:"text-align:right;color:blue;",width:"90px",formatter:a.unEditableNumberCellFormatter,noresize:!0,hidden:!0,rowSpan:2,showInCtxMenu:!0}]]},b=[{name:e.rate,field:"rate-value",field_name:"rate-value",styles:"text-align:right;",width:"75px",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:a.formulaCurrencyCellFormatter,noresize:!0,rowSpan:2},{name:e.grandTotal,field:"grand_total",styles:"text-align:right;color:blue;",
width:"100px",formatter:a.unEditableCurrencyCellFormatter,noresize:!0,hidden:!1,rowSpan:2,showInCtxMenu:!0}],d=this.constructTypeColumnStructure(c);else c="auto",2<this.typeColumns.length&&(c="600px"),c=this.fixedColumns={noscroll:!1,width:"50",cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0,rowSpan:2},{name:e.description,field:"description",width:c,formatter:a.treeCellFormatter,noresize:!0,rowSpan:2}]]},b=[{name:e.grandTotal,field:"grand_total",
styles:"text-align:right;color:blue;",width:"100px",formatter:a.unEditableCurrencyCellFormatter,hidden:!1,rowSpan:2,noresize:!0,showInCtxMenu:!0}],parseInt(String(this.bill.addendum_version))&&c.cells[0].push({name:e.addendum,field:"addendum_version",styles:"text-align: center;",width:"68px",formatter:a.addendumInfoCellFormatter,noresize:!0,rowSpan:2}),d=this.constructTypeColumnStructure(c);dojo.forEach(b,function(a){d.cells[0].push(a)});this.structure=d},constructTypeColumnStructure:function(a){var c=
this,b=this.typeColumnChildren,d=[],f=0;dojo.forEach(this.typeColumns,function(g){c.typeColumsToQtyUsed[g.id]=g.use_original_quantity;var h=b.length;f++;"tree"!=c.type&&(b[1].name=g.floor_area_display_metric?e.costPerMetreSquare:e.costPerSquareFeet);d.push({name:g.name+"<br>"+e.totalUnit+":"+g.quantity,styles:"text-align:center;",headerClasses:"staticHeader typeHeader"+f,colSpan:h,headerId:g.id,hidden:g.is_hidden});for(i=0;i<b.length;i++)h=g.id+"-"+b[i].field_name,h={field:h,columnType:"typeColumn",
billColumnSettingId:g.id,headerClasses:"typeHeader"+f},p.mixin(h,b[i]),a.cells[0].push(h)});a.cells.push(d);return a},createHeaderCtxMenu:function(){if("undefined"!==typeof this.fixedColumns){var a=this.fixedColumns.cells[0],c=this,b={headerMenu:new dijit.Menu};dojo.forEach(a,function(a,e){a.showInCtxMenu&&b.headerMenu.addChild(new dijit.CheckedMenuItem({label:a.name,checked:"undefined"===typeof a.hidden||!1===a.hidden?!0:!1,onChange:function(a){var b=!1;a&&(b=!0);c.showHideMergedColumn(b,e)}}))});
this.plugins={menus:b}}},showHideMergedColumn:function(a,c){this.beginUpdate();this.layout.setColumnVisibility(c,a);this.endUpdate()},refreshGrid:function(){this.beginUpdate();this.set("structure",this.structure);this.set("headerMenu",this.createHeaderCtxMenu());this.store.close();this.pluginMgr=new this._pluginMgrClass(this);this.pluginMgr.preInit();this.pluginMgr.postInit();this.pluginMgr.startup();this._refresh();this.endUpdate()},editableCellDblClick:function(a){var c;c=1<this._click.length&&
has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(c.cell,c.rowIndex);this.onRowClick(c);this.onRowDblClick(a)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},onHeaderCellClick:function(a){dojo.hasClass(a.cell.id,"staticHeader")||(a.grid.setSortIndex(a.cell.index),a.grid.onHeaderClick(a))},onHeaderCellMouseOver:function(a){dojo.hasClass(a.cell.id,
"staticHeader")||dojo.addClass(a.cellNode,this.cellOverClass)},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var c=a.node.children[0].children[0].rows[1],b=a.node.children[0].children[0].rows[0].children;c.parentNode.removeChild(c);dojo.forEach(b,function(a,b){var c=dojo.attr(a,"rowSpan");(!c||2>c)&&dojo.attr(a,"rowSpan",2)})}},disableToolbarButtons:function(a,c){if(a&&c instanceof Array){var b=this;dojo.forEach(c,function(a){(a=
dijit.byId(String(b.bill.id)+b.elementId+a+"Row-button"))&&a._setDisabledAttr(!1)})}},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,l.disconnect);delete this._connects}});return n("buildspace.apps.Editor.BillManager.BillGridBuilder",dijit.layout.BorderContainer,{pageId:"page-00",style:"padding:0px;width:100%;height:100%;",gutters:!1,stackContainerTitle:"",bill:null,project:null,elementId:0,itemId:-1,rowSelector:null,gridOpts:{},type:null,postCreate:function(){var a=this;
this.inherited(arguments);p.mixin(this.gridOpts,{bill:this.bill,elementId:this.elementId,type:this.type,region:"center",borderContainerWidget:this});var c=this.grid=new B(this.gridOpts);if("tree"!==this.type){var b=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"}),d,f=this.gridOpts.bqCSRFToken;if(0<this.gridOpts.currentPrintableRevision.version){d=e.printAddendum;var g=new x({style:"display: none;"});dojo.forEach(["printWithPrice","printWithoutPrice"],function(b){var c;
c="printWithoutPrice"===b?0:1;return g.addChild(new y({label:e[b],onClick:function(){window.open("BQPrintAddendum/"+String(a.bill.id)+"/"+f+"/"+c,"_blank");return window.focus()}}))});b.addChild(new w({label:e.printAddendum,iconClass:"icon-16-container icon-16-print",name:"printAddendum",dropDown:g}))}else d=e.printBQ,b.addChild(new dijit.form.Button({label:d,iconClass:"icon-16-container icon-16-print",onClick:function(){(new v({billId:String(a.bill.id),bqCSRFToken:f})).show()}}));this.addChild(b)}this.addChild(c);
if(b=dijit.byId("billGrid"+String(this.bill.id)+"-stackContainer"))b.addChild(new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),content:this,id:this.pageId,grid:c})),b.selectChild(this.pageId)}})});
