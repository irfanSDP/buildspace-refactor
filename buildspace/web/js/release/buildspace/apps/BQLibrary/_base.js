define("dojo/_base/declare dojo/aspect dojo/when dojo/_base/event dijit/Menu dojo/keys dojo/on dojo/dom-geometry dijit/Tooltip ./buildUpGrid ./buildUpSummary buildspace/widget/grid/cells/Formatter dojo/currency dijit/layout/AccordionContainer dijit/layout/AccordionPane ./AddResourceCategoryDialog dojo/i18n!buildspace/nls/BQLibrary".split(" "),function(u,v,w,k,C,x,l,D,E,y,z,r,A,F,G,B,d){return u("buildspace.apps.BQLibrary",buildspace.apps._App,{win:null,toolbarActions:["edit","delete"],init:function(a){var b=
this;this.win=new buildspace.widget.Window({title:d.appName,onClose:dojo.hitch(this,"kill")});a=this.borderContainer=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});var c=new dijit.Toolbar({region:"top",style:"padding:2px;width:100%;"});c.addChild(new dijit.form.Button({label:d.newLibrary,iconClass:"icon-16-container icon-16-add",style:"outline:none!important;",onClick:dojo.hitch(b,"addLibrary")}));dojo.forEach(this.toolbarActions,function(a){c.addChild(new dijit.ToolbarSeparator);
c.addChild(new dijit.form.Button({id:"bq_library-toolbar_"+a,label:d[a],iconClass:"icon-16-container icon-16-"+a,style:"outline:none!important;",disabled:!0,onClick:dojo.hitch(b,a+"Library")}))});c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({label:d.toggleSidebar,iconClass:"icon-16-container icon-16-arrow_bidirectional",style:"outline:none!important;",onClick:dojo.hitch(b,"toggleSidebar")}));c.addChild(new dijit.ToolbarSeparator);var e=this.tabArea=new dijit.layout.TabContainer({region:"center",
style:"width:100%;height:100%;"}),f=this.libraryStore=new dojo.data.ItemFileWriteStore({url:"bqLibrary/libraryList"}),g=new dijit.tree.ForestStoreModel({store:f,rootId:"root",rootLabel:d.libraries,childrenAttrs:["__children"]}),h=this.left=new dijit.EditableTree({model:g,splitter:!0,region:"left",openOnClick:!0,ajaxSubmitUrl:"bqLibrary/libraryUpdate",onSuccess:function(a){b.updateTabTitle(a)},labelAttr:"name",style:"background-color:#ecede9;width:170px;height:100%;",getIconClass:dojo.hitch(f,function(b,
a){return b.root?a?"icon-16-container icon-16-file":"icon-16-container icon-16-folder":"icon-16-container icon-16-list"}),onMouseDown:function(a){var c=dijit.getEnclosingWidget(a.target);c&&c.item&&c.item.root&&b.disableToolbarButtons(!0);if(dojo.mouseButtons.isRight(a))try{this.set("selectedNode",c)}catch(t){k.stop(a)}k.stop(a)},onClick:function(a,c){c.item&&"root"!=c.item.id&&b.disableToolbarButtons(!1)}});l(h.domNode,l.selector(".dijitTree","contextmenu"),function(a){k.stop(a)});l(h.domNode,l.selector(".dijitTreeNode",
"contextmenu"),function(a){var c=new dijit.Menu,d={target:a.target,coords:a.keyCode!==x.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null};c&&h.selectedItem&&(b.disableToolbarButtons(h.selectedItem.root?!0:!1),b.treeContextMenuItems(c),c._openMyself(d));k.stop(a)});dojo.connect(h,"onDblClick",this,"onItem");a.addChild(c);a.addChild(h);a.addChild(e);this.win.addChild(a);this.win.show();this.win.startup()},toggleSidebar:function(){0<=this.borderContainer.getIndexOfChild(this.left)?this.borderContainer.removeChild(this.left):
this.borderContainer.addChild(this.left)},disableToolbarButtons:function(a){dojo.forEach(this.toolbarActions,function(b){dijit.byId("bq_library-toolbar_"+b)._setDisabledAttr(a)})},updateTabTitle:function(a){var b=this.tabArea,c=b.getChildren();this.left.model.store.fetchItemByIdentity({identity:a,onItem:function(a){for(var d in c)if("object"==typeof c[d].lib_info&&c[d].lib_info.id==a.id){c[d].lib_info.name=a.name;c[d].set("title",buildspace.truncateString(a.name,25));b.resize();break}}})},addLibrary:function(){var a=
this,b=this.libraryStore;dojo.xhrPost({url:"bqLibrary/libraryAdd",handleAs:"json",load:function(c){c.success&&(b.newItem({id:c.item.id,name:c.item.name,_csrf_token:c.item._csrf_token}),b.save(),0>a.borderContainer.getIndexOfChild(a.left)&&a.borderContainer.addChild(a.left))},error:function(a){}})},editLibrary:function(){this.left._itemNodesMap[this.left.selectedNode.item.id][0].labelWidget.edit()},deleteLibrary:function(){var a=this,b=this.left.selectedNode.item,c=this.libraryStore,e=buildspace.dialog.indeterminateProgressBar({title:d.deleting+
". "+d.pleaseWait+"..."}),f=dijit.byId("TreeInlineEditBox_error-tooltip");f&&f.destroyRecursive();var g={url:"bqLibrary/libraryDelete",content:{id:b.id,_csrf_token:b._csrf_token},handleAs:"json",load:function(d){if(d.success){d=a.tabArea.getChildren();for(var g in d)if("object"==typeof d[g].lib_info&&d[g].lib_info.id==b.id){a.tabArea.removeChild(d[g]);break}c.deleteItem(b);c.save();e.hide()}a.disableToolbarButtons(!0)},error:function(a){e.hide()}};buildspace.dialog.confirm(d.confirmation,"<div>"+
d.deleteLibraryAndAllData+"</div>",60,280,function(){e.show();dojo.xhrPost(g)})},treeContextMenuItems:function(a){var b=this.left;"root"==this.left.selectedItem.id?(a.addChild(new dijit.MenuItem({label:d.newLibrary,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addLibrary")})),a.addChild(new dijit.MenuItem({label:d.reload,iconClass:"icon-16-container icon-16-reload",onClick:function(){b.model._requeryTop();b.collapseAll();b.expandAll()}}))):(a.addChild(new dijit.MenuItem({label:d.edit,
iconClass:"icon-16-container icon-16-edit",onClick:dojo.hitch(this,"editLibrary")})),a.addChild(new dijit.MenuItem({label:d.delete,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteLibrary")})))},makeTab:function(a,b,c){var e=dijit.byId("bqLibrary_"+a+"-stackContainer");e&&dijit.byId("bqLibrary_"+a+"-stackContainer").destroyRecursive();e=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"bqLibrary_"+a+"-stackContainer"});e.addChild(new dijit.layout.ContentPane({title:d.elements,
content:c,grid:c.grid}));c=new dijit.layout.StackController({region:"top",containerId:"bqLibrary_"+a+"-stackContainer"});var f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1});f.addChild(e);f.addChild(new dijit.layout.ContentPane({id:"bqLibrary_"+a+"-controllerPane",style:"padding:0px;overflow:hidden;",class:"breadCrumbTrail",region:"top",content:c}));e=new dijit.layout.ContentPane({closable:!0,style:"padding: 0px; overflow: hidden;border:0px;",
title:buildspace.truncateString(b,25),content:f});this.tabArea.addChild(e);this.tabArea.selectChild(e);dojo.subscribe("bqLibrary_"+a+"-stackContainer-selectChild","",function(b){var c=dijit.byId("bqLibrary_"+a+"-stackContainer");if(c){var d=c.getChildren(),e=dojo.indexOf(d,b);e+=1;if(d.length>e){for(;d.length>e;){c.removeChild(d[e]);d[e].destroyRecursive(!0);e+=1;var g=dijit.byId("add_resource_category_"+a+"-btn");g&&g.destroy()}var f=b.grid.selection.selectedIndex;b.grid.store.save();b.grid.store.close();
var q=v.after(b.grid,"_onFetchComplete",function(){q.remove();-1<f&&(this.scrollToRow(f),this.selection.setSelected(f,!0))});b.grid.sort()}}});e.lib_info={name:b,id:a}},onItem:function(a){this.disableToolbarButtons(!0);var b=this.libraryStore;if(b.isItem(a)){var c=b.getValue(a,"id");a=b.getValue(a,"name");if("root"!=c){b=this.tabArea.getChildren();for(var e in b)if("object"==typeof b[e].lib_info&&b[e].lib_info.id==c)return this.tabArea.selectChild(b[e]);var f=this;e=new r;b=dojo.data.ItemFileWriteStore({url:"bqLibrary/getElementList/id/"+
c,clearOnClose:!0});b=f.grid=buildspace.apps.BQLibrary.grid({id:"element-page-container-"+c,stackContainerTitle:a,pageId:"element-page-"+c,libraryId:c,gridOpts:{store:b,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:e.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea"},{name:d.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],addUrl:"bqLibrary/elementAdd",
updateUrl:"bqLibrary/elementUpdate",deleteUrl:"bqLibrary/elementDelete",pasteUrl:"bqLibrary/elementPaste",onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&f.createItemGrid(c,a)}}});f.makeTab(c,a,b)}}},createItemGrid:function(a,b){var c=this,e=r(),f=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],g=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,
buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID],h=new dojo.data.ItemFileWriteStore({url:"bqLibrary/getItemList/id/"+b.id,clearOnClose:!0}),n=dojo.xhrGet({url:"bqLibrary/getUnits",handleAs:"json"}),p=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});p.show();return w(n,function(t){p.hide();buildspace.apps.BQLibrary.grid({stackContainerTitle:b.description,id:"item-page-container-"+a,pageId:"item-page-"+b.id,libraryId:a,
elementId:b.id,type:"tree",gridOpts:{store:h,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:e.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:e.treeCellFormatter},{name:d.type,field:"type",width:"70px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:f,values:g,formatter:e.typeCellFormatter},{name:d.unit,field:"uom_id",width:"70px",
styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:t.options,values:t.values,formatter:e.unitIdCellFormatter},{name:d.rate,field:"rate-value",width:"100px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:e.formulaCurrencyCellFormatter},{name:d.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],addUrl:"bqLibrary/itemAdd",updateUrl:"bqLibrary/itemUpdate",deleteUrl:"bqLibrary/itemDelete",
deleteRateUrl:"bqLibrary/itemRateDelete",pasteUrl:"bqLibrary/itemPaste",indentUrl:"bqLibrary/itemIndent",outdentUrl:"bqLibrary/itemOutdent",onRowDblClick:function(b){b=this.getItem(b.rowIndex);0<b.id&&null!==b.description[0]&&b.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM&&c.createBuildUpRateContainer(a,b)}}})},function(a){})},createBuildUpRateContainer:function(a,b){var c=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation,
e=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;outline:none;",gutters:!1}),f=new dijit.layout.AccordionContainer({id:"accordian_"+a+"_"+b.id+"-container",region:"center",style:"padding:0px;width:100%;height:100%;border:0px;outline:none;"}),g=new r,h=dojo.xhrGet({url:"bqLibrary/getUnits",handleAs:"json"}),n=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});n.show();dojo.xhrGet({url:"bqLibrary/resourceList/item_id/"+b.id,handleAs:"json",
load:function(p){h.then(function(h){if(0==p.length)f.addChild(new dijit.layout.ContentPane({title:d.emptyResourceCategoryTitle,style:"padding:0px;border:0px;",doLayout:!1,id:"accPane-empty_resource-"+b.id,content:'<div style="text-align:center;"><p><h1>'+d.emptyResourceCategory+"</h1></p></div> "}));else{var k=z({id:"buildUpRateSummary-"+b.id,itemId:b.id,container:e,_csrf_token:b._csrf_token});dojo.forEach(p,function(a){var c=new dojo.data.ItemFileWriteStore({url:"bqLibrary/getBuildUpRateItemList/item_id/"+
b.id+"/resource_id/"+a.id,clearOnClose:!0});c=y({resource:a,bqItemId:b.id,gridOpts:{itemId:b.id,addUrl:"bqLibrary/buildUpRateItemAdd",updateUrl:"bqLibrary/buildUpRateItemUpdate",deleteUrl:"bqLibrary/buildUpRateItemDelete",pasteUrl:"bqLibrary/buildUpRateItemPaste",store:c,buildUpSummaryWidget:k,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:g.rowCountCellFormatter},{name:d.description,field:"description",width:"auto",editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",
formatter:g.linkedCellFormatter},{name:d.number,field:"number-value",width:"100px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:g.formulaCurrencyCellFormatter},{name:d.constant,field:"constant-value",width:"100px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:g.formulaCurrencyCellFormatter},{name:d.qty,field:"quantity-value",width:"70px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:g.formulaNumberCellFormatter},{name:d.unit,field:"uom_id",width:"70px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:h.options,values:h.values,formatter:g.linkedUnitIdCellFormatter},{name:d.rate,field:"rate-value",width:"120px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:g.formulaCurrencyCellFormatter},{name:d.total,field:"total",width:"120px",styles:"text-align:right;",formatter:g.linkedCurrencyCellFormatter},
{name:d.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:g.formulaCurrencyCellFormatter},{name:d.lineTotal,field:"line_total",width:"120px",styles:"text-align:right;",formatter:g.linkedCurrencyCellFormatter}]}});f.addChild(new dijit.layout.ContentPane({title:a.name+'<span style="color:blue;float:right;">'+buildspace.currencyAbbreviation+"&nbsp;"+A.format(a.total_build_up)+"</span>",style:"padding:0px;border:0px;",
doLayout:!1,id:"accPane-"+a.id+"-"+b.id,content:c}))});e.addChild(k)}e.addChild(f);var q=dijit.byId("bqLibrary_"+a+"-stackContainer");if(q){var m=dijit.byId("bqLibrary_"+a+"-controllerPane"),l=new dijit.form.Button({id:"add_resource_category_"+a+"-btn",label:d.addResourceCategory,style:"float:right;color:#333333!important;",iconClass:"icon-16-container icon-16-add",baseClass:"buildUpRateImportResourceCategory",onClick:function(d){B({libraryId:a,BQItem:b,currencyAbbr:c,baseContainer:e}).show()}});
m.addChild(l);m=document.createElement("div");m=new dojox.layout.ContentPane({title:buildspace.truncateString(b.description,60)+" ("+d.buildUpRate+")",id:"buildUpRatePage-"+b.id,executeScripts:!0},m);q.addChild(m);m.set("content",e);q.selectChild("buildUpRatePage-"+b.id)}n.hide()})},error:function(a){n.hide()}})},kill:function(){var a=dijit.byId("TreeInlineEditBox_error-tooltip");a&&a.destroyRecursive();this.win&&"undefined"!=typeof this.win&&this.win.close()}})});
