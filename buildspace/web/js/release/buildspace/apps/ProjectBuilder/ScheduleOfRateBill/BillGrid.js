define("buildspace/apps/ProjectBuilder/ScheduleOfRateBill/BillGrid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-attr dijit/Menu dojo/number dojox/grid/enhanced/plugins/Menu dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn dojo/_base/event dojo/keys dijit/focus dojo/_base/html dojo/request/xhr dijit/PopupMenuItem dijit/MenuSeparator buildspace/widget/grid/cells/Select buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/ProjectBuilder".split(" "),
function(p,q,B,C,D,E,F,G,r,t,u,v,l,w,H,I,x,J,K,L,y,f){var A=p("buildspace.apps.ProjectBuilder.ScheduleOfRateBill.BillGrid",dojox.grid.EnhancedGrid,{type:null,billId:-1,elementId:0,itemId:-1,style:"border-top:none;",selectedItem:null,borderContainerWidget:null,keepSelection:!0,rowSelector:"0px",addUrl:null,updateUrl:null,rowUpdateUrl:null,deleteUrl:null,deleteRateUrl:null,deleteQuantityUrl:null,pasteUrl:null,indentUrl:null,outdentUrl:null,headerMenu:null,parentGrid:null,elementGridStore:null,currentBillLockedStatus:!1,
currentGridType:"element",constructor:function(a){this.type=a.type;this.hierarchyTypes=a.hierarchyTypes;this.hierarchyTypesForHead=a.hierarchyTypesForHead;this.unitOfMeasurements=a.unitOfMeasurements;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;this.currentBillLockedStatus=a.currentBillLockedStatus;this.currentGridType=a.currentGridType;this.formatter=new y;this.rearranger=r(this,{});this.formulatedColumn=t(this,{});this.setColumnStructure()},
canSort:function(a){return!1},postCreate:function(){var a=this;a.inherited(arguments);this.on("RowContextMenu",function(b){a.selection.clear();a.selection.setSelected(b.rowIndex,!0);a.setupContextMenuAndToolbarButtonRestriction(b);a.contextMenu(b)},!0);this.on("RowClick",function(b){a.setupContextMenuAndToolbarButtonRestriction(b)})},doApplyCellEdit:function(a,b,c){var d=this,e=d.getItem(b),g=d.store,h=c.replace("-value","");-1!==c.indexOf("-value")&&(a=this.formulatedColumn.convertRowIndexToItemId(a,
b));if(a!==e[c][0]){var m=buildspace.dialog.indeterminateProgressBar({title:f.savingData+". "+f.pleaseWait+"..."}),h={id:e.id,attr_name:h,val:a,bill_id:d.billId,_csrf_token:e._csrf_token?e._csrf_token:null},k=this.updateUrl;e.id==buildspace.constants.GRID_LAST_ROW&&(k=0<b?d.getItem(b-1):!1,q.mixin(h,{prev_item_id:k?k.id:0,relation_id:e.relation_id}),k=this.addUrl);var z=function(a,b){for(var c in a)e.hasOwnProperty(c)&&c!=b._getIdentifierAttribute()&&b.setValue(e,c,a[c]);"tree"!=d.type&&dojo.forEach(a.other_elements,
function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(c){for(var d in a)c.hasOwnProperty(d)&&d!=b._getIdentifierAttribute()&&b.setValue(c,d,a[d])}})});b.save()};m.show();dojo.xhrPost({url:k,content:h,handleAs:"json",load:function(a){if(a.success){0<e.id?z(a.data,g):(g.deleteItem(e),g.save(),dojo.forEach(a.items,function(a){g.newItem(a)}),g.save(),d.disableToolbarButtons(!0));var h=d.getCellByField(c);window.setTimeout(function(){d.focus.setFocusIndex(b,h.index)},10);m.hide()}},error:function(a){m.hide()}})}d.inherited(arguments)},
canEdit:function(a,b){var c=this;if("tree"==this.type&&void 0!=a){var d=this.getItem(b),e=a.field;if(this.currentBillLockedStatus)return!1;if(0<d.id[0]){if((d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&"description"!=e&&"type"!=e&&a.editable){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}if(d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&"description"!=
e&&"type"!=e&&a.editable){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}"tree"==c.type&&"type"===e&&(e=c.getItem(b+1),(d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&a.editable&&void 0!==e&&d.level[0]<e.level[0]?(a.options=c.hierarchyTypesForHead.options,a.values=c.hierarchyTypesForHead.values):(a.options=c.hierarchyTypes.options,a.values=c.hierarchyTypes.values))}else if("description"!==
e&&"type"!==e)return}return this._canEdit},doCancelEdit:function(a){this.inherited(arguments);this.views.renormalizeRow(a);this.scroller.rowHeightChanged(a,!0)},setColumnStructure:function(){var a=this.formatter,b=!0;this.currentBillLockedStatus&&(b=!1);if("tree"==this.type){var c=this.unitOfMeasurements,d=this.hierarchyTypes;this.structure=[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0},{name:f.description,field:"description",width:"auto",
editable:b,cellType:"buildspace.widget.grid.cells.Textarea",formatter:a.treeCellFormatter,noresize:!0},{name:f.type,field:"type",width:"70px",styles:"text-align:center;",editable:b,type:"dojox.grid.cells.Select",options:d.options,values:d.values,formatter:a.typeCellFormatter,noresize:!0},{name:f.unit,field:"uom_id",width:"70px",editable:b,styles:"text-align:center;",type:"dojox.grid.cells.Select",options:c.options,values:c.values,formatter:a.unitIdCellFormatter,noresize:!0},{name:f.estimationRate+
" ("+this.currencySetting+")",field:"estimation_rate",styles:"text-align:right;",width:"128px",editable:b,cellType:"buildspace.widget.grid.cells.Textarea",formatter:a.currencyCellFormatter,noresize:!0}]}else this.structure=[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:a.rowCountCellFormatter,noresize:!0},{name:f.description,field:"description",width:"auto",editable:b,cellType:"buildspace.widget.grid.cells.Textarea",noresize:!0}]},cutItems:function(){this.selectedItem=this.selection.getFirstSelected();
this.pasteOp="cut"},copyItems:function(){this.selectedItem=this.selection.getFirstSelected();this.pasteOp="copy"},pasteItem:function(a){var b=this,c=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),d=this.store,e=this.selection.getFirstSelected(),g=e.id==buildspace.constants.GRID_LAST_ROW&&0<a?this.getItem(a-1).id:0;c.show();dojo.xhrPost({url:this.pasteUrl,content:{type:this.pasteOp,target_id:e.id,prev_item_id:g,id:this.selectedItem.id,_csrf_token:this.selectedItem._csrf_token},
handleAs:"json",load:function(e){var h=[];if(e.success){var k=e.c;switch(b.pasteOp){case "cut":d.fetchItemByIdentity({identity:e.data.id,onItem:function(c){c=b.getItemIndex(c);h.push(c);for(var e=0,f=k.length;e<f;++e)d.fetchItemByIdentity({identity:k[e].id,onItem:function(a){a=b.getItemIndex(a);h.push(a)}});0<h.length&&b.rearranger.moveRows(h,a);b.selectAfterPaste(c>a?a:a-1,!0)}});d.fetchItemByIdentity({identity:e.data.id,onItem:function(a){for(var b in e.data)a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&
d.setValue(a,b,e.data[b]);d.save();var c=0;for(a=k.length;c<a;++c)d.fetchItemByIdentity({identity:k[c].id,onItem:function(a){for(var b in k[c])a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&d.setValue(a,b,k[c][b]);d.save()}})}});break;case "copy":var f=d.newItem(e.data);d.save();f=b.getItemIndex(f);h.push(f);for(var f=0,g=k.length;f<g;++f){var n=d.newItem(k[f]);d.save();n=b.getItemIndex(n);h.push(n)}0<h.length&&(b.rearranger.moveRows(h,a),b.selectAfterPaste(a,!1))}}b.pasteOp=null;h.length=0;
c.hide()},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null;c.hide()}})},selectAfterPaste:function(a,b){this.selection.clear();this.selectedItem=null;this.selection.setSelected(a,!0);b&&this.scrollToRow(0<a-3?a-3:a)},pasteCell:function(a,b){var c=this,d=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),e=this.store,g=this.selection.getFirstSelected();d.show();dojo.xhrPost({url:this.pasteUrl,content:{target_id:g.id,id:this.selectedItem.id,
_csrf_token:this.selectedItem._csrf_token},handleAs:"json",load:function(a){if(a.success){var b=a.c;e.fetchItemByIdentity({identity:a.data.id,onItem:function(c){for(var d in a.data)c.hasOwnProperty(d)&&d!=e._getIdentifierAttribute()&&e.setValue(c,d,a.data[d]);e.save();var f=0;for(c=b.length;f<c;++f)e.fetchItemByIdentity({identity:b[f].id,onItem:function(a){for(var c in b[f])a.hasOwnProperty(c)&&c!=e._getIdentifierAttribute()&&e.setValue(a,c,b[f][c]);e.save()}})}})}c.selection.clear();c.disableToolbarButtons(!0);
c.selectedItem=null;d.hide()},error:function(a){c.selection.clear();c.disableToolbarButtons(!0);c.selectedItem=null;d.hide()}})},addRow:function(a){l.curNode.blur();l.curNode=null;var b=this,c,d=buildspace.dialog.indeterminateProgressBar({title:f.addingRow+". "+f.pleaseWait+"..."}),e=b.store,g=b.getItem(a),h=b.billId;0<g.id?(c=0<a?b.getItem(a-1).id:0,c={prev_item_id:c,before_id:g.id,bill_id:h,_csrf_token:g._csrf_token}):(c=0<a?b.getItem(a-1).id:0,c={id:g.id,bill_id:h,prev_item_id:c,relation_id:g.relation_id,
_csrf_token:g._csrf_token});d.show();dojo.xhrPost({url:this.addUrl,content:c,handleAs:"json",load:function(c){c.success&&dojo.forEach(c.items,function(c){0<c.id&&(c=e.newItem(c),e.save(),c=b.getItemIndex(c),b.rearranger.moveRows([c],a),b.selection.clear())});window.setTimeout(function(){var c="tree"==b.type?2:1;b.selection.setSelected(a,!0);b.focus.setFocusIndex(a,c)},30);d.hide()},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);d.hide()}})},deleteRow:function(a){var b=this,c=null,
d=null,c=b.getItem(a),e=buildspace.dialog.indeterminateProgressBar({title:f.deleting+". "+f.pleaseWait+"..."});l.curNode.blur();l.curNode=null;e.show();var g={url:this.deleteUrl,content:{id:c.id,_csrf_token:c._csrf_token},handleAs:"json",load:function(c){if(c.success){c=c.items;for(var d=b.store,f=0,h=c.length;f<h;++f)d.fetchItemByIdentity({identity:c[f].id,onItem:function(a){d.deleteItem(a);d.save()}});c.length=0}e.hide();b.selection.clear();window.setTimeout(function(){b.focus.setFocusIndex(a,0)},
10);b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null;e.hide()}};"tree"!=this.type?(c=f.deleteElementDialogBoxTitle,d=f.deleteElementDialogBoxMsg):c.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||c.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N?(c=f.deleteHeadDialogBoxTitle,d=f.deleteHeadDialogBoxMsg):(c=f.deleteItemDialogBoxTitle,d=f.deleteItemMsg);new buildspace.dialog.confirm(c,
d,80,320,function(){dojo.xhrPost(g)},function(){e.hide()})},indentOutdent:function(a,b){var c=this,d=c.store;if(0<a){var e=c.getItem(a),g=buildspace.dialog.indeterminateProgressBar({title:f.recalculateRows+". "+f.pleaseWait+"..."});g.show();0<e.id&&dojo.xhrPost({url:this[b+"Url"],content:{id:e.id,_csrf_token:e._csrf_token},handleAs:"json",load:function(a){if(a.success){var b=a.c,c;for(c in a.item)a.item.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&d.setValue(e,c,a.item[c]);var f=0;for(a=b.length;f<
a;++f)d.fetchItemByIdentity({identity:b[f].id,onItem:function(a){for(var c in b[f])a.hasOwnProperty(c)&&c!=d._getIdentifierAttribute()&&d.setValue(a,c,b[f][c])}});d.save()}g.hide()},error:function(a){c.selection.clear();c.disableToolbarButtons(!0);g.hide()}})}},refreshGrid:function(){this.beginUpdate();this.set("structure",this.structure);this.store.close();this.pluginMgr=new this._pluginMgrClass(this);this.pluginMgr.preInit();this.pluginMgr.postInit();this.pluginMgr.startup();this._refresh();this.endUpdate()},
editableCellDblClick:function(a){var b;b=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:a;this.focus.setFocusCell(b.cell,b.rowIndex);this.onRowClick(b);this.onRowDblClick(a)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},contextMenu:function(a){var b=this.rowCtxMenu=new dijit.Menu;this.contextMenuItems(a);var c={target:a.target,
coords:a.keyCode!==v.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null},d=this.getItem(a.rowIndex);if(this.currentBillLockedStatus)return!1;b&&d&&(this.selection.isSelected(a.rowIndex)||a.rowNode&&w.hasClass(a.rowNode,"dojoxGridRowbar"))&&(b._openMyself(c),u.stop(a))},contextMenuItems:function(a){var b=this.getItem(a.rowIndex-1),c=this.getItem(a.rowIndex),d=a.cell,e=!1;"tree"==this.type&&(void 0===b&&(e=!0),b&&b.type[0]===buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&(e=!0));0<c.id&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.cut,
iconClass:"icon-16-container icon-16-cut",onClick:dojo.hitch(this,"cutItems"),disabled:!1})),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.copy,iconClass:"icon-16-container icon-16-copy",onClick:dojo.hitch(this,"copyItems"),disabled:!1})));b=this.selectedItem?!1:!0;this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,"pasteItem",a.rowIndex,d),disabled:b}));0<c.id&&"tree"==this.type&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.indent,
iconClass:"icon-16-container icon-16-indent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"indent"),disabled:!1})),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.outdent,iconClass:"icon-16-container icon-16-outdent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"outdent"),disabled:!1})));this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow",a.rowIndex),disabled:e}));0<c.id&&(this.rowCtxMenu.addChild(new x),
this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow",a.rowIndex),disabled:!1})))},disableToolbarButtons:function(a,b){var c=dijit.byId(this.billId+this.elementId+"AddRow-button"),d=dijit.byId(this.billId+this.elementId+"DeleteRow-button"),e=dijit.byId(this.billId+this.elementId+"IndentRow-button"),f=dijit.byId(this.billId+this.elementId+"OutdentRow-button");c._setDisabledAttr(a);d._setDisabledAttr(a);e&&e._setDisabledAttr(a);
f&&f._setDisabledAttr(a);if(a&&b instanceof Array){var h=this;dojo.forEach(b,function(a){(a=dijit.byId(h.billId+h.elementId+a+"Row-button"))&&a._setDisabledAttr(!1)})}},disableAllButtonWhenCurrentBillIsLocked:function(){this.currentBillLockedStatus||this.disableToolbarButtons(!0,["Add"])},setupContextMenuAndToolbarButtonRestriction:function(a){(a=this.getItem(a.rowIndex))&&0<a.id&&!this.currentBillLockedStatus?this.disableToolbarButtons(!1):this.disableAllButtonWhenCurrentBillIsLocked()}});return p("buildspace.apps.ProjectBuilder.ScheduleOfRateBill.BillGridBuilder",
dijit.layout.BorderContainer,{pageId:"page-00",style:"padding:0px;width:100%;height:100%;border:0px!important;",gutters:!1,stackContainerTitle:"",billId:-1,elementId:0,itemId:-1,rowSelector:null,gridOpts:{},type:null,postCreate:function(){this.inherited(arguments);q.mixin(this.gridOpts,{billId:this.billId,elementId:this.elementId,type:this.type,region:"center",borderContainerWidget:this});var a=this.grid=new A(this.gridOpts),b=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});
b.addChild(new dijit.form.Button({id:this.billId+this.elementId+"AddRow-button",label:f.addRow,iconClass:"icon-16-container icon-16-add",disabled:-1<a.selection.selectedIndex?!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.addRow(a.selection.selectedIndex)}}));"tree"==this.type&&(b.addChild(new dijit.ToolbarSeparator),b.addChild(new dijit.form.Button({id:this.billId+this.elementId+"IndentRow-button",label:f.indent,iconClass:"icon-16-container icon-16-indent",disabled:-1<a.selection.selectedIndex?
!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.indentOutdent(a.selection.selectedIndex,"indent")}})),b.addChild(new dijit.ToolbarSeparator),b.addChild(new dijit.form.Button({id:this.billId+this.elementId+"OutdentRow-button",label:f.outdent,iconClass:"icon-16-container icon-16-outdent",disabled:-1<a.selection.selectedIndex?!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.indentOutdent(a.selection.selectedIndex,"outdent")}})));b.addChild(new dijit.ToolbarSeparator);b.addChild(new dijit.form.Button({id:this.billId+
this.elementId+"DeleteRow-button",label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",disabled:-1<a.selection.selectedIndex?!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.deleteRow(a.selection.selectedIndex)}}));if("tree"!=this.type){var c=this;b.addChild(new dijit.ToolbarSeparator);b.addChild(new dijit.form.Button({label:f.printBill,iconClass:"icon-16-container icon-16-print",onClick:function(a){window.open("scheduleOfRateBill/printBill/id/"+c.billId,"_blank")}}))}this.addChild(b);
this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:a,region:"center"}));if(b=dijit.byId("scheduleOfRateBillGrid"+this.billId+"-stackContainer")){var d=document.createElement("div");b.addChild(new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),content:this,id:this.pageId,grid:a},d));b.selectChild(this.pageId)}}})});
