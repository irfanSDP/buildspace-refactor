define("buildspace/apps/ProjectBuilder/BillManager/importElementDialog","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style dojo/aspect buildspace/widget/grid/cells/Formatter dojox/grid/enhanced/plugins/IndirectSelection dojo/i18n!buildspace/nls/BillManagerImport".split(" "),function(f,m,k,w,x,y,q,r,t,n,z,d){var v=f("buildspace.apps.ProjectBuilder.BillManager.ImportElementGrid",dojox.grid.EnhancedGrid,{type:null,selectedItem:null,billId:0,billElementId:0,
dialogWidget:null,_csrf_token:null,billGrid:null,style:"border-top:none;",constructor:function(a){this.itemIds=[];this.connects=[];"element"==a.type&&(this.plugins={indirectSelection:{headerSelector:!0,width:"20px",styles:"text-align:center;"}});this.inherited(arguments)},canSort:function(a){return!1},postCreate:function(){var a=this;a.inherited(arguments);this.on("RowClick",function(b){b=a.getItem(b.rowIndex);"element"==a.type&&(b&&0<b.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0))});
"element"==this.type&&(this._connects.push(k.connect(this,"onCellClick",function(b){a.selectTree(b)})),this._connects.push(k.connect(this.rowSelectCell,"toggleAllSelection",function(b){a.toggleAllSelection(b)})))},dodblclick:function(a){this.onRowDblClick(a)},disableToolbarButtons:function(a){dijit.byId("ImportElementGrid-"+this.billElementId+"_"+this.billId+"ImportDescription-button")._setDisabledAttr(a)},"import":function(){var a=this,b=a.billGrid,c=a.itemIds;if(0<c.length){var g=b.getItemIndex(this.selectedItem),
e=b.getItem(g-1),l=buildspace.dialog.indeterminateProgressBar({title:d.importingData+". "+d.pleaseWait+"..."}),h=[];l.show();dojo.xhrPost({url:"billManagerImport/importBillElements",content:{id:e?e.id:0,bill_id:a.billId,ids:[c],_csrf_token:a._csrf_token},handleAs:"json",load:function(c){if(c.success){var e=b.store;c=c.elements;for(var d=0,u=c.length;d<u;++d){var f=e.newItem(c[d]);e.save();f=b.getItemIndex(f);h.push(f)}0<h.length&&b.rearranger.moveRows(h,g)}a.itemIds=[];b.selection.clear();b.disableToolbarButtons(!0);
h.length=0;l.hide();a.dialogWidget.hide()},error:function(c){a.itemIds=[];b.selection.clear();b.disableToolbarButtons(!0);h.length=0;l.hide();a.dialogWidget.hide()}})}},selectTree:function(a){var b=a.rowIndex;a=this.selection.selected[b];(b=this.getItem(b))&&this.pushItemIdIntoGridArray(b,a)},pushItemIdIntoGridArray:function(a,b){var c=dojo.indexOf(this.itemIds,a.id[0]);b?-1==c&&this.itemIds.push(a.id[0]):-1!=c&&this.itemIds.splice(c,1)},toggleAllSelection:function(a){var b=this,c=b.selection;a?(c.selectRange(0,
b.rowCount-1),b.itemIds=[],b.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,c){0<a.id&&b.itemIds.push(a.id[0])})}})):(c.deselectAll(),b.itemIds=[])},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,k.disconnect);delete this._connects}}),p=f("buildspace.apps.ProjectBuilder.BillManager.ImportElementGridContainer",dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0px;width:100%;height:100%;",gutters:!1,billId:0,billElementId:0,gridOpts:{},postCreate:function(){this.inherited(arguments);
m.mixin(this.gridOpts,{type:this.type,billId:this.billId,billElementId:this.billElementId,region:"center"});var a=this.grid=new v(this.gridOpts);if("element"==this.type){var b=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});b.addChild(new dijit.form.Button({id:"ImportElementGrid-"+this.billElementId+"_"+this.billId+"ImportDescription-button",label:d["import"],iconClass:"icon-16-container icon-16-import",onClick:function(){a["import"]()}}));this.addChild(b)}this.addChild(new dijit.layout.ContentPane({style:"width:100%",
content:a,region:"center"}));if(b=dijit.byId("billManager-element_import_"+this.billId+"_"+this.billElementId+"-stackContainer")){var c=document.createElement("div"),c=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),id:this.pageId,executeScripts:!0},c);b.addChild(c);c.set("content",this);m.mixin(c,{grid:a});b.selectChild(this.pageId)}}});return f("buildspace.apps.ProjectBuilder.BillManager.ImportElementDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",
title:d.importElementsFromLibrary,selectedItem:null,billId:0,elementId:0,billGrid:null,buildRendering:function(){var a=this.createContent();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){r.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==q.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createContent:function(){var a=this,b=new dijit.layout.BorderContainer({style:"padding:0px;width:950px;height:500px;",
gutters:!1}),c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:d.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));var g=new n,e=dojo.data.ItemFileWriteStore({clearOnClose:!0,url:"billManagerImport/getLibraryList"}),g=p({stackContainerTitle:d.libraries,pageId:"import-page_library-"+this.billId+"_"+this.elementId,billId:this.billId,billElementId:this.elementId,
gridOpts:{store:e,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:g.rowCountCellFormatter},{name:d.title,field:"name",width:"auto"}],onRowDblClick:function(b){b=this.getItem(b.rowIndex);0<b.id&&null!==b.name[0]&&a.createElementGrid(b)}}}),g=this.makeGridContainer(g,d.libraries);b.addChild(c);b.addChild(g);return b},createElementGrid:function(a){var b=n(),c=new dojo.data.ItemFileWriteStore({url:"billManagerImport/getElementList/id/"+a.id});p({stackContainerTitle:a.name,
pageId:"import-page_element-"+this.billId+"_"+this.elementId,billId:this.billId,billElementId:this.elementId,type:"element",gridOpts:{store:c,dialogWidget:this,selectedItem:this.selectedItem,billGrid:this.billGrid,_csrf_token:a._csrf_token,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:b.rowCountCellFormatter},{name:d.description,field:"description",width:"auto"}]}})},makeGridContainer:function(a,b){var c=this.billId+"_"+this.elementId,d=dijit.byId("billManager-element_import_"+
c+"-stackContainer");d&&dijit.byId("billManager-element_import_"+c+"-stackContainer").destroyRecursive();var d=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"billManager-element_import_"+c+"-stackContainer"}),e=new dijit.layout.ContentPane({title:b,content:a,grid:a.grid});d.addChild(e);var e=new dijit.layout.StackController({region:"top",containerId:"billManager-element_import_"+c+"-stackContainer"}),e=new dijit.layout.ContentPane({style:"padding:0px;overflow:hidden;",
"class":"breadCrumbTrail",region:"top",content:e}),f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1,region:"center"});f.addChild(d);f.addChild(e);dojo.subscribe("billManager-element_import_"+c+"-stackContainer-selectChild","",function(a){var b=dijit.byId("billManager-element_import_"+c+"-stackContainer");if(b){var d=b.getChildren(),e=dojo.indexOf(d,a);if(d.length>e+1){a.grid.store.save();a.grid.store.close();var f=t.after(a.grid,"_onFetchComplete",
function(){f.remove();this.scrollToRow(this.selection.selectedIndex)});a.grid._refresh()}for(;d.length>e+1;)e+=1,b.removeChild(d[e]),d[e].destroyRecursive(!0)}});return f}})});
