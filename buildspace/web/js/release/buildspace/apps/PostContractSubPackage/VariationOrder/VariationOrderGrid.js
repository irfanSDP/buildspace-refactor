define("buildspace/apps/PostContractSubPackage/VariationOrder/VariationOrderGrid","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/html dojo/dom-style dojo/number dijit/focus dojo/_base/event dojo/keys dijit/TooltipDialog dijit/popup dojox/grid/EnhancedGrid ./BillDialog dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/PostContract".split(" "),function(r,p,t,w,F,m,n,x,y,z,q,A,B,C,D,
G,f){var E=r("buildspace.apps.PostContractSubPackage.VariationOrder.VariationOrderEnhancedGrid",A,{type:null,style:"border-top:none;",rowSelector:"0px",selectedItem:null,region:"center",subPackage:null,locked:!1,keepSelection:!0,addUrl:null,updateUrl:null,deleteUrl:null,pasteUrl:null,indentUrl:null,outdentUrl:null,constructor:function(a){this.connects=[];this.rearranger=C(this,{});this.formulatedColumn=D(this,{})},canSort:function(a){return!1},postCreate:function(){var a=this;this.inherited(arguments);
var b;this._connects.push(p.connect(this,"onCellMouseOver",function(c){var d=a.getItem(c.rowIndex),e=c.rowIndex,g=c.cell.field.replace("-value","");"undefined"!==typeof d[g+"-has_formula"]&&d[g+"-has_formula"][0]&&(d=d[g+"-value"][0],d=this.formulatedColumn.convertItemIdToRowIndex(d,e),null===b&&(b=new z({content:d,onMouseLeave:function(){q.close(b)}}),q.open({popup:b,around:c.cellNode})))}));this._connects.push(p.connect(this,"onCellMouseOut",function(a){void 0!==b&&q.close(b)}));this.locked||(this.on("RowContextMenu",
function(b){a.selection.clear();var d=a.getItem(b.rowIndex);a.selection.setSelected(b.rowIndex,!0);if("vo"==a.type&&d.can_be_edited[0]||"vo-items"==a.type&&"false"==a.variationOrder.is_approved[0])a.contextMenu(b),0<d.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0,["Add","OmitFromBill"])},!0),this.on("RowClick",function(b){(b=a.getItem(b.rowIndex))&&0<b.id?a.disableToolbarButtons(!1):a.disableToolbarButtons(!0,["Add","OmitFromBill"])}))},canEdit:function(a,b){var c=this;if(void 0!=a){var d=
this.getItem(b),e=a.field;if("vo"==this.type){if("is_approved"===e&&d.id==buildspace.constants.GRID_LAST_ROW){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}if(0<d.id&&!d.can_be_edited[0]){window.setTimeout(function(){c.disableToolbarButtons(!0);c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}}else if("vo-items"==this.type){if("addition_quantity-value"!=e&&"current_percentage-value"!=e&&"current_amount-value"!=e&&"up_to_date_percentage-value"!=
e&&"up_to_date_amount-value"!=e&&0<d.id&&0<d.bill_item_id[0]){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}if("description"!=e&&"type"!=e&&0<d.id&&d.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}if(!(d.id!=buildspace.constants.GRID_LAST_ROW&&d.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||"rate-value"!=e&&"addition_quantity-value"!=
e)){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}}else if("vo-claims"==this.type){if(d.id==buildspace.constants.GRID_LAST_ROW||d.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}e=0<d.id?m.parse(d["omission_quantity-value"][0])*m.parse(d["rate-value"][0])*m.parse(d.total_unit[0]):0;d=0<d.id?m.parse(d["addition_quantity-value"][0])*m.parse(d["rate-value"][0])*
m.parse(d.total_unit[0]):0;if(e>d){window.setTimeout(function(){c.edit.cancel();c.focus.setFocusIndex(b,a.index)},10);return}}}return this._canEdit},doApplyCellEdit:function(a,b,c){var d=this,e=d.getItem(b),g=d.store,k=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),h=c.replace("-value","");-1!==c.indexOf("-value")&&(a=this.formulatedColumn.convertRowIndexToItemId(a,b));if(a!==e[c][0]){var u={id:e.id,attr_name:h,val:a,_csrf_token:e._csrf_token?e._csrf_token:null},l=this.updateUrl;
e.id==buildspace.constants.GRID_LAST_ROW&&(l=0<b?d.getItem(b-1):!1,t.mixin(u,{prev_item_id:l?l.id:0,relation_id:e.relation_id}),l=this.addUrl);var v={url:l,content:u,handleAs:"json",load:function(a){if(a.success){if(0<e.id){for(var h in a.data)e.hasOwnProperty(h)&&h!=g._getIdentifierAttribute()&&g.setValue(e,h,a.data[h]);g.save()}else g.deleteItem(e),g.save(),dojo.forEach(a.items,function(a){g.newItem(a)}),g.save(),d.disableToolbarButtons(!0);var l=d.getCellByField(c);window.setTimeout(function(){d.focus.setFocusIndex(b,
l.index)},10);k.hide()}},error:function(a){k.hide()}};"vo-items"!=d.type||"type"!=h&&"uom_id"!=h&&"addition_quantity"!=h||!e.has_addition_build_up_quantity[0]?(k.show(),dojo.xhrPost(v),d.inherited(arguments)):(buildspace.dialog.confirm(f.confirmation,"<div>"+f.detachAllBuildUpAndLink+"</div>",60,280,function(){k.show();dojo.xhrPost(v)}),d.doCancelEdit(b))}else d.inherited(arguments)},onStyleRow:function(a){this.inherited(arguments);if(a.node.children[0]&&2<=a.node.children[0].children[0].rows.length){var b=
a.node.children[0].children[0].rows[1],c=a.node.children[0].children[0].rows[0].children;b.parentNode.removeChild(b);dojo.forEach(c,function(a,b){var d=dojo.attr(a,"rowSpan");(!d||2>d)&&dojo.attr(a,"rowSpan",2)})}},doCancelEdit:function(a){this.inherited(arguments);this.views.renormalizeRow(a);this.scroller.rowHeightChanged(a,!0)},editableCellDblClick:function(a){var b;b=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:
a;this.focus.setFocusCell(b.cell,b.rowIndex);this.onRowClick(b);this.onRowDblClick(a)},dodblclick:function(a){if(a.cellNode)if(a.cell.editable)this.editableCellDblClick(a);else this.onCellDblClick(a);else this.onRowDblClick(a)},contextMenu:function(a){var b=this.rowCtxMenu=new dijit.Menu;this.contextMenuItems(a);var c={target:a.target,coords:a.keyCode!==y.F10&&"pageX"in a?{x:a.pageX,y:a.pageY}:null},d=this.getItem(a.rowIndex);b&&d&&(this.selection.isSelected(a.rowIndex)||a.rowNode&&w.hasClass(a.rowNode,
"dojoxGridRowbar"))&&(b._openMyself(c),x.stop(a))},contextMenuItems:function(a){var b=this.getItem(a.rowIndex);0<b.id&&"vo-items"==this.type&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.cut,iconClass:"icon-16-container icon-16-cut",onClick:dojo.hitch(this,"cutItems")}));"vo-items"==this.type&&this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,"pasteItem",a.rowIndex),disabled:this.selectedItem?!1:!0}));0<b.id&&
"vo-items"==this.type&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.indent,iconClass:"icon-16-container icon-16-indent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"indent")})),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.outdent,iconClass:"icon-16-container icon-16-outdent",onClick:dojo.hitch(this,"indentOutdent",a.rowIndex,"outdent")})));this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow",
a.rowIndex)}));0<b.id&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow",a.rowIndex)}))},cutItems:function(){this.selectedItem=this.selection.getFirstSelected()},pasteItem:function(a){var b=this,c=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),d=b.store,e=b.selection.getFirstSelected(),g=e.id==buildspace.constants.GRID_LAST_ROW&&0<a?b.getItem(a-1).id:0;c.show();dojo.xhrPost({url:this.pasteUrl,
content:{type:"cut",target_id:e.id,prev_item_id:g,id:b.selectedItem.id,_csrf_token:b.selectedItem._csrf_token},handleAs:"json",load:function(e){var h=[];if(e.success){var k=e.c;d.fetchItemByIdentity({identity:e.data.id,onItem:function(c){c=b.getItemIndex(c);h.push(c);for(var e=0,f=k.length;e<f;++e)d.fetchItemByIdentity({identity:k[e].id,onItem:function(a){a=b.getItemIndex(a);h.push(a)}});0<h.length&&b.rearranger.moveRows(h,a);c=c>a?a:a-1;b.selection.clear();b.selectedItem=null;b.selection.setSelected(c,
!0);b.scrollToRow(0<c-3?c-3:c);b.disableToolbarButtons(!1)}});d.fetchItemByIdentity({identity:e.data.id,onItem:function(a){for(var b in e.data)a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&d.setValue(a,b,e.data[b]);d.save();var c=0;for(a=k.length;c<a;++c)d.fetchItemByIdentity({identity:k[c].id,onItem:function(a){for(var b in k[c])a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&d.setValue(a,b,k[c][b]);d.save()}})}})}h.length=0;c.hide()},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);
b.selectedItem=null;c.hide()}})},addRow:function(a){n.curNode.blur();n.curNode=null;var b=this,c=buildspace.dialog.indeterminateProgressBar({title:f.addingRow+". "+f.pleaseWait+"..."}),d=b.store,e=b.getItem(a);if(0<e.id)e={before_id:e.id,_csrf_token:e._csrf_token};else var g=0<a?b.getItem(a-1).id:0,e={id:e.id,prev_item_id:g,relation_id:e.relation_id,_csrf_token:e._csrf_token};c.show();dojo.xhrPost({url:this.addUrl,content:e,handleAs:"json",load:function(e){e.success&&dojo.forEach(e.items,function(c){0<
c.id&&(c=d.newItem(c),d.save(),c=b.getItemIndex(c),b.rearranger.moveRows([c],a),b.selection.clear())});window.setTimeout(function(){b.selection.setSelected(a,!0);b.focus.setFocusIndex(a,"vo-items"==b.type?3:1)},30);c.hide()},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);c.hide()}})},deleteRow:function(a){var b=this,c=null,d=null,c=b.getItem(a),e=buildspace.dialog.indeterminateProgressBar({title:f.deleting+". "+f.pleaseWait+"..."});n.curNode.blur();n.curNode=null;e.show();var g=
{url:this.deleteUrl,content:{id:c.id,_csrf_token:c._csrf_token},handleAs:"json",load:function(c){if(c.success){c=c.items;for(var d=b.store,f=0,g=c.length;f<g;++f)d.fetchItemByIdentity({identity:c[f].id,onItem:function(a){d.deleteItem(a);d.save()}});c.length=0}e.hide();b.selection.clear();b.disableToolbarButtons(!0);window.setTimeout(function(){b.focus.setFocusIndex(a,0)},10);b.selectedItem=null;b.pasteOp=null},error:function(a){b.selection.clear();b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=
null;e.hide()}};"vo"==this.type?(c=f.deleteVariationOrderDialogBoxTitle,d=f.deleteVariationOrderDialogBoxMsg):(c=f.deleteVariationOrderItemDialogBoxTitle,d=f.deleteVariationOrderItemDialogBoxMsg);new buildspace.dialog.confirm(c,d,80,320,function(){dojo.xhrPost(g)},function(){e.hide()})},indentOutdent:function(a,b){var c=this,d=c.store;if(0<a){var e=c.getItem(a),g=buildspace.dialog.indeterminateProgressBar({title:f.recalculateRows+". "+f.pleaseWait+"..."});g.show();0<e.id&&dojo.xhrPost({url:this[b+
"Url"],content:{id:e.id,_csrf_token:e._csrf_token},handleAs:"json",load:function(a){if(a.success){var c=a.c,b;for(b in a.item)a.item.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&d.setValue(e,b,a.item[b]);var f=0;for(a=c.length;f<a;++f)d.fetchItemByIdentity({identity:c[f].id,onItem:function(a){for(var b in c[f])a.hasOwnProperty(b)&&b!=d._getIdentifierAttribute()&&d.setValue(a,b,c[f][b])}});d.save()}g.hide()},error:function(a){c.selection.clear();c.disableToolbarButtons(!0);g.hide()}})}},openBillDialog:function(a){-1<
a&&(a=this.getItem(a),B({variationOrderItem:a,variationOrder:this.variationOrder,isLastItem:a.id[0]==buildspace.constants.GRID_LAST_ROW?!0:!1,type:"omit_from_bill",locked:this.locked,variationOrderItemGrid:this}).show())},disableToolbarButtons:function(a,b){a=this.locked?!0:a;var c;switch(this.type){case "vo":c="variationOrder-"+this.subPackage.id;break;case "vo-items":c="variationOrder-"+this.subPackage.id+"_"+this.variationOrder.id+"-items";break;default:throw Error("type must be set!");}var d=
dijit.byId(c+"AddRow-button"),e=dijit.byId(c+"DeleteRow-button"),f=dijit.byId(c+"IndentRow-button"),k=dijit.byId(c+"OutdentRow-button"),h=dijit.byId(c+"OmitFromBillRow-button");f&&f._setDisabledAttr(a);k&&k._setDisabledAttr(a);h&&h._setDisabledAttr(a);d&&d._setDisabledAttr(a);e&&e._setDisabledAttr(a);a&&b instanceof Array&&!this.locked&&dojo.forEach(b,function(a){(a=dijit.byId(c+a+"Row-button"))&&a._setDisabledAttr(!1)})},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,p.disconnect);
delete this._connects}});return r("buildspace.apps.PostContractSubPackage.VariationOrder.VariationOrderGrid",dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0;margin:0;width:100%;height:100%;",gutters:!1,subPackage:null,variationOrder:null,gridOpts:{},locked:!1,type:null,pageId:0,postCreate:function(){var a,b;this.inherited(arguments);t.mixin(this.gridOpts,{type:this.type,subPackage:this.subPackage,variationOrder:this.variationOrder,locked:this.locked});var c=this.grid=new E(this.gridOpts);
switch(this.type){case "vo":a="variationOrder-"+this.subPackage.id;b="SP_variationOrder-"+this.subPackage.id;break;case "vo-items":a="variationOrder-"+this.subPackage.id+"_"+this.variationOrder.id+"-items";b="SP_variationOrderItems-"+this.subPackage.id+"_"+this.variationOrder.id;break;case "vo-claims":a="variationOrder-"+this.subPackage.id+"_"+this.variationOrder.id+"-claims";break;default:throw Error("type must be set!");}if(!this.locked){var d=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});
d.addChild(new dijit.form.Button({id:a+"AddRow-button",label:f.addRow,iconClass:"icon-16-container icon-16-add",disabled:0>c.selection.selectedIndex?!0:!1,onClick:function(){-1<c.selection.selectedIndex&&c.addRow(c.selection.selectedIndex)}}));d.addChild(new dijit.ToolbarSeparator);"vo-items"==this.type&&(d.addChild(new dijit.form.Button({id:a+"IndentRow-button",label:f.indent,iconClass:"icon-16-container icon-16-indent",disabled:0>c.selection.selectedIndex?!0:!1,onClick:function(){-1<c.selection.selectedIndex&&
c.indentOutdent(c.selection.selectedIndex,"indent")}})),d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:a+"OutdentRow-button",label:f.outdent,iconClass:"icon-16-container icon-16-outdent",disabled:0>c.selection.selectedIndex?!0:!1,onClick:function(){-1<c.selection.selectedIndex&&c.indentOutdent(c.selection.selectedIndex,"outdent")}})),d.addChild(new dijit.ToolbarSeparator));d.addChild(new dijit.form.Button({id:a+"DeleteRow-button",label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",
disabled:0>c.selection.selectedIndex?!0:!1,onClick:function(){-1<c.selection.selectedIndex&&c.deleteRow(c.selection.selectedIndex)}}));"vo-items"==this.type&&(d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:a+"OmitFromBillRow-button",label:f.omitFromBills,iconClass:"icon-16-container icon-16-eject",disabled:0>c.selection.selectedIndex?!0:!1,onClick:function(){-1<c.selection.selectedIndex&&c.openBillDialog(c.selection.selectedIndex)}})));this.addChild(d)}this.addChild(new dijit.layout.ContentPane({style:"width:100%",
content:c,region:"center"}));"vo-claims"!==this.type&&(a=dijit.byId(b+"-stackContainer"))&&(b=document.createElement("div"),b=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,45),id:this.pageId,content:this,grid:c,executeScripts:!0},b),a.addChild(b),a.selectChild(this.pageId))}})});
