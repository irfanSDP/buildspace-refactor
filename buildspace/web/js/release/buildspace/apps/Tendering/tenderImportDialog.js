define("buildspace/apps/Tendering/tenderImportDialog","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/when dojo/html dojo/dom dojo/keys dojo/dom-style buildspace/widget/grid/cells/Formatter dojox/grid/enhanced/plugins/IndirectSelection dijit/ProgressBar dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/text!./templates/tenderImportForm.html dojo/text!./templates/projectInfoForm.html dojo/i18n!buildspace/nls/TenderImport dojox/form/Uploader".split(" "),
function(f,r,D,E,F,G,h,l,H,I,t,m,n,p,q,u,v,d,J){var w=function(a,b){return 0<a?a:""},x=function(a,b){b=this.grid.getItem(b);var c=16*parseInt(String(b.level));a=null==a?"&nbsp":a;b&&parseInt(String(b.type))<buildspace.apps.Tendering.ProjectStructureConstants.TYPE_BILL&&(a="<b>"+a+"</b>");return'<div class="treeNode" style="padding-left:'+c+'px;"><div class="treeContent">'+a+"&nbsp;</div></div>"},y=f("buildspace.apps.Tendering.FileImportGrid",dojox.grid.EnhancedGrid,{type:null,selectedItem:null,dialogWidget:null,
escapeHTMLInData:!1,gridData:null,style:"border-top:none;",constructor:function(a){this.inherited(arguments)},canSort:function(a){return!1},postCreate:function(){this.inherited(arguments)},destroy:function(){this.inherited(arguments)}}),z=f("buildspace.apps.Tendering.ProjectInfoForm",[m,n,p,q],{templateString:v,baseClass:"buildspace-form",region:"top",nls:d,style:"padding:5px;overflow:auto;padding-bottom:10px;",projectTitle:null,country:null,state:null,workCategory:null,description:null,client:null,
postCreate:function(){this.inherited(arguments)},startup:function(){this.inherited(arguments)}}),A=f("buildspace.apps.Tendering.FileImportGridContainer",dijit.layout.BorderContainer,{stackContainerTitle:"",style:"padding:0px;width:100%;height:100%;",gutters:!1,region:"center",gridOpts:{},projectInfo:null,postCreate:function(){this.inherited(arguments);r.mixin(this.gridOpts,{region:"center"});var a=this.grid=new y(this.gridOpts);this.addChild(new z({projectTitle:this.projectInfo.projectTitle,workCategory:this.projectInfo.work_category,
description:this.projectInfo.description,country:this.projectInfo.country,state:this.projectInfo.state,client:this.projectInfo.client}));this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:a,region:"center"}));if(a=dijit.byId("Tendering-item_import_list_stackContainer")){var b=document.createElement("div");b=new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,200),id:this.pageId,executeScripts:!0},b);a.addChild(b);b.set("content",this);a.selectChild(this.pageId)}}}),
B=f("buildspace.apps.Tendering.FileImportGridDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:d.importTenderProject,selectedItem:null,gridData:null,tempFileInfo:null,rootProject:null,importType:null,projectInfo:null,importUrl:null,buildRendering:function(){var a=this.createContent();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){l.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==
h.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},removeUploadedFile:function(){},createContent:function(){var a=this,b=new dijit.layout.BorderContainer({style:"padding:0px;width:650px;height:450px;",gutters:!1}),c=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:d.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:function(){a.removeUploadedFile();a.hide()}}));
c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({label:d.import,iconClass:"icon-16-container icon-16-import",onClick:dojo.hitch(this,"import")}));var e=A({stackContainerTitle:this.projectInfo.projectTitle,projectInfo:this.projectInfo,gridOpts:{store:dojo.data.ItemFileWriteStore({data:this.gridData}),dialogWidget:this,structure:[{name:"No.",field:"count",width:"30px",styles:"text-align:center;",formatter:w},{name:d.description,field:"title",width:"auto",formatter:x}]}});b.addChild(c);
b.addChild(e);return b},import:function(){var a=this;this.hide();var b=buildspace.dialog.indeterminateProgressBar({title:d.savingData+". "+d.pleaseWait+"..."});b.show().then(function(){dojo.xhrPost({url:a.importUrl,content:{filename:a.tempFileInfo.filename,extension:a.tempFileInfo.extension,uploadPath:a.tempFileInfo.uploadPath,uid:a.projectInfo.unique_id,pid:a.rootProject?parseInt(String(a.rootProject.id)):-1},handleAs:"json",load:function(c){if(c.running)switch(a.importType){case "tender":a.getImportProjectLogStatus(b);
break;default:a.getImportAddendumLogStatus(parseInt(c.version),b)}else b.hide(),buildspace.dialog.alert(d.error,"<div>"+c.errorMsg+"</div>",98,300)},error:function(c){b.hide()}})})},getImportProjectLogStatus:function(a){var b=this;dojo.xhrPost({url:"tendering/getImportTenderProjectProgress",content:{uid:this.projectInfo.unique_id},handleAs:"json",sync:!1,load:function(c){c.exists?(a.hide(),(c=dijit.byId("Tendering-project_listing_grid"))&&c.reload()):setTimeout(function(){b.getImportProjectLogStatus(a)},
2E3)},error:function(c){a.hide()}})},getImportAddendumLogStatus:function(a,b){var c=this;dojo.xhrPost({url:"tendering/getImportAddendumProjectProgress",content:{id:parseInt(String(this.rootProject.id)),version:a},handleAs:"json",sync:!1,load:function(e){e.exists?(b.hide(),c.importAddendumBillProgressDialog()):setTimeout(function(){c.getImportAddendumLogStatus(a,b)},2E3)},error:function(e){b.hide()}})},importAddendumBillProgressDialog:function(){if(this.rootProject&&!isNaN(parseInt(String(this.rootProject.id)))&&
parseInt(String(this.rootProject.tender_type_id))===buildspace.constants.TENDER_TYPE_PARTICIPATED){var a=new t({value:0,title:"Importing Addendum Bills",layoutAlign:"center"}),b=new dijit.Dialog({content:a,style:"background:#fff;padding:5px;height:78px;width:280px;",splitter:!1});b.closeButtonNode.style.display="none";b._onKey=function(c){c.keyCode==h.ESCAPE&&dojo.stopEvent(c)};b.onHide=function(){b.destroyRecursive()};this.importAddendumBillProgress(b,a)}},importAddendumBillProgress:function(a,b){var c=
this;dojo.xhrPost({url:"tendering/getImportAddendumBillProgress",content:{id:parseInt(String(this.rootProject.id))},handleAs:"json",sync:!1,load:function(e){var k=parseInt(e.total_imported_bills),g=parseInt(e.total_bills);e.exists&&0<g&&k!=g?(a.open||a.show(),a.set({title:"Importing "+k+"/"+g+" Addendum Bills"}),b.set({value:k/g*100}),setTimeout(function(){c.importAddendumBillProgress(a,b)},5E3)):(a.open&&a.hide(),c.reloadProjectBreakdown(),c.reloadRevision())},error:function(e){a.open&&a.hide()}})},
reloadProjectBreakdown:function(){var a=dijit.byId("main-project_breakdown");a&&a.grid.reload();(a=dijit.byId(String(this.rootProject.id)+"-tenderAlternative-tenderAlternativeListGrid"))&&a.reload()},reloadRevision:function(){var a=dijit.byId(parseInt(String(this.rootProject.id))+"-ProjectRevision");a&&(dojo.empty(a.projectRevisionSettingsForm.tableContainer),a.projectRevisionSettingsForm.masterGenerateProjectRevisionTableRow())},reloadProjectListing:function(a){var b=dijit.byId("Tendering-project_listing_grid");
if(b){var c=b.store.newItem(a);a=[];c=b.getItemIndex(c);a.push(c);0<a.length&&(b.rearranger.moveRows(a,0),b.selection.setSelected(0,!0),b.render())}}}),C=f("buildspace.apps.Tendering.FileImportForm",[m,n,p,q],{templateString:u,baseClass:"buildspace-form",region:"center",dialogObj:null,importType:null,rootProject:null,nls:d,uploadUrl:"tendering/uploadTenderProject",importUrl:"tendering/importTenderProject",style:"padding:5px;overflow:auto;",postCreate:function(){this.inherited(arguments);var a=this.fileUploaderNode;
a.on("Complete",dojo.hitch(this,"uploadComplete"));a.on("Begin",dojo.hitch(this,"uploadBegin"))},startup:function(){this.inherited(arguments)},doImportFile:function(){},uploadBegin:function(a){(this.pb=buildspace.dialog.indeterminateProgressBar({title:d.uploadingData+". "+d.pleaseWait+"..."})).show()},uploadComplete:function(a){this.dialogObj.hide();this.pb&&this.pb.hide();a.success?(this.importGridDialog=new B({gridData:a.projectBreakdown,projectInfo:a.projectInfo,rootProject:this.rootProject,tempFileInfo:a.tempFileInfo,
importType:this.importType,title:this.title,importUrl:this.importUrl})).show():buildspace.dialog.alert(d.error,"<div>"+a.errorMsg+"</div>",80,320)},close:function(){},onCancel:function(){}});return f("buildspace.apps.Tendering.FileImportDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:d.importTenderProject,rootProject:null,uploadUrl:null,importUrl:null,buildRendering:function(){var a=this.createForm();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){l.set(this.containerNode,
{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==h.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createForm:function(){var a=new dijit.layout.BorderContainer({style:"padding:0px;width:400px;height:120px;",gutters:!1}),b=new C({dialogObj:this,title:this.title,importType:this.importType,rootProject:this.rootProject,uploadUrl:this.uploadUrl,importUrl:this.importUrl}),c=new dijit.Toolbar({region:"top",
style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:d.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));a.addChild(c);a.addChild(b);return a}})});
