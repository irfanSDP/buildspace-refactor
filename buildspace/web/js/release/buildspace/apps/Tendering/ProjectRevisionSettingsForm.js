define("buildspace/apps/Tendering/ProjectRevisionSettingsForm","dojo/_base/declare dojo/html dojo/dom dojo/dom-construct dojo/keys dojo/request dojo/dom-style dojo/dom-attr dojo/dom-geometry dojo/_base/lang dijit/form/Form dijit/form/RadioButton dijit/form/Select dijit/form/ValidationTextBox dijit/form/NumberTextBox dijit/form/CurrencyTextBox dojo/number dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/on buildspace/apps/PageGenerator/GeneratorDialog dojo/text!./templates/projectRevisionSettingsForm.html dojo/text!./templates/projectRevisionSettingsRow.html dojo/text!./templates/projectParticipatedRevisionSettingsForm.html dojo/text!./templates/projectParticipatedRevisionSettingsRow.html dojo/i18n!buildspace/nls/Tendering".split(" "),
function(h,q,F,t,u,k,e,G,H,I,v,J,K,L,M,N,O,l,P,m,n,w,x,y,z,A,B,g){var C=h("buildspace.apps.Tendering.ExportAddendumForm",[v,l,m,n,dojox.form.manager._Mixin,dojox.form.manager._NodeMixin,dojox.form.manager._ValueMixin,dojox.form.manager._DisplayMixin],{templateString:'<form data-dojo-attach-point="containerNode"><table class="table-form"><tr><td class="label" style="width:80px;"><label style="display: inline;"></span>'+g.downloadAs+' :</label></td><td><input type="text" name="filename" style="padding:2px;width:220px;" data-dojo-type="dijit/form/ValidationTextBox" data-dojo-props="trim:true, propercase:true, required: true"><input type="hidden" name="id" value=""><input type="hidden" name="rid" value=""><input type="hidden" name="_csrf_token" value=""></td></tr></table></form>',
project:null,revisionData:null,region:"center",dialogWidget:null,exportUrl:null,style:"outline:none;padding:0;margin:0;border:none;",baseClass:"buildspace-form",startup:function(){this.inherited(arguments);var a=this.revisionData.revision.toString();60<a.length&&(a=a.substring(0,60));this.setFormValues({filename:a,id:this.project.id,rid:this.revisionData.id,_csrf_token:this.project._csrf_token})},submit:function(){if(this.validate()&&this.exportUrl){var a=dojo.formToObject(this.id),b=a.filename.replace(/ /g,
"_");buildspace.windowOpen("POST",this.exportUrl,{filename:b,id:a.id,rid:a.rid,_csrf_token:a._csrf_token});this.dialogWidget&&this.dialogWidget.hide()}}}),D=h("buildspace.apps.Tendering.ExportAddendumDialog",dijit.Dialog,{style:"padding:0px;margin:0;",title:g.exportAddendum,project:null,revisionData:null,exportUrl:null,buildRendering:function(){var a=this.createContent();a.startup();this.content=a;this.inherited(arguments)},postCreate:function(){e.set(this.containerNode,{padding:"0",margin:"0"});
this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(a){a.keyCode==u.ESCAPE&&dojo.stopEvent(a)},onHide:function(){this.destroyRecursive()},createContent:function(){var a=new dijit.layout.BorderContainer({style:"padding:0;width:400px;height:80px;",gutters:!1}),b=new dijit.Toolbar({region:"top",style:"outline:none!important;padding:2px;overflow:hidden;"}),c=C({project:this.project,revisionData:this.revisionData,exportUrl:this.exportUrl,dialogWidget:this});b.addChild(new dijit.form.Button({label:g.close,
iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));b.addChild(new dijit.ToolbarSeparator);b.addChild(new dijit.form.Button({label:g.download,iconClass:"icon-16-container icon-16-import",style:"outline:none!important;",onClick:dojo.hitch(c,"submit")}));a.addChild(b);a.addChild(c);return a}}),E=h("buildspace.apps.Tendering.ProjectRevisionSettingRowForm",[l,m,n],{isNew:!1,projectId:-1,revisionId:-1,region:"center",nls:g,rootProject:null,revisionData:null,
ProjectRevisionSettingsForm:null,_csrf_token:0,constructor:function(a){return parseInt(a.rootProject.tender_type_id[0],10)===buildspace.constants.TENDER_TYPE_PARTICIPATED?a.templateString=B:a.templateString=z},postCreate:function(){this.inherited(arguments);var a=this;this.setSelectedCurrentPrintingRevision();parseInt(this.rootProject.tender_type_id[0],10)!==buildspace.constants.TENDER_TYPE_PARTICIPATED&&(this.isNew?this.save():this.exitEditMode(),this.revisionData.locked_status&&parseInt(String(this.rootProject.status_id))!==
buildspace.constants.STATUS_IMPORT||this.exportButton.set("disabled",!0),this.updateRevisionStatusDescription(this.revisionData.locked_status),this.lockedStatusValue.set("value",this.revisionData.locked_status));w(this.showRevisionSelectedLink,"click",function(b){a.assignNewSelectedRevision()})},assignNewSelectedRevision:function(){var a=this,b=new buildspace.dialog.indeterminateProgressBar({title:"Processing..."}),c={id:this.projectId,revisionId:this.revisionId,"project_revision[project_structure_id]":this.projectId,
"project_revision[current_selected_revision]":!0,"project_revision[_csrf_token]":this._csrf_token};b.show().then(function(){k.post("projectBuilder/assignNewSelectedRevision",{data:c,handleAs:"json",preventCache:!0}).then(function(f){a.ProjectRevisionSettingsForm.revisionDatas=f;b.hide();a.ProjectRevisionSettingsForm.clearOldRevisionAndAddNewRevision()},function(f){console.log(f);b.hide()})})},save:function(){var a=this;parseInt(this.revisionData.locked_status)===parseInt(this.lockedStatusValue.value)&&
this.exitEditMode();if(1===parseInt(this.lockedStatusValue.value)){var b=this.ProjectRevisionSettingsForm.workarea,c=dijit.byId("main-project_breakdown");(new x({project:this.rootProject,validateUrl:"pageGenerator/validateAddendumBill",onSuccess:dojo.hitch(this,"_lockRevision"),onClickErrorNode:function(f,d){switch(parseInt(f.type)){case buildspace.apps.Tendering.ProjectStructureConstants.TYPE_BILL:f.bill_status==buildspace.apps.Tendering.ProjectStructureConstants.BILL_STATUS_OPEN&&b.initTab(f,{billId:f.id,
billType:f.bill_type,billLayoutSettingId:f.billLayoutSettingId,projectBreakdownGrid:c.grid,rootProject:a.rootProject})}}})).show()}else a.formSubmission({id:this.projectId,revisionId:this.revisionId,"project_revision[project_structure_id]":this.projectId,"project_revision[revision]":this.revisionValue.value,"project_revision[version]":this.revisionData.version,"project_revision[locked_status]":this.lockedStatusValue.value,"project_revision[_csrf_token]":this._csrf_token})},_lockRevision:function(){var a=
{id:this.projectId,revisionId:this.revisionId,"project_revision[project_structure_id]":this.projectId,"project_revision[revision]":this.revisionValue.value,"project_revision[version]":this.revisionData.version,"project_revision[locked_status]":this.lockedStatusValue.value,"project_revision[_csrf_token]":this._csrf_token},b=this;new buildspace.dialog.confirm(g.updateBillSummaryPhrases,g.updateBillSummaryPhrasesMsg,80,320,function(){b.lockedStatusValue.set("value",b.revisionData.locked_status);b.exitEditMode()},
function(){b.formSubmission(a)})},formSubmission:function(a){var b=this,c=this.ProjectRevisionSettingsForm,f=new buildspace.dialog.indeterminateProgressBar({title:"Processing..."});f.show().then(function(){k.post("projectBuilder/saveProjectRevision",{data:a,handleAs:"json",preventCache:!0}).then(function(d){f.hide();if(d.success){d.item.locked_status||parseInt(String(b.rootProject.status_id))===buildspace.constants.STATUS_IMPORT?(b.exportButton.set("disabled",!1),b.reuploadTenderDocumentButton&&b.reuploadTenderDocumentButton.set("disabled",
!1),dijit.byId(b.rootProject.id+"AddBillRow-button").domNode.style.display="none",dijit.byId(b.rootProject.id+"DeleteRow-button").domNode.style.display="none"):(b.exportButton.set("disabled",!0),b.reuploadTenderDocumentButton&&b.reuploadTenderDocumentButton.set("disabled",!0));b.revisionId=d.item.id;b.updateRevisionStatusDescription(d.item.locked_status);q.set(b.updatedAtView,d.item.updated_at);if(b.revisionData.locked_status=d.item.locked_status)if(b.hideActionButton(),!dijit.byId(b.rootProject.id+
"PublishToPostContractRow-button")&&(d=dijit.byId(b.rootProject.id+"TenderingBuilder-toolbar"),b.rootProject.is_admin[0]&&d)){var p=b.ProjectRevisionSettingsForm.workarea;d.addChild(new dijit.ToolbarSeparator({id:b.rootProject.id+"PublishToPostContractBtn-toolbar_separator"}));d.addChild(new dijit.form.Button({id:b.rootProject.id+"PublishToPostContractRow-button",label:g.pushToPostContract,iconClass:"icon-16-container icon-16-indent",onClick:function(r){p.removeBillTab();p.removeTabByType(9999999);
(r=p.getParent())&&r.publishToPostContract()}}))}c.closeElementItemGrid()}else buildspace.dialog.alert("Warning",d.errors[Object.keys(d.errors)[0]],100,300)},function(d){f.hide()})});this.exitEditMode()},setSelectedCurrentPrintingRevision:function(){var a=this.revisionData.selected?"none":"block";e.set(this.showRevisionSelectedMarker,"display",this.revisionData.selected?"block":"none");e.set(this.showRevisionSelectedLink,"display",a)},exportAddendum:function(){D({project:this.rootProject,revisionData:this.revisionData,
exportUrl:"tenderingExportFile/exportAddendum"}).show()},reuploadTenderDocumentAddendum:function(){var a={url:"tendering/generateAddendumFileInTenderDocument",content:{pid:parseInt(String(this.rootProject.id)),rid:parseInt(this.revisionData.id),_csrf_token:String(this.rootProject._csrf_token)},handleAs:"json",load:function(b){buildspace.dialog.alert("Notice",g.pleaseCheckAddendumInTenderDocument,100,320)}};new buildspace.dialog.confirm(g.reuploadToTenderDocument,g.reuploadToTenderDocumentMsg,100,
320,function(){dojo.xhrPost(a)})},enterEditMode:function(){this.setupEditMode()},setupEditMode:function(){e.set(this.addendumStatusInput,"display","");e.set(this.addendumStatusView,"display","none");e.set(this.editButton.domNode,"display","none");e.set(this.saveButton.domNode,"display","")},exitEditMode:function(){e.set(this.addendumStatusInput,"display","none");e.set(this.addendumStatusView,"display","");e.set(this.editButton.domNode,"display","");e.set(this.saveButton.domNode,"display","none");
this.tableTenderDocumentRow&&parseInt(String(this.rootProject.status_id))==buildspace.constants.STATUS_TENDERING?(e.set(this.ProjectRevisionSettingsForm.tableTenderDocumentHeader,"display",""),e.set(this.tableTenderDocumentRow,"display",""),this.revisionData.locked_status&&0!=parseInt(this.revisionData.version)||this.reuploadTenderDocumentButton.set("disabled",!0)):(e.set(this.ProjectRevisionSettingsForm.tableTenderDocumentHeader,"display","none"),e.set(this.tableTenderDocumentRow,"display","none"))},
updateRevisionStatusDescription:function(a){q.set(this.addendumStatusView,a?g.addendumLocked:g.addendumProgressing);a?this.ProjectRevisionSettingsForm.addAddendumButton.set("disabled",!1):this.ProjectRevisionSettingsForm.addAddendumButton.set("disabled",!0)},hideActionButton:function(){e.set(this.editButton.domNode,"display","none");e.set(this.saveButton.domNode,"display","none");e.set(this.noActionLabel,"display","")}});return h("buildspace.apps.Tendering.ProjectRevisionSettingsForm",[l,m,n],{projectId:-1,
baseClass:"buildspace-form",style:"padding:5px;overflow:auto;border:0px;",region:"center",rootProject:null,nls:g,workarea:null,revisionDatas:null,_csrf_token:0,tableCount:1,rowArray:[],constructor:function(a){return parseInt(a.rootProject.tender_type_id[0],10)===buildspace.constants.TENDER_TYPE_PARTICIPATED?a.templateString=A:a.templateString=y},postMixInProperties:function(){this.inherited(arguments);this.rowArray[this.projectId]=[]},postCreate:function(){this.inherited(arguments);this.masterGenerateProjectRevisionTableRow()},
masterGenerateProjectRevisionTableRow:function(){var a=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."}),b=this;a.show().then(function(){dojo.xhrGet({url:"projectBuilder/getProjectRevisionLists",handleAs:"json",content:{id:b.projectId},load:function(c){b.revisionDatas=c;b.populateProjectRevisionTableRow();a.hide()},error:function(c){a.hide()}})})},addAddendum:function(){var a=this,b=this.tableCount-1,c=new buildspace.dialog.indeterminateProgressBar({title:"Processing..."}),f=
{id:this.projectId,revisionId:-1,"project_revision[project_structure_id]":this.projectId,"project_revision[revision]":"Addendum "+b,"project_revision[version]":b,"project_revision[locked_status]":!1,"project_revision[_csrf_token]":this._csrf_token};c.show().then(function(){k.post("projectBuilder/saveProjectRevision",{data:f,handleAs:"json",preventCache:!0}).then(function(d){a.revisionDatas=d;c.hide();d.success?(a.clearOldRevisionAndAddNewRevision(),dijit.byId(a.rootProject.id+"AddBillRow-button").domNode.style.display=
"inline",dijit.byId(a.rootProject.id+"DeleteRow-button").domNode.style.display="inline"):buildspace.dialog.alert("Warning",d.errors[Object.keys(d.errors)[0]],100,300)},function(d){c.hide()})})},clearOldRevisionAndAddNewRevision:function(){this.rowArray[this.projectId]=[];this.tableCount=1;dojo.empty(this.tableContainer);var a=dijit.byId(this.rootProject.id+"PublishToPostContractRow-button");if(a){var b=dijit.byId(this.rootProject.id+"PublishToPostContractBtn-toolbar_separator");b&&b.destroyRecursive();
a.destroyRecursive()}this.populateProjectRevisionTableRow();this.closeElementItemGrid()},populateProjectRevisionTableRow:function(){this._csrf_token=this.revisionDatas.form.csrf_token;var a=this.revisionDatas.projectRevisions,b;for(b in a){var c=a[b],f=this.rowArray[this.projectId][b]=new E({count:this.tableCount,rootProject:this.rootProject,projectId:this.projectId,revisionId:c.id,revisionData:c,ProjectRevisionSettingsForm:this,_csrf_token:this.revisionDatas.form.csrf_token});parseInt(this.rootProject.tender_type_id[0],
10)!==buildspace.constants.TENDER_TYPE_PARTICIPATED&&(0===Number(b)||this.rootProject.tendering_module_locked[0]||c.locked_status)&&this.rowArray[this.projectId][b].hideActionButton();this.addTableRow(f)}if(parseInt(this.rootProject.tender_type_id[0],10)!==buildspace.constants.TENDER_TYPE_PARTICIPATED)return c.locked_status||this.addAddendumButton.set("disabled",!0),this.rootProject.tendering_module_locked[0]&&this.addAddendumButton.set("disabled",!0),!0},addTableRow:function(a){t.place(a.domNode,
this.tableContainer);this.tableCount++},closeElementItemGrid:function(){dijit.byId("main-project_breakdown").grid.reload();this.workarea&&this.workarea.removeBillTab()}})});
