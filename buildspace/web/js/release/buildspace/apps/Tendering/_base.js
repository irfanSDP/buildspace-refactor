define(["dojo/_base/declare","dojo/_base/lang","./Builder","buildspace/widget/grid/cells/Formatter","dojo/i18n!buildspace/nls/Tendering"],function(k,n,l,m,d){return k("buildspace.apps.Tendering",buildspace.apps._App,{win:null,init:function(a){this.win=new buildspace.widget.Window({title:d.tendering+" > "+d.projectList,onClose:dojo.hitch(this,"kill")});a=m();var b=new dojo.data.ItemFileWriteStore({clearOnClose:!0,url:"tendering/getProjects"});this.projectListing=new buildspace.apps.Tendering.ProjectListing({region:"center",
gridOpts:{structure:[{name:"&nbsp;",field:"id",width:"30px",styles:"text-align:center;",formatter:a.rowCountCellFormatter,filterable:!1},{name:d.title,field:"title",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea",autoComplete:!0},{name:d.reference,field:"reference",width:"120px",styles:"text-align: center;",autoComplete:!0},{name:d.country,field:"country",width:"100px",styles:"text-align: center;",autoComplete:!0},{name:d.state,field:"state",width:"120px",styles:"text-align: center;",
autoComplete:!0},{name:d.status,field:"status",width:"100px",styles:"text-align: center;",autoComplete:!0},{name:d.created_at,field:"created_at",width:"120px",styles:"text-align: center;",filterable:!1}],store:b,deleteUrl:"projectBuilder/projectListingDelete",onRowDblClick:dojo.hitch(this,"projectListingDblClick")}});this.win.addChild(this.projectListing);this.win.show();this.win.startup()},projectListingDblClick:function(a){if((a=this.projectListing.grid.getItem(a.rowIndex))&&!isNaN(parseInt(String(a.id))))if(parseInt(String(a.tender_type_id))===
buildspace.constants.TENDER_TYPE_PARTICIPATED){var b=new dijit.ProgressBar({value:0,title:"Importing Bills",layoutAlign:"center"}),c=new dijit.Dialog({content:b,style:"background:#fff;padding:5px;height:78px;width:280px;",splitter:!1});c.closeButtonNode.style.display="none";c._onKey=function(e){e.keyCode==keys.ESCAPE&&dojo.stopEvent(e)};c.onHide=function(){c.destroyRecursive()};this.importBillProgress(a,c,b)}else return this.createBuilderWin(a)},importBillProgress:function(a,b,c){var e=this;dojo.xhrPost({url:"tendering/getImportTenderBillProgress",
content:{id:parseInt(String(a.id))},handleAs:"json",sync:!1,load:function(f){var h=parseInt(f.total_imported_bills),g=parseInt(f.total_bills);if(f.exists&&0<g&&h!=g)b.open||b.show(),b.set({title:"Importing "+h+"/"+g+" Bills"}),c.set({value:h/g*100}),setTimeout(function(){e.importBillProgress(a,b,c)},5E3);else return b.open&&b.hide(),e.createBuilderWin(a)},error:function(f){b.open&&b.hide()}})},createBuilderWin:function(a){this.kill();this.project=a;this.win=new buildspace.widget.Window({title:d.tendering+
" > "+buildspace.truncateString(a.title,100)+" ("+d.status+"::"+a.status[0].toUpperCase()+")",onClose:dojo.hitch(this,"kill")});this.win.addChild(new l({project:a}));this.win.show();this.win.startup()},makeTab:function(a,b,c){this.tabArea.addChild(c);this.tabArea.selectChild(c);c.mod_info={title:b,appName:a}},kill:function(){this.win&&"undefined"!=typeof this.win&&this.win.close()}})});
