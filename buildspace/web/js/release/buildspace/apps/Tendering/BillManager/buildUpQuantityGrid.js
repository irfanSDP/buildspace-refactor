define("buildspace/apps/Tendering/BillManager/buildUpQuantityGrid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-attr dojo/_base/connect dojox/grid/enhanced/plugins/Menu dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn dojo/_base/event dojo/keys dojo/currency dijit/focus dojo/_base/html dojo/request/xhr dijit/PopupMenuItem buildspace/widget/grid/cells/Select buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox dijit/popup dijit/TooltipDialog dojo/i18n!buildspace/nls/BuildUpQuantityGrid".split(" "),
function(q,r,B,C,k,D,E,t,u,v,w,F,l,x,G,H,I,J,K,m,y,g){var A=q("buildspace.apps.Tendering.BillManager.BuildUpQuantity.grid",dojox.grid.EnhancedGrid,{billColumnSettingId:null,BillItem:null,style:"border:none!important;",selectedItem:null,keepSelection:!0,addUrl:null,updateUrl:null,deleteUrl:null,pasteUrl:null,buildUpSummaryWidget:null,type:null,disableEditingMode:!1,constructor:function(b){this.rearranger=t(this,{});this.formulatedColumn=u(this,{})},canSort:function(b){return!1},canEdit:function(b,
a){return this.disableEditingMode?!1:this._canEdit},postCreate:function(){var b=this,a=null;this.inherited(arguments);this.disableEditingMode||(this.on("RowContextMenu",function(a){b.selection.clear();var c=b.getItem(a.rowIndex);b.selection.setSelected(a.rowIndex,!0);b.contextMenu(a);c&&0<c.id?b.disableToolbarButtons(!1):b.disableToolbarButtons(!0,["Add"])},!0),this.on("RowClick",function(a){(a=b.getItem(a.rowIndex))&&0<a.id?b.disableToolbarButtons(!1):b.disableToolbarButtons(!0,["Add"])}));this._connects.push(k.connect(this,
"onCellMouseOver",function(b){var d=b.cell.field,c=b.rowIndex,f=this.getItem(c),d=d.replace("-value","");"undefined"!==typeof f[d+"-has_formula"]&&f[d+"-has_formula"][0]&&(f=f[d+"-value"][0],f=this.formulatedColumn.convertItemIdToRowIndex(f,c),null===a&&(a=new y({content:f,onMouseLeave:function(){m.close(a)}}),m.open({popup:a,around:b.cellNode})))}));this._connects.push(k.connect(this,"onCellMouseOut",function(){null!==a&&(m.close(a),a=null)}));this._connects.push(k.connect(this,"onStartEdit",function(){null!==
a&&(m.close(a),a=null)}))},doApplyCellEdit:function(b,a,c){var d=this,e=d.getItem(a),f=d.store;if(b!==e[c][0]){var n=c.replace("-value","");-1!==c.indexOf("-value")&&(b=this.formulatedColumn.convertRowIndexToItemId(b,a));var n={id:e.id,attr_name:n,val:b,type:d.type,_csrf_token:e._csrf_token?e._csrf_token:null},h=this.updateUrl;e.id==buildspace.constants.GRID_LAST_ROW&&(h=0<a?d.getItem(a-1):!1,r.mixin(n,{prev_item_id:h?h.id:0,relation_id:e.relation_id,bill_column_setting_id:d.billColumnSettingId}),
h=this.addUrl);var z=function(a,b){for(var c in a)e.hasOwnProperty(c)&&c!=b._getIdentifierAttribute()&&b.setValue(e,c,a[c]),dojo.forEach(a.affected_nodes,function(a){b.fetchItemByIdentity({identity:a.id,onItem:function(c){for(var d in a)e.hasOwnProperty(d)&&d!=b._getIdentifierAttribute()&&b.setValue(c,d,a[d])}})});b.save()},p=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."});p.show();dojo.xhrPost({url:h,content:n,handleAs:"json",load:function(b){if(b.success){e&&0<e.id?z(b.data,
f):(f.deleteItem(e),f.save(),dojo.forEach(b.items,function(a){f.newItem(a)}),f.save(),d.disableToolbarButtons(!0));d.updateTotalBuildUp(b.total_build_up);var h=d.getCellByField(c);window.setTimeout(function(){d.focus.setFocusIndex(a,h.index)},10)}p.hide()},error:function(a){console.log(a);p.hide()}})}this.inherited(arguments)},dodblclick:function(b){},addRow:function(b){l.curNode.blur();l.curNode=null;var a=this,c,d=buildspace.dialog.indeterminateProgressBar({title:g.addingRow+". "+g.pleaseWait+"..."}),
e=a.store;c=a.getItem(b);if(0<c.id)c={before_id:c.id,type:a.type,_csrf_token:c._csrf_token,bill_column_setting_id:a.billColumnSettingId,relation_id:c.relation_id};else{var f=0<b?a.getItem(b-1).id:0;c={id:c.id,type:a.type,prev_item_id:f,relation_id:c.relation_id,bill_column_setting_id:a.billColumnSettingId,_csrf_token:c._csrf_token}}d.show();dojo.xhrPost({url:this.addUrl,content:c,handleAs:"json",load:function(c){c.success&&dojo.forEach(c.items,function(c){0<c.id&&(c=e.newItem(c),e.save(),c=a.getItemIndex(c),
a.rearranger.moveRows([c],b),a.selection.clear())});window.setTimeout(function(){a.selection.setSelected(b,!0);a.focus.setFocusIndex(b,1)},30);d.hide()},error:function(b){a.selection.clear();a.disableToolbarButtons(!0);d.hide()}})},deleteRow:function(b){var a=this,c=a.getItem(b),d=buildspace.dialog.indeterminateProgressBar({title:g.deleting+". "+g.pleaseWait+"..."});l.curNode.blur();l.curNode=null;d.show();var e={url:this.deleteUrl,content:{id:c.id,_csrf_token:c._csrf_token},handleAs:"json",load:function(f){if(f.success){var e=
f.affected_nodes,h=a.store;h.deleteItem(c);h.save();var g=0;for(f=e.length;g<f;++g)h.fetchItemByIdentity({identity:e[g].id,onItem:function(a){for(var b in e[g])a.hasOwnProperty(b)&&b!=h._getIdentifierAttribute()&&h.setValue(a,b,e[g][b]);h.save()}});a.updateTotalBuildUp()}d.hide();a.selection.clear();window.setTimeout(function(){a.focus.setFocusIndex(b,0)},10);a.disableToolbarButtons(!0);a.selectedItem=null;a.pasteOp=null},error:function(b){a.selection.clear();a.disableToolbarButtons(!0);a.selectedItem=
null;a.pasteOp=null;d.hide()}};new buildspace.dialog.confirm(g.deleteBuildUpQtyItemTitle,g.deleteBuildUpQtyItemMsg,80,320,function(){dojo.xhrPost(e)},function(){d.hide()})},cutItems:function(){this.selectedItem=this.selection.getFirstSelected();this.pasteOp="cut"},copyItems:function(){this.selectedItem=this.selection.getFirstSelected();this.pasteOp="copy"},pasteItem:function(b){var a=this,c=buildspace.dialog.indeterminateProgressBar({title:g.pleaseWait+"..."}),d=a.store,e=a.selection.getFirstSelected(),
f=e.id==buildspace.constants.GRID_LAST_ROW&&0<b?a.getItem(b-1).id:0;c.show();dojo.xhrPost({url:this.pasteUrl,content:{type:a.pasteOp,target_id:e.id,id:a.selectedItem.id,prev_item_id:f,_csrf_token:a.selectedItem._csrf_token},handleAs:"json",load:function(e){var f=[];if(e.success)switch(a.pasteOp){case "cut":d.fetchItemByIdentity({identity:e.data.id,onItem:function(c){c=a.getItemIndex(c);f.push(c);0<f.length&&a.rearranger.moveRows(f,b);a.selectAfterPaste(c>b?b:b-1,!0)}});break;case "copy":e=d.newItem(e.data),
d.save(),e=a.getItemIndex(e),f.push(e),0<f.length&&(a.rearranger.moveRows(f,b),a.selectAfterPaste(b,!1)),a.updateTotalBuildUp()}a.disableToolbarButtons(!1);a.pasteOp=null;f.length=0;c.hide()},error:function(b){a.selection.clear();a.disableToolbarButtons(!0);a.selectedItem=null;a.pasteOp=null;c.hide()}})},selectAfterPaste:function(b,a){this.selection.clear();this.selectedItem=null;this.selection.setSelected(b,!0);a&&this.scrollToRow(0<b-3?b-3:b)},contextMenu:function(b){if(this.disableEditingMode)return!1;
var a=this.rowCtxMenu=new dijit.Menu;this.contextMenuItems(b);var c={target:b.target,coords:b.keyCode!==w.F10&&"pageX"in b?{x:b.pageX,y:b.pageY}:null},d=this.getItem(b.rowIndex);a&&d&&(this.selection.isSelected(b.rowIndex)||b.rowNode&&x.hasClass(b.rowNode,"dojoxGridRowbar"))&&(a._openMyself(c),v.stop(b))},contextMenuItems:function(b){var a=this.getItem(b.rowIndex);a&&0<a.id&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:g.cut,iconClass:"icon-16-container icon-16-cut",onClick:dojo.hitch(this,
"cutItems")})),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:g.copy,iconClass:"icon-16-container icon-16-copy",onClick:dojo.hitch(this,"copyItems")})));this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:g.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,"pasteItem",b.rowIndex),disabled:this.selectedItem?!1:!0}));this.rowCtxMenu.addChild(new dijit.MenuItem({label:g.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow",b.rowIndex)}));
a&&0<a.id&&this.rowCtxMenu.addChild(new dijit.MenuItem({label:g.deleteRow,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow",b.rowIndex)}))},disableToolbarButtons:function(b,a){var c=dijit.byId("builUpGrid-"+this.billColumnSettingId+"_"+this.BillItem.id+"AddRow-button"),d=dijit.byId("builUpGrid-"+this.billColumnSettingId+"_"+this.BillItem.id+"DeleteRow-button");c._setDisabledAttr(b);d._setDisabledAttr(b);if(b&&a instanceof Array){var e=this;dojo.forEach(a,function(a){dijit.byId("builUpGrid-"+
e.billColumnSettingId+"_"+e.BillItem.id+a+"Row-button")._setDisabledAttr(!1)})}},updateTotalBuildUp:function(){this.buildUpSummaryWidget.refreshTotalQuantity()},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,k.disconnect);delete this._connects}});return q("buildspace.apps.Tendering.BillManager.BuildUpQuantityGrid",dijit.layout.BorderContainer,{style:"padding:0;margin:0;width:100%;height:100%;border:none!important;",gutters:!1,billColumnSettingId:null,type:null,BillItem:null,
disableEditingMode:!1,gridOpts:{},postCreate:function(){this.inherited(arguments);r.mixin(this.gridOpts,{billColumnSettingId:this.billColumnSettingId,BillItem:this.BillItem,region:"center",type:this.type,disableEditingMode:this.disableEditingMode});var b=this.grid=new A(this.gridOpts);if(!this.disableEditingMode){var a=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});a.addChild(new dijit.form.Button({id:"builUpGrid-"+this.billColumnSettingId+"_"+this.BillItem.id+
"AddRow-button",label:g.addRow,iconClass:"icon-16-container icon-16-add",disabled:-1<b.selection.selectedIndex?!1:!0,onClick:function(){-1<b.selection.selectedIndex&&b.addRow(b.selection.selectedIndex)}}));a.addChild(new dijit.ToolbarSeparator);a.addChild(new dijit.form.Button({id:"builUpGrid-"+this.billColumnSettingId+"_"+this.BillItem.id+"DeleteRow-button",label:g.deleteRow,iconClass:"icon-16-container icon-16-delete",disabled:-1<b.selection.selectedIndex?!1:!0,onClick:function(){-1<b.selection.selectedIndex&&
b.deleteRow(b.selection.selectedIndex)}}));this.addChild(a)}this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:b,region:"center"}))}})});
