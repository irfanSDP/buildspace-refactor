define("buildspace/apps/Tendering/BillManager/BillGrid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-attr dijit/TooltipDialog dijit/popup dijit/Menu dojo/number dijit/CheckedMenuItem dojox/grid/enhanced/plugins/Menu dojox/grid/enhanced/plugins/Selector dojox/grid/enhanced/plugins/Rearrange buildspace/widget/grid/plugins/FormulatedColumn buildspace/apps/ProjectBuilder/BillManager/ImportQtyDialog ./editBillNoteDialog ./PrintBillDialog dojo/_base/event dojo/keys dijit/focus dojo/_base/connect dojo/_base/html dojo/request/xhr dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dijit/PopupMenuItem dijit/MenuSeparator buildspace/widget/grid/cells/Select buildspace/widget/grid/cells/Textarea buildspace/widget/grid/cells/FormulaTextBox buildspace/widget/grid/cells/Formatter dojo/i18n!buildspace/nls/Tendering dojo/on dojox/grid/_Grid dojox/widget/PlaceholderMenuItem buildspace/widget/grid/cells/TextBox".split(" "),
function(C,B,S,T,D,y,U,z,V,W,X,F,G,H,E,I,J,K,x,A,L,Y,M,N,O,Z,P,aa,ba,ca,Q,f,da){var R=C("buildspace.apps.Tendering.BillManager.BillGrid",dojox.grid.EnhancedGrid,{type:null,bill:null,elementId:0,itemId:-1,style:"border-top:none;",selectedItem:null,borderContainerWidget:null,keepSelection:!0,rowSelector:"0px",addUrl:null,updateUrl:null,rowUpdateUrl:null,deleteUrl:null,deleteRateUrl:null,deleteQuantityUrl:null,pasteUrl:null,indentUrl:null,outdentUrl:null,headerMenu:null,typeColumns:null,markupSettings:null,
parentGrid:null,elementGridStore:null,currentBQAddendumId:-1,currentBillLockedStatus:!1,currentBillVersion:0,currentPrintableVersion:0,currentGridType:"element",currentBillType:null,ORIGINAL_BILL_VERSION:0,typeColumsToQtyUsed:[],constructor:function(c){this.bill=c.bill;this.type=c.type;this.hierarchyTypes=c.hierarchyTypes;this.hierarchyTypesForHead=c.hierarchyTypesForHead;this.unitOfMeasurements=c.unitOfMeasurements;this.columnGroup=c.columnGroup;this.typeColumns=c.typeColumns;this.markupSettings=
c.markupSettings;this.currencySetting=buildspace.billCurrencyAbbreviation?buildspace.billCurrencyAbbreviation:buildspace.currencyAbbreviation;this.currentBQAddendumId=c.currentBQAddendumId;this.currentBillLockedStatus=c.currentBillLockedStatus;this.currentBillVersion=c.currentBillVersion;this.currentPrintableVersion=c.currentPrintableVersion;this.currentGridType=c.currentGridType;c=this.formatter=new Q;this.typeColumnChildren="tree"!=this.type?[{name:"% "+f.job,field_name:"total",width:"60px",styles:"text-align:right;",
editable:!1,formatter:c.elementTypeJobPercentageCellFormatter},{name:f.costPerMetreSquare,field_name:"total_cost",width:"100px",styles:"text-align:right;",editable:!1,formatter:c.unEditableCurrencyCellFormatter},{name:f.total+"/"+f.unit,field_name:"total_per_unit",width:"100px",styles:"text-align:right;",editable:!1,formatter:c.elementTotalPerUnitCellFormatter},{name:f.estimated+" "+f.costPerMetreSquare,field_name:"estimated_cost_per_metre_square",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.TextBox",
editable:!0,formatter:c.numberCellFormatter},{name:f.estimated+" "+f.totalCost,field_name:"estimated_cost",width:"100px",styles:"text-align:right;",formatter:c.unEditableCurrencyCellFormatter}]:[{name:f.include,field_name:"include",width:"60px",styles:"text-align:center;",editable:!0,cellType:"dojox.grid.cells.Select",options:[f.yesCapital,f.noCapital],values:["true","false"],formatter:c.yesNoCellFormatter},{name:f.qty+"/"+f.unit,field_name:"quantity_per_unit-value",width:"70px",styles:"text-align:right;",
editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:c.billQuantityCellFormatter},{name:f.qty+"/"+f.unit+" (2)",field_name:"quantity_per_unit_remeasurement-value",width:"70px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:c.billQuantityCellFormatter},{name:f.difference+" (%)",field_name:"quantity_per_unit_difference",width:"85px",styles:"text-align:right;color:blue;",editable:!1,formatter:c.unEditablePercentageCellFormatter},
{name:f.total+"/"+f.unit,field_name:"total_per_unit",width:"100px",styles:"text-align:right;",editable:!1,formatter:c.itemTotalPerUnitCellFormatter}];this.rearranger=F(this,{});this.formulatedColumn=G(this,{});this.setColumnStructure();this.createHeaderCtxMenu()},canSort:function(c){return!1},postCreate:function(){this.inherited(arguments);var c=this,a=null;this.on("RowContextMenu",function(b){c.selection.clear();c.selection.setSelected(b.rowIndex,!0);c.setupContextMenuAndToolbarButtonRestriction(b);
c.contextMenu(b)},!0);this.on("RowClick",function(b){c.setupContextMenuAndToolbarButtonRestriction(b)},!0);if("item"===c.currentGridType){var d={"quantity_per_unit-value":1,"rate-value":1};this._connects.push(A.connect(this,"onCellMouseOver",function(b){var e=b.cell.field,g=b.cell.field_name,h=b.rowIndex,k=this.getItem(h);"undefined"!==typeof d[g]&&(e=e.replace("-value",""),k&&k.hasOwnProperty(e+"-has_formula")&&"undefined"!==typeof k[e+"-has_formula"]&&k[e+"-has_formula"][0]&&(k=k[e+"-value"][0],
k=this.formulatedColumn.convertItemIdToRowIndex(k,h),null===a&&(a=new D({content:k,onMouseLeave:function(){y.close(a)}}),y.open({popup:a,around:b.cellNode}))))}))}else this._connects.push(A.connect(this,"onCellMouseOver",function(b){var e=b.cell.field,g=this.getItem(b.rowIndex);g&&"addendum_version"==e&&g.hasOwnProperty("addendum_version")&&"undefined"!==typeof g.addendum_version&&parseInt(g.addendum_version)&&null===a&&dojo.xhrGet({url:"tendering/getAddendumInfoByElement/id/"+String(g.id),handleAs:"json",
sync:!0,preventCache:!0}).then(function(h){if(h.length){for(var k='<table class="buildspace-table"><thead><tr><th class="gridCell" style="text-align:center;padding:2px;">'+f.version+'</th><th class="gridCell" style="text-align:center;padding:2px;">'+f.revision+"</th></tr><tbody>",l=0;l<h.length;l++)k+='<tr><td class="gridCell" style="text-align:center;">'+h[l].version+'</td><td class="gridCell" style="text-align:center;padding-left:4px;padding-right:4px;">'+h[l].revision+"</td></tr>";a=new D({content:k+
"</tbody></table>",onMouseLeave:function(){y.close(a)}});y.open({popup:a,around:b.cellNode})}})}));this._connects.push(A.connect(this,"onCellMouseOut",function(){null!==a&&(y.close(a),a=null)}));this._connects.push(A.connect(this,"onStartEdit",function(){null!==a&&(y.close(a),a=null)}))},doApplyCellEdit:function(c,a,d){var b=this,e=b.getItem(a),g=b.store,h=d.replace("-value","");-1!==d.indexOf("-value")&&(c=this.formulatedColumn.convertRowIndexToItemId(c,a));if(c!==e[d][0]){var k=buildspace.dialog.indeterminateProgressBar({title:f.savingData+
". "+f.pleaseWait+"..."}),l={id:e.id,attr_name:h,val:c,bill_id:String(b.bill.id),_csrf_token:e._csrf_token?e._csrf_token:null,currentBQAddendumId:this.currentBQAddendumId},m=this.updateUrl;e.id==buildspace.constants.GRID_LAST_ROW&&(m=0<a?b.getItem(a-1):!1,B.mixin(l,{prev_item_id:m?m.id:0,relation_id:e.relation_id}),m=this.addUrl);var q=function(p,n){for(var v in p)e.hasOwnProperty(v)&&v!=n._getIdentifierAttribute()&&n.setValue(e,v,p[v]);p.affected_nodes.hasOwnProperty("affected_bill_items")&&dojo.forEach(p.affected_nodes.affected_bill_items,
function(u){n.fetchItemByIdentity({identity:u.id,onItem:function(w){for(var r in u)w.hasOwnProperty(r)&&r!=n._getIdentifierAttribute()&&n.setValue(w,r,u[r])}})});p.affected_nodes.hasOwnProperty("affected_bill_item_type_references")&&dojo.forEach(p.affected_nodes.affected_bill_item_type_references,function(u){n.fetchItemByIdentity({identity:u.id,onItem:function(w){for(var r in u)w.hasOwnProperty(r)&&r!=n._getIdentifierAttribute()&&n.setValue(w,r,u[r])}})});dojo.forEach(p.affected_nodes,function(u){n.fetchItemByIdentity({identity:u.id,
onItem:function(w){for(var r in u)w.hasOwnProperty(r)&&r!=n._getIdentifierAttribute()&&n.setValue(w,r,u[r])}})});"tree"!=b.type&&dojo.forEach(p.other_elements,function(u){n.fetchItemByIdentity({identity:u.id,onItem:function(w){for(var r in u)w.hasOwnProperty(r)&&r!=n._getIdentifierAttribute()&&n.setValue(w,r,u[r])}})});n.save()},t={url:m,content:l,handleAs:"json",load:function(p){if(p.success){0<e.id?q(p.data,g):(g.deleteItem(e),g.save(),dojo.forEach(p.items,function(v){g.newItem(v)}),g.save(),b.disableToolbarButtons(!0));
"type"==d&&buildspace.apps.Tendering.NoMarkupItemTypes.includes(c)&&b.refreshGrid();var n=b.getCellByField(d);window.setTimeout(function(){b.focus.setFocusIndex(a,n.index)},10);k.hide()}},error:function(p){k.hide()}};void 0!=e[h+"-has_build_up"]&&e[h+"-has_build_up"][0]?(h="<div>"+f.detachAllBuildUpAndLink+"</div>",buildspace.dialog.confirm(f.confirmation,h,60,280,function(){k.show();dojo.xhrPost(t)}),b.doCancelEdit(a)):"type"==d&&buildspace.apps.Tendering.NoMarkupItemTypes.includes(c)?(h="<div>"+
f.changeItemTypeRemoveMarkup+"</div>",buildspace.dialog.confirm(f.confirmation,h,60,280,function(){k.show().then(function(){dojo.xhrPost(t)})}),b.doCancelEdit(a)):(k.show(),dojo.xhrPost(t),b.inherited(arguments))}else b.inherited(arguments)},canEdit:function(c,a){var d=this;if(d.currentBillLockedStatus)return!1;if(void 0!=c){var b=this.getItem(a),e=c.field;if("tree"==this.type){var g=!0,h=!1,k=e.split("-"),l=[buildspace.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT,buildspace.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE,
buildspace.constants.HIERARCHY_TYPE_HEADER,buildspace.constants.HIERARCHY_TYPE_HEADER_N,buildspace.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM,buildspace.constants.HIERARCHY_TYPE_NOID];if(3==k.length){var m=k[0];e=k[1];h=!0;0>l.indexOf(b.type[0])&&(d.typeColumsToQtyUsed[m]&&"quantity_per_unit_remeasurement"==e||!d.typeColumsToQtyUsed[m]&&"quantity_per_unit"==e||d.currentBillVersion==b.version[0]&&!d.currentBillLockedStatus)&&(g=!1)}if(b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED)if(0<
b.id[0])if(h){if(g){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}}else if("rate-value"!==e)if("markup_percentage-value"!=e&&"markup_amount-value"!=e){if(d.currentBillVersion!=b.version[0]){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if(d.currentBillLockedStatus){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if(b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||"description"==e||"type"==e||!c.editable){if(b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&"description"!=e&&"type"!=e&&c.editable){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if(b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_HTML_EDITOR&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID||"description"!=e){if(b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&
"type"!=e&&"uom_id"!=e){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if(b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&"description"!=e&&"type"!=e&&"rate-value"!=e&&"markup_percentage-value"!=e&&"markup_amount-value"!=e&&"uom_id"!=e&&c.editable){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if(b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE||
"description"==e||"type"==e||"rate-value"==e||"markup_percentage-value"==e||"markup_amount-value"==e||"uom_id"==e||!c.editable){if(b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&"description"!=e&&"type"!=e&&"markup_percentage-value"!=e&&"markup_amount-value"!=e&&"uom_id"!=e&&c.editable){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if(b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE&&"rate-value"==e){window.setTimeout(function(){d.edit.cancel();
d.focus.setFocusIndex(a,c.index)},10);return}}else{window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}}else{window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}}else{window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}if("tree"==d.type){if(0<e.indexOf("-quantity_per_unit-value")&&(g=e.split("-"),"false"==b[g[0]+"-include"][0])){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,
c.index)},10);return}if(0<e.indexOf("-quantity_per_unit_remeasurement-value")&&(g=e.split("-"),"false"==b[g[0]+"-include"][0])){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}"type"===e&&(e=d.getItem(a+1),(b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||b.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&c.editable&&void 0!==e&&b.level[0]<e.level[0]?(c.options=d.hierarchyTypesForHead.options,c.values=d.hierarchyTypesForHead.values):
(c.options=d.hierarchyTypes.options,c.values=d.hierarchyTypes.values))}}else{if(0<=[buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N].indexOf(b.type[0])){window.setTimeout(function(){d.edit.cancel();
d.focus.setFocusIndex(a,c.index)},10);return}}else{if(e=[buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT,buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_PC_RATE,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N],(d.currentBillVersion!=b.version[0]||d.currentBillLockedStatus)&&e.push(buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE),0<=e.indexOf(b.type[0])){window.setTimeout(function(){d.edit.cancel();
d.focus.setFocusIndex(a,c.index)},10);return}}else{if("description"!==e&&"type"!==e||d.currentBillLockedStatus){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}}else if("type"==e&&(d.currentBillVersion!=b.version[0]||d.currentBillLockedStatus)){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}}else{[g]=b.hasOwnProperty("editable")?b.editable:!1;if(b.hasOwnProperty("editable")&&!g){window.setTimeout(function(){d.edit.cancel();
d.focus.setFocusIndex(a,c.index)},10);return}if(0<b.id[0]&&("markup_percentage-value"==e||"markup_amount-value"==e)&&b.markup_disabled[0]){window.setTimeout(function(){d.edit.cancel();d.focus.setFocusIndex(a,c.index)},10);return}}}return this._canEdit},doCancelEdit:function(c){this.inherited(arguments);this.views.renormalizeRow(c);this.scroller.rowHeightChanged(c,!0)},setColumnStructure:function(c){c=this.formatter;var a=!0;if(this.markupSettings.bill_markup_enabled||this.markupSettings.element_markup_enabled||
this.markupSettings.item_markup_enabled)a=!1;var d="auto";if(1<this.typeColumns.length||this.markupSettings.bill_markup_enabled||this.markupSettings.element_markup_enabled||this.markupSettings.item_markup_enabled)d="580px";if("tree"==this.type){var b=this.unitOfMeasurements,e=this.hierarchyTypes;d=this.fixedColumns={noscroll:!1,width:57.8,cells:[[{name:"No",field:"id",styles:"text-align:center;",width:"30px",formatter:c.rowCountCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:f.billReference,
field:"bill_ref",styles:"text-align:center; color: red;",width:"80px",noresize:!0,hidden:!0,rowSpan:2,showInCtxMenu:!0,formatter:c.billRefCellFormatter},{name:f.description,field:"description",width:d,editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:c.treeCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:f.type,field:"type",width:"70px",styles:"text-align:center;",editable:!0,type:"dojox.grid.cells.Select",options:e.options,values:e.values,formatter:c.typeCellFormatter,
noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:f.unit,field:"uom_id",width:"70px",editable:!0,styles:"text-align:center;",type:"dojox.grid.cells.Select",options:b.options,values:b.values,formatter:c.unitIdCellFormatter,noresize:!0,rowSpan:2,showInCtxMenu:!0},{name:f.grandTotalQty,field:"grand_total_quantity",styles:"text-align:right;color:blue;",width:"90px",formatter:c.unEditableNumberCellFormatter,noresize:!0,hidden:!0,rowSpan:2,showInCtxMenu:!0}]]};a=[{name:f.rate,field:"rate-value",field_name:"rate-value",
styles:"text-align:right;",width:"75px",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:c.formulaCurrencyCellFormatter,noresize:!0,rowSpan:2},{name:f.originalGrandTotal,field:"grand_total",styles:"text-align:right;color:blue;",width:"100px",formatter:c.unEditableCurrencyCellFormatter,noresize:!0,hidden:a,rowSpan:2,showInCtxMenu:!0}];var g=this.constructTypeColumnStructure(d)}else d=this.fixedColumns={noscroll:!1,width:"50",cells:[[{name:"No",field:"id",styles:"text-align:center;",
width:"30px",formatter:c.rowCountCellFormatter,noresize:!0,rowSpan:2},{name:f.description,field:"description",width:d,editable:!0,cellType:"buildspace.widget.grid.cells.Textarea",formatter:c.treeCellFormatter,noresize:!0,rowSpan:2}]]},a=[{name:f.grandTotal,field:"grand_total",styles:"text-align:right;color:blue;",width:"100px",formatter:c.unEditableCurrencyCellFormatter,hidden:a,rowSpan:2,noresize:!0,showInCtxMenu:!0}],parseInt(String(this.bill.addendum_version))&&d.cells[0].push({name:f.addendum,
field:"addendum_version",styles:"text-align: center;",width:"68px",formatter:c.addendumInfoCellFormatter,noresize:!0,rowSpan:2}),g=this.constructTypeColumnStructure(d);dojo.forEach(a,function(k){g.cells[0].push(k)});if("tree"==this.type&&this.markupSettings.item_markup_enabled||"tree"!=this.type&&this.markupSettings.element_markup_enabled)a=[{name:f.markup+" (%)",field:"markup_percentage-value",width:"80px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",
formatter:c.formulaPercentageCellFormatter,noresize:!0},{name:f.markup+" ("+this.currencySetting+")",field:"markup_amount-value",width:"100px",styles:"text-align:right;",editable:!0,cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:c.formulaCurrencyCellFormatter,noresize:!0}],dojo.forEach(a,function(k){g.cells[0].push(k)}),g.cells[1].push({name:"tree"==this.type?f.item+" "+f.markup:f.element+" "+f.markup,styles:"text-align:center;",headerClasses:"staticHeader",colSpan:a.length});if(this.markupSettings.bill_markup_enabled||
this.markupSettings.element_markup_enabled||this.markupSettings.item_markup_enabled){var h=[];"tree"==this.type&&h.push({name:f.rateAfterMarkup,field:"rate_after_markup",width:"100px",styles:"text-align:right;",headerClasses:"typeHeader1",formatter:c.rateAfterMarkupCellFormatter,noresize:!0});dojo.forEach([{name:f.total+" (%) "+f.markup,field:"tree"==this.type?"grand_total":"original_grand_total",formatter:"tree"==this.type?c.itemTotalMarkupPercentageCellFormatter:c.elementTotalMarkupPercentageCellFormatter},
{name:f.total+" ("+this.currencySetting+") "+f.markup,field:"tree"==this.type?"grand_total":"original_grand_total",formatter:"tree"==this.type?c.itemTotalMarkupAmountCellFormatter:c.elementTotalMarkupAmountCellFormatter},{name:f.overallTotalAfterMarkup,field:"tree"==this.type?"grand_total_after_markup":"overall_total_after_markup",formatter:"tree"==this.type?c.itemOverallTotalAfterMarkupCellFormatter:c.elementOverallTotalAfterMarkupCellFormatter}],function(k){h.push({name:k.name,field:k.field,width:"100px",
styles:"text-align:right;",headerClasses:"typeHeader1",formatter:k.formatter,noresize:!0})});"tree"!=this.type&&h.push({name:"% "+f.job,field:"overall_total_after_markup",styles:"text-align:right;",headerClasses:"typeHeader1",width:"70px",formatter:c.elementJobPercentageCellFormatter,noresize:!0});dojo.forEach(h,function(k){g.cells[0].push(k)});c=[];this.markupSettings.item_markup_enabled&&c.push(f.item);this.markupSettings.element_markup_enabled&&c.push(f.element);this.markupSettings.bill_markup_enabled&&
c.push(f.bill);g.cells[1].push({name:'<div style="font-weight:normal;">('+c.toString()+")</div>"+f.markupSummary,styles:"text-align:center;",headerClasses:"staticHeader typeHeader1",colSpan:h.length})}this.structure=g},constructTypeColumnStructure:function(c){var a=this,d=this.typeColumnChildren,b=[],e=0;dojo.forEach(this.typeColumns,function(g){a.typeColumsToQtyUsed[g.id]=g.use_original_quantity;var h=g.remeasurement_quantity_enabled||"tree"!=a.type?d.length:d.length-2;e++;if("tree"!=a.type){d[1].name=
g.floor_area_display_metric?f.costPerMetreSquare:f.costPerSquareFeet;if(g.show_estimated_total_cost)var k=!1;else k=!0,h-=2;d[3].hidden=k;d[4].hidden=k}b.push({name:g.name+"<br>"+f.totalUnit+":"+g.quantity,styles:"text-align:center;",headerClasses:"staticHeader typeHeader"+e,colSpan:h,headerId:g.id,hidden:g.is_hidden});for(i=0;i<d.length;i++)if(h=g.id+"-"+d[i].field_name,g.remeasurement_quantity_enabled||"tree"!=a.type||"quantity_per_unit_remeasurement-value"!=d[i].field_name&&"quantity_per_unit_difference"!=
d[i].field_name)h={field:h,columnType:"typeColumn",billColumnSettingId:g.id,hidden:g.is_hidden,headerClasses:"typeHeader"+e},B.mixin(h,d[i]),c.cells[0].push(h)});c.cells.push(b);return c},createHeaderCtxMenu:function(){if("undefined"!==typeof this.fixedColumns){var c=this.fixedColumns.cells[0],a=this,d={headerMenu:new dijit.Menu};dojo.forEach(c,function(b,e){b.showInCtxMenu&&d.headerMenu.addChild(new dijit.CheckedMenuItem({label:b.name,checked:"undefined"===typeof b.hidden||!1===b.hidden?!0:!1,onChange:function(g){var h=
!1;g&&(h=!0);a.showHideMergedColumn(h,e)}}))});this.plugins={menus:d}}},showHideMergedColumn:function(c,a){this.beginUpdate();this.layout.setColumnVisibility(a,c);this.endUpdate()},copyItems:function(){this.selectedItem=this.selection.getFirstSelected();this.pasteOp="copy";this.selectedBillColumnSettingId=this.copyCellType=null},copyCell:function(c,a){this.selectedItem=this.selection.getFirstSelected();this.selectedBillColumnSettingId=a;this.copyCellType=c;this.pasteOp=null},importQty:function(c,
a){(new H({billId:String(this.bill.id),billItem:this.selection.getFirstSelected(),billGrid:this,qtyType:c,targetBillColumnSettingId:a})).show()},pasteItem:function(c){var a=this,d=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),b=a.store,e=a.selection.getFirstSelected(),g=e.id==buildspace.constants.GRID_LAST_ROW&&0<c?a.getItem(c-1).id:0;d.show();dojo.xhrPost({url:this.pasteUrl,content:{type:a.pasteOp,target_id:e.id,prev_item_id:g,id:a.selectedItem.id,currentBQAddendumId:a.currentBQAddendumId,
_csrf_token:a.selectedItem._csrf_token},handleAs:"json",load:function(h){var k=[];if(h.success){var l=h.c;switch(a.pasteOp){case "copy":h=b.newItem(h.data);b.save();h=a.getItemIndex(h);k.push(h);h=0;for(var m=l.length;h<m;++h){var q=b.newItem(l[h]);b.save();q=a.getItemIndex(q);k.push(q)}0<k.length&&(a.rearranger.moveRows(k,c),a.selectAfterPaste(c,!1))}}a.disableToolbarButtons(!1);a.pasteOp=null;k.length=0;d.hide()},error:function(h){a.selection.clear();a.disableToolbarButtons(!0);a.selectedItem=null;
a.pasteOp=null;d.hide()}})},selectAfterPaste:function(c,a){this.selection.clear();this.selectedItem=null;this.selection.setSelected(c,!0);a&&this.scrollToRow(0<c-3?c-3:c)},pasteCell:function(c,a){var d=this,b=buildspace.dialog.indeterminateProgressBar({title:f.pleaseWait+"..."}),e=d.store;c=d.selection.getFirstSelected();b.show();"rate"!=d.copyCellType?(a=a.field.split("-"),a={type:d.copyCellType,target_id:c.id,target_bill_column_setting_id:a[0],id:d.selectedItem.id,bill_column_setting_id:d.selectedBillColumnSettingId,
currentBQAddendumId:d.currentBQAddendumId,_csrf_token:d.selectedItem._csrf_token}):a={type:d.copyCellType,target_id:c.id,id:d.selectedItem.id,currentBQAddendumId:d.currentBQAddendumId,_csrf_token:d.selectedItem._csrf_token};dojo.xhrPost({url:this.pasteUrl,content:a,handleAs:"json",load:function(g){if(g.success){var h=g.c;e.fetchItemByIdentity({identity:g.data.id,onItem:function(k){for(var l in g.data)k.hasOwnProperty(l)&&l!=e._getIdentifierAttribute()&&e.setValue(k,l,g.data[l]);e.save();var m=0;for(k=
h.length;m<k;++m)e.fetchItemByIdentity({identity:h[m].id,onItem:function(q){for(var t in h[m])q.hasOwnProperty(t)&&t!=e._getIdentifierAttribute()&&e.setValue(q,t,h[m][t]);e.save()}})}})}d.selection.clear();d.disableToolbarButtons(!0);d.selectedItem=null;d.copyCellType=null;d.selectedBillColumnSettingId=null;b.hide()},error:function(g){d.selection.clear();d.disableToolbarButtons(!0);d.selectedItem=null;d.copyCellType=null;d.selectedBillColumnSettingId=null;b.hide()}})},addRow:function(c){x.curNode.blur();
x.curNode=null;var a=this,d=buildspace.dialog.indeterminateProgressBar({title:f.addingRow+". "+f.pleaseWait+"..."}),b=a.store,e=a.getItem(c),g=String(a.bill.id);if(0<e.id){var h=0<c?a.getItem(c-1).id:0;h={prev_item_id:h,before_id:e.id,bill_id:g,_csrf_token:e._csrf_token,currentBQAddendumId:this.currentBQAddendumId}}else h=0<c?a.getItem(c-1).id:0,h={id:e.id,bill_id:g,prev_item_id:h,relation_id:e.relation_id,_csrf_token:e._csrf_token,currentBQAddendumId:this.currentBQAddendumId};d.show();dojo.xhrPost({url:this.addUrl,
content:h,handleAs:"json",load:function(k){k.success&&dojo.forEach(k.items,function(l){0<l.id&&(l=b.newItem(l),b.save(),l=a.getItemIndex(l),a.rearranger.moveRows([l],c),a.selection.clear())});window.setTimeout(function(){var l="tree"==a.type?2:1;a.selection.setSelected(c,!0);a.focus.setFocusIndex(c,l)},30);d.hide()},error:function(k){a.selection.clear();a.disableToolbarButtons(!0);d.hide()}})},deleteRow:function(c){var a=this,d=null,b=null;d=a.getItem(c);var e=buildspace.dialog.indeterminateProgressBar({title:f.deleting+
". "+f.pleaseWait+"..."}),g="normal";0!=this.currentBillVersion&&void 0!==d.version&&d.version!=this.currentBillVersion&&(g="strikeThroughDelete");x.curNode.blur();x.curNode=null;e.show();var h={url:this.deleteUrl,content:{id:d.id,method:g,addendum_id:a.currentBQAddendumId,_csrf_token:d._csrf_token},handleAs:"json",load:function(k){if(k.success){var l=k.items,m=a.store;if(void 0!=k.affected_nodes){k=k.affected_nodes;for(var q in k)dojo.forEach(k[q],function(p){m.fetchItemByIdentity({identity:p.id,
onItem:function(n){for(var v in p)n.hasOwnProperty(v)&&v!=m._getIdentifierAttribute()&&(m.setValue(n,v,p[v]),m.save())}})})}var t=0;for(q=l.length;t<q;++t)m.fetchItemByIdentity({identity:l[t].id,onItem:function(p){if("normal"===g)m.deleteItem(p);else for(var n in l[t])p.hasOwnProperty(n)&&n!=m._getIdentifierAttribute()&&m.setValue(p,n,l[t][n]);m.save()}});l.length=0}e.hide();a.selection.clear();window.setTimeout(function(){a.focus.setFocusIndex(c,0)},10);a.disableToolbarButtons(!0);a.selectedItem=
null;a.pasteOp=null;a.copyCellType=null},error:function(k){a.selection.clear();a.disableToolbarButtons(!0);a.selectedItem=null;a.pasteOp=null;a.copyCellType=null;e.hide()}};"tree"!=this.type?(d=f.deleteElementDialogBoxTitle,b=f.deleteElementDialogBoxMsg):d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||d.type==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N?(d=f.deleteHeadDialogBoxTitle,b=f.deleteHeadDialogBoxMsg):(d=f.deleteItemDialogBoxTitle,b=f.deleteItemDialogBoxMsg);new buildspace.dialog.confirm(d,
b,80,320,function(){dojo.xhrPost(h)},function(){e.hide()})},deleteQuantity:function(c,a,d){var b=this,e=b.getItem(c),g=buildspace.dialog.indeterminateProgressBar({title:f.deleting+". "+f.pleaseWait+"..."});x.curNode.blur();x.curNode=null;g.show();a=a.field.split("-");dojo.xhrPost({url:this.deleteQuantityUrl,content:{type:d,bill_column_setting_id:a[0],id:e.id,_csrf_token:e._csrf_token},handleAs:"json",load:function(h){if(h.success){var k=b.store;dojo.forEach(h.items,function(l){k.fetchItemByIdentity({identity:l.id,
onItem:function(m){for(var q in l)m.hasOwnProperty(q)&&q!=k._getIdentifierAttribute()&&(k.setValue(m,q,l[q]),k.save())}})})}g.hide();b.selection.clear();window.setTimeout(function(){b.focus.setFocusIndex(c,0)},10);b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null;b.copyCellType=null},error:function(h){b.selection.clear();b.disableToolbarButtons(!0);b.selectedItem=null;b.pasteOp=null;b.copyCellType=null;g.hide()}})},deleteRate:function(c){var a=this,d=a.getItem(c),b=buildspace.dialog.indeterminateProgressBar({title:f.deleting+
". "+f.pleaseWait+"..."});x.curNode.blur();x.curNode=null;b.show();dojo.xhrPost({url:this.deleteRateUrl,content:{id:d.id,_csrf_token:d._csrf_token},handleAs:"json",load:function(e){if(e.success){var g=a.store;dojo.forEach(e.items,function(h){g.fetchItemByIdentity({identity:h.id,onItem:function(k){for(var l in h)k.hasOwnProperty(l)&&l!=g._getIdentifierAttribute()&&(g.setValue(k,l,h[l]),g.save())}})})}b.hide();a.selection.clear();window.setTimeout(function(){a.focus.setFocusIndex(c,0)},10);a.disableToolbarButtons(!0);
a.selectedItem=null;a.pasteOp=null;a.copyCellType=null},error:function(e){a.selection.clear();a.disableToolbarButtons(!0);a.selectedItem=null;a.pasteOp=null;a.copyCellType=null;b.hide()}})},indentOutdent:function(c,a){if(0<c){var d=this,b=d.store,e=this.getItem(c),g=buildspace.dialog.indeterminateProgressBar({title:f.recalculateRows+". "+f.pleaseWait+"..."});g.show();0<e.id&&dojo.xhrPost({url:this[a+"Url"],content:{id:e.id,_csrf_token:e._csrf_token},handleAs:"json",load:function(h){if(h.success){var k=
h.c,l;for(l in h.item)h.item.hasOwnProperty(l)&&l!=b._getIdentifierAttribute()&&b.setValue(e,l,h.item[l]);var m=0;for(h=k.length;m<h;++m)b.fetchItemByIdentity({identity:k[m].id,onItem:function(q){for(var t in k[m])q.hasOwnProperty(t)&&t!=b._getIdentifierAttribute()&&b.setValue(q,t,k[m][t])}});b.save()}g.hide()},error:function(h){d.selection.clear();d.disableToolbarButtons(!0);g.hide()}})}},refreshGrid:function(){this.beginUpdate();this.set("structure",this.structure);this.set("headerMenu",this.createHeaderCtxMenu());
this.store.close();this.pluginMgr=new this._pluginMgrClass(this);this.pluginMgr.preInit();this.pluginMgr.postInit();this.pluginMgr.startup();this._refresh();this.endUpdate()},editableCellDblClick:function(c){var a=1<this._click.length&&has("ie")?this._click[1]:1<this._click.length&&this._click[0].rowIndex!=this._click[1].rowIndex?this._click[0]:c;this.focus.setFocusCell(a.cell,a.rowIndex);this.onRowClick(a);this.onRowDblClick(c)},dodblclick:function(c){if(c.cellNode)if(c.cell.editable)this.editableCellDblClick(c);
else this.onCellDblClick(c);else this.onRowDblClick(c)},contextMenu:function(c){var a=this.rowCtxMenu=new dijit.Menu;this.contextMenuItems(c);var d={target:c.target,coords:c.keyCode!==K.F10&&"pageX"in c?{x:c.pageX,y:c.pageY}:null},b=this.getItem(c.rowIndex-1),e=this.getItem(c.rowIndex);if(void 0!==e.project_revision_deleted_at&&e.project_revision_deleted_at[0]&&b&&void 0!==b.project_revision_deleted_at&&b.project_revision_deleted_at[0])return!1;a&&e&&(this.selection.isSelected(c.rowIndex)||c.rowNode&&
L.hasClass(c.rowNode,"dojoxGridRowbar"))&&(a._openMyself(d),J.stop(c))},contextMenuItems:function(c){var a=this.getItem(c.rowIndex-1);var d=this.getItem(c.rowIndex+1);var b=this.getItem(c.rowIndex),e=c.cell,g=!1,h=!0,k=!1,l=!0;if(this.currentBillLockedStatus||"element"===this.currentGridType&&this.currentBillVersion!=this.ORIGINAL_BILL_VERSION)return 0<b.id&&"tree"==this.type?this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.editItemNote,iconClass:"icon-16-container icon-16-note",onClick:dojo.hitch(this,
"doEditItemNote",b)})):0<b.id&&"tree"!=this.type&&this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.editTradeNote,iconClass:"icon-16-container icon-16-note",onClick:dojo.hitch(this,"doEditTradeNote",b)})),!0;"element"!==this.currentGridType&&(b.version&&b.version[0]!=this.currentBillVersion&&(g=!0),0<this.currentBillVersion&&b&&(g=!1,0<b.id&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&(l=!1),a&&0<a.id[0]&&
(a.version[0]==this.currentBillVersion||a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&(b.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||b.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&(l=!1),a&&0<a.id&&(b.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&
a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&(l=!1)),0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&(!d||d.id[0]!=buildspace.constants.GRID_LAST_ROW||b.type[0]!==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type[0]!==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||(h=!1),b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&(h=!1)),void 0!==
b.project_revision_deleted_at&&b.project_revision_deleted_at[0]&&(k=!0),0<this.currentBillVersion&&b&&b.id==buildspace.constants.GRID_LAST_ROW&&(null===a||a&&a.type[0]===buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type[0]===buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&(l=!0));0<b.id&&(this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.copy,iconClass:"icon-16-container icon-16-copy",onClick:dojo.hitch(this,"copyItems"),disabled:g})),"tree"==this.type&&(0<e.field.indexOf("-quantity_per_unit-value")?
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&(a=e.field.split("-"),d=z.parse(b[a[0]+"-quantity_per_unit-final_value"]),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.copyQty,iconClass:"icon-16-container icon-16-copy",disabled:g?g:isNaN(d)||0==d||null==d?!0:!1,onClick:dojo.hitch(this,"copyCell","qty",a[0])})),!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.importQtyFromProjects,
iconClass:"icon-16-container icon-16-import",onClick:dojo.hitch(this,"importQty","qty",a[0])}))):0<e.field.indexOf("-quantity_per_unit_remeasurement-value")?b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&(a=e.field.split("-"),d=z.parse(b[a[0]+"-quantity_per_unit_remeasurement-final_value"]),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.copyQty,iconClass:"icon-16-container icon-16-copy",disabled:isNaN(d)||0==d||null==d?!0:!1,onClick:dojo.hitch(this,"copyCell","qty_remeasurement",
a[0])})),!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.importQtyFromProjects,iconClass:"icon-16-container icon-16-import",onClick:dojo.hitch(this,"importQty","qty_remeasurement",a[0])}))):"rate-value"==e.field&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&
(d=z.parse(b["rate-final_value"]),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.copyRate,iconClass:"icon-16-container icon-16-copy",disabled:isNaN(d)||0==d||null==d?!0:!1,onClick:dojo.hitch(this,"copyCell","rate")})))));a=!0;d="pasteItem";"tree"==this.type&&this.selectedItem?("qty"==this.copyCellType&&0<b.id&&0<e.field.indexOf("-quantity_per_unit-value")&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=
buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID?(a=e.field.split("-"),a=this.selectedItem[a[0]+"-quantity_per_unit-has_build_up"][0]&&this.selectedItem.uom_id[0]!=b.uom_id[0]?!0:!1,d="pasteCell"):
"qty_remeasurement"==this.copyCellType&&0<b.id&&0<e.field.indexOf("-quantity_per_unit_remeasurement-value")&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID?(a=e.field.split("-"),a=this.selectedItem[a[0]+"-quantity_per_unit_remeasurement-has_build_up"][0]&&this.selectedItem.uom_id[0]!=b.uom_id[0]?!0:!1,d="pasteCell"):"rate"==this.copyCellType&&0<b.id&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID?(a=!1,d="pasteCell"):null==this.copyCellType&&(a=!1),
!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]!=this.currentBillVersion&&"pasteCell"==d&&(a=!0)):a=this.selectedItem?!1:!0;this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.paste,iconClass:"icon-16-container icon-16-paste",onClick:dojo.hitch(this,d,c.rowIndex,e),disabled:g?g:a}));0<b.id&&"tree"==this.type?(!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&(this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.indent,
iconClass:"icon-16-container icon-16-indent",onClick:dojo.hitch(this,"indentOutdent",c.rowIndex,"indent"),disabled:h})),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.outdent,iconClass:"icon-16-container icon-16-outdent",onClick:dojo.hitch(this,"indentOutdent",c.rowIndex,"outdent"),disabled:h}))),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.editItemNote,iconClass:"icon-16-container icon-16-note",onClick:dojo.hitch(this,"doEditItemNote",b)}))):0<b.id&&"tree"!=this.type&&this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.editTradeNote,
iconClass:"icon-16-container icon-16-note",onClick:dojo.hitch(this,"doEditTradeNote",b)}));this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.addRow,iconClass:"icon-16-container icon-16-add",onClick:dojo.hitch(this,"addRow",c.rowIndex),disabled:l}));0<b.id&&(this.rowCtxMenu.addChild(new P),this.rowCtxMenu.addChild(new dijit.MenuItem({label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",onClick:dojo.hitch(this,"deleteRow",c.rowIndex),disabled:k})),"tree"==this.type&&(0<e.field.indexOf("-quantity_per_unit-value")?
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&(a=e.field.split("-"),d=z.parse(b[a[0]+"-quantity_per_unit-final_value"]),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.deleteQty,iconClass:"icon-16-container icon-16-delete",disabled:g?g:isNaN(d)||0==d||null==d?!0:!1,onClick:dojo.hitch(this,"deleteQuantity",c.rowIndex,e,"qty")}))):0<e.field.indexOf("-quantity_per_unit_remeasurement-value")?
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_RATE_ONLY&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_EXCLUDE&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_NOT_LISTED&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_ITEM_LUMP_SUM_PERCENT&&
b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&(a=e.field.split("-"),d=z.parse(b[a[0]+"-quantity_per_unit_remeasurement-final_value"]),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.deleteQty,iconClass:"icon-16-container icon-16-delete",disabled:isNaN(d)||0==d||null==d?!0:!1,onClick:dojo.hitch(this,"deleteQuantity",c.rowIndex,e,"qty_remeasurement")}))):"rate-value"==
e.field&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&b.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&!this.currentBillLockedStatus&&0<this.currentBillVersion&&b.version&&b.version[0]==this.currentBillVersion&&(d=z.parse(b["rate-final_value"]),this.rowCtxMenu.addChild(new dijit.PopupMenuItem({label:f.deleteRate,iconClass:"icon-16-container icon-16-delete",disabled:isNaN(d)||0==d||null==d?!0:!1,onClick:dojo.hitch(this,
"deleteRate",c.rowIndex)})))))},doEditItemNote:function(c){(new E({item:c,billGrid:this,title:f.editItemNote,updateUrl:"billManager/itemNoteUpdate"})).show()},doEditTradeNote:function(c){(new E({item:c,billGrid:this,title:f.editTradeNote,updateUrl:"billManager/elementNoteUpdate"})).show()},onHeaderCellClick:function(c){dojo.hasClass(c.cell.id,"staticHeader")||(c.grid.setSortIndex(c.cell.index),c.grid.onHeaderClick(c))},onHeaderCellMouseOver:function(c){dojo.hasClass(c.cell.id,"staticHeader")||dojo.addClass(c.cellNode,
this.cellOverClass)},onStyleRow:function(c){this.inherited(arguments);if(c.node.children[0]&&2<=c.node.children[0].children[0].rows.length){var a=c.node.children[0].children[0].rows[1],d=c.node.children[0].children[0].rows[0].children;a.parentNode.removeChild(a);dojo.forEach(d,function(b,e){e=dojo.attr(b,"rowSpan");(!e||2>e)&&dojo.attr(b,"rowSpan",2)})}},disableToolbarButtons:function(c,a){var d=dijit.byId(String(this.bill.id)+this.elementId+"AddRow-button"),b=dijit.byId(String(this.bill.id)+this.elementId+
"DeleteRow-button"),e=dijit.byId(String(this.bill.id)+this.elementId+"IndentRow-button"),g=dijit.byId(String(this.bill.id)+this.elementId+"OutdentRow-button"),h=dijit.byId(String(this.bill.id)+this.elementId+"ImportElementFromLibraryRow-button");d&&d._setDisabledAttr(c);b&&b._setDisabledAttr(c);h&&h._setDisabledAttr(c);e&&e._setDisabledAttr(c);g&&g._setDisabledAttr(c);if(c&&a instanceof Array){var k=this;dojo.forEach(a,function(l){(l=dijit.byId(String(k.bill.id)+k.elementId+l+"Row-button"))&&l._setDisabledAttr(!1)})}},
setupContextMenuAndToolbarButtonRestriction:function(c){if(this.currentBillLockedStatus)return this.disableToolbarButtons(!0);this.disableToolbarButtons(!0,["Delete"]);const a=this.getItem(c.rowIndex);if("tree"==this.type){const d=0===c.rowIndex?null:this.getItem(c.rowIndex-1);c=a&&a.id==buildspace.constants.GRID_LAST_ROW?null:this.getItem(c.rowIndex+1);if(a&&a.hasOwnProperty("project_revision_deleted_at")&&a.project_revision_deleted_at[0])return this.disableToolbarButtons(!0,["Add"]);a&&a.hasOwnProperty("version")&&
a.version[0]!=this.currentBillVersion&&this.disableToolbarButtons(!0,["Delete"]);0<this.currentBillVersion&&a&&(d&&0<d.id[0]&&(d.version[0]==this.currentBillVersion||d.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&d.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&(a.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||a.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&this.disableToolbarButtons(!0,["Add","Delete"]),d&&0<d.id&&(a.type[0]==
buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER||a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&d.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&d.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&(0<a.id?this.disableToolbarButtons(!0,["Add","Delete"]):this.disableToolbarButtons(!0,["Add"])),0<a.id&&a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&
this.disableToolbarButtons(!0,["Add","Delete"]),0<this.currentBillVersion&&a.version&&a.version[0]==this.currentBillVersion&&(!c||c.id[0]!=buildspace.constants.GRID_LAST_ROW||a.type[0]!==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type[0]!==buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N||this.disableToolbarButtons(!0,["Add","Delete","Indent","Outdent"]),a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type[0]!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&
this.disableToolbarButtons(!0,["Add","Delete","Indent","Outdent"])));0<this.currentBillVersion&&a&&a.id==buildspace.constants.GRID_LAST_ROW&&(null===d||d&&d.type[0]===buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&d.type[0]===buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N)&&this.disableToolbarButtons(!0)}else a&&a.hasOwnProperty("editable")&&a.editable&&!isNaN(a.id)?this.disableToolbarButtons(!0,["Add","Delete"]):this.disableToolbarButtons(!0,["Add"]);a&&a.hasOwnProperty("editable")&&
a.editable&&(a.editable[0]||this.disableToolbarButtons(!0,["Add"]))},destroy:function(){this.inherited(arguments);dojo.forEach(this._connects,A.disconnect);delete this._connects}});return C("buildspace.apps.Tendering.BillManager.BillGridBuilder",dijit.layout.BorderContainer,{pageId:"page-00",style:"padding:0px;width:100%;height:100%;",gutters:!1,stackContainerTitle:"",rootProject:null,bill:null,elementId:0,itemId:-1,rowSelector:null,gridOpts:{},type:null,postCreate:function(){var c=this;this.inherited(arguments);
B.mixin(this.gridOpts,{bill:this.bill,elementId:this.elementId,type:this.type,region:"center",borderContainerWidget:this});var a=this.grid=new R(this.gridOpts),d=new dijit.Toolbar({region:"top",style:"padding:2px;border-bottom:none;width:100%;"});this.rootProject.tender_type_id==buildspace.constants.TENDER_TYPE_TENDERED&&(d.addChild(new dijit.form.Button({id:String(this.bill.id)+this.elementId+"AddRow-button",label:f.addRow,iconClass:"icon-16-container icon-16-add",disabled:-1<a.selection.selectedIndex?
!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.addRow(a.selection.selectedIndex)}})),d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:String(this.bill.id)+this.elementId+"IndentRow-button",label:f.indent,iconClass:"icon-16-container icon-16-indent",disabled:-1<a.selection.selectedIndex?!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.indentOutdent(a.selection.selectedIndex,"indent")}})),d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:String(this.bill.id)+
this.elementId+"OutdentRow-button",label:f.outdent,iconClass:"icon-16-container icon-16-outdent",disabled:-1<a.selection.selectedIndex?!1:!0,onClick:function(){-1<a.selection.selectedIndex&&a.indentOutdent(a.selection.selectedIndex,"outdent")}})),d.addChild(new dijit.ToolbarSeparator),d.addChild(new dijit.form.Button({id:String(this.bill.id)+this.elementId+"DeleteRow-button",label:f.deleteRow,iconClass:"icon-16-container icon-16-delete",disabled:-1<a.selection.selectedIndex?!1:!0,onClick:function(){-1<
a.selection.selectedIndex&&a.deleteRow(a.selection.selectedIndex)}})));if("tree"!==this.type){var b=this.gridOpts.bqCSRFToken;var e=0<this.gridOpts.currentPrintableVersion?f.printAddendum:f.printBQ;if(0<this.gridOpts.currentPrintableVersion){var g=new N({style:"display: none;"});dojo.forEach(["printWithPrice","printWithoutPrice"],function(h){var k="printWithoutPrice"===h?"BQPrintAddendum/"+String(c.bill.id)+"/withPrice/0/"+b:"BQPrintAddendum/"+String(c.bill.id)+"/withPrice/1/"+b;return g.addChild(new O({label:f[h],
onClick:function(){window.open(k,"_blank");return window.focus()}}))});d.addChild(new M({label:f.printAddendum,iconClass:"icon-16-container icon-16-print",name:"printAddendum",dropDown:g}))}else d.addChild(new dijit.form.Button({label:e,iconClass:"icon-16-container icon-16-print",onClick:function(){(new I({billId:String(c.bill.id),statusId:c.rootProject.status_id[0],bqCSRFToken:b})).show()}}))}this.rootProject.tender_type_id==buildspace.constants.TENDER_TYPE_PARTICIPATED&&"tree"==this.type||this.addChild(d);
this.addChild(new dijit.layout.ContentPane({style:"width:100%",content:a,region:"center"}));(d=dijit.byId("add_resource_category_"+String(this.bill.id)+"-btn"))&&d.destroy();if(d=dijit.byId("billGrid"+String(this.bill.id)+"-stackContainer"))d.addChild(new dojox.layout.ContentPane({title:buildspace.truncateString(this.stackContainerTitle,60),content:this,id:this.pageId,grid:a})),d.selectChild(this.pageId)}})});
