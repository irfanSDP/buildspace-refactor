define("dojo/_base/declare dojo/dom-style dojo/request dojo/aspect dojo/when dojo/_base/event dijit/Menu dojo/keys dojo/on dojo/store/Memory dojo/dom-geometry dijit/Tooltip ./buildUpGrid ./buildUpSummary buildspace/widget/grid/cells/Formatter dojo/currency dijit/layout/AccordionContainer dijit/layout/AccordionPane dojo/i18n!buildspace/nls/BQLibrary".split(" "),function(v,A,r,B,w,k,C,D,t,l,E,F,x,y,q,z,G,H,e){return v("buildspace.apps.BQLibraryReport",buildspace.apps._App,{win:null,selectedElementStore:[],
selectedItemStore:[],elementItemStore:[],init:function(b){this.win=new buildspace.widget.Window({title:e.appName,onClose:dojo.hitch(this,"kill")});b=this.borderContainer=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;",gutters:!1});var a=new dijit.Toolbar({region:"top",style:"padding:2px;width:100%;"});a.addChild(new dijit.form.Button({label:e.toggleSidebar,iconClass:"icon-16-container icon-16-arrow_bidirectional",style:"outline:none!important;",onClick:dojo.hitch(this,
"toggleSidebar")}));var d=this.tabArea=new dijit.layout.TabContainer({region:"center",style:"width:100%;height:100%;"}),c=this.libraryStore=new dojo.data.ItemFileWriteStore({url:"bqLibrary/libraryList"}),f=new dijit.tree.ForestStoreModel({store:c,rootId:"root",rootLabel:e.libraries,childrenAttrs:["__children"]}),c=this.left=new dijit.EditableTree({model:f,splitter:!0,region:"left",openOnClick:!0,labelAttr:"name",style:"background-color:#ecede9;width:170px;height:100%;",getIconClass:dojo.hitch(c,function(a,
c){return a.root?c?"icon-16-container icon-16-file":"icon-16-container icon-16-folder":"icon-16-container icon-16-list"}),onMouseDown:function(a){var c=dijit.getEnclosingWidget(a.target);if(dojo.mouseButtons.isRight(a))try{this.set("selectedNode",c)}catch(h){k.stop(a)}k.stop(a)}});t(c.domNode,t.selector(".dijitTree","contextmenu"),function(a){k.stop(a)});dojo.connect(c,"onDblClick",this,"onItem");b.addChild(a);b.addChild(c);b.addChild(d);this.win.addChild(b);this.win.show();this.win.startup()},toggleSidebar:function(){0<=
this.borderContainer.getIndexOfChild(this.left)?this.borderContainer.removeChild(this.left):this.borderContainer.addChild(this.left)},makeTab:function(b,a,d){var c=dijit.byId("bqLibrary_report_"+b+"-stackContainer");c&&dijit.byId("bqLibrary_report_"+b+"-stackContainer").destroyRecursive();c=new dijit.layout.StackContainer({style:"width:100%;height:100%;border:0px;",region:"center",id:"bqLibrary_report_"+b+"-stackContainer"});c.addChild(new dijit.layout.ContentPane({title:e.elements,content:d,grid:d.grid}));
d=new dijit.layout.StackController({region:"top",containerId:"bqLibrary_report_"+b+"-stackContainer"});var f=new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;",gutters:!1});f.addChild(c);f.addChild(new dijit.layout.ContentPane({id:"bqLibrary_report_"+b+"-controllerPane",style:"padding:0px;overflow:hidden;","class":"breadCrumbTrail",region:"top",content:d}));c=new dijit.layout.ContentPane({closable:!0,style:"padding: 0px; overflow: hidden;border:0px;",title:buildspace.truncateString(a,
25),content:f});this.tabArea.addChild(c);this.tabArea.selectChild(c);dojo.subscribe("bqLibrary_report_"+b+"-stackContainer-selectChild","",function(a){var c=dijit.byId("bqLibrary_report_"+b+"-stackContainer");if(c){var h=c.getChildren();a=dojo.indexOf(h,a);a+=1;if(h.length>a)for(;h.length>a;)c.removeChild(h[a]),h[a].destroyRecursive(!0),a+=1}});c.lib_info={name:a,id:b}},onItem:function(b){var a=this.libraryStore;if(a.isItem(b)){var d=a.getValue(b,"id");b=a.getValue(b,"name");if("root"!=d){var a=this.tabArea.getChildren(),
c;for(c in a)if("object"==typeof a[c].lib_info&&a[c].lib_info.id==d)return this.tabArea.selectChild(a[c]);var f=this;c=new q;this.selectedElementStore[d]=new l({idProperty:"id"});this.selectedItemStore[d]=new l({idProperty:"id"});this.elementItemStore[d]=[];a=dojo.data.ItemFileWriteStore({url:"bqLibrary/getElementList/id/"+d,clearOnClose:!0});a=f.grid=buildspace.apps.BQLibraryReport.grid({id:"element-reportpage-container-"+d,stackContainerTitle:b,pageId:"element-reportpage-"+d,libraryId:d,gridOpts:{gridContainer:f,
store:a,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:c.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea"},{name:e.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);0<a.id&&null!==a.description[0]&&f.createItemGrid(d,a)},singleCheckBoxSelection:function(a){var c=a.rowIndex;a=this.selection.selected[c];c=this.getItem(c);
this.removedIds=[];if(a)return this.gridContainer.selectedElementStore[this.libraryId].put({id:c.id[0]}),this.getAffectedItemsByElements(c,"add");this.gridContainer.selectedElementStore[this.libraryId].remove(c.id[0]);this.removedIds.push(c.id[0]);return this.getAffectedItemsByElements(c,"remove")},toggleAllSelection:function(a){var c=this,b=this.selection;c.removedIds=[];if(a)return b.selectRange(0,c.rowCount-1),c.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&c.gridContainer.selectedElementStore[c.libraryId].put({id:a.id[0]})})}}),
c.getAffectedItemsByElements(null,"add");b.deselectAll();c.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&(c.gridContainer.selectedElementStore[c.libraryId].remove(a.id[0]),c.removedIds.push(a.id[0]))})}});return c.getAffectedItemsByElements(null,"remove")},getAffectedItemsByElements:function(a,c){var b=this,d=[],f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();if("add"===c)a?d.push(a.id[0]):b.gridContainer.selectedElementStore[b.libraryId].query().forEach(function(a){d.push(a.id)});
else for(var n in b.removedIds)d.push(b.removedIds[n]);r.post("bqLibraryReporting/getAffectedItemsBySelectedElements",{handleAs:"json",data:{libraryId:b.libraryId,trade_ids:JSON.stringify(b.gridContainer.arrayUnique(d))}}).then(function(a){for(var g in a)b.gridContainer.elementItemStore[b.libraryId][g]||(b.gridContainer.elementItemStore[b.libraryId][g]=new l({idProperty:"id"}));if("add"===c)for(g in a)for(var d in a[g])b.gridContainer.elementItemStore[b.libraryId][g].put({id:a[g][d]}),b.gridContainer.selectedItemStore[b.libraryId].put({id:a[g][d]});
else for(g in a)for(d in b.gridContainer.selectedElementStore[b.libraryId].remove(g),a[g])b.gridContainer.elementItemStore[b.libraryId][g].remove(a[g][d]),b.gridContainer.selectedItemStore[b.libraryId].remove(a[g][d]);f.hide()},function(a){f.hide();console.log(a)})}}});f.makeTab(d,b,a)}}},createItemGrid:function(b,a){var d=this,c=q(),f=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM_TEXT,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID_TEXT],
k=[buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER,buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM,buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID],m=new dojo.data.ItemFileWriteStore({url:"bqLibrary/getItemList/id/"+a.id,clearOnClose:!0}),h=dojo.xhrGet({url:"bqLibrary/getUnits",handleAs:"json"}),u=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});u.show();return w(h,function(h){u.hide();buildspace.apps.BQLibraryReport.grid({stackContainerTitle:a.description,
id:"item-reportpage-container-"+b,pageId:"item-reportpage-"+a.id,libraryId:b,elementId:a.id,type:"tree",gridOpts:{gridContainer:d,store:m,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:c.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea",formatter:c.treeCellFormatter},{name:e.type,field:"type",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:f,values:k,
formatter:c.typeCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:h.options,values:h.values,formatter:c.unitIdCellFormatter},{name:e.rate,field:"rate-value",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:c.formulaCurrencyCellFormatter},{name:e.lastUpdated,field:"updated_at",width:"120px",styles:"text-align: center;"}],onRowDblClick:function(a){a=this.getItem(a.rowIndex);
0<a.id&&null!==a.description[0]&&a.type[0]==buildspace.widget.grid.constants.HIERARCHY_TYPE_WORK_ITEM&&d.createBuildUpRateContainer(b,a)},singleCheckBoxSelection:function(a){var c=a.rowIndex;a=this.selection.selected[c];c=this.getItem(c);this.removedIds=[];if(a)return this.gridContainer.selectedItemStore[this.libraryId].put({id:c.id[0]}),this.getAffectedElementsByItems(c,"add");this.gridContainer.selectedItemStore[this.libraryId].remove(c.id[0]);this.removedIds.push(c.id[0]);return this.getAffectedElementsByItems(c,
"remove")},toggleAllSelection:function(a){var c=this,b=this.selection;c.removedIds=[];if(a)return b.selectRange(0,c.rowCount-1),c.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&c.gridContainer.selectedItemStore[c.libraryId].put({id:a.id[0]})})}}),c.getAffectedElementsByItems(null,"add");b.deselectAll();c.store.fetch({onComplete:function(a){dojo.forEach(a,function(a,b){0<a.id&&(c.gridContainer.selectedItemStore[c.libraryId].remove(a.id[0]),c.removedIds.push(a.id[0]))})}});
return c.getAffectedElementsByItems(null,"remove")},getAffectedElementsByItems:function(a,c){var b=this,d=[],f=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});f.show();if("add"===c)b.gridContainer.selectedItemStore[b.libraryId].query().forEach(function(a){d.push(a.id)});else for(var h in b.removedIds)d.push(b.removedIds[h]);r.post("bqLibraryReporting/getAffectedElementsBySelectedItems",{handleAs:"json",data:{libraryId:b.libraryId,item_ids:JSON.stringify(b.gridContainer.arrayUnique(d))}}).then(function(a){for(var d in a)b.gridContainer.elementItemStore[b.libraryId][d]||
(b.gridContainer.elementItemStore[b.libraryId][d]=new l({idProperty:"id"}));var e=dijit.byId("element-reportpage-container-"+b.libraryId);if("add"===c)for(d in a){for(var g in a[d])b.gridContainer.elementItemStore[b.libraryId][d].put({id:a[d][g]}),b.gridContainer.selectedItemStore[b.libraryId].put({id:a[d][g]});e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a)return b.gridContainer.selectedElementStore[b.libraryId].put({id:d}),e.grid.rowSelectCell.toggleRow(a._0,!0)}})}else for(d in a){b.gridContainer.selectedElementStore[b.libraryId].remove(d);
for(g in a[d])b.gridContainer.elementItemStore[b.libraryId][d].remove(a[d][g]),b.gridContainer.selectedItemStore[b.libraryId].remove(a[d][g]);e.grid.store.fetchItemByIdentity({identity:d,onItem:function(a){if(a&&0===b.gridContainer.elementItemStore[b.libraryId][d].data.length)return b.gridContainer.selectedElementStore[b.libraryId].remove(d),e.grid.rowSelectCell.toggleRow(a._0,!1)}})}f.hide()},function(a){f.hide();console.log(a)})}}})},function(a){})},createBuildUpRateContainer:function(b,a){var d=
new dijit.layout.BorderContainer({style:"padding:0px;width:100%;height:100%;border:0px;outline:none;",gutters:!1}),c=new dijit.layout.AccordionContainer({id:"accordian_"+b+"_"+a.id+"-container",region:"center",style:"padding:0px;width:100%;height:100%;border:0px;outline:none;"}),f=new q,k=dojo.xhrGet({url:"bqLibrary/getUnits",handleAs:"json"}),m=buildspace.dialog.indeterminateProgressBar({title:e.pleaseWait+"..."});m.show();dojo.xhrGet({url:"bqLibrary/resourceList/item_id/"+a.id,handleAs:"json",load:function(h){k.then(function(k){if(0==
h.length)c.addChild(new dijit.layout.ContentPane({title:e.emptyResourceCategoryTitle,style:"padding:0px;border:0px;",doLayout:!1,id:"accPane-empty_resource-"+a.id,content:'<div style="text-align:center;"><p><h1>'+e.emptyResourceCategory+"</h1></p></div> "}));else{var l=y({id:"buildUpRateSummary-"+a.id,itemId:a.id,container:d,_csrf_token:a._csrf_token});dojo.forEach(h,function(b){var d=new dojo.data.ItemFileWriteStore({url:"bqLibrary/getBuildUpRateItemList/item_id/"+a.id+"/resource_id/"+b.id,clearOnClose:!0}),
d=x({resource:b,bqItemId:a.id,gridOpts:{itemId:a.id,store:d,buildUpSummaryWidget:l,structure:[{name:"No.",field:"id",width:"30px",styles:"text-align:center;",formatter:f.rowCountCellFormatter},{name:e.description,field:"description",width:"auto",cellType:"buildspace.widget.grid.cells.Textarea",formatter:f.linkedCellFormatter},{name:e.number,field:"number-value",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaCurrencyCellFormatter},
{name:e.constant,field:"constant-value",width:"100px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaCurrencyCellFormatter},{name:e.qty,field:"quantity-value",width:"70px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaNumberCellFormatter},{name:e.unit,field:"uom_id",width:"70px",styles:"text-align:center;",cellType:"dojox.grid.cells.Select",options:k.options,values:k.values,formatter:f.linkedUnitIdCellFormatter},
{name:e.rate,field:"rate-value",width:"120px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaCurrencyCellFormatter},{name:e.total,field:"total",width:"120px",styles:"text-align:right;",formatter:f.linkedCurrencyCellFormatter},{name:e.wastage+" (%)",field:"wastage-value",width:"70px",styles:"text-align:right;",cellType:"buildspace.widget.grid.cells.FormulaTextBox",formatter:f.formulaCurrencyCellFormatter},{name:e.lineTotal,field:"line_total",width:"120px",
styles:"text-align:right;",formatter:f.linkedCurrencyCellFormatter}]}});c.addChild(new dijit.layout.ContentPane({title:b.name+'<span style="color:blue;float:right;">'+buildspace.currencyAbbreviation+"&nbsp;"+z.format(b.total_build_up)+"</span>",style:"padding:0px;border:0px;",doLayout:!1,id:"accPane-"+b.id+"-"+a.id,content:d}))});d.addChild(l)}d.addChild(c);var n=dijit.byId("bqLibrary_report_"+b+"-stackContainer");if(n){var p=document.createElement("div"),p=new dojox.layout.ContentPane({title:buildspace.truncateString(a.description,
60)+" ("+e.buildUpRate+")",id:"buildUpRatePage-"+a.id,executeScripts:!0},p);n.addChild(p);p.set("content",d);n.selectChild("buildUpRatePage-"+a.id)}m.hide()})},error:function(a){m.hide()}})},kill:function(){var b=dijit.byId("TreeInlineEditBox_error-tooltip");b&&b.destroyRecursive();"undefined"!=typeof this.win&&this.win.close()},markedCheckBoxObject:function(b,a){var d=b.store;a.query().forEach(function(a){a.id!=buildspace.constants.GRID_LAST_ROW&&d.fetchItemByIdentity({identity:a.id,onItem:function(a){if(a)return b.rowSelectCell.toggleRow(a._0,
!0)}})})},arrayUnique:function(b){return b.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse()}})});
