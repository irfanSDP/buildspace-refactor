define("buildspace/apps/Gantt/TaskEditorDialog","dojo/_base/declare dojo/aspect dojo/_base/lang dojo/_base/connect dojo/on dojo/date/locale dojo/when dojo/html dojo/dom dojo/keys dojo/dom-attr dojo/dom-style dijit/_WidgetBase dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/text!./templates/taskEditorForm.html dijit/form/SimpleTextarea buildspace/apps/ProjectManagement/TagBillItemGrid dojo/i18n!buildspace/nls/ProjectManagement".split(" "),function(k,l,m,y,z,c,A,B,
C,n,h,g,p,q,r,t,u,v,w,d){var x=k("buildspace.apps.Gantt.TaskEditorForm",[p,q,r,t],{templateString:u,baseClass:"buildspace-form",region:"center",dialogObj:null,ganttMaster:null,task:null,taskRow:null,projectSchedule:null,nls:d,style:"padding:5px;overflow:auto;",taskProgress:0,postCreate:function(){function b(b){"STATUS_DONE"==b?(a.completedDateNode.required=!0,b=a.task.completedDate?c.format(new Date(a.task.completedDate),{datePattern:"yyyy-MM-dd",selector:"date"}):c.format(new Date,{datePattern:"yyyy-MM-dd",
selector:"date"}),a.completedDateNode.set("value",b),g.set(a.completedDateLabelNode,"display","inline"),g.set(a.completedDateSpanNode,"display","inline")):(g.set(a.completedDateLabelNode,"display","none"),g.set(a.completedDateSpanNode,"display","none"),a.completedDateNode.required=!1,a.completedDateNode.set("value",null))}var a=this;this.inherited(arguments);(new v({name:"description",id:"description",trim:!0,rows:"5",value:this.task.description})).placeAt(this.descriptionDivNode);b(this.task.status);
this.statusSelectNode.on("change",function(a){b(a)})},startup:function(){var b=this;this.inherited(arguments);var a=m.mixin({},this.task);a.progress=this.task.progress?parseFloat(this.task.progress):0;a.start=c.format(new Date(this.task.start),{datePattern:"yyyy-MM-dd",selector:"date"});a.end=c.format(new Date(this.task.end),{datePattern:"yyyy-MM-dd",selector:"date"});a.completedDate=c.format(new Date(this.task.completedDate),{datePattern:"yyyy-MM-dd",selector:"date"});a.depends?(h.set(this.startDateNode,
"readonly",!0),h.set(this.startDateNode,"disabled",!0)):(h.set(this.startDateNode,"readonly",!1),h.set(this.startDateNode,"disabled".false));this.taskEditorForm.setFormValues(a);this.startDateNode.on("blur",function(){var a=c.format(new Date(this.get("value")),{datePattern:"dd/MM/yyyy",selector:"date"});"undefined"!=typeof a&&Date.isValid(a)||(a=c.format(new Date(this.dropDownDefaultValue),{datePattern:"dd/MM/yyyy",selector:"date"}));b.startDateChangeCallback(Date.parseString(a))});this.endDateNode.on("blur",
function(){var a=c.format(new Date(this.get("value")),{datePattern:"dd/MM/yyyy",selector:"date"});"undefined"!=typeof a&&Date.isValid(a)||(a=c.format(new Date(this.dropDownDefaultValue),{datePattern:"dd/MM/yyyy",selector:"date"}));b.endDateChangeCallback(Date.parseString(a))});this.durationTextNode.on("change",function(a){var e=Date.parseString(c.format(new Date(b.startDateNode.get("value")),{datePattern:"dd/MM/yyyy",selector:"date"}));a=parseInt(a);a=0>=a?1:a;this.set("value",a);b.endDateNode.set("value",
c.format(new Date(b.ganttMaster.computeEndByDuration(e.getTime(),a)),{datePattern:"yyyy-MM-dd",selector:"date"}))});this.startIsMilestoneNode.set("checked",this.task.startIsMilestone);this.endIsMilestoneNode.set("checked",this.task.endIsMilestone)},startDateChangeCallback:function(b){var a=parseInt(this.durationTextNode.get("value"));b.clearTime();this.endDateNode.set("value",c.format(new Date(this.ganttMaster.computeEndByDuration(b.getTime(),a)),{datePattern:"yyyy-MM-dd",selector:"date"}))},endDateChangeCallback:function(b){var a=
Date.parseString(c.format(new Date(this.startDateNode.get("value")),{datePattern:"dd/MM/yyyy",selector:"date"}));b.setHours(23,59,59,999);b.getTime()<a.getTime()?(a=parseInt(this.durationTextNode.get("value")),a=incrementDateByWorkingDays(b.getTime(),-a),this.startDateNode.set("value",c.format(new Date(this.ganttMaster.computeStart(a)),{datePattern:"yyyy-MM-dd",selector:"date"}))):this.durationTextNode.set("value",recomputeDuration(a.getTime(),b.getTime()))},close:function(){},save:function(){if(this.taskEditorForm.validate()){var b=
this.taskRow.attr("taskId");b=this.ganttMaster.getTask(b);var a=dojo.formToObject(this.taskEditorForm.id);this.ganttMaster.beginTransaction();b.name=a.name;b.description=a.description;b.code=a.code;b.progress=parseFloat(a.progress);b.duration=parseInt(a.duration);b.totalCost=parseFloat(a.totalCost);b.startIsMilestone=a.hasOwnProperty("startIsMilestone")?!0:!1;b.endIsMilestone=a.hasOwnProperty("endIsMilestone")?!0:!1;var d=Date.parseString(c.format(new Date(a.start),{datePattern:"dd/MM/yyyy",selector:"date"})),
e=Date.parseString(c.format(new Date(a.end),{datePattern:"dd/MM/yyyy",selector:"date"}));b.setPeriod(d.getTime(),e.getTime()+864E5);b.changeStatus(a.status);"STATUS_DONE"==a.status?(a=Date.parseString(c.format(new Date(a.completedDate),{datePattern:"dd/MM/yyyy",selector:"date"})),b.completedDate=a.getTime()):b.completedDate=null;this.ganttMaster.endTransaction()&&this.dialogObj.hide()}}});return k("buildspace.apps.Gantt.TaskEditorDialog",dijit.Dialog,{style:"padding:0px;margin:0px;",title:d.taskEditor,
ganttMaster:null,task:null,taskRow:null,projectSchedule:null,buildRendering:function(){this.content=this.createContent();this.inherited(arguments)},postCreate:function(){g.set(this.containerNode,{padding:"0px",margin:"0px"});this.closeButtonNode.style.display="none";this.inherited(arguments)},_onKey:function(b){b.keyCode==n.ESCAPE&&dojo.stopEvent(b)},onHide:function(){this.destroyRecursive()},createContent:function(){var b=this.tabContainer=new dijit.layout.TabContainer({region:"center",style:"padding:0px;width:780px;height:420px;",
id:"TaskEditor-TabContainer"}),a=this.createForm();a.startup();b.addChild(a);isNaN(parseInt(this.task.id))&&isNaN(parseInt(this.task.idFromDB))||this.task.hasChild||b.addChild(this.createTagBillItemGrid(this.task));return b},createForm:function(){var b=new dijit.layout.BorderContainer({style:"padding:0px;width:780px;height:380px;",title:d.taskDetails,gutters:!1}),a=new x({dialogObj:this,projectSchedule:this.projectSchedule,ganttMaster:this.ganttMaster,task:this.task,taskRow:this.taskRow}),c=new dijit.Toolbar({region:"top",
style:"outline:none!important;padding:2px;overflow:hidden;"});c.addChild(new dijit.form.Button({label:d.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",onClick:dojo.hitch(this,"hide")}));c.addChild(new dijit.ToolbarSeparator);c.addChild(new dijit.form.Button({label:d.save,iconClass:"icon-16-container icon-16-save",style:"outline:none!important;",onClick:dojo.hitch(a,"save")}));b.addChild(c);b.addChild(a);return b},createTagBillItemGrid:function(b){var a=new dijit.Toolbar({region:"top",
style:"outline:none!important;border:none;padding:2px;width:100%;"}),c=b.hasOwnProperty("idFromDB")&&!isNaN(parseInt(b.idFromDB))?b.idFromDB:b.id,e=dojo.data.ItemFileWriteStore({url:"projectManagement/getTaggedBillItemList/id/"+c,clearOnClose:!0,urlPreventCache:!0}),f=new w({region:"center",store:e,scheduleTaskItem:b,projectSchedule:this.projectSchedule,projectScheduleWidget:this});a.addChild(new dijit.form.Button({label:d.close,iconClass:"icon-16-container icon-16-close",style:"outline:none!important;",
onClick:dojo.hitch(this,"hide")}));a.addChild(new dijit.ToolbarSeparator);a.addChild(new dijit.form.Button({label:d.tagBillItems,style:"outline:none!important;",iconClass:"icon-16-container icon-16-connect",onClick:dojo.hitch(f,"openBillDialog")}));a.addChild(new dijit.ToolbarSeparator);a.addChild(new dijit.form.Button({id:"ProjectManagement"+b.id+"-TaggedBillItemDeleteRow-button",label:d.deleteRow,style:"outline:none!important;",disabled:!0,iconClass:"icon-16-container icon-16-delete",onClick:function(){if(-1<
f.selection.selectedIndex){var a=f.getItem(f.selection.selectedIndex);a&&0<a.id[0]&&a.hasOwnProperty("type")&&0<a.type&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_HEADER_N&&a.type!=buildspace.widget.grid.constants.HIERARCHY_TYPE_NOID&&f.deleteRow(a)}}}));a.addChild(new dijit.ToolbarSeparator);var g=new dijit.form.NumberTextBox({name:"hours_per_day",style:"width:40px;padding:2px;",required:!0,value:b.hoursPerDay,constraints:{min:0,
max:24}});a.addChild(g);a.addChild(new dijit.form.Button({label:d.saveHoursPerDay,style:"outline:none!important;",iconClass:"icon-16-container icon-16-save",onClick:function(){if(g.validate()){var a=buildspace.dialog.indeterminateProgressBar({title:d.pleaseWait+"..."});a.show().then(function(){dojo.xhrPost({url:"projectManagement/hoursPerDayUpdate",content:{id:c,val:g.get("value"),_csrf_token:b._csrf_token},handleAs:"json",load:function(c){if(c.success){b.hoursPerDay=c.val;g.set("value",b.hoursPerDay);
f.store.save();f.store.close();var d=l.after(f,"_onFetchComplete",function(){d.remove();-1!=this.selection.selectedIndex&&this.scrollToRow(this.selection.selectedIndex)});f._refresh();a.hide()}},error:function(b){a.hide()}})})}}}));e=new dijit.layout.BorderContainer({style:"padding:0;margin:0;width:100%;height:100%;border:none;outline:none;",gutters:!1});e.addChild(a);e.addChild(f);a=new dijit.layout.StackContainer({style:"padding:0;margin:0;border:none;width:100%;height:100%;",region:"center",id:"projectSchedule"+
this.projectSchedule.id[0]+"-stackContainer"});a.addChild(new dojox.layout.ContentPane({title:buildspace.truncateString(b.name,45),content:e,id:"tagBillItemPage-"+this.projectSchedule.id[0]+"_"+b.id,grid:f}));a.selectChild("tagBillItemPage-"+this.projectSchedule.id[0]+"_"+b.id);e=new dijit.layout.StackController({region:"top",containerId:"projectSchedule"+this.projectSchedule.id[0]+"-stackContainer"});e=new dijit.layout.ContentPane({style:"padding:0;margin:0;overflow:hidden;",class:"breadCrumbTrail",
region:"top",content:e});var h=new dijit.layout.BorderContainer({style:"padding:0px;width:780px;height:420px;",title:d.billItems,gutters:!1,id:"tabChild-billItemList"});h.addChild(a);h.addChild(e);return h}})});
